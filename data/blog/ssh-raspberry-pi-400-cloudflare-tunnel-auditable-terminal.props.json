{
	"locale": "en-us",
	"post": {
		"id": "6087ca5d7773ff01bc69869b",
		"uuid": "97cc2515-4169-4f3a-8f95-836de104c041",
		"title": "SSHing to my Raspberry Pi 400 from a browser, with Cloudflare Tunnel and Auditable Terminal",
		"slug": "ssh-raspberry-pi-400-cloudflare-tunnel-auditable-terminal",
		"html": "<p>A few weeks ago I received a <a href=\"https://www.raspberrypi.org/products/raspberry-pi-400/\">Raspberry Pi 400</a> as a gift. I didn’t have time to do anything beyond plug it in and verify that it works. It’s great that the Pi 400 comes with everything you need except for a screen: there’s the computer itself, mouse, HDMI cable and power adapter.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image19-3.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>The Pi 400 has been sitting gathering dust when Cloudflare launched <a href=\"http://blog.cloudflare.com/browser-ssh-terminal-with-auditing/\">Auditable Terminal</a> giving me the perfect excuse to get out the Pi 400 and hook it up.</p><p>Auditable Terminal gives you a fully featured <a href=\"https://www.cloudflare.com/learning/access-management/what-is-ssh/\">SSH client</a> in your browser. You authenticate using Cloudflare Access and can log into a computer from anywhere just using the browser and get a terminal. And using Cloudflare Tunnel you can securely connect a computer to Cloudflare without punching holes in a firewall. And you end up with a consistent terminal experience across devices: 256 colours, Unicode support and the same fonts everywhere.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/SSHing-to-Raspberry-Pi-400-from-a-browser-2.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>This is ideal for my use case: set up the Pi 400 on my home network, use Cloudflare Tunnel to connect it to the Cloudflare network, use Auditable Terminal to connect to the Pi 400 via Cloudflare and the tunnel using nothing more than a browser.</p><p>Here’s what it looks like:</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image9-3.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Before getting into the details of how I set that up, it’s worth stopping and appreciating how cool this is. I am logging into the Pi 400 via SSH but inside the browser window just by visiting a URL in a browser and authenticating using Cloudflare for Teams. And since it’s a URL that SSH session can just be a browser bookmark!</p><p>There’s another reason I wanted to do this: I like to use Cloudflare’s own products. I have a number of Cloudflare accounts that I pay for so that I see the true customer experience. I see the emails we send out and what it’s like to navigate our UI for real use. The Pi 400 gave me a chance to experience with Cloudflare Tunnel and Auditable Terminal.</p><p>Also this is really cool.</p><p>So… if you want to do this yourself, follow along as I take you through the steps I went through to hook a brand new Pi 400 up to Cloudflare and access it from anywhere.</p><h3 id=\"stage-1-prepare-the-pi\">Stage 1: Prepare the Pi</h3><p>I plugged the Pi 400 into my TV via HDMI, to the Internet via Ethernet and booted it. It comes with the OS pre-installed on an SD card so it only took seconds to be at a welcome screen:</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image2-33.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Inevitably with a brand new machine there were a lot of updates to install so I let the machine run through that before logging in for the first time.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image23-1.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>The Pi 400 doesn’t come with the SSH server enabled, so it’s necessary to run the raspi-config program from the command line (<code>sudo raspi-config</code>). The SSH server is under option “3 Interface Options”:</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image1-36.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>It’s option “P2 SSH” and when turned on will allow SSH access to the machine. By default this will be using SSH with password authentication and so it’s pretty important to change the <a href=\"https://www.raspberrypi.org/documentation/linux/usage/users.md\">default pi/raspberry combination</a> (and to go much further and switch to <a href=\"https://www.raspberrypi.org/documentation/remote-access/ssh/passwordless.md\">using certificates</a>).</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image22.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>But for the rest of this run through I am going to stick with password authentication in SSH. We’ll see later that Cloudflare has a clever solution to setting up SSH security with certificates.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image4-17.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>With SSH access setup and the Pi 400 fully updated, the second step is to set up Cloudflare Tunnel.</p><h3 id=\"stage-2-cloudflare-tunnel\">Stage 2: Cloudflare Tunnel</h3><p>Even with SSH setup on the Pi 400 it’s only accessible from inside my home network and I want to get access to it from anywhere. I could open a port in my home firewall, but I hate that idea.</p><p>The answer is<a href=\"http://blog.cloudflare.com/tunnel-for-everyone/\"> Cloudflare Tunnel</a>. It’s a (free!) small daemon (called <code>cloudflared</code>) that will connect from the Pi 400 to multiple Cloudflare data centers and maintain connections to them. It’ll be authenticated to my Cloudflare account and once setup I’ll be able to use Cloudflare for Teams to connect to it via the web.</p><p>Setting it up is a doddle. I already had a domain name setup on Cloudflare, if I hadn’t I could have set one up quickly. The Cloudflare Tunnel documentation takes you through <a href=\"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation\">installing it</a>.</p><p>The only thing I didn’t know was the architecture of the Pi 400 (32 bit? 64 bit?); so I ran <code>lscpu</code> which tells me that it’s <code>armv7l</code> (which is 32-bit). How did I know that armv7l was 32-bit? I didn’t. I googled it.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image10-3.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>You can build <code>cloudflared</code> from source if you wish as it’s <a href=\"https://github.com/cloudflare/cloudflared\">an open source project</a>. But I chose to go the speedy route and <code>wget</code> it.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image25.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>With <code>cloudflared</code> installed on the Pi 400 it was time to authenticate it to my account. Authentication is <a href=\"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/setup\">clearly documented</a> and I started by typing <code>cloudflared tunnel login</code>. On a machine with a UI and browser this would have opened the browser ready for me to log into my Cloudflare account and set up <code>cloudflared</code>.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image30.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Since I was doing all this while SSH’d into the Pi I had to copy and paste the URL to my browser and then choose which of my domains I would use. (I did this before we changed the name from Argo Tunnel to Cloudflare Tunnel… it’s the same thing).</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image18-1.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Once authorized, the <code>cloudflared</code> command running on the Pi 400 automatically sets up the tunnel. In the dashboard I received confirmation of this:</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image12-2.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>And back on the Pi 400 there was confirmation that <code>cloudflared</code> had been authorized and that a <code>cert.pem</code> file was created.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image6-9.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Now that <code>cloudflared</code> was authorized it was time to go ahead and set up an actual tunnel that can be used for the Auditable Terminal. I chose the incredibly original name ‘terminal’ for this.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image5-15.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>At this point the tunnel is set up but not running yet. So the Pi 400 is not yet connected to Cloudflare. I’ll come back to that. But the next step is setting up Cloudflare for Teams so that users can authenticate to the other end of the tunnel and get access.</p><h3 id=\"stage-3-cloudflare-for-teams\">Stage 3: Cloudflare for Teams</h3><p>I didn’t have Cloudflare for Teams setup so the first step was to visit <a href=\"https://dash.teams.cloudflare.com/\">https://dash.teams.cloudflare.com/</a> and following the <a href=\"https://developers.cloudflare.com/cloudflare-one/setup\">setup guide</a>. I chose the unoriginal team name <code>jgctesting</code> and entered it:</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image14-2.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>And it’s here that things got complicated. I ended up writing this blog post to give anyone a step-by-step guide to getting Auditable Terminal working, but also so that we can learn from my confusion. (The team has put up a <a href=\"https://developers.cloudflare.com/cloudflare-one/tutorials/ssh\">complete tutorial on this here</a>.)</p><p>If you follow the Cloudflare for Teams documentation <a href=\"https://developers.cloudflare.com/cloudflare-one/setup\">you have three choices</a>.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image17-1.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>It wasn’t 100% obvious to me that what I needed to do was add an application (as opposed to a location). The answer is… add an application. The process for doing so is documented <a href=\"https://developers.cloudflare.com/cloudflare-one/applications/configure-apps\">here</a>.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image8-5.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>In particular, I’m going to add a Self-Hosted Application (rather than SaaS) since I’m self-hosting it; it’s an SSH server on a Raspberry Pi 400 hidden behind the sofa after all.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image29.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>The next step is to give the application a name and specify the URL it will be accessible via. For me that’s “Raspberry Pi 400” (yeah, I’m great with original names) and I’m making it available via pi400.jgc.org.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image24-1.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Cloudflare for Teams provides <a href=\"https://developers.cloudflare.com/cloudflare-one/identity\">a lot of different authentication and identity options</a>, but for this demo I am going to use the simplest. When I want to connect to this application (which will be Auditable Terminal ultimately) I’m going to have Cloudflare email me a one-time PIN.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image27.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Next up is adding a rule which will let Cloudflare for Teams know who should be allowed access to this application. I am allowing anyone with an @jgc.org email address to get a one-time PIN. Rules can be <a href=\"https://developers.cloudflare.com/cloudflare-one/policies/zero-trust\">much more complex than that</a>!</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image13-2.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>And finally I need to enable browser rendering (which will enable the SSH access and Auditable Terminal).</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image21-1.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><h3 id=\"stage-4-connecting-it-all-together\">Stage 4: Connecting it all together</h3><p>At this stage I had <code>cloudflared</code> setup and authorized on the Pi 400, Cloudflare for Teams setup so that anyone with an @jgc.org email could get a PIN to access Auditable Terminal on pi400.jgc.org (I’ve since reconfigured everything so going to that URL doesn’t do anything today).</p><p>But all these things need connecting together. That means: editing a config file on the Pi 400 and telling Cloudflare to route to the tunnel for pi400.jgc.org.</p><p>I started with the config file which was <code>/home/pi/.cloudflared/config.yml</code>. The first step was to get the tunnel ID.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image26.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>And then edit the config file. Three things needed changing from the defaults: the tunnel (which is just the ID from <code>cloudflared tunnel list</code>), the credentials-file (which is a JSON file in the same location as the config file and with the same name as the tunnel ID) and the hostname (in my case pi400.jgc.org)</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image15-1.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>With the tunnel installed, authorized and configured I was able to finally run it and make sure that it can connect to Cloudflare. It worked! And created four connections to Cloudflare. Two to Lisbon and two to Amsterdam. Cloudflare Tunnel manages these connections to ensure that my Pi 400 is reachable across the Cloudflare network.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image28.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>And finally… I just needed to tell <code>cloudflared</code> to route pi400.jgc.org to the tunnel (once again using that tunnel ID).</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image16-1.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><h3 id=\"stage-5-try-it-\">Stage 5: Try it!</h3><p>And then it was time to try it. I went back to my browser and browsed to pi400.jgc.org and was greeted with a login screen. Since I’d authorized any @jgc.org address I entered an @jgc.org email.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image7-7.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>The next step was to enter the one-time PIN that was emailed to me.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image11-2.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>And, since I am using user/password for SSH I was asked for the user name followed by password.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image20-2.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>And, wow, there I was looking at a command prompt on the Pi 400.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/pi400-login-OG.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Of course, just doing on my laptop wasn’t enough, so I went ahead and logged in the same way on my phone.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/04/image3.jpg\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>The absolute last step was to make sure that <code>cloudflared</code> <a href=\"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/run-tunnel/run-as-service\">runs automatically</a> which was as simple as typing <code>sudo cloudflared --config .cloudflared/config.yml service install</code>.</p><h3 id=\"conclusion\">Conclusion</h3><p>This was pretty fast (especially factoring in my ignorance about all the details of configuring Cloudflare for Teams and Cloudflare Tunnel). Now I can log into that Pi 400 from anywhere in just a browser. So powerful.</p><p>But it’s still using username/password for SSH and that can be fixed with <a href=\"https://developers.cloudflare.com/cloudflare-one/identity/users/short-lived-certificates\">short-lived certificates</a>. And my authentication to access is using one-time PINs; for a real application it would be <a href=\"https://developers.cloudflare.com/cloudflare-one/identity/idp-integration\">better to use SSO</a>.</p>",
		"comment_id": "6087ca5d7773ff01bc69869b",
		"feature_image": "http://blog.cloudflare.com/content/images/2021/04/image19-2.png",
		"featured": false,
		"visibility": "public",
		"created_at": "2021-04-27T09:25:01.000+01:00",
		"updated_at": "2023-07-05T19:50:13.000+01:00",
		"published_at": "2021-04-27T14:00:00.000+01:00",
		"custom_excerpt": "This is how I set up a Pi 400 on my home network, used Cloudflare Tunnel to connect it to the Cloudflare network, used Auditable Terminal to connect to the Pi 400 via Cloudflare and the tunnel using nothing more than a browser.",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "5d1644b141acde0011a94f2c",
				"name": "John Graham-Cumming",
				"slug": "john-graham-cumming",
				"profile_image": "http://blog.cloudflare.com/content/images/2017/03/url-2.jpg",
				"cover_image": "http://blog.cloudflare.com/content/images/2023/05/Twitter-Header-@cloudflare-US.png",
				"bio": null,
				"website": null,
				"location": "Lisbon, Portugal",
				"facebook": null,
				"twitter": null,
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/john-graham-cumming/"
			}
		],
		"tags": [
			{
				"id": "60a554ac88249201ba715076",
				"name": "#BLOG-498",
				"slug": "hash-blog-498",
				"description": null,
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			},
			{
				"id": "5d16450341acde0011a9525e",
				"name": "Raspberry Pi",
				"slug": "raspberry-pi",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/raspberry-pi/"
			},
			{
				"id": "5e9468a55915ff01ba5d17e9",
				"name": "SSH",
				"slug": "ssh",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/ssh/"
			},
			{
				"id": "5eafe962ad4c4401bca11b64",
				"name": "Zero Trust",
				"slug": "zero-trust",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Zero-Trust.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Zero Trust",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Zero Trust'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/zero-trust/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			}
		],
		"primary_author": {
			"id": "5d1644b141acde0011a94f2c",
			"name": "John Graham-Cumming",
			"slug": "john-graham-cumming",
			"profile_image": "http://blog.cloudflare.com/content/images/2017/03/url-2.jpg",
			"cover_image": "http://blog.cloudflare.com/content/images/2023/05/Twitter-Header-@cloudflare-US.png",
			"bio": null,
			"website": null,
			"location": "Lisbon, Portugal",
			"facebook": null,
			"twitter": null,
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/john-graham-cumming/"
		},
		"primary_tag": null,
		"url": "http://blog.cloudflare.com/ssh-raspberry-pi-400-cloudflare-tunnel-auditable-terminal/",
		"excerpt": "This is how I set up a Pi 400 on my home network, used Cloudflare Tunnel to connect it to the Cloudflare network, used Auditable Terminal to connect to the Pi 400 via Cloudflare and the tunnel using nothing more than a browser.",
		"reading_time": 9,
		"access": true,
		"comments": false,
		"og_image": "http://blog.cloudflare.com/content/images/2021/04/Copy-of-Open-Graph-Images-Template--1200x627----Q42020-1.png",
		"og_title": null,
		"og_description": null,
		"twitter_image": "http://blog.cloudflare.com/content/images/2021/04/Copy-of-Open-Graph-Images-Template--1200x627----Q42020.png",
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": "This is how I set up a Pi 400 on my home network, used Cloudflare Tunnel to connect it to the Cloudflare network, used Auditable Terminal to connect to the Pi 400 via Cloudflare and the tunnel using nothing more than a browser.",
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	}
}