<div class="mb2 gray5">8 min read</div>
<div class="post-content lh-copy gray1">
	<!--kg-card-begin: markdown-->
	<p><em><small>This post is also available in <a href="https://blog.cloudflare.com/es-es/icloud-private-relay-es-es">Español</a>.</small></em></p>
	<!--kg-card-end: markdown-->
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/03/image3.png" class="kg-image" alt="iCloud Private Relay: information for Cloudflare customers" loading="lazy"></figure>
	<p>iCloud Private Relay is a new Internet privacy service from Apple that allows users with iOS 15, iPadOS 15, or macOS Monterey on their devices and an iCloud+ subscription, to connect to the Internet and browse with Safari in a more secure and private way. Cloudflare is proud to work with Apple to operate portions of Private Relay infrastructure.</p>
	<p>In this post, we’ll explain how website operators can ensure the best possible experience for end users using iCloud Private Relay. Additional material is available from Apple, including “<a href="https://support.apple.com/guide/icloud/set-up-icloud-private-relay-mm7dc25cb68f/icloud" target="_blank">Set up iCloud Private Relay on all your devices</a>”, and <a href="https://developer.apple.com/support/prepare-your-network-for-icloud-private-relay" target="_blank">“Prepare Your Network or Web Server for iCloud Private Relay”</a> which covers network operator scenarios in detail.</p>
	<h2 id="how-browsing-works-using-icloud-private-relay">How browsing works using iCloud Private Relay</h2>
	<p>The design of the iCloud Private Relay system ensures that no single party handling user data has complete information on both who the user is and what they are trying to access.</p>
	<p>To do this, Private Relay uses modern encryption and transport mechanisms to relay traffic from user devices through Apple and partner infrastructure before sending traffic to the destination website.</p>
	<p>Here’s a diagram depicting what connection metadata is available to who when <em><strong>not</strong></em> using Private Relay to browse the Internet:</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2022/03/image2.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Let’s look at what happens when we <strong>add</strong> Private Relay to the mix:</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2022/03/image1.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>By adding <em>two</em> "relays" (labeled “Ingress Proxy” and “Egress Proxy” above), connection metadata is split:</p>
	<ul>
		<li>The user’s original IP address is visible to the access network (e.g. the coffee shop you’re sitting in, or your home ISP) and the first relay (operated by Apple), but the server or website name is encrypted and not visible to either. <br><br>The first relay hands encrypted data to a second relay (e.g. Cloudflare), but is unable to see “inside” the traffic to Cloudflare.</li>
		<li>Cloudflare-operated relays know only that it is receiving traffic from a Private Relay user, but not specifically who or their client IP address. Cloudflare relays then forward traffic on to the destination server.</li>
	</ul>
	<p>Splitting connections in this way prevents websites from seeing user IP addresses and minimizes how much information entities “on path” can collect on user behavior.</p>
	<p>Much more extensive information on how Private Relay works is available from Apple, including in the whitepaper “<a href="https://www.apple.com/privacy/docs/iCloud_Private_Relay_Overview_Dec2021.PDF" target="_blank">iCloud Private Relay Overview</a>” (pdf).</p>
	<h2 id="cloudflare-s-role-as-a-second-relay-">Cloudflare’s role as a ‘second relay’</h2>
	<p>As mentioned above, Cloudflare functions as a second relay in the iCloud Private Relay system. We’re well suited to the task — Cloudflare operates one of the largest, fastest networks in the world. Our infrastructure makes sure traffic reaches every network in the world quickly and reliably, no matter where in the world a user is connecting from.</p>
	<p>We’re also adept at building and working with modern encryption and transport protocols, including <a href="https://blog.cloudflare.com/rfc-8446-aka-tls-1-3">TLS 1.3</a> and <a href="https://blog.cloudflare.com/the-road-to-quic">QUIC</a>. QUIC, and closely related <a href="https://datatracker.ietf.org/wg/masque/about" target="_blank">MASQUE</a>, are the technologies that enable Private Relay to efficiently move data between multiple relay hops without incurring performance penalties.</p>
	<p>The same building blocks that power Cloudflare products were used to build support for Private Relay: our <a href="https://www.cloudflare.com/network" target="_blank">network</a>, 1.1.1.1, <a href="https://workers.cloudflare.com" target="_blank">Cloudflare Workers</a>, and software like <a href="https://github.com/cloudflare/quiche" target="_blank">quiche</a>, our <a href="https://blog.cloudflare.com/enjoy-a-slice-of-quic-and-rust">open-source</a> QUIC (and now MASQUE) protocol handling library, which now includes proxy support.</p>
	<h2 id="i-m-a-website-operator-what-do-i-need-to-do-to-properly-handle-icloud-private-relay-traffic">I’m a website operator. What do I need to do to properly handle iCloud Private Relay traffic?</h2>
	<p>We’ve gone out of our way to ensure the use of iCloud Private Relay does not have any noticeable impact on your websites, APIs, and other content you serve on the web.</p>
	<h3 id="ensuring-geolocation-accuracy">Ensuring geolocation accuracy</h3>
	<p>IP addresses are often used by website operators to "geolocate" users, with user locations being used to show content specific to certain locations (e.g. search results) or to otherwise customize user experiences. Private Relay is designed to preserve IP address to geolocation mapping accuracy, even while preventing tracking and fingerprinting.</p>
	<p>Preserving the ability to derive rough user location ensures that users with Private Relay enabled are able to:</p>
	<ol>
		<li>See place search and other locally relevant content when they interact with geography-specific content without precise location sharing enabled.</li>
		<li>Consume content subject to licensing restrictions limiting which regions have access to it (e.g. live sports broadcasts and similar rights-restricted content).</li>
	</ol>
	<p>One of the key “acceptance tests” we think about when thinking about geolocating users is the “local pizza test”: with location services disabled, are the results returned for the search term “pizza near me” geographically relevant? Because of the geography preserving and IP address management systems we operate, they are!</p>
	<p>At a high-level, here’s how it works:</p>
	<ul>
		<li>Apple relays geolocate user IP addresses and translate them into a “<a href="https://en.wikipedia.org/wiki/Geohash" target="_blank">geohash</a>”. Geohashes are compact representations of latitude and longitude. The system includes protections to ensure geohashes cannot be spoofed by clients, and operates with reduced precision to ensure user privacy is maintained. Apple relays do not send user IP addresses onward.</li>
		<li>Cloudflare relays maintain a pool of IP addresses for exclusive use by Private Relay. These IP addresses have been registered with geolocation database providers to correspond to specific cities around the world. When a Private Relay user connects and presents the previously determined geohash, the closest matching IP address is selected.</li>
		<li>Servers see an IP address that corresponds to the original user IP address’s location, without obtaining information that may be used to identify the specific user.</li>
	</ul>
	<p>In most parts of the world, Private Relay supports geolocation to the nearest city by default. If users prefer to be located at more coarse location granularity, the option to locate based on country and timezone is available in Private Relay settings.</p>
	<p>If your website relies on geolocation of client IP addresses to power or modify user experiences, <strong>please ensure your geolocation database is kept up to date</strong>. Apple and Cloudflare work directly with every major IP to geolocation provider to ensure they have an accurate mapping of Private Relay egress IP addresses (which present to your server as the client IP address) to geography. These mappings may change from time to time. Using the most up-to-date version of your provider’s database will ensure the most accurate geolocation results for all users, including those using Private Relay.</p>
	<p>In addition to making sure your geolocation databases are up-to-date, even greater location accuracy and precision can be obtained by ensuring your origin is reachable via IPv6. Private Relay egress nodes prefer IPv6 whenever AAAA DNS records are available, and use IPv6 egress IP addresses that are geolocated with greater precision than their IPv4 equivalents. This means you can geolocate users to more specific locations (without compromising user privacy) and deliver more relevant content to users as a result.</p>
	<p><strong>If you’re a website operator using Cloudflare to protect and accelerate your site, no action is needed from you</strong>. Our geolocation feeds used to enrich client requests with location metadata are kept up-to-date and include the information needed to geolocate users using iCloud Private Relay.</p>
	<h3 id="delivering-high-performance-user-experiences">Delivering high performance user experiences</h3>
	<p>One of the more counterintuitive things about performance on the Internet is that adding intermediate network “hops” between a user and a server can often <em><strong>speed up</strong></em> overall network performance, rather than slow it down, if those intermediate hops are well-connected and tuned for speed.</p>
	<p>The networks that power iCloud Private Relay are exceptionally well-connected to other networks around the world, and we spend <a href="https://blog.cloudflare.com/tag/network-performance-update">considerable effort</a> squeezing every last ounce of performance out of our systems every day. We even have automated systems, like <a href="https://blog.cloudflare.com/argo">Argo Smart Routing</a>, that take data on how the Internet is performing and find the best paths across it to ensure consistent performance even in the face of Internet congestion and other “weather”.</p>
	<p>Using Private Relay to reach websites instead of going directly to the origin server can result in significant, <strong>measured decreases in page load time for clients using Private Relay vs those that are not</strong>. That’s pretty neat: increased privacy does <strong>not</strong> come at the price of reduced page load and render performance when using Private Relay.</p>
	<h3 id="limiting-reliance-on-ip-addresses-in-fraud-and-bot-management-systems">Limiting reliance on IP addresses in fraud and bot management systems</h3>
	<p>To ensure that iCloud Private Relay users have good experiences interacting with your website, you should ensure that any systems that rely on IP address as a signal or way of indexing users properly accommodate many users originating from one or a handful of addresses.</p>
	<p>Private Relay’s concentration of users behind a given IP address is similar to commonly deployed enterprise web gateways or carrier grade network address translation (CG-NAT) systems.</p>
	<p>As explained in Apple <a href="https://www.apple.com/privacy/docs/iCloud_Private_Relay_Overview_Dec2021.PDF" target="_blank">technical documentation</a>, “Private Relay is designed to ensure only valid Apple devices and accounts in good standing are allowed to use the service. Websites that use IP addresses to enforce fraud prevention and anti-abuse measures can trust that connections through Private Relay have been validated at the account and device level by Apple.” Because of these advanced device and user authorization steps, you might consider allowlisting Private Relay IP addresses explicitly. Should you wish to do so, Private Relay’s egress IP addresses are available in <a href="https://mask-api.icloud.com/egress-ip-ranges.csv" target="_blank">CSV form here</a>.</p>
	<p>If you as a server operator are interested in managing traffic from users using systems like iCloud Private Relay or similar NAT infrastructure, consider constructing rules using user level identifiers like cookies, and other metadata present including geography.</p>
	<p>For Cloudflare customers, our rate limiting and bot management capabilities are well suited to handle traffic from systems like Private Relay. Cloudflare <a href="https://blog.cloudflare.com/multi-user-ip-address-detection">automatically detects</a> when IP addresses are likely to be used by multiple users, tuning our machine learning and other security heuristics accordingly. Additionally, our WAF <a href="https://developers.cloudflare.com/waf/custom-rules/rate-limiting/parameters" target="_blank">includes functionality</a> specifically designed to manage traffic originating from shared IP addresses.</p>
	<h3 id="understanding-traffic-flows">Understanding traffic flows</h3>
	<p>As discussed above, IP addresses used by iCloud Private Relay are specific to the service. However, network and server operators (including Cloudflare customers) studying their traffic and logs may notice large amounts of user traffic arriving from Cloudflare’s network, AS13335. These traffic flows originating from AS13335 include forward proxied traffic from iCloud Private Relay, our enterprise web gateway products, and other products including WARP, our consumer VPN.</p>
	<p>In the case of Cloudflare customers, traffic traversing our network to reach your Cloudflare proxied property is included in all usage and billing metrics as traffic from any Internet user would be.</p>
	<h2 id="i-operate-a-corporate-or-school-network-and-i-d-like-to-know-more-about-icloud-private-relay">I operate a corporate or school network and I’d like to know more about iCloud Private Relay</h2>
	<p>CIOs and network administrators may have questions about how iCloud Private Relay interacts with their corporate networks, and how they might be able to use similar technologies to make their networks more secure. Apple's document, “<a href="https://developer.apple.com/support/prepare-your-network-for-icloud-private-relay" target="_blank">Prepare Your Network or Web Server for iCloud Private Relay</a>” covers network operator scenarios in detail.</p>
	<p>Most <a href="https://www.cloudflare.com/learning/network-layer/enterprise-networking" target="_blank">enterprise networks</a> will not have to do anything to support Private Relay traffic. If the end-to-end encrypted nature of the system creates compliance challenges, local networks can block the use of Private Relay for devices connected to them.</p>
	<p>Corporate customers of Cloudflare One services can put in place the name resolution blocks needed to disable Private Relay through their DNS filtering dashboard. Cloudflare One, Cloudflare’s <a href="https://www.cloudflare.com/network-security" target="_blank">corporate network security suite</a>, includes Gateway, built on the same network and codebase that powers iCloud Private Relay.</p>
	<h2 id="icloud-private-relay-makes-browsing-the-internet-more-private-and-secure">iCloud Private Relay makes browsing the Internet more private and secure</h2>
	<p>iCloud Private Relay is an exciting step forward in preserving user privacy on the Internet, without forcing compromises in performance.</p>
	<p>If you’re an iCloud+ subscriber you can <a href="https://support.apple.com/guide/icloud/set-up-icloud-private-relay-mm7dc25cb68f/icloud#:~:text=On%20your%20iPhone%2C%20iPad%2C%20or%20iPod%20touch%2C%20go%20to,or%20cellular%20plan%20(SIM)." target="_blank">enable Private Relay in iCloud Settings</a> on your iPhone, iPad, or Mac on iOS15, iPadOS15, or macOS Monterey.</p>
</div>