<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/12/image2-4.png" class="kg-image" alt="Improving DNS Privacy with Oblivious DoH in 1.1.1.1"></figure>
	<p>Today we are announcing support for a new proposed DNS standard — co-authored by engineers from Cloudflare, Apple, and Fastly — that separates IP addresses from queries, so that no single entity can see both at the same time. Even better, we’ve made source code available, so anyone can try out ODoH, or run their own ODoH service!</p>
	<p>But first, a bit of context. The Domain Name System (DNS) is the foundation of a human-usable Internet. It maps usable domain names, such as cloudflare.com, to IP addresses and other information needed to connect to that domain. A quick primer about the importance and issues with DNS can be read in a previous <a href="https://blog.cloudflare.com/announcing-1111/">blog post</a>. For this post, it’s enough to know that, in the initial design and still dominant usage of DNS, queries are sent in cleartext. This means anyone on the network path between your device and the DNS resolver can see both the query that contains the hostname (or website) you want, as well as the IP address that identifies your device.</p>
	<p>To safeguard DNS from onlookers and third parties, the IETF standardized DNS encryption with DNS over HTTPS (DoH) and DNS over TLS (DoT). Both protocols prevent queries from being intercepted, redirected, or modified between the client and resolver. Client support for DoT and DoH is growing, having been implemented in recent versions of Firefox, iOS, and more. Even so, until there is wider deployment among Internet service providers, Cloudflare is one of only a few providers to offer a public DoH/DoT service. This has raised two main concerns. One concern is that the centralization of DNS introduces single points of failure (although, with data centers in more than 100 countries, Cloudflare is designed to always be reachable). The other concern is that the resolver can still link all queries to client IP addresses.</p>
	<p>Cloudflare is committed to end-user privacy. Users of our public DNS resolver service are protected by a <a href="https://blog.cloudflare.com/announcing-the-results-of-the-1-1-1-1-public-dns-resolver-privacy-examination/">strong, audited privacy policy</a>. However, for some, trusting Cloudflare with sensitive query information is a barrier to adoption, even with such a strong privacy policy. Instead of relying on privacy policies and audits, what if we could give users an option to remove that bar with technical guarantees?</p>
	<p>Today, Cloudflare and partners are launching support for a protocol that does exactly that: Oblivious DNS over HTTPS, or ODoH for short.</p>
	<h3 id="odoh-partners-">ODoH Partners:</h3>
	<p>We're excited to launch ODoH with several leading launch partners who are equally committed to privacy.</p>
	<p>A key component of ODoH is a proxy that is disjoint from the target resolver. Today, we’re launching ODoH with several leading proxy partners, including: PCCW, SURF, and Equinix.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/12/image3-8.png" class="kg-image"></figure>
	<blockquote>“ODoH is a revolutionary new concept designed to keep users' privacy at the center of everything. Our ODoH partnership with Cloudflare positions us well in the privacy and "Infrastructure of the Internet" space. As well as the enhanced security and performance of the underlying PCCW Global network, which can be accessed on-demand via Console Connect, the performance of the proxies on our network are now improved by Cloudflare’s 1.1.1.1 resolvers. This model for the first time completely decouples client proxy from the resolvers. This partnership strengthens our existing focus on privacy as the world moves to a more remote model and privacy becomes an even more critical feature.” -- <strong>Michael Glynn, Vice President, Digital Automated Innovation, PCCW Global</strong><br></blockquote>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/12/image8-1.png" class="kg-image"></figure>
	<blockquote>“We are partnering with Cloudflare to implement better user privacy via ODoH. The move to ODoH is a true paradigm shift, where the users’ privacy or the IP address is not exposed to any provider, resulting in true privacy. With the launch of ODoH-pilot, we’re joining the power of Cloudflare’s network to meet the challenges of any users around the globe. The move to ODoH is not only a paradigm shift but it emphasizes how privacy is important to any users than ever, especially during 2020. It resonates with our core focus and belief around Privacy.” — <strong>Joost van Dijk, Technical Product Manager, SURF</strong><br></blockquote>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/12/image9.png" class="kg-image"></figure>
	<h3 id="how-does-oblivious-dns-over-https-odoh-work">How does Oblivious DNS over HTTPS (ODoH) work?</h3>
	<p>ODoH is an emerging protocol being developed at the <a href="https://tools.ietf.org/html/draft-pauly-dprive-oblivious-doh-03" target="_blank">IETF</a>. ODoH works by adding a layer of public key encryption, as well as a network proxy between clients and DoH servers such as 1.1.1.1. The combination of these two added elements guarantees that only the user has access to both the DNS messages and their own IP address at the same time. </p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/12/image6-2.png" class="kg-image"></figure>
	<p>There are three players in the ODoH path. Looking at the figure above, let’s begin with the target. <strong>The target</strong> decrypts queries encrypted by the client, via a proxy. Similarly, the target encrypts responses and returns them to the proxy. The standard says that the target may or may not be the resolver (we’ll touch on this later). <strong>The proxy</strong> does as a proxy is supposed to do, in that it forwards messages between client and target. <strong>The client</strong> behaves as it does in DNS and DoH, but differs by encrypting queries for the target, and decrypting the target’s responses. Any client that chooses to do so can specify a proxy and target of choice.</p>
	<p>Together, the added encryption and proxying provide the following guarantees:</p>
	<ol>
		<li>The target sees only the query and the proxy’s IP address.</li>
		<li>The proxy has no visibility into the DNS messages, with no ability to identify, read, or modify either the query being sent by the client or the answer being returned by the target.</li>
		<li>Only the intended target can read the content of the query and produce a response.</li>
	</ol>
	<p>These three guarantees improve client privacy while maintaining the security and integrity of DNS queries. However, each of these guarantees relies on one fundamental property — that <strong>the proxy and the target servers do not collude</strong>. So long as there is no collusion, an attacker succeeds only if both the proxy and target are compromised.</p>
	<p>One aspect of this system worth highlighting is that the target is separate from the upstream recursive resolver that performs DNS resolution. In practice, for performance, we expect the target to be the same. In fact, 1.1.1.1 is now both a recursive resolver and a target! There is no reason that a target needs to exist separately from any resolver. If they are separated then the target is free to choose resolvers, and just act as a go-between. The only real requirement, remember, is that the proxy and target never collude.</p>
	<p>Also, importantly, clients are in complete control of proxy and target selection. Without any need for <a href="https://wiki.mozilla.org/Trusted_Recursive_Resolver" target="_blank">TRR</a>-like programs, clients can have privacy for their queries, in addition to security. Since the target only knows about the proxy, the target and any upstream resolver are oblivious to the existence of any client IP addresses. Importantly, this puts clients in greater control over their queries and the ways they might be used. For example, clients could select and alter their proxies and targets any time, for any reason!</p>
	<h3 id="odoh-message-flow">ODoH Message Flow</h3>
	<p>In ODoH, the ‘O’ stands for oblivious, and this property comes from the level of encryption of the DNS messages themselves. This added encryption is `end-to-end` between client and target, and independent from the connection-level encryption provided by TLS/HTTPS. One might ask why this additional encryption is required at all in the presence of a proxy. This is because two separate TLS connections are required to support proxy functionality. Specifically, the proxy terminates a TLS connection from the client, and initiates another TLS connection to the target. Between those two connections, the DNS message contexts would otherwise appear in plaintext! For this reason, ODoH additionally encrypts messages between client and target so the proxy has no access to the message contents.</p>
	<p>The whole process begins with clients that encrypt their query for the target using <a href="https://tools.ietf.org/html/draft-irtf-cfrg-hpke-06" target="_blank">HPKE</a>. Clients obtain the target’s public key via DNS, where it is bundled into a <a href="https://tools.ietf.org/html/draft-ietf-dnsop-svcb-https-02" target="_blank">HTTPS resource record</a> and protected by DNSSEC. When the TTL for this key expires, clients request a new copy of the key as needed (just as they would for an A/AAAA record when that record’s TTL expires). The usage of a target’s DNSSEC-validated public key guarantees that only the intended target can decrypt the query and encrypt a response (answer).</p>
	<p>Clients transmit these encrypted queries to a proxy over an HTTPS connection. Upon receipt, the proxy forwards the query to the designated target. The target then decrypts the query, produces a response by sending the query to a recursive resolver such as 1.1.1.1, and then encrypts the response to the client. The encrypted query from the client contains encapsulated keying material from which targets derive the response encryption symmetric key.</p>
	<p>This response is then sent back to the proxy, and then subsequently forwarded to the client. All communication is authenticated and confidential since these DNS messages are end-to-end encrypted, despite being transmitted over two separate HTTPS connections (client-proxy and proxy-target). The message that otherwise appears to the proxy as plaintext is actually an encrypted garble.</p>
	<h3 id="what-about-performance-do-i-have-to-trade-performance-to-get-privacy">What about Performance? Do I have to trade performance to get privacy?</h3>
	<p>We’ve been doing lots of measurements to find out, and will be doing more as ODoH deploys more widely. Our initial set of measurement configurations spanned cities in the USA, Canada, and Brazil. Importantly, our measurements include not just 1.1.1.1, but also 8.8.8.8 and 9.9.9.9. The full set of measurements, so far, is documented for <a href="https://arxiv.org/abs/2011.10121" target="_blank">open access</a>.</p>
	<p>In those measurements, it was important to isolate the cost of proxying and additional encryption from the cost of TCP and TLS connection setup. This is because the TLS and TCP costs are incurred by DoH, anyway. So, in our setup, we ‘primed’ measurements by establishing connections once and reusing that connection for all measurements. We did this for both DoH and for ODoH, since the same strategy could be used in either case.</p>
	<p>The first thing that we can say with confidence is that the additional encryption is marginal. We know this because we randomly selected 10,000 domains from the <a href="https://arxiv.org/abs/1806.01156" target="_blank">Tranco million dataset</a> and measured both encryption of the A record with a different public key, as well as its decryption. The additional cost between a proxied DoH query/response and its ODoH counterpart is consistently less than 1ms at the 99th percentile.</p>
	<p>The ODoH request-response pipeline, however, is much more than just encryption. A very useful way of looking at measurements is by looking at the cumulative distribution chart — if you’re familiar with these kinds of charts, skip to the next paragraph. In contrast to most charts where we start along the x-axis, with cumulative distributions we often start with the y-axis.</p>
	<p>The chart below shows the cumulative distributions for query/response times in DoH, ODoH, and DoH when transmitted over the Tor Network. The dashed horizontal line that starts on the left from 0.5 is the 50% mark. Along this horizontal line, for any plotted curve, the part of the curve below the dashed line is 50% of the data points. Now look at the x-axis, which is a measure of time. The lines that appear to the left are faster than lines to the right. One last important detail is that the x-axis is plotted on a logarithmic scale. What does this mean? Notice that the distance between the labeled markers (10x) is equal in cumulative distributions but the ‘x’ is an exponent, and represents orders of magnitude. So, while the time difference between the first two markers is 9ms, the difference between the 3rd and 4th markers is 900ms.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/12/image7-1.png" class="kg-image"></figure>
	<p>In this chart, the middle curve represents ODoH measurements. We also measured the performance of privacy-preserving alternatives, for example, DoH queries transmitted over the Tor network as represented by the right curve in the chart. (Additional privacy-preserving alternatives are captured in the open access <a href="https://arxiv.org/abs/2011.10121" target="_blank">technical report</a>.) Compared to other privacy-oriented DNS variants, ODoH cuts query time in half, or better. This point is important since privacy and performance rarely play nicely together, so seeing this kind of improvement is encouraging!</p>
	<p>The chart above also tells us that 50% of the time ODoH queries are resolved in fewer than 228ms. Now compare the middle line to the left line that represents ‘straight-line’ (or normal) DoH without any modification. That left plotline says that 50% of the time, DoH queries are resolved in fewer than 146ms. Looking below the 50% mark, the curves also tell us that ½ the time that difference is never greater than 100ms. On the other side, looking at the curves above the 50% mark tells us that ½ ODoH queries are competitive with DoH.</p>
	<p>Those curves also hide a lot of information, so it is important to delve further into the measurements. The chart below has three different cumulative distribution curves that describe ODoH performance if we select proxies and targets by their latency. This is also an example of the insights that measurements can reveal, some of which are counterintuitive. For example, looking above 0.5, these curves say that ½ of ODoH query/response times are virtually indistinguishable, no matter the choice of proxy and target. Now shift attention below 0.5 and compare the two solid curves against the dashed curve that represents overall average. This region suggests that selecting the lowest-latency proxy and target offers minimal improvement over the average but, most importantly, it shows that selecting the lowest-latency proxy leads to worse performance!</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/12/image4-3.png" class="kg-image"></figure>
	<p>Open questions remain, of course. This first set of measurements were executed largely in North America. Does performance change at a global level? How does this affect client performance, in practice? We’re working on finding out, and this release will help us to do that.</p>
	<h3 id="interesting-can-i-experiment-with-odoh-is-there-an-open-odoh-service">Interesting! Can I experiment with ODoH? Is there an open ODoH service?</h3>
	<p>Yes, and yes! We have open sourced our interoperable ODoH implementations in Rust, <a href="https://github.com/cloudflare/odoh-rs/" target="_blank">odoh-rs</a> and Go, <a href="https://github.com/cloudflare/odoh-go/" target="_blank">odoh-go</a>, as well as integrated the target into the Cloudflare DNS Resolver. That’s right, 1.1.1.1 is ready to receive queries via ODoH.</p>
	<p>We have also open sourced test clients in Rust, <a href="https://github.com/cloudflare/odoh-client-rs/" target="_blank">odoh-client-rs</a>, and Go, <a href="https://github.com/cloudflare/odoh-client-go/" target="_blank">odoh-client-go</a>, to demo ODoH queries. You can also check out the HPKE configuration used by ODoH for message encryption to 1.1.1.1 by querying the service directly:</p>
	<!--kg-card-begin: markdown-->
	<pre><code>$ dig -t type65 +dnssec @ns1.cloudflare.com odoh.cloudflare-dns.com 

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; -t type65 +dnssec @ns1.cloudflare.com odoh.cloudflare-dns.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 19923
;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 1232
;; QUESTION SECTION:
;odoh.cloudflare-dns.com.	IN	TYPE65

;; ANSWER SECTION:
odoh.cloudflare-dns.com. 300	IN	TYPE65	\# 108 00010000010003026832000400086810F8F96810F9F9000600202606 470000000000000000006810F8F92606470000000000000000006810 F9F98001002E002CFF0200280020000100010020ED82DBE32CCDE189 BC6C643A80B5FAFF82548D21601C613408BACAAE6467B30A
odoh.cloudflare-dns.com. 300	IN	RRSIG	TYPE65 13 3 300 20201119163629 20201117143629 34505 odoh.cloudflare-dns.com. yny5+ApxPSO6Q4aegv09ZnBmPiXxDEnX5Xv21TAchxbxt1VhqlHpb5Oc 8yQPNGXb0fb+NyibmHlvTXjphYjcPA==

;; Query time: 21 msec
;; SERVER: 173.245.58.100#53(173.245.58.100)
;; WHEN: Wed Nov 18 07:36:29 PST 2020
;; MSG SIZE  rcvd: 291
</code></pre>
	<!--kg-card-end: markdown-->
	<p>We are working to add ODoH to existing stub resolvers such as <a href="https://github.com/cloudflare/cloudflared" target="_blank">cloudflared</a>. If you're interested in adding support to a client, or if you encounter bugs with the implementations, please drop us a line at [email protected]! Announcements about the ODoH specification and server will be sent to the <a href="https://datatracker.ietf.org/wg/dprive/about/" target="_blank">IETF DPRIVE</a> <a href="https://mailarchive.ietf.org/arch/browse/dns-privacy/" target="_blank">mailing list</a>. You can subscribe and follow announcements and discussion about the specification <a href="https://www.ietf.org/mailman/listinfo/dns-privacy" target="_blank">here</a>.</p>
	<p>We are committed to moving it forward in the IETF and are already seeing interest from client vendors. Eric Rescorla, CTO of Firefox, says,</p>
	<blockquote>Oblivious DoH is a great addition to the secure DNS ecosystem. We're excited to see it starting to take off and are looking forward to experimenting with it in Firefox.</blockquote>
	<p>We hope that more operators join us along the way and provide support for the protocol, by running either proxies or targets, and we hope client support will increase as the available infrastructure increases, too.</p>
	<p>The ODoH protocol is a practical approach for improving privacy of users, and aims to improve the overall adoption of encrypted DNS protocols without compromising performance and user experience on the Internet.</p>
	<h3 id="acknowledgements">Acknowledgements</h3>
	<p><a href="https://blog.cloudflare.com/author/marek/">Marek Vavruša</a> and <a href="https://blog.cloudflare.com/author/anbang/">Anbang Wen</a> were instrumental in getting the 1.1.1.1 resolver to support ODoH. Chris Wood and <a href="https://blog.cloudflare.com/author/peter-wu/">Peter Wu</a> helped get the ODoH libraries ready and tested. The <a href="https://tools.ietf.org/html/draft-pauly-dprive-oblivious-doh-03" target="_blank">IETF draft for ODoH</a> is authored by Eric Kinnear, Patrick McManus, Tommy Pauly and Christopher Wood. ODoH itself took inspiration from "<a href="https://odns.cs.princeton.edu/pdf/pets.pdf" target="_blank">Oblivious DNS: Practical Privacy for DNS Queries</a>", the work of Schmitt et al. published in PoPETs 2019.</p>
</div>