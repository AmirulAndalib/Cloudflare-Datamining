<div class="mb2 gray5">5 min read</div>
<div class="post-content lh-copy gray1">
	<!--kg-card-begin: markdown-->
	<p><small>This post is also available in <a href="https://blog.cloudflare.com/es-es/introducing-http-traffic-anomalies-notifications-es-es">Español</a>.</small></p>
	<!--kg-card-end: markdown-->
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/10/Traffic-anomalies-1.png" class="kg-image" alt="Introducing notifications for HTTP Traffic Anomalies" loading="lazy" width="2401" height="1350"></figure>
	<p>When it comes to managing Internet properties, the difference between a small technical hiccup and major incident is often a matter of speed. Proactive alerting plays a crucial role, which is why we were excited when we released <a href="https://blog.cloudflare.com/smarter-origin-service-level-monitoring">HTTP Error Rate notifications</a> — giving administrators visibility into when end users are experiencing errors. </p>
	<p>But what if there are issues that don't show up as errors, like a sudden drop in traffic, or a spike? </p>
	<p>Today, we're excited to announce Traffic Anomalies notifications, available to enterprise customers. These notifications trigger when Cloudflare detects unexpected changes in traffic, giving another valuable perspective into the health of your systems.</p>
	<p>Unexpected changes in traffic could be indicative of many things. If you run an ecommerce site and see a spike in traffic that could be great news — maybe customers are flocking to your sale, or you just had an ad run on a popular TV show. However, it could also mean that something is going wrong: maybe someone accidentally turned off a firewall rule, and now you’re seeing more malicious traffic. Either way, you might want to know that something has changed. </p>
	<p>Similarly, a sudden drop in traffic could mean many things. Perhaps it’s Friday afternoon and all of your employees are signing off and no longer accessing your company website. Or maybe a link to your site is broken, and now potential customers aren’t able to access it. You could be losing potential revenue every minute that traffic is low, so you’d want to know as soon as possible to investigate.</p>
	<h3 id="how-can-we-tell-when-to-alert">How can we tell when to alert? </h3>
	<p>Calculating anomalies in time series datasets is difficult to do well. The simplest way to do it is to use basic thresholds. However, as we’ve <a href="https://blog.cloudflare.com/smarter-origin-service-level-monitoring">previously blogged about</a>, simple thresholds aren’t very accurate when trying to determine when things are actually going wrong. There are too many edge cases for them to work effectively. </p>
	<p>Calculating anomalies in HTTP errors is relatively easy. We know that in general there should be a very low number of errors, so any spike is bad and therefore alertable. That’s why we use <a href="https://sre.google/workbook/alerting-on-slos" target="_blank">Service Level Objectives (SLOs)</a> to calculate anomalies for our <a href="https://developers.cloudflare.com/notifications/notification-available/#traffic-monitoring" target="_blank">HTTP Error Rate notifications</a>. </p>
	<p>However, analyzing overall HTTP traffic behaves more similarly to <a href="https://blog.cloudflare.com/introducing-thresholds-in-security-event-alerting-a-z-score-love-story">Cloudflare Security Events</a>: there’s some general baseline of events that is computed from historical trends. Any deviation from that baseline is alertable. Because of those similarities, we decided to use the same calculations for Traffic Anomalies notifications as we have previously used for Security Event notifications: <a href="https://blog.cloudflare.com/get-notified-when-your-site-is-under-attack">z-scores</a>. This involves comparing the current value to the average over a period of time. However, many standard deviations away from the average the current value is, is the z-score. </p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image4-6.png" class="kg-image" alt="" loading="lazy" width="1292" height="898">
		<figcaption><em>Plot of HTTP traffic against z-scores. The blue is the HTTP traffic, purple is the positive z-score bound of the traffic, and green is the negative z-score bound of the traffic</em></figcaption>
	</figure>
	<p>For Traffic Anomalies notifications, we’re comparing the traffic over the past 5 minutes (the short window) to the average of the traffic over the past 4 hours (the long window). Positive z-scores indicate a spike, and negative z-scores indicate a drop. If the current value is more than 3.5 standard deviations away from the average, we alert. We measure every 5 minutes, so we can alert on any traffic spike or drop in a timely fashion.</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image2-9.png" class="kg-image" alt="" loading="lazy" width="1375" height="125">
		<figcaption><em>Green bucket is the long window and the red bucket is the short window</em></figcaption>
	</figure>
	<p>While our Security Event notifications only trigger when there is a spike in security events (a drop is almost always a good thing), in the case of Traffic Anomalies we send notifications for both spikes <em>and</em> drops. This is because a drop of HTTP traffic is likely indicative of a problem, and a surge could be good or bad. </p>
	<p>As with Security Events, Traffic Anomalies notifications support <a href="https://blog.cloudflare.com/introducing-thresholds-in-security-event-alerting-a-z-score-love-story">minimum thresholds</a>. This means that, even if we determine that an event is outside 3.5 standard deviations, if the number of events is insignificant, we don’t alert. A spike must be at least 200 requests, and a drop must fall by at least 200 requests. This makes the notifications less noisy, since we aren’t alerting on small spikes and drops. </p>
	<h3 id="digging-a-little-deeper">Digging a little deeper</h3>
	<p>Cloudflare stores sampled statistics on requests that go through its network <a href="https://blog.cloudflare.com/http-analytics-for-6m-requests-per-second-using-clickhouse">in Clickhouse</a>. Every minute, we take HTTP traffic from Clickhouse and store it in an instance of VictoriaMetrics, a time-series data storage solution. VictoriaMetrics gives us out-of-the-box algorithmic functions for free, and it has been a good fit for our use case. We chose VictoriaMetrics for a few reasons.</p>
	<p>Firstly, it's easy to configure and operate. As a team, we want to optimize for low operational burden and VictoriaMetrics has been great thus far. Secondly, VictoriaMetrics has the ability to scale horizontally, meaning we can run it in a highly available mode. For a system such as this where we want something reliable to compute time sensitive information for our customers, the high availability requirement is essential. Finally, in our tests, we found that VictoriaMetrics used around ⅓ of the memory that Prometheus, a similar alternative product, did for the same use case. </p>
	<p>Once we have data in VictoriaMetrics, we can run queries against it and determine whether we need to alert our customers or not, based on notification configurations they have created ahead of time. To do this we leverage our existing Alert Notification System, <a href="https://blog.cloudflare.com/new-tools-to-monitor-your-server-and-avoid-downtime">which we blogged about initially in 2019</a>. We know we can count on our current notification system for the last mile to deliver these critical notifications to our customers.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image1-9.png" class="kg-image" alt="" loading="lazy" width="1999" height="387">
		<figcaption><em>Data flow from HTTP request to notification</em></figcaption>
	</figure>
	<h6 id="setting-up-the-notification"><em>Setting up the Notification </em></h6>
	<p>To configure this notification, navigate to the “Notifications” tab of the dashboard. Select Traffic Anomalies as your notification type. As with all Cloudflare notifications, you’re able to name and describe your notification, and choose how you want to be notified. </p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image5-3.png" class="kg-image" alt="" loading="lazy" width="1999" height="482">
		<figcaption><em>Traffic Anomalies notification in the Dashboard</em></figcaption>
	</figure>
	<p>You can choose which domains you want monitored for Traffic Anomalies, whether you want to include traffic that’s already been mitigated by Cloudflare DoS or WAF products, and whether there are specific status codes you want included or excluded. You can also choose whether you want to be alerted on traffic spikes, drops, or both. </p>
	<p>We’re excited to use this system to help serve our Enterprise customers with invaluable notifications regarding the overall health of their systems. Head over to the Notifications tab in the dash to check this new notification out now!</p>
</div>