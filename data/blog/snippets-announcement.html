<div class="post-content lh-copy gray1">
	<!--kg-card-begin: markdown-->
	<p><em><small>This post is also available in <a href="https://blog.cloudflare.com/zh-cn/snippets-announcement-zh-cn/">简体中文</a>, <a href="https://blog.cloudflare.com/zh-tw/snippets-announcement-zh-tw/">繁體中文</a>, <a href="https://blog.cloudflare.com/ja-jp/snippets-announcement-ja-jp/">日本語</a>, <a href="https://blog.cloudflare.com/de-de/snippets-announcement-de-de/">Deutsch</a>, <a href="https://blog.cloudflare.com/fr-fr/snippets-announcement-fr-fr/">Français</a>, <a href="https://blog.cloudflare.com/es-es/snippets-announcement-es-es/">Español</a> and <a href="https://blog.cloudflare.com/pt-br/snippets-announcement-pt-br/">Português</a>.</small></em></p>
	<!--kg-card-end: markdown-->
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/11/image3-28.png" class="kg-image" alt="The most programmable Supercloud with Cloudflare Snippets" loading="lazy"></figure>
	<h2 id="your-traffic-how-you-like-it">Your traffic, how you like it</h2>
	<p>Cloudflare is used by a highly diverse customer base. We offer simple-to-use products for everything from setting HTTP headers to rewriting the URI path and performing URL redirects. Sometimes customers need more than the out-of-the-box functionality, not just adding an HTTP header - but performing some advanced calculation to create the output. Today they would need to create a feature request and wait for it to be shipped, write a <a href="https://workers.cloudflare.com/?ref=blog.cloudflare.com" target="_blank">Cloudflare Worker</a>, or keep this modification ‘on origin’ - on their own infrastructure.</p>
	<p>To simplify this, we are delighted to announce Cloudflare Snippets. Snippets are a new way to perform traffic modifications that users either cannot do via our productised offerings, or want to do programmatically. The best part? The vast majority of customers will pay<em> nothing extra</em> for using Snippets.</p>
	<p>Users now have a choice. Perform the action via a rule. Or, if more functionality is needed, write a Snippet. &nbsp;Neither will mean waiting. Neither will incur additional cost (although a high fair usage cap will apply). Snippets unblocks users to do what they want, when they want. All on Cloudflare.</p>
	<p>Snippets will support the import of code written in various languages, such as JavaScript (modern), VCL (legacy) and Apache .htaccess files (legacy). This allows customers to migrate legacy operational code onto our platform - whilst also consolidating their JavaScript operations.</p>
	<p>Please use the sign-up form to join the waitlist for Snippets if you are interested in testing. We hope to begin admitting users into the closed beta early 2023.</p>
	<h2 id="why-build-snippets">Why build Snippets?</h2>
	<p>Over the past 18 months we have released a number of new rules products such as <a href="https://blog.cloudflare.com/introducing-transform-rules-with-url-rewriting-at-the-edge/">Transform Rules,</a> <a href="https://blog.cloudflare.com/introducing-cache-rules/">Cache Rules</a>, <a href="https://blog.cloudflare.com/origin-rules/">Origin Rules</a>, <a href="https://blog.cloudflare.com/configuration-rules/">Config Rules</a> and <a href="https://blog.cloudflare.com/dynamic-redirect-rules/">Redirect Rules</a>. These new products give more control to customers on how we process their traffic as it flows through our global network. The feedback on these products so far has been overwhelmingly positive. However, our customers still occasionally need the ability to do more than the out-of-the-box functionality allows.</p>
	<p>There are always some use cases where a product doesn’t provide the functionality that a customer needs for their specific situation. &nbsp;For example, whilst thousands of our customers are now using Transform Rules to solve their HTTP header modification use cases, there remains a small number of use cases that are not possible, such as setting dynamic expiry times with cookies or hashing tokens with a key.</p>
	<p>This is where Cloudflare Snippets help. Customers will no longer need to use the full Cloudflare Workers platform to implement these relatively simple use cases. Nor will they need to wait for us to build their feature requests. Instead, they will be able to run a Snippet of JavaScript.</p>
	<h2 id="migrating-legacy-code-to-snippets">Migrating legacy code to Snippets</h2>
	<p><a href="https://varnish-cache.org/docs/trunk/users-guide/vcl.html?ref=blog.cloudflare.com" target="_blank">Varnish Control Language</a> (VCL) is only used within the context of Varnish. Launched around 16 years ago, it has historically been used to configure traffic and routing for Content Delivery Networks as it was extensible to a wide range of use cases.</p>
	<p>There are still a good number of businesses out there using VCL to perform routing and traffic modification actions. Whilst other providers are deprecating support for VCL, we want to make sure those of you comfortable using it are still supported.</p>
	<p>Snippets won't run pure VCL. Instead, we will convert VCL into easy to maintain rules or Snippets. To achieve this we’re building a simple-to-use, self-serve VCL converter that analyzes uploaded VCL code and auto-generates suggested Snippets, and if we can find a match, also generates suggested rules for products such as Transform Rules or Cache Rules.</p>
	<p>This topic was initially handled via <a href="https://blog.cloudflare.com/announcing-turpentine/">Project Turpentine</a>, a suite of tools used by Cloudflare employees to parse a customer’s VCL into a suggested JavaScript configuration. This JavaScript could then be loaded into a Worker, or series of Workers.</p>
	<p>Snippets takes the idea and principles of Turpentine further. Much further. By building a parser directly in the dashboard it puts the power directly into the hands of users and gives them a choice. You can tell us to migrate everything we can into Rules with the remaining code migrated into Snippets, or, you can choose to tell us to migrate everything into discrete Snippets. It's your call.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/11/image1-55.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>We’ll give Apache <a href="https://developer.mozilla.org/en-US/docs/Learn/Server-side/Apache_Configuration_htaccess?ref=blog.cloudflare.com" target="_blank">htaccess</a> and NGINX <a href="https://www.nginx.com/resources/wiki/start/topics/examples/full/?ref=blog.cloudflare.com" target="_blank">configuration files</a> the same treatment. The goal being users simply upload the files from their websites Apache or NGINX configuration, and we generate suggested Snippets and/or rules.</p>
	<p>The days of having to use legacy code for operational tasks are coming to an end. Snippets allow users to migrate these workloads to Cloudflare, and let them focus on the bigger problems of the business vs maintaining legacy systems.</p>
	<h2 id="the-difference-between-snippets-and-workers">The difference between Snippets and Workers</h2>
	<p>Most readers will already be familiar with Cloudflare Workers, our powerful developer platform which allows businesses to run and build entire products and solutions on Cloudflare's global network. Snippets is also built on this platform, but has a few key differences.</p>
	<p>The first major difference is that a Snippet will run as part of the <a href="https://developers.cloudflare.com/ruleset-engine/?ref=blog.cloudflare.com" target="_blank">Ruleset Engine</a> as dedicated new <em>phases</em>, similar to Transform Rules and Cache Rules. Customers will be able to select and execute a Snippet based on any <a href="https://developers.cloudflare.com/ruleset-engine/rules-language/fields?ref=blog.cloudflare.com" target="_blank">ruleset engine filter</a>. This allows customers to run a Snippet against every request, or filter for specific HTTP traffic based on the fields we offer, such as traffic with a certain bot score, originating from a specific country, or with a specific cookie. Snippets will be additive, meaning users can have one Snippet to add an HTTP header, and another to rewrite the URL, and both will execute if they match:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/11/image2-39.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Another major difference - Cloudflare Snippets are available for all plan levels, at no additional cost. 99% of users won't pay a single cent, ever, to use this solution. This allows customers to migrate their simple workloads from legacy solutions like VCL to the Cloudflare platform, and actively reduce their monthly spend.</p><!--kg-card-begin: html-->
	<table>
		<thead>
			<tr>
				<th></th>
				<th>Free Plans</th>
				<th>Pro Plans</th>
				<th> Business Plans</th>
				<th>Enterprise Plans</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Snippets available</td>
				<td>5 Snippets per zone.</td>
				<td>20 Snippets per zone.</td>
				<td>50 Snippets per zone.</td>
				<td>200 Snippets per zone*<br>(Customers can speak with their Customer Success team to have this increased).</td>
			</tr>
		</tbody>
	</table><!--kg-card-end: html-->
	<p>Cloudflare Snippets are lightweight when compared with Workers, offering 5ms maximum execution time, 2MB maximum memory and 32KB total package size. This comparably small footprint allows us to offer this to 99% of users at no additional cost, whilst also being sufficient for the identified use cases like HTTP header modification, URL rewriting and traffic routing - all of which don't need the vast resources offered by Cloudflare Workers.</p><!--kg-card-begin: html-->
	<table>
		<thead>
			<tr>
				<th></th>
				<th>Cloudflare Snippets</th>
				<th>Cloudflare Workers Unbound<br>(For comparison)</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Runtime support</td>
				<td>JavaScript</td>
				<td>JavaScript and WASM</td>
			</tr>
			<tr>
				<td>Execution location</td>
				<td>Global - All Cloudflare locations</td>
				<td>Global - All Cloudflare locations</td>
			</tr>
			<tr>
				<td>Triggers supported</td>
				<td>Ruleset Engine Filters</td>
				<td>HTTP Request<br>HTTP Response<br>Cron Triggers</td>
			</tr>
			<tr>
				<td>Maximum execution time</td>
				<td>5ms</td>
				<td>30 Seconds HTTP<br>15 Minutes (Cron Trigger)</td>
			</tr>
			<tr>
				<td>Maximum memory</td>
				<td>2MB</td>
				<td>128MB</td>
			</tr>
			<tr>
				<td>Total package size</td>
				<td>32KB</td>
				<td>5MB</td>
			</tr>
			<tr>
				<td>Environment variables</td>
				<td>8/Snippet</td>
				<td>64/Worker</td>
			</tr>
			<tr>
				<td>Environment variable size</td>
				<td>1KB</td>
				<td>5KB</td>
			</tr>
			<tr>
				<td>Subrequests</td>
				<td>1/request</td>
				<td>1000/request</td>
			</tr>
			<tr>
				<td>Terraform Support</td>
				<td>✅</td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Wrangler Support</td>
				<td></td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Cron Triggers</td>
				<td></td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Key Value Store</td>
				<td></td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Durable Objects</td>
				<td></td>
				<td>✅</td>
			</tr>
			<tr>
				<td>R2 Integration</td>
				<td></td>
				<td>✅</td>
			</tr>
		</tbody>
	</table><!--kg-card-end: html-->
	<h2 id="what-will-you-be-able-to-build-with-cloudflare-snippets">What will you be able to build with Cloudflare Snippets?</h2>
	<p>Snippets will allow customers to migrate their existing workloads to Cloudflare. They will also open up a number of new possible use cases for customers. We have highlighted three common examples below, however there are many more to choose from.</p>
	<h3 id="example-1-sending-suspect-bots-to-a-honeypot">Example 1: Sending suspect bots to a honeypot</h3>
	<p>When creating Snippets customers will be able to access Cloudflare <a href="https://developers.cloudflare.com/workers/runtime-apis/request/?ref=blog.cloudflare.com" target="_blank">features</a> available in the Workers runtime, such as the bot score field. This enables customers to forward an HTTP request to a honeypot or use the RegExp Javascript function to change the URL construct being sent back to the end user when traffic is assigned a bot score below a certain threshold, e.g. <a href="https://developers.cloudflare.com/bots/concepts/bot-score/?ref=blog.cloudflare.com#:~:text=A%20bot%20score%20is%20a,request%20came%20from%20a%20human." target="_blank">29 and lower</a>.</p><!--kg-card-begin: markdown-->
	<pre><code class="language-javascript">…
if (request.cf.botManagement.score &lt; 30) {
const honeypot = "https://example.com/";
return await fetch(honeypot, request);
…
}
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="example-2-cookie-modification">Example 2: Cookie modification</h3>
	<p>Another common use case we foresee Snippets addressing is cookie modification. Usage can range from simply setting an expiry in five minutes by using <code>getTime</code> and <code>setTime</code> JavaScript functions to setting a dynamic cookie based on user request attributes for A/B testing purposes.</p><!--kg-card-begin: markdown-->
	<pre><code class="language-javascript">…
{
let res = await fetch(request);
res = new Response(res.body, res);
// 24h * 60m * 60s * 1000ms = 86400000ms
const expiry = new Date(Date.now() + 7 * 86400000).toUTCString();
const group = request.headers.get("userGroup") == "premium" ? "A" : "B";
res.headers.append(
      "Set-Cookie",
`testGroup=${group}; Expires=${expiry}; path=/`
    );
…
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="example-3-uri-query-management">Example 3: URI query management</h3>
	<p>Customers can also deploy Cloudflare Snippets to do complex operations such as splicing the URI query value to selectively remove or inject additional parameters. Query string manipulation is typically done using Transform Rules. However, with Transform Rules the <code>set/</code> action is effectively a <code>replace</code> action. This action when applied to the URI query string will remove the entire value if there is one and set it to what the user specifies, thus overwriting it. This is a problem for customers who wish to selectively inject specific query parameters for matching traffic. For example, &nbsp;setting an additional query, e.g. <code>?utm_campaign=facebook</code> when common social media platforms are detected in the user agent. With Snippets, customers will be able to do this selective removal and insertion using a simple piece of JavaScript, e.g.</p><!--kg-card-begin: markdown-->
	<pre><code class="language-javascript">…
if (userAgent.includes("Facebook")) {
      const url = new URL(request.url);
      const params = new URLSearchParams(url.search);
      params.set("utm_campaign", "facebook");
      url.search = params.toString();
      const transformedRequest = new Request(url, request)
…
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>We are excited to see what other use cases Cloudflare Snippets unlock for our customers.</p>
	<h2 id="will-you-stop-adding-actions-to-rulesets">Will you stop adding actions to rulesets?</h2>
	<p>The simple answer is no! We will continue to build out our no-code actions within the ruleset engine, developing new products to solve customer needs.</p>
	<p>It may sound obvious - but a core component to feature improvement is talking to customers. Talking to Snippet users will help us understand what real life use cases Snippets help solve and highlight feature gaps we have in our product suite. We can then review if it makes sense to productise that use case, or leave it requiring Snippets.</p>
	<p>We also understand that not everyone is a software developer. We are therefore exploring how we can make Snippets accessible to all by creating selectable templates available in a library that can be copied and modified by customers, with minimum coding knowledge required. With Snippets, powerful won’t mean difficult.</p>
	<h2 id="accessing-cloudflare-snippets">Accessing Cloudflare Snippets</h2>
	<p>Snippets are currently under development — you can sign up <a href="https://www.cloudflare.com/lp/cloudflare-snippets/?ref=blog.cloudflare.com" target="_blank">here</a> to join the waitlist for access.</p>
	<p>We hope to begin admitting users into the closed beta in early 2023, with an open beta to follow.</p>
</div>