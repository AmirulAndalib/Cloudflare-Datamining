<div class="mb2 gray5">10 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3d97S9cLxaxXV7fyA3Wont/e42f3b2c078b097067b6423e7cee4b59/image2-3.png" alt="Data generation and sampling strategies" class="kg-image" width="1801" height="1013" loading="lazy">

	</figure>
	<p>At Cloudflare, we are always looking for ways to make our customers' faster and more secure. A key part of that commitment is our ongoing investment in research and development of new technologies, such as the work on our machine learning based <a href="https://www.cloudflare.com/learning/ddos/glossary/web-application-firewall-waf">Web Application Firewall (WAF)</a> solution we announced during <a href="https://blog.cloudflare.com/waf-ml">security week</a>.</p>
	<p>In this blog, we’ll be discussing some of the data challenges we encountered during the machine learning development process, and how we addressed them with a combination of data augmentation and generation techniques.</p>
	<p>Let’s jump right in!</p>
	<div class="flex anchor relative">
		<h2 id="introduction">Introduction</h2>
		<a href="https://blog.cloudflare.com/#introduction" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>The purpose of a WAF is to analyze the characteristics of a HTTP request and determine whether the request contains any data which may cause damage to destination server systems, or was generated by an entity with malicious intent. A WAF typically <a href="https://www.cloudflare.com/application-services/solutions">protects applications</a> from common attack vectors such as <a href="https://www.cloudflare.com/learning/security/threats/cross-site-scripting">cross-site-scripting (XSS)</a>, file inclusion and <a href="https://www.cloudflare.com/learning/security/threats/sql-injection">SQL injection</a>, to name a few. These attacks can result in the loss of sensitive user data and damage to critical software infrastructure, leading to monetary loss and reputation risk, along with direct harm to customers.</p>
	<div class="flex anchor relative">
		<h3 id="how-do-we-use-machine-learning-for-the-waf">How do we use machine learning for the WAF?</h3>
		<a href="https://blog.cloudflare.com/#how-do-we-use-machine-learning-for-the-waf" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>The Cloudflare ML solution, at a high level, trains a classifier to distinguish between various traffic types and attack vectors, such as SQLi, XSS, Command Injection, etc. based on structural or statistical properties of the content. This is achieved by performing the following operations:</p>
	<ol>
		<li>
			<p>We inspect the raw HTTP input and perform some number of transformations on it such as normalization, content substitutions, or de-duplication.</p>
		</li>
		<li>
			<p>Decompose or partition it via some process of <a href="https://en.wikipedia.org/wiki/Lexical_analysis#Tokenization">tokenization</a>, generate statistical information about the content, or extract structural data.</p>
		</li>
		<li>
			<p>Compute optimal internal numerical representations of the inputs via the process of training the model. The nature of these internal representations depends on the class of model and architecture.</p>
		</li>
		<li>
			<p>Learn to map internal content representations against <a href="https://developers.google.com/machine-learning/glossary#class">classes</a> (XSS, SQLi or others), scores or some other target of interest.</p>
		</li>
		<li>
			<p>At run-time, use previously learned representations and mappings to analyze a new input and provide the most likely label or score for it. The score ranges from 1 to 99, with 1 indicating that the request is almost certainly malicious and 99 indicating that the request is probably clean.</p>
		</li>
	</ol>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7u9bJYCjNOH3rGEbQ5zlO1/a175b0be66d684af349c37166abda782/image3-1.png" alt="" class="kg-image" width="1530" height="510" loading="lazy">

	</figure>
	<p>This reasonable starting point stumbles immediately upon a critical challenge right from the start: we need high quality labeled data, and lots of it as that has the biggest impact on model performance. Contrary to well-researched fields like image recognition, text sentiment analysis, or classification, large datasets of HTTP requests with malicious payloads embedded are difficult to get.</p>
	<p>To make matters even harder, strict implementation requirements for a production-quality WAF restrict the complexity of our potential ML models or architectures to ones that are relatively simple and light-weight, implying that we cannot simply pave over shortcomings of the data.</p>
	<div class="flex anchor relative">
		<h2 id="data-and-challenges">Data and challenges</h2>
		<a href="https://blog.cloudflare.com/#data-and-challenges" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>The selection of a dataset is likely the most difficult of all the aspects that contribute to the final set of attributes of a <a href="https://www.cloudflare.com/learning/ai/what-is-machine-learning">machine learning model</a>. In most cases, the model is tasked with learning the distribution of the data in some statistical sense, thus choosing and curating the dataset to ensure that the desired properties of the final solution are even possible to learn is incredibly crucial! ML models are only as reliable as the data used to train them. If we train an ML model on an incomplete dataset, or on data that doesn’t accurately represent the population, predictions might be inaccurate as they will be a direct reflection of the data.</p>
	<p>To build a strong ML WAF, a good dataset must have large volumes of heterogeneous data covering malicious samples for all attack categories, a diverse set of negative/benign samples, and samples representing a broad spectrum of obfuscation techniques.</p>
	<p>Due to those constraints, creating a solid dataset has a number of challenges:</p>
	<div class="flex anchor relative">
		<h3 id="privacy">Privacy</h3>
		<a href="https://blog.cloudflare.com/#privacy" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Privacy requirements limit data availability and how it can be used. Cloudflare has strict privacy guidelines and does not keep all request data - it simply isn't available, and what is available must be carefully selected, anonymised, and stripped of sensitive information.</p>
	<div class="flex anchor relative">
		<h3 id="heterogeneity-of-samples">Heterogeneity of samples</h3>
		<a href="https://blog.cloudflare.com/#heterogeneity-of-samples" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Due to the wide assortment of potential request content types and forms, finding enough benign samples is difficult. Furthermore, it is challenging to collect data that represents requests with various charsets and content-encodings. Covering all attack configurations is also important because some attacks can be inserted into essentially any kind of request (e.g. five bytes in a huge "regular" request)</p>
	<div class="flex anchor relative">
		<h3 id="sample-difficulty">Sample difficulty</h3>
		<a href="https://blog.cloudflare.com/#sample-difficulty" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>We want a dataset with a good mix of attack techniques and isn’t dominated by the ones that are easily generated by tools which simply swap out constants, transform expressions through invariants, and so on (sqli-fuzzer). Additionally, the vast majority of freely available samples in the wild are fairly trivial auto-generated payloads as part of indiscriminate scanning and discovery tools. They have very similar structural and statistical characteristics. Some of them are fairly old as well and do not reflect the current software landscape. How to "grade" the sample difficulty is not immediately obvious! What’s easy to a human may not be easy for a particular preprocessor/model, and vice-versa.</p>
	<div class="flex anchor relative">
		<h3 id="noisy-labels">Noisy labels</h3>
		<a href="https://blog.cloudflare.com/#noisy-labels" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Label noise affects results a lot, especially when it comes to esoteric, specific, or unusual attacks which are likely to be classified as benign by rules WAF.</p>
	<p>What’s the strategy to overcome this?</p>
	<div class="flex anchor relative">
		<h2 id="data-augmentation">Data augmentation</h2>
		<a href="https://blog.cloudflare.com/#data-augmentation" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>In simple terms, <a href="https://en.wikipedia.org/wiki/Data_augmentation">Data Augmentation</a> is a process of generating artificial (but realistic) data to increase the diversity of our data by studying statistical distribution of existing real-world data.</p>
	<p>This is crucial for us because one of the biggest concerns with rules-based WAFs is <a href="https://en.wikipedia.org/wiki/False_positives_and_false_negatives">false positives</a>. False positives are a serious challenge for WAFs because the risk of accidentally filtering legitimate traffic deters users from employing very strict rulesets. Data augmentation is used to build a solution that does not rely on observing specific high-risk keywords or character sequences, but instead uses a more holistic analysis of content and context, making it considerably less likely to block legitimate requests.</p>
	<p>There are many sequences of characters which appear almost exclusively in payloads, but are themselves not dangerous. In order to reduce false positives and improve overall performance, we focussed on generating a lot of heterogeneous negative samples to force the model to consider the structural, semantic, and statistical properties of the content when making a classification decision.</p>
	<p>In the context of our data and use cases, data augmentation means that we mutate benign content in a variety of ways as the content will remain benign (this isn’t going to accidentally turn it into a valid payload, with probability 1). For instance, we can add random character noise, permute keywords, merge benign content together from multiple sources, and so on. Alternatively, we can seed benign content with ‘dangerous’ keywords or <a href="https://en.wikipedia.org/wiki/N-gram">ngrams</a> frequently occuring in payloads - this results in a benign sample, but ideally will teach the model not to be too sensitive to the presence of malicious tokens lacking the proper semantics and structure.</p>
	<div class="flex anchor relative">
		<h3 id="benign-content">Benign content</h3>
		<a href="https://blog.cloudflare.com/#benign-content" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>First and foremost, generating benign content is way easier. Mutating a malicious block of content into different malicious blocks is difficult because malicious payloads have a stricter grammar and syntax than general HTTP content due to the fact that it has code, therefore they must be manipulated in a specific manner.</p>
	<p>However, there are a few options &nbsp;if we want to do this in the future. Tools like sqli-fuzzer, &nbsp;automates the process of fuzzing a given payload by applying transformations which preserve the underlying semantics while changing the representation or adding obfuscation. Outside existing third-party tools, it's possible to generate our own malicious payloads using various "append malicious content to non-malicious content" techniques, with the trade off that this doesn't actually generate *new* malicious content, just puts it into a different context.</p>
	<div class="flex anchor relative">
		<h3 id="pseudo-random-noise-samples">Pseudo-random noise samples</h3>
		<a href="https://blog.cloudflare.com/#pseudo-random-noise-samples" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>A useful approach we identified for bolstering the number of negative training samples was to generate large quantities of pseudo-random strings of increasing complexity.</p>
	<p>The probability of any pseudo-random string (drawn from essentially any token distribution) being a valid payload or malicious attack is essentially zero, but we can build a series of token sampling distributions that make it increasingly difficult for the model to distinguish them from a real payload, and we discovered that this resulted in dramatically better performance in terms of <a href="https://en.wikipedia.org/wiki/False_positive_rate">false positive rate</a>, robustness, and overall model properties.</p>
	<p>This approach works by taking a collection of tokens and a probability distribution over these tokens, and independently sampling a stream of tokens from it to create our ‘sample’. Each sample length is selected from a separate discrete sample length distribution.</p>
	<p>For an extremely simple example, we could take a token collection consisting of ASCII characters and a uniform sampling distribution:</p>
	<p><code>['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9']</code></p>
	<p>We sample random strings of length 0-32 from this to get some (uninteresting) negative samples:</p>
	<p><code><i>8hwk1d740hfstbb4aogbpi4qayppvdl41b6blornuzktp4yl</i></code></p>
	<p><code><i>1deq7rug1zftmn9tjr73yttjnye99zh2140z2x9lr8n6sxhucdgn6bmqvfv7auw8fwbkrtxilk45ht-</i></code></p>
	<p>We wouldn’t expect even a very simple model to struggle to learn that these samples are benign, &nbsp;but as we increase the complexity of the token collections, we can move towards much more ‘difficult’ noise examples, including elements such as: fragments of valid URIs, user agents, XML/XSLT content or even restricted language identifiers, or keywords.</p>
	<p>Here are some examples of more complex token collections and the kinds of random strings they produce as our negative samples:</p>
	<p><i>Ascii_script: alphanumeric characters plus &nbsp;'&lt;', '&gt;', '/', '&lt;/', '-', '+', '=', '&lt; ', ' &gt;', ' ', ' /&gt;'</i></p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6i3VyWGzBWnaekmFn2tGiT/b2f091c9d91a5f480cee24486c649228/Screenshot-2022-09-05-at-13.16.14.png" alt="" class="kg-image" width="1628" height="242" loading="lazy">

	</figure>
	<p><i>alphanumerics, plus special characters, plus a variant of full javascript or sql keywords and (multi-character) sub-token fragments</i></p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/52NYD6gz6hJp5JVce60DBb/112933462a04aaeea3f2cb070f45c3e5/Screenshot-2022-09-05-at-13.17.48.png" alt="" class="kg-image" width="1626" height="242" loading="lazy">

	</figure>
	<p>It’s fairly straightforward to construct a suite of these noise generators of varying complexity, and targeting different types of content: JSON, XML, URIs with SQL-esque ‘noise’, and so on. As the strings get sufficiently long, the probability that they will contain at least some dangerous looking subsequences grows, so it’s also an excellent test of model robustness.</p>
	<p>We make extensive use of noise strings to enhance the core dataset used for training and testing the model by directly training the model on increasingly difficult noise before fine-tuning on exclusively real data, appending noise of varying complexity to malicious(real) samples or benign samples to both induce and test for model robustness for padding attacks, and estimating false positive rate for certain classes of benign content.</p>
	<div class="flex anchor relative">
		<h3 id="beyond-independent-sampling-of-random-strings">Beyond independent sampling of random strings?</h3>
		<a href="https://blog.cloudflare.com/#beyond-independent-sampling-of-random-strings" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>A natural extension to the above method for generating pseudo-random strings is to drop the ‘independence’ assumption for sampling tokens. This means that we’re starting to emulate the process by which real data is generated, to some extent, yielding samples with increasingly realistic local (and eventually global) structure. Some approaches for this might include a simple Markov chain, and extend all the way to state-of-the-art <a href="https://www.cloudflare.com/learning/ai/what-is-large-language-model">Large Language Models</a>.</p>
	<p>We experimented with using contemporary autoregressive language models trained on our corpus of real malicious payloads and found it extremely effective at generating novel payloads, as well as transforming payloads into sophisticated obfuscated representations. As the language models approached convergence on the data the likelihood of each sample being a valid payload approached 100%, allowing us to use early samples as ‘extremely strong negatives’ and the later samples as positive samples. The success of this work has suggested that deeper investigation into the use of language models for security analysis may be fruitful, not only for training classifiers, but also for creating powerful adversarial pen-testing agents.</p>
	<div class="flex anchor relative">
		<h2 id="results-summary">Results summary</h2>
		<a href="https://blog.cloudflare.com/#results-summary" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Let’s see a comparative summary of results and improvements, before and after the augmentation:</p>
	<div class="flex anchor relative">
		<h3 id="model-performance-on-evaluation-metrics">Model performance on evaluation metrics</h3>
		<a href="https://blog.cloudflare.com/#model-performance-on-evaluation-metrics" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>The effectiveness of machine learning models for classification problems can be evaluated using a wide range of metrics, including <a href="https://en.wikipedia.org/wiki/Evaluation_of_binary_classifiers">accuracy, precision, recall, F1 Score,</a> and others. It is important to note that in addition to using quantitative metrics, we also consider the model's general properties and behavioral constraints. This criteria and metrics-based approach is especially important in our domain where data is inherently noisy, labels are not trustworthy, the domain of the inputs is extremely large, and hard to cover with samples.</p>
	<p>For this post, we will concentrate on key quantitative metrics like F1 score even though we examine a variety of metrics to assess the model performance. F1 score is the weighted average (harmonic mean) of precision and recall. We can represent the F1 score with the formula:</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/bWOTqvQ8CzWMQrdnojquV/107aeb9f49cdd59750745be2dbb4e2ac/57sg9aMxBhrWv1CnYdMvRNodVVjcvCUZIrbRExH2sD4-f-7sy2mOKjqRaU3Z6uAH_WEVXHLmzuHBooN_ThqEfan7dVu5khiwLzr8a7ts1UpyNdP6bVWQ4WNhxv_o.png" alt="" class="kg-image" width="608" height="124" loading="lazy">

	</figure>
	<p>Where,</p>
	<p><b>True Positives (TP):</b> malicious content classified correctly by the model</p>
	<p><b>False Positives (FP):</b> benign content that the model classified as malicious</p>
	<p><b>True Negatives (TN):</b> benign content classified correctly by the model</p>
	<p><b>False Negatives (FN):</b> malicious content that the model classified as benign</p>
	<p>Since this formula takes false positives and false negatives into consideration, this score is more reliable than other metrics. There are a few methods to calculate this for <a href="https://en.wikipedia.org/wiki/Multiclass_classification">multi-class</a> problems, like <a href="https://towardsdatascience.com/multi-class-metrics-made-simple-part-ii-the-f1-score-ebe8b2c2ca1">Macro F1 Score, Micro F1 Score and Weighted F1 Score</a>. Although each method has advantages and disadvantages, we obtained nearly identical results with all three methods. Below are the numbers:</p><!--kg-card-begin: html-->
	<style type="text/css">
		.tg {
			border-collapse: collapse;
			border-spacing: 0;
		}

		.tg td {
			border-color: black;
			border-style: solid;
			border-width: 1px;
			font-family: Arial, sans-serif;
			font-size: 14px;
			overflow: hidden;
			padding: 10px 5px;
			word-break: normal;
		}

		.tg th {
			border-color: black;
			border-style: solid;
			border-width: 1px;
			font-family: Arial, sans-serif;
			font-size: 14px;
			font-weight: normal;
			overflow: hidden;
			padding: 10px 5px;
			word-break: normal;
		}

		.tg .tg-5t9h {
			background-color: #A4C2F4;
			font-weight: bold;
			text-align: center;
			vertical-align: top
		}

		.tg .tg-m0cw {
			background-color: #C9DAF8;
			font-weight: bold;
			text-align: center;
			vertical-align: top
		}

		.tg .tg-p7vi {
			background-color: #C9DAF8;
			font-weight: bold;
			text-align: left;
			vertical-align: top
		}

		.tg .tg-skn0 {
			background-color: #A4C2F4;
			text-align: left;
			vertical-align: top
		}

		.tg .tg-ktyi {
			background-color: #FFF;
			text-align: left;
			vertical-align: top
		}

		.tg .tg-7yig {
			background-color: #FFF;
			text-align: center;
			vertical-align: top
		}
	</style>
	<table class="tg" width="100%">
		<thead>
			<tr>
				<th class="tg-skn0" rowspan="2"></th>
				<th class="tg-5t9h" colspan="3" rowspan="2"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Without Augmentation</span></th>
				<th class="tg-5t9h" colspan="3" rowspan="2"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">With Augmentation</span></th>
			</tr>
			<tr>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td class="tg-p7vi"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Class</span></td>
				<td class="tg-m0cw"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Precision</span></td>
				<td class="tg-m0cw"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Recall</span></td>
				<td class="tg-m0cw"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">F1 Score</span></td>
				<td class="tg-m0cw"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Precision</span></td>
				<td class="tg-m0cw"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Recall</span></td>
				<td class="tg-m0cw"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent">F1 Score</span></td>
			</tr>
			<tr>
				<td class="tg-ktyi"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Benign</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.69</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.17</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.27</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.98</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">1.00</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
			</tr>
			<tr>
				<td class="tg-ktyi"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">SQLi</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.77</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.96</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.85</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">1.00</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">1.00</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">1.00</span></td>
			</tr>
			<tr>
				<td class="tg-ktyi"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">XSS</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.56</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.94</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.70</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">1.00</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.98</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
			</tr>
			<tr>
				<td class="tg-ktyi"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Total(Micro Average)</span></td>
				<td class="tg-7yig"></td>
				<td class="tg-7yig"></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.67</span></td>
				<td class="tg-7yig"></td>
				<td class="tg-7yig"></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
			</tr>
			<tr>
				<td class="tg-ktyi"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Total(Macro Average)</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.67</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.69</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.61</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
			</tr>
			<tr>
				<td class="tg-ktyi"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Total(Weighted Average)</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.68</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.67</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.60</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
				<td class="tg-7yig"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">0.99</span></td>
			</tr>
		</tbody>
	</table><!--kg-card-end: html-->
	<p>The important takeaway is that the range of this F1 score is best at 1 and worst at 0.</p>
	<p>The model after augmentation appears to have similar precision and recall with good overall performance, as indicated by a value of 0.99 after augmentation, compared to 0.61 for Macro F1.</p>
	<p>So far in the results summary, we've only discussed F1 Score; however, there are other improvements in characteristics that we've observed in the model that are listed below:</p>
	<p><b>False positive characteristics</b></p>
	<ul>
		<li>
			<p>Estimated false positive rate reduced by approximately 80% on test data sets. There are significantly fewer false positives involving PromQL and other SQL-structured analogues. PromQL examples result in high scores and are classified correctly:</p>
		</li>
	</ul>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3lUchXLKHNfQEkM952eDQd/443efc4aa7a9d93509938da05e161581/Screenshot-2022-09-05-at-12.35.06.png" alt="" class="kg-image" width="1618" height="206" loading="lazy">

	</figure>
	<p>Today, the only major category of false positives are literal SQL or JavaScript files.</p>
	<ul>
		<li>
			<p>General false positive rate on noise from JSON-esque, XML/SOAP-esque, and SQL-esque content-generators reduced to about a 1/100,000 rate from about 1/50 to 1/1.</p>
		</li>
	</ul>
	<p><b>True positive characteristics</b></p>
	<ul>
		<li>
			<p><b>True positive</b> rate for highly fuzzed content is vastly improved. Models trained solely on real data were easily bypassed by advanced fuzzing tools, whereas models trained on real plus augmented data are extremely resistant, with many payloads receiving higher risk scores as fuzzing increases. Examples:</p>
		</li>
	</ul>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5CDUCnINmeCQ5NAxnF5LQD/c72bb1f9a7b5e318da3886479842ef79/Screenshot-2022-09-05-at-12.36.25.png" alt="" class="kg-image" width="1622" height="112" loading="lazy">

	</figure>
	<p>These yield approximately same scores as they are a result of only a few byte &nbsp; alterations</p>
	<ul>
		<li>
			<p>Proportion of client-provided test sets that primarily contain payloads not blocked by rules-waf for XSS/SQLi successfully classified is about 97.5% (with the remaining 2.5% being arguable) up from about 91%.</p>
		</li>
		<li>
			<p>Padding a payload with almost any amount of ASCII, JSON-esque, special-characters, or other content will not reduce the risk score substantially. Due to the addition of hard noise long length augmented training samples, even a six byte payload in a 100 kilobyte string will be caught. Examples:</p>
		</li>
	</ul>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4vhJPYVNW2bfVfPTgQmT4H/16f3587fea7bdb6570cfc53bc7cff451/Screenshot-2022-09-05-at-12.37.03.png" alt="" class="kg-image" width="1626" height="136" loading="lazy">

	</figure>
	<p>They both generate similar scores even though the latter has junk padding around the payload.</p>
	<p><b>Execution performance</b></p>
	<ul>
		<li>
			<p>Runtime characteristics are unchanged for inference.</p>
		</li>
	</ul>
	<p>On top of that, we validated the model against the Cloudflare’s highly mature signature-based WAF and confirmed that machine learning WAF performs comparable to signature WAF, with the ML WAF demonstrating its strength particularly in cases of correctly handling highly obfuscated or irregularly fuzzed content (as well as avoiding some rules-based engine false positives). ​​Finally, we were able to conclude that augmentation helps in improving the model performance and induce the right set of properties.</p>
	<div class="flex anchor relative">
		<h2 id="conclusion">Conclusion</h2>
		<a href="https://blog.cloudflare.com/#conclusion" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>We built a machine learning powered WAF, with the substantial challenge to gather a diversified training set, given constraints to avoid sensitive real customer data for privacy and regulatory considerations. To create a broader and diversified dataset without requiring vast amounts of sensitive data, we used techniques such as fuzzing, data augmentation, and synthetic data generation. This allowed us to improve the solution's false positive robustness and overall model performance.</p>
	<p>Furthermore, these techniques reduced the time complexity required to retrieve/clean real data, and helped induce the correct model behavior. In the future, we intend to investigate autoregressive language models to generate synthetic pseudo-valid payloads.</p>
</div>