<div class="mb2 gray5 ">10 min. de lecture</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_0.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Au cas où vous ne seriez pas encore au courant, Cloudflare a <a href="https://blog.cloudflare.com/dns-resolver-1-1-1-1">lancé</a> un service de résolveur <a href="https://www.cloudflare.com/learning/dns/what-is-dns">DNS</a> dédié à la protection de la vie privée le 1er avril. Ce n’était pas un poisson d’avril ! Ce service, notre premier axé sur les particuliers, est compatible avec les nouvelles normes DNS telles que DNS over HTTPS:443 et TLS:853 en plus des protocoles traditionnels over UDP:53 et TCP:53, le tout avec une adresse facile à retenir : <a href="https://1.1.1.1">1.1.1.1</a>.</p>
	<p>Comme cela a été dit dans l’article d’origine, notre politique est de ne jamais, au grand jamais, inscrire les adresses IP des clients sur un disque, et d’effacer tous les journaux dans les 24 heures. Néanmoins, les personnes exceptionnellement soucieuses de la protection de la vie privée ne voudront peut-être pas révéler leur adresse IP au résolveur, et nous respectons cela. C'est pourquoi nous lançons un service Tor onion pour notre résolveur à l'adresse <a href="https://dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion">dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion</a> et accessible via <a href="https://tor.cloudflare-dns.com">tor.cloudflare-dns.com</a>.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/tor.gif" class="kg-image" alt="" loading="lazy"></figure>
	<p><strong>Remarque :</strong> ce résolveur caché en est encore au stade expérimental et ne doit pas être utilisé dans le cadre d'activités de production ou pour d'autres utilisations délicates tant qu'il n'a pas été plus amplement testé.</p>
	<h3 id="cours-acc-l-r-sur-tor"><strong>Cours accéléré sur Tor</strong><br></h3>
	<h4 id="qu-est-ce-que-tor"><strong>Qu’est-ce que </strong><a href="https://www.torproject.org"><strong>Tor</strong></a><strong> ?</strong></h4>
	<p>Imaginez un Internet alternatif où, pour vous connecter à www.cloudflare.com, au lieu de déléguer à votre fournisseur d'accès Internet la tâche de trouver un chemin vers nos serveurs, vous avez dû passer par les étapes suivantes pour atteindre Cloudflare :</p>
	<ol>
		<li>Vous calculez un chemin vers votre destination comme ceci :<br><br><code>Vous -&gt; votre FAI -&gt; X -&gt; Y -&gt; Z -&gt; www.cloudflare.com.</code></li>
		<li>Vous cryptez votre paquet avec la clé publique de Z, puis avec celle de Y, et enfin avec celle de X.</li>
		<li>Vous soumettez le résultat à X, qui le décrypte avec sa clé privée ;</li>
		<li>X soumet le résultat à Y, qui le décrypte avec sa clé privée ;</li>
		<li>Y envoie le résultat à Z, qui décrypte avec sa clé privée pour obtenir le paquet d’origine ;</li>
		<li>Z soumet le paquet à <a href="https://blog.cloudflare.com/welcome-hidden-resolver/www.cloudflare.com">www.cloudflare.com</a>.</li>
	</ol>
	<p>Si chacun joue correctement son rôle, il est possible de faire en sorte que seul le relais d'entrée X connaisse votre adresse IP et que seul le relais de sortie Z connaisse le site Web auquel vous vous connectez, ce qui préserve votre anonymat et votre vie privée. Pour simplifier, disons que Tor est un ensemble d'ordinateurs et de serveurs gérés par des volontaires du monde entier qui servent de relais à un immense réseau édifié par-dessus Internet où chaque saut d'un relais à un autre retire une couche de cryptage, d'où son nom : le routeur de type oignon.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/exit-node.png" class="kg-image" alt="" loading="lazy"></figure>
	<h4 id="en-quoi-consistent-les-services-cach-s-tor"><strong>En quoi consistent les services cachés Tor ?</strong></h4>
	<p>Garantir l'anonymat des internautes n'est pas la seule fonction du réseau Tor. Il convient en particulier de signaler que la connexion est toujours accessible par le relais de sortie et par toute personne se trouvant entre celui-ci et la destination, y compris les fournisseurs de réseau. Pour résoudre ce problème, et aussi pour assurer l'anonymat des éditeurs de contenu, Tor autorise les services cachés. Les services cachés (Onion) sont des nœuds Tor qui affichent leur clé publique, encodée comme une adresse avec le nom de domaine de premier niveau .onion, et établissent des connexions entièrement sur le réseau Tor :</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_3.png" class="kg-image" alt="" loading="lazy"></figure>
	<h4 id="comment-r-soudre-un-domaine-en-utilisant-tor"><strong>Comment résoudre un domaine en utilisant Tor ?</strong></h4>
	<p>Le processus de retour d'une adresse IP associée à un nom de domaine est appelé <em>résolution DNS</em>. Étant donné que Tor utilise toujours des adresses IP, vous devez toujours utiliser la résolution DNS pour naviguer sur le Web via Tor. Il existe deux méthodes courantes pour résoudre un nom de domaine en utilisant Tor :</p>
	<ol>
		<li>Résoudre le nom directement, puis communiquer avec l'adresse IP par le biais de Tor</li>
		<li>Demander à un relais de sortie Tor de résoudre publiquement le nom et de se connecter à l'IP</li>
	</ol>
	<p>De toute évidence, la première option dévoile votre IP à votre résolveur DNS et, à moins que votre client n'utilise DNS-over-HTTPS ou DNS-over-TLS, elle dévoile votre nom de destination à votre FAI. Ce qui est moins évident, c'est que la seconde option peut vous exposer à des <a href="https://arstechnica.com/information-technology/2014/01/scientists-detect-spoiled-onions-trying-to-sabotage-tor-privacy-network">attaques</a> par manipulation telles que l'empoisonnement du cache DNS ou sslstrip à cause de <a href="https://trac.torproject.org/projects/tor/wiki/doc/ReportingBadRelays">mauvais relais</a>. C’est là qu’intervient notre nouveau service :</p>
	<p> 3. &nbsp;Demandez notre service de résolveur basé sur .onion !</p>
	<h3 id="comment-fonctionne-le-r-solveur-cach-de-cloudflare"><strong>Comment fonctionne le résolveur caché de Cloudflare ?</strong></h3>
	<p>Pour faire court, notre service de résolveur basé sur .onion est un service Tor caché qui transfère toutes les communications sur les ports DNS vers les ports correspondants sur 1.1.1.1, donc l'IP client apparente est une IP interne plutôt que la vôtre. Mais ce n'est pas tout.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_4.png" class="kg-image" alt="" loading="lazy"></figure>
	<h4 id="le-r-solveur-cach-est-il-s-curis-"><strong>Le résolveur caché est-il sécurisé ?</strong></h4>
	<p>Il existe une différence notable entre l'utilisation de 1.1.1.1 et ce service : l'adresse .onion est « dns4tor » suivie de 49 caractères alphanumériques en apparence aléatoires. Cette chaîne de 56 caractères contient en fait une clé publique Ed25519 complète servant à sécuriser la communication avec le service caché. Cela implique un certain nombre de défis en matière de sécurité utilisable :</p>
	<ol>
		<li>Comment les utilisateurs peuvent-ils être sûrs que l'adresse est correcte ?</li>
	</ol>
	<p>Nous avons tout simplement acheté un <a href="https://crt.sh/?id=439705277">certificat</a> avec tor.cloudflare-dns.com comme nom d'objet et l'adresse .onion comme nom alternatif. De cette façon, si vous êtes au bon endroit, vous devriez voir ceci :</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_5.png" class="kg-image" alt="" loading="lazy"></figure>
	<p> 2. &nbsp; Comment les utilisateurs peuvent-ils mémoriser cette adresse ?</p>
	<p>Selon nous, il est inutile de mémoriser cette adresse. Dans l'idéal, il vous suffit d'aller sur <a href="https://tor.cloudflare-dns.com">https://tor.cloudflare-dns.com</a> et de demander au navigateur d'acheminer votre demande à l'adresse .onion. Cette procédure est possible grâce à l'en-tête HTTP optionnel « <a href="https://tools.ietf.org/html/rfc7838">Alt-Svc</a> » avertissant le navigateur que les ressources sont accessibles depuis un autre emplacement réseau, par le biais d'un éventuel protocole différent. <a href="https://nightly.mozilla.org">Firefox Nightly</a>, de <a href="https://hacks.mozilla.org/2018/05/a-cartoon-intro-to-dns-over-https">Mozilla</a>, permet désormais d'utiliser les adresses .onion comme services alternatifs.</p>
	<p>Considérez cette fonctionnalité comme <a href="https://blog.cloudflare.com/opportunistic-encryption-bringing-http-2-to-the-unencrypted-web">un cryptage opportuniste</a> : une fois que votre navigateur reçoit un en-tête Alt-Svc indiquant qu'une adresse .onion est disponible pour tor.cloudflare-dns.com, s'il sait que les adresses .onion sont accessibles (par exemple via un proxy SOCKS), il tente de vérifier que le service alternatif a le même niveau de sécurité ou un niveau supérieur. Il s'agit notamment de s'assurer qu'il est possible de se connecter au service caché à l'aide du même certificat et du même <a href="https://tools.ietf.org/html/rfc6066#section-3">nom de serveur</a>. Si c'est le cas, le navigateur utilise plutôt le service alternatif, ce qui garantit que vos futures requêtes ne quitteront pas le réseau Tor.</p>
	<h4 id="notre-r-solveur-cach-est-il-rapide"><strong>Notre résolveur caché est-il rapide ?</strong></h4>
	<p>Imaginons qu'entre deux points sur Terre, on ait installé un câble à fibre optique capable de transmettre des paquets sans perte et à la vitesse de la lumière.</p>
	<p></p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_6.png" class="kg-image" alt="" loading="lazy"></figure>
	<p></p>
	<p>Avec un calcul rapide, il est facile de voir qu'en moyenne, chaque paquet parcourt une distance correspondant à un <strong>quart</strong> de la circonférence de la Terre en <strong>33 ms</strong> environ, tandis que chaque paquet Tor a besoin de <strong>200 ms</strong> pour réaliser <strong>un tour et demi</strong> du monde et atteindre un service caché, soit trois tours pour un voyage qui permet de préserver l'anonymat des deux parties.</p>
	<p>Cloudflare, cependant, n'exige pas l'anonymat pour ses serveurs, c'est pourquoi nous pouvons réduire le nombre de relais à seulement trois en activant un <a href="https://gitweb.torproject.org/torspec.git/tree/proposals/260-rend-single-onion.txt">paramètre</a> <a href="https://trac.torproject.org/projects/tor/ticket/17178">facultatif</a> pour les services cachés qui privilégie les faibles latences plutôt que l'anonymat géographique du service. Soulignons que cela n'a aucune incidence sur la vie privée ou l'anonymat des clients. En effet, comme vous l'avez peut-être remarqué, dans la première image représentant le service caché, l'origine est à trois sauts du point de rendez-vous alors que notre service caché est à un seul saut.</p>
	<p>Nous travaillons activement au développement de moyens permettant d'accélérer ce service et de réduire au maximum les temps morts.</p>
	<h4 id="pourquoi-devrais-je-utiliser-le-r-solveur-cach-de-cloudflare"><strong>Pourquoi devrais-je utiliser le résolveur caché de Cloudflare ?</strong></h4>
	<p>Avant toute chose, la résolution des requêtes DNS via le réseau Tor, par exemple en se connectant au résolveur 8.8.8.8 de Google, garantit un niveau d'anonymat bien plus élevé que celui des requêtes effectuées directement. Non seulement cela empêche le résolveur de voir votre adresse IP, mais même votre FAI ne saura pas que vous avez tenté de résoudre un nom de domaine.</p>
	<p>Néanmoins, à moins que la destination ne soit un service caché, les attaquants passifs peuvent capturer des paquets sortant du réseau Tor, et les nœuds de sortie malveillants peuvent empoisonner les requêtes DNS ou dégrader le cryptage via <a href="https://moxie.org/software/sslstrip">sslstripping</a>. Même si vous ne naviguez que sur des sites <a href="https://www.eff.org/pages/tor-and-https">HTTPS</a>, les attaquants passifs peuvent savoir à quelles adresses vous vous êtes connecté(e). Pire encore, les personnes capables de comparer le trafic avant qu'il n'entre sur le réseau Tor et après qu'il quitte le réseau peuvent potentiellement utiliser les métadonnées (taille, temps, etc.) pour <a href="https://nymity.ch/tor-dns">lever l'anonymat</a> du client. La seule solution est donc d'éliminer le recours aux nœuds de sortie en utilisant plutôt des services cachés. C'est ce que propose notre résolveur basé sur .onion.</p>
	<p>De plus, si votre client ne prend pas en charge les requêtes DNS cryptées, l'utilisation d'un résolveur basé sur .onion peut sécuriser la connexion contre les attaques on-path, y compris les attaques de type « BGP hijacking ». Cela se traduit par un niveau de sécurité pour DNS-over-UDP et DNS-over-TCP comparable à celui de DNS-over-HTTPS et DNS-over-TLS.</p>
	<p>Cependant, ce service n'est pas uniquement destiné à préserver votre anonymat. Ce qui permet à Tor de garantir l'anonymat de chacun, c'est le nombre de personnes qui l'utilisent. Si seuls les lanceurs d'alerte, par exemple, utilisaient le réseau Tor, alors toute personne se connectant au réseau Tor serait automatiquement soupçonnée d'être un lanceur d'alerte. Par conséquent, plus il y aura de gens qui utiliseront Tor pour visionner des mèmes ou regarder des vidéos de chats sur Internet, plus il sera facile pour ceux qui ont vraiment besoin d'anonymat de se fondre das la masse avec le trafic.</p>
	<p>La lenteur de Tor rebute beaucoup d'utilisateurs. Je peux donc comprendre les gens qui ne veulent pas sacrifier leurs temps de chargement rapides pour préserver l'anonymat des activistes et des dissidents. Cela dit, les requêtes DNS sont petites et, étant donné que la plupart des navigateurs et des systèmes d'exploitation cachent les résultats DNS, le trafic total n'est pas très important. En conséquence, l'utilisation de ce résolveur basé sur .onion ne ralentira que légèrement votre requête DNS initiale sans rien ralentir d'autre, tout en contribuant à la préservation de l'anonymat global du réseau Tor et de ses utilisateurs.</p>
	<h3 id="pourquoi-ferais-je-confiance-au-r-solveur-cach-de-cloudflare"><strong>Pourquoi ferais-je confiance au résolveur caché de Cloudflare ?</strong></h3>
	<p>L'utilisation d'un résolveur basé sur .onion vous garantit que votre FAI ne découvrira jamais que vous résolvez un domaine, que les nœuds de sortie n'auront pas la possibilité de manipuler les réponses DNS et que le résolveur ne connaîtra jamais votre adresse IP. Cependant, l'utilisation du résolveur de Cloudflare basé sur .onion présente l'avantage unique de combiner la puissance de Tor avec toutes les fonctionnalités de protection de la vie privée du résolveur 1.1.1.1, telles que la minimisation du nom de requête, ainsi qu'une équipe d'ingénieurs œuvrant pour son amélioration à chaque niveau, notamment sur les protocoles DNS-over-HTTPS et DNS-over-TLS.</p>
	<p>Comme l'a dit Matthew Prince, PDG de Cloudflare, <a href="https://blog.cloudflare.com/the-trouble-with-tor">il y a environ deux ans</a>, nous accordons une grande valeur à l'anonymat en ligne. De plus, lorsque nous avons annoncé le résolveur 1.1.1.1, nous nous sommes <a href="https://developers.cloudflare.com/1.1.1.1/commitment-to-privacy">engagés</a> à faire tout notre possible pour ne pas savoir ce que vous faites sur Internet. En offrant un moyen d'utiliser le résolveur sur le réseau Tor et en le rendant aussi rapide que possible, nous faisons un grand pas dans cette direction.</p>
	<h3 id="comment-le-param-trer"><strong>Comment le paramétrer ?</strong></h3>
	<p>Le résolveur basé sur .onion est compatible avec tous les protocoles DNS compatibles avec 1.1.1.1, uniquement sur le réseau Tor. Cependant, comme tous les clients DNS ne sont pas capables de se connecter au réseau Tor, il est nécessaire de se livrer à quelques manipulations pour le faire fonctionner. Nous allons expliquer ici comment configurer DNS-over-HTTPS à partir du résolveur basé sur .onion, mais pour toutes les autres utilisations, rendez-vous sur notre <a href="https://developers.cloudflare.com/1.1.1.1/fun-stuff/dns-over-tor">page développeurs</a> pour en savoir plus sur l'utilisation du résolveur basé sur .onion.</p>
	<h4 id="vous-vous-souvenez-de-cloudflared"><strong>Vous vous souvenez de cloudflared ?</strong></h4>
	<p>Voici comment vous pouvez configurer <code>cloudflared</code> pour démarrer un client DNS qui utilise DNS-over-HTTPS, redirigé à travers le réseau Tor :</p>
	<ol>
		<li>Tout d’abord, commencez par télécharger <code>cloudflared</code> en suivant le <a href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/cloudflared-proxy">guide d’exécution d’un client DNS-over-HTTPS</a>.</li>
		<li>Démarrez un proxy Tor SOCKS et utilisez socat pour rediriger le port TCP:443 vers localhost :</li>
	</ol><!--kg-card-begin: markdown-->
	<pre><code>socat TCP4-LISTEN:443,reuseaddr,fork SOCKS4A:127.0.0.1:dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion:443,socksport=9150
</code></pre>
	<!--kg-card-end: markdown-->
	<p>3. Demandez à votre ordinateur de traiter l'adresse .onion comme localhost :</p><!--kg-card-begin: markdown-->
	<pre><code>cat &lt;&lt; EOF &gt;&gt; /etc/hosts 
127.0.0.1 dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion 
128.EOF
</code></pre>
	<!--kg-card-end: markdown-->
	<p>4. &nbsp;Enfin, lancez un daemon DNS over UDP local :</p><!--kg-card-begin: markdown-->
	<pre><code>cloudflared proxy-dns --upstream "https://dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion/dns-query"
INFO[0000] Adding DNS upstream                           url="https://dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion/dns-query"
INFO[0000] Starting DNS over HTTPS proxy server          addr="dns://localhost:53"
INFO[0000] Starting metrics server                       addr="127.0.0.1:35659"
</code></pre>
	<!--kg-card-end: markdown-->
	<p>5. &nbsp;Il ne vous reste plus qu’à profiter !</p>
</div>