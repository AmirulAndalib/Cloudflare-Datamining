{
	"locale": "en-us",
	"post": {
		"id": "6193a867d6d2a702a97d3d5f",
		"uuid": "caa975b0-347e-45eb-8fa5-85dd725d5e27",
		"title": "Automatically generating types for Cloudflare Workers",
		"slug": "automatically-generated-types",
		"html": "<!--kg-card-begin: markdown--><p><em><small>This post is also available in <a href=\"http://blog.cloudflare.com/zh-cn/automatically-generated-types-zh-cn/\">简体中文</a>, <a href=\"http://blog.cloudflare.com/ja-jp/automatically-generated-types-ja-jp/\">日本語</a>.</small></em></p>\n<!--kg-card-end: markdown--><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/11/image1-29.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Historically, keeping our Rust and TypeScript type repos up to date has been hard. They were manually generated, which means they ran the risk of being inaccurate or out of date. Until recently, the workers-types repository needed to be manually updated whenever the types changed. We also used to add type information for mostly complete browser APIs. This led to confusion when people would try to use browser APIs that aren’t supported by the Workers runtime they would compile but throw errors.</p><p>That all changed this summer when Brendan Coll, whilst he was interning with us, built an automated pipeline for generating them. It runs every time we build the Workers runtime, generating types for our TypeScript and Rust repositories. Now everything is up-to-date and accurate.</p><h2 id=\"a-quick-overview\">A quick overview</h2><p>Every time the Workers runtime code is built, a script runs over the public APIs and generates the Rust and TypeScript types as well as a JSON file containing an <a href=\"https://en.wikipedia.org/wiki/Intermediate_representation\">intermediate representation</a> of the static types. The types are sent to the appropriate repositories and the JSON file is uploaded as well in case people want to create their own types packages. More on that later.</p><p>This means the static types will always be accurate and up to date. It also allows projects running Workers in other, statically-typed languages to generate their own types from our intermediate representation. Here is an example PR from our Cloudflare bot. It’s detected a change in the runtime types and is updating the TypeScript files as well as the intermediate representation.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/11/image2-12.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><h2 id=\"using-the-auto-generated-types\">Using the auto-generated types</h2><p>To get started, use wrangler to generate a new TypeScript project:</p><!--kg-card-begin: markdown--><pre><code class=\"language-sh\">$ wrangler generate my-typescript-worker https://github.com/cloudflare/worker-typescript-template\n</code></pre>\n<!--kg-card-end: markdown--><p>If you already have a TypeScript project, you can install the latest version of <a href=\"https://github.com/cloudflare/workers-types\">workers-types</a> with:</p><!--kg-card-begin: markdown--><pre><code class=\"language-sh\">$ npm install --save-dev @cloudflare/workers-types\n</code></pre>\n<!--kg-card-end: markdown--><p>And then add <code>@cloudflare/workers-types</code> to your project's tsconfig.json file.</p><!--kg-card-begin: markdown--><pre><code class=\"language-json\">{\n  &quot;compilerOptions&quot;: {\n    &quot;target&quot;: &quot;ES2020&quot;,\n    &quot;module&quot;: &quot;CommonJS&quot;,\n    &quot;lib&quot;: [&quot;ES2020&quot;],\n    &quot;types&quot;: [&quot;@cloudflare/workers-types&quot;]\n  }\n}\n</code></pre>\n<!--kg-card-end: markdown--><p>After that, you should get automatic type completion in your IDE of choice.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/11/image3-19.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><h2 id=\"how-it-works\">How it works</h2><p>Here is some example code from the Workers runtime codebase.</p><!--kg-card-begin: markdown--><pre><code class=\"language-cpp\">class Blob: public js::Object {\npublic:\n  typedef kj::Array&lt;kj::OneOf&lt;kj::Array&lt;const byte&gt;, kj::String, js::Ref&lt;Blob&gt;&gt;&gt; Bits;\n  struct Options {\n    js::Optional&lt;kj::String&gt; type;\n    JS_STRUCT(type);\n  };\n\n  static js::Ref&lt;Blob&gt; constructor(js::Optional&lt;Bits&gt; bits, js::Optional&lt;Options&gt; options);\n  \n  int getSize();\n  js::Ref&lt;Blob&gt; slice(js::Optional&lt;int&gt; start, js::Optional&lt;int&gt; end);\n\n  JS_RESOURCE_TYPE(Blob) {\n    JS_READONLY_PROPERTY(size, getSize);\n    JS_METHOD(slice);\n  }\n};\n</code></pre>\n<!--kg-card-end: markdown--><p>A Python script runs over this code during each build and generates an <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">Abstract Syntax Tree</a> containing information about the function including an identifier, any argument types and any return types.</p><!--kg-card-begin: markdown--><pre><code class=\"language-json\">{\n  &quot;name&quot;: &quot;Blob&quot;,\n  &quot;kind&quot;: &quot;class&quot;,\n  &quot;members&quot;: [\n    {\n      &quot;name&quot;: &quot;size&quot;,\n      &quot;type&quot;: {\n        &quot;name&quot;: &quot;integer&quot;\n      },\n      &quot;readonly&quot;: true\n    },\n    {\n      &quot;name&quot;: &quot;slice&quot;,\n      &quot;type&quot;: {\n        &quot;params&quot;: [\n          {\n            &quot;name&quot;: &quot;start&quot;,\n            &quot;type&quot;: {\n              &quot;name&quot;: &quot;integer&quot;,\n              &quot;optional&quot;: true\n            }\n          },\n          {\n            &quot;name&quot;: &quot;end&quot;,\n            &quot;type&quot;: {\n              &quot;name&quot;: &quot;integer&quot;,\n              &quot;optional&quot;: true\n            }\n          }\n        ],\n        &quot;returns&quot;: {\n          &quot;name&quot;: &quot;Blob&quot;\n        }\n      }\n    }\n  ]\n}\n</code></pre>\n<!--kg-card-end: markdown--><p>Finally, the <a href=\"https://github.com/cloudflare/workers-types\">TypeScript types</a> repositories are automatically sent PRs with the updated types.</p><!--kg-card-begin: markdown--><pre><code class=\"language-typescript\">declare type BlobBits = (ArrayBuffer | string | Blob)[];\n\ninterface BlobOptions {\n  type?: string;\n}\n\ndeclare class Blob {\n  constructor(bits?: BlobBits, options?: BlobOptions);\n  readonly size: number;\n  slice(start?: number, end?: number, type?: string): Blob;\n}\n</code></pre>\n<!--kg-card-end: markdown--><h3 id=\"overrides\">Overrides</h3><p>In some cases, TypeScript supports concepts that our C++ runtime does not. Namely, generics and function overloads. In these cases, we override the generated types with partial declarations. For example, <code>DurableObjectStorage</code> makes heavy use of generics for its getter and setter functions.</p><!--kg-card-begin: markdown--><pre><code>declare abstract class DurableObjectStorage {\n\t get&lt;T = unknown&gt;(key: string, options?: DurableObjectStorageOperationsGetOptions): Promise&lt;T | undefined&gt;;\n\t get&lt;T = unknown&gt;(keys: string[], options?: DurableObjectStorageOperationsGetOptions): Promise&lt;Map&lt;string, T&gt;&gt;;\n\t \n\t list&lt;T = unknown&gt;(options?: DurableObjectStorageOperationsListOptions): Promise&lt;Map&lt;string, T&gt;&gt;;\n\t \n\t put&lt;T&gt;(key: string, value: T, options?: DurableObjectStorageOperationsPutOptions): Promise&lt;void&gt;;\n\t put&lt;T&gt;(entries: Record&lt;string, T&gt;, options?: DurableObjectStorageOperationsPutOptions): Promise&lt;void&gt;;\n\t \n\t delete(key: string, options?: DurableObjectStorageOperationsPutOptions): Promise&lt;boolean&gt;;\n\t delete(keys: string[], options?: DurableObjectStorageOperationsPutOptions): Promise&lt;number&gt;;\n\t \n\t transaction&lt;T&gt;(closure: (txn: DurableObjectTransaction) =&gt; Promise&lt;T&gt;): Promise&lt;T&gt;;\n\t}\n</code></pre>\n<!--kg-card-end: markdown--><p>You can also write type overrides using Markdown. <a href=\"https://github.com/cloudflare/workers-types/blob/master/docs/kv.md\">Here</a> is an example of overriding types of <code>KVNamespace</code>.</p><h2 id=\"creating-your-own-types\">Creating your own types</h2><p>The JSON IR (<a href=\"https://en.wikipedia.org/wiki/Intermediate_representation\">intermediate representation</a>) has been open sourced alongside the TypeScript types and can be found <a href=\"https://github.com/cloudflare/workers-types/blob/master/src/workers.json\">in this GitHub repository</a>. We’ve also open sourced the <a href=\"https://github.com/cloudflare/workers-types/blob/master/src/schema.json\">type schema</a> itself, which describes the format of the IR. If you’re interested in generating Workers types for your own language, you can take the IR, which describes the declaration in a \"normalized\" data structure, and generate types from it.</p><p>The declarations inside <code>workers.json</code> contain the elements to derive function signatures and other elements needed for code generation such as identifiers, argument types, return types and error management. A concrete use-case would be to generate external function declarations for a language that compiles to WebAssembly, to import precisely the set of available function calls available from the Workers runtime.</p><h2 id=\"conclusion\">Conclusion</h2><p>Cloudflare cares deeply about supporting the TypeScript and Rust ecosystems. Brendan created a tool which will ensure the type information for both languages is always up-to-date and accurate. We also are open-sourcing the type information itself in JSON format, so that anyone interested can create type data for any language they’d like!</p><h3 id=\"watch-on-cloudflare-tv\">Watch on Cloudflare TV</h3><!--kg-card-begin: html--><div style=\"position: relative; padding-top: 56.25%;\"><iframe src=\"https://iframe.videodelivery.net/07356fcb9d66ada45f8dcc2217b8c1d7?preload=true&poster=https%3A%2F%2Fvideodelivery.net%2F07356fcb9d66ada45f8dcc2217b8c1d7%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D0m4s%26height%3D600\" style=\"border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;\" allow=\"accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;\" allowfullscreen=\"true\"></iframe></div><!--kg-card-end: html-->",
		"comment_id": "6193a867d6d2a702a97d3d5f",
		"feature_image": "http://blog.cloudflare.com/content/images/2021/11/image1-28.png",
		"featured": false,
		"visibility": "public",
		"created_at": "2021-11-16T12:47:35.000+00:00",
		"updated_at": "2021-12-30T00:53:16.000+00:00",
		"published_at": "2021-11-16T13:58:45.000+00:00",
		"custom_excerpt": "Every time the Workers runtime code is built, a script runs over the public APIs and generates the Rust and TypeScript types as well as a JSON file containing an intermediate representation of the static types. The types are sent to the appropriate repositories and the JSON file is uploaded as well.",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "6186c9a51a6fe202ab7b100e",
				"name": "Brendan Coll",
				"slug": "brendan-coll",
				"profile_image": "http://blog.cloudflare.com/content/images/2021/11/brendan-coll.png",
				"cover_image": null,
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": "@_mrbbot",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/brendan-coll/"
			},
			{
				"id": "614367cb99308e02a7f66dc8",
				"name": "Jonathan Kuperman",
				"slug": "jkup",
				"profile_image": "http://blog.cloudflare.com/content/images/2021/09/jon.jpeg",
				"cover_image": null,
				"bio": "Developer advocate on the Cloudflare Workers team.",
				"website": "https://jonkuperman.com/",
				"location": null,
				"facebook": null,
				"twitter": "@jkup",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/jkup/"
			}
		],
		"tags": [
			{
				"id": "6193a8dcd6d2a702a97d3d66",
				"name": "#BLOG-803",
				"slug": "hash-blog-803",
				"description": null,
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			},
			{
				"id": "618ab476015c6002aaf44684",
				"name": "Full Stack Week",
				"slug": "full-stack-week",
				"description": "This week, as we do in our Innovation Weeks, we’ll make a series of announcements to help paint a vision for how we see the future of compute, and giving our developers the tools they need to build their next application on our network.",
				"feature_image": "http://blog.cloudflare.com/content/images/2021/11/image2-8.png",
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/full-stack-week/"
			},
			{
				"id": "5d16450341acde0011a95253",
				"name": "Cloudflare Workers",
				"slug": "workers",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/workers/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			},
			{
				"id": "5d16450341acde0011a95252",
				"name": "Serverless",
				"slug": "serverless",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Serverless.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Serverless",
				"meta_description": "Cloudflare blog posts tagged 'serverless'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/serverless/"
			},
			{
				"id": "64a3e2b834124c000b00b717",
				"name": "Developer Platform",
				"slug": "developer-platform",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developer-platform/"
			}
		],
		"primary_author": {
			"id": "6186c9a51a6fe202ab7b100e",
			"name": "Brendan Coll",
			"slug": "brendan-coll",
			"profile_image": "http://blog.cloudflare.com/content/images/2021/11/brendan-coll.png",
			"cover_image": null,
			"bio": null,
			"website": null,
			"location": null,
			"facebook": null,
			"twitter": "@_mrbbot",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/brendan-coll/"
		},
		"primary_tag": null,
		"url": "http://blog.cloudflare.com/automatically-generated-types/",
		"excerpt": "Every time the Workers runtime code is built, a script runs over the public APIs and generates the Rust and TypeScript types as well as a JSON file containing an intermediate representation of the static types. The types are sent to the appropriate repositories and the JSON file is uploaded as well.",
		"reading_time": 4,
		"access": true,
		"comments": false,
		"og_image": "http://blog.cloudflare.com/content/images/2021/11/Automatically-generating-types-for-Cloudflare-Workers-OG-1.png",
		"og_title": null,
		"og_description": null,
		"twitter_image": "http://blog.cloudflare.com/content/images/2021/11/Automatically-generating-types-for-Cloudflare-Workers-OG.png",
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": "Every time the Workers runtime code is built, a script runs over the public APIs and generates the Rust and TypeScript types as well as a JSON file containing an intermediate representation of the static types. The types are sent to the appropriate repositories and the JSON file is uploaded as well in case people want to create their own types packages. ",
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	}
}