{
	"post": {
		"id": "651495d441a590000a60118c",
		"uuid": "326e978f-5e1a-4da7-9aed-d1d117df32d8",
		"title": "Running Serverless Puppeteer with Workers and Durable Objects",
		"slug": "running-serverless-puppeteer-workers-durable-objects",
		"html": "<figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2023/09/Running-Serverless-Puppeteer-with-Workers-and-Durable-Objects.png\" class=\"kg-image\" alt=\"Running Serverless Puppeteer with Workers and Durable Objects\" loading=\"lazy\" width=\"1600\" height=\"900\"></figure><p>Last year, we <a href=\"http://blog.cloudflare.com/introducing-workers-browser-rendering-api/\">announced the Browser Rendering API</a> – letting users running Puppeteer, a browser automation library, directly in Workers. Puppeteer is one of the most popular libraries used to interact with a headless browser instance to accomplish tasks like taking screenshots, generating PDFs, crawling web pages, and testing <a href=\"https://www.cloudflare.com/learning/security/what-is-web-application-security/\">web applications</a>. We’ve heard from developers that configuring and maintaining their own serverless browser automation systems can be quite painful.</p><p>The <a href=\"https://developers.cloudflare.com/browser-rendering/\">Workers Browser Rendering API</a> solves this. It makes the Puppeteer library available directly in your Worker, connected to a real web browser, without the need to configure and manage infrastructure or keep browser sessions warm yourself. You can use <a href=\"https://www.npmjs.com/package/@cloudflare/puppeteer\">@cloudflare/puppeteer</a> to run the full Puppeteer API directly on Workers! </p><p>We’ve seen so much interest from the developer community since launching last year. While the Browser Rendering API is still in beta (sign up to our <a href=\"https://www.cloudflare.com/lp/workers-browser-rendering-api/?ref=blog.cloudflare.com&amp;cf_target_id=99BC25CE5278572504B986049859D8A2\">waitlist</a> to get access), we wanted to share a way to get more out of our <a href=\"https://developers.cloudflare.com/browser-rendering/platform/limits/\">current limits</a> by using the Browser Rendering API with <a href=\"https://developers.cloudflare.com/durable-objects/\">Durable Objects</a>. We’ll also be sharing pricing for the Rendering API, so you can build knowing exactly what you’ll pay for.</p><h3 id=\"building-a-responsive-web-design-testing-tool-with-the-browser-rendering-api\">Building a responsive web design testing tool with the Browser Rendering API</h3><p>As a designer or frontend developer, you want to make sure that content is well-designed for visitors browsing on different screen sizes. With the number of possible devices that users are browsing on are growing, it becomes difficult to test all the possibilities manually. While there are many testing tools on the market, we want to show how easy it is to create your own Chromium based tool with the Workers Browser Rendering API and Durable Objects. </p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2023/09/pasted-image-0--6--2.png\" class=\"kg-image\" alt loading=\"lazy\" width=\"852\" height=\"236\"></figure><p>We’ll be using the Worker to handle any incoming requests, pass them to the Durable Object to take screenshots and store them in an R2 bucket. The Durable Object is used to create a browser session that’s persistent. By using <a href=\"https://developers.cloudflare.com/durable-objects/api/alarms-in-durable-objects/\">Durable Object Alarms</a> we can keep browsers open for longer and reuse browser sessions across requests.</p><p>Let’s dive into how we can build this application:</p><ol><li>Create a Worker with a Durable Object, Browser Rendering API binding and R2 bucket. This is the resulting wrangler.toml:</li></ol><pre><code>name = \"rendering-api-demo\"\nmain = \"src/index.js\"\ncompatibility_date = \"2023-09-04\"\ncompatibility_flags = [ \"nodejs_compat\"]\naccount_id = \"c05e6a39aa4ccdd53ad17032f8a4dc10\"\n\n\n# Browser Rendering API binding\nbrowser = { binding = \"MYBROWSER\" }\n\n# Bind an R2 Bucket\n[[r2_buckets]]\nbinding = \"BUCKET\"\nbucket_name = \"screenshots\"\n\n# Binding to a Durable Object\n[[durable_objects.bindings]]\nname = \"BROWSER\"\nclass_name = \"Browser\"\n\n[[migrations]]\ntag = \"v1\" # Should be unique for each entry\nnew_classes = [\"Browser\"] # Array of new classes\n</code></pre><p>2. Define the Worker</p><p>This Worker simply passes the request onto the Durable Object.</p><pre><code class=\"language-javascript\">export default {\n\tasync fetch(request, env) {\n\n\t\tlet id = env.BROWSER.idFromName(\"browser\");\n\t\tlet obj = env.BROWSER.get(id);\n\t  \n\t\t// Send a request to the Durable Object, then await its response.\n\t\tlet resp = await obj.fetch(request.url);\n\t\tlet count = await resp.text();\n\t  \n\t\treturn new Response(\"success\");\n\t}\n};\n</code></pre><p>3. Define the Durable Object class</p><pre><code class=\"language-js\">const KEEP_BROWSER_ALIVE_IN_SECONDS = 60;\n\nexport class Browser {\n\tconstructor(state, env) {\n\t\tthis.state = state;\n\t\tthis.env = env;\n\t\tthis.keptAliveInSeconds = 0;\n\t\tthis.storage = this.state.storage;\n\t}\n  \n\tasync fetch(request) {\n\t\t// screen resolutions to test out\n\t\tconst width = [1920, 1366, 1536, 360, 414]\n\t\tconst height = [1080, 768, 864, 640, 896]\n\n\t\t// use the current date and time to create a folder structure for R2\n\t\tconst nowDate = new Date()\n\t\tvar coeff = 1000 * 60 * 5\n\t\tvar roundedDate = (new Date(Math.round(nowDate.getTime() / coeff) * coeff)).toString();\n\t\tvar folder = roundedDate.split(\" GMT\")[0]\n\n\t\t//if there's a browser session open, re-use it\n\t\tif (!this.browser) {\n\t\t\tconsole.log(`Browser DO: Starting new instance`);\n\t\t\ttry {\n\t\t\t  this.browser = await puppeteer.launch(this.env.MYBROWSER);\n\t\t\t} catch (e) {\n\t\t\t  console.log(`Browser DO: Could not start browser instance. Error: ${e}`);\n\t\t\t}\n\t\t  }\n\t\t\n\t\t// Reset keptAlive after each call to the DO\n\t\tthis.keptAliveInSeconds = 0;\n\t\t\n\t\tconst page = await this.browser.newPage();\n\n\t\t// take screenshots of each screen size \n\t\tfor (let i = 0; i &lt; width.length; i++) {\n\t\t\tawait page.setViewport({ width: width[i], height: height[i] });\n\t\t\tawait page.goto(\"https://workers.cloudflare.com/\");\n\t\t\tconst fileName = \"screenshot_\" + width[i] + \"x\" + height[i]\n\t\t\tconst sc = await page.screenshot({\n\t\t\t\tpath: fileName + \".jpg\"\n\t\t\t}\n\t\t\t);\n\n\t\t\tthis.env.BUCKET.put(folder + \"/\"+ fileName + \".jpg\", sc);\n\t\t  }\n\t\t\n\t\t// Reset keptAlive after performing tasks to the DO.\n\t\tthis.keptAliveInSeconds = 0;\n\n\t\t// set the first alarm to keep DO alive\n\t\tlet currentAlarm = await this.storage.getAlarm();\n\t\tif (currentAlarm == null) {\n\t\tconsole.log(`Browser DO: setting alarm`);\n\t\tconst TEN_SECONDS = 10 * 1000;\n\t\tthis.storage.setAlarm(Date.now() + TEN_SECONDS);\n\t\t}\n\t\t\n\t\tawait this.browser.close();\n\t\treturn new Response(\"success\");\n\t}\n\n\tasync alarm() {\n\t\tthis.keptAliveInSeconds += 10;\n\t\n\t\t// Extend browser DO life\n\t\tif (this.keptAliveInSeconds &lt; KEEP_BROWSER_ALIVE_IN_SECONDS) {\n\t\t  console.log(`Browser DO: has been kept alive for ${this.keptAliveInSeconds} seconds. Extending lifespan.`);\n\t\t  this.storage.setAlarm(Date.now() + 10 * 1000);\n\t\t} else console.log(`Browser DO: cxceeded life of ${KEEP_BROWSER_ALIVE_IN_SECONDS}. Browser DO will be shut down in 10 seconds.`);\n\t  }\n\n  }\n</code></pre><p>That’s it! With less than a hundred lines of code, you can fully customize a powerful tool to automate responsive web design testing. You can even incorporate it into your CI pipeline to automatically test different window sizes with each build and verify the result is as expected by using an automated library like <a href=\"https://www.npmjs.com/package/pixelmatch\">pixelmatch</a>.</p><h3 id=\"how-much-will-this-cost\">How much will this cost?</h3><p>We’ve spoken to many customers deploying a Puppeteer service on their own infrastructure, on <a href=\"https://www.cloudflare.com/learning/cloud/what-is-a-public-cloud/\">public cloud containers</a> or <a href=\"https://www.cloudflare.com/learning/serverless/glossary/function-as-a-service-faas/\">functions</a> or using managed services. The common theme that we’ve heard is that these services are costly – costly to maintain and expensive to run. </p><p>While you won’t be billed for the Browser Rendering API yet, we want to be transparent with you about costs you start building. We know it’s important to understand the pricing structure so that you don’t get a surprise bill and so that you can design your application efficiently.</p><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2023/09/pasted-image-0--7--2.png\" class=\"kg-image\" alt loading=\"lazy\" width=\"1316\" height=\"468\"></figure><p>You pay based on two usage metrics:</p><ol><li>Number of sessions: A Browser Session is a new instance of a browser being launched</li><li>Number of concurrent sessions: Concurrent Sessions is the number of browser instances open at once</li></ol><p>Using Durable Objects to persist browser sessions improves performance by eliminating the time that it takes to spin up a new browser session. Since it re-uses sessions, it cuts down on the number of concurrent sessions needed. We highly encourage this model of session re-use if you expect to see consistent traffic for applications that you build on the Browser Rendering API.</p><p>If you have feedback about this pricing, we’re all ears. Feel free to reach out through <a href=\"https://discord.gg/8Gs9T6jN\">Discord</a> (channel name: browser-rendering-api-beta) and share your thoughts.</p><h3 id=\"get-started\">Get Started</h3><p>Sign up to our <a href=\"https://www.cloudflare.com/lp/workers-browser-rendering-api/?ref=blog.cloudflare.com&amp;cf_target_id=99BC25CE5278572504B986049859D8A2\">waitlist</a> to get access to the Workers Browser Rendering API. We’re so excited to see what you build! Share your creations with us on Twitter/X <a href=\"https://www.twitter.com/cloudflaredev\">@CloudflareDev</a> or on our Discord community.</p>",
		"comment_id": "651495d441a590000a60118c",
		"feature_image": "http://blog.cloudflare.com/content/images/2023/09/Running-Serverless-Puppeteer-with-Workers-and-Durable-Objects-1.png",
		"featured": false,
		"visibility": "public",
		"created_at": "2023-09-27T21:51:32.000+01:00",
		"updated_at": "2023-11-28T17:20:39.000+00:00",
		"published_at": "2023-09-28T14:00:38.000+01:00",
		"custom_excerpt": "We’ve heard from developers that configuring and maintaining their own serverless browser automation systems can be quite painful. The Workers Browser Rendering API solves this",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "613a16bb3a467902a7476f60",
				"name": "Tanushree Sharma",
				"slug": "tanushree",
				"profile_image": "http://blog.cloudflare.com/content/images/2021/09/IMG_1328-1.jpg",
				"cover_image": null,
				"bio": "Product Manager, Cloudflare Workers",
				"website": null,
				"location": "Austin",
				"facebook": null,
				"twitter": "@_tanushreeeee",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/tanushree/"
			}
		],
		"tags": [
			{
				"id": "6514972a41a590000a6011cb",
				"name": "#BLOG-2085",
				"slug": "hash-blog-2085",
				"description": null,
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			},
			{
				"id": "5d16450341acde0011a95211",
				"name": "Birthday Week",
				"slug": "birthday-week",
				"description": "Collection of Cloudflare blog posts tagged 'Birthday Week'.",
				"feature_image": "http://blog.cloudflare.com/content/images/2023/09/Welcome-to-Birthday-Week-2023.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Birthday Week",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Birthday Week'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/birthday-week/"
			},
			{
				"id": "5d16450341acde0011a951ee",
				"name": "Product News",
				"slug": "product-news",
				"description": "Product News (EN)",
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Product-News-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Product News",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Product News'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/product-news/"
			},
			{
				"id": "606373480c4aa103f3124dcb",
				"name": "Durable Objects",
				"slug": "durable-objects",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/durable-objects/"
			},
			{
				"id": "5d16450341acde0011a95165",
				"name": "JavaScript",
				"slug": "javascript",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/javascript/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			}
		],
		"primary_author": {
			"id": "613a16bb3a467902a7476f60",
			"name": "Tanushree Sharma",
			"slug": "tanushree",
			"profile_image": "http://blog.cloudflare.com/content/images/2021/09/IMG_1328-1.jpg",
			"cover_image": null,
			"bio": "Product Manager, Cloudflare Workers",
			"website": null,
			"location": "Austin",
			"facebook": null,
			"twitter": "@_tanushreeeee",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/tanushree/"
		},
		"primary_tag": null,
		"url": "http://blog.cloudflare.com/running-serverless-puppeteer-workers-durable-objects/",
		"excerpt": "We’ve heard from developers that configuring and maintaining their own serverless browser automation systems can be quite painful. The Workers Browser Rendering API solves this",
		"reading_time": 5,
		"access": true,
		"comments": false,
		"og_image": "http://blog.cloudflare.com/content/images/2023/09/Running-Serverless-Puppeteer-with-Workers-and-Durable-Objects-OG-1.png",
		"og_title": null,
		"og_description": null,
		"twitter_image": "http://blog.cloudflare.com/content/images/2023/09/Running-Serverless-Puppeteer-with-Workers-and-Durable-Objects-OG.png",
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": "We’ve heard from developers that configuring and maintaining their own serverless browser automation systems can be quite painful. The Workers Browser Rendering API solves this",
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": "Running Serverless Puppeteer with Workers and Durable Objects.",
		"feature_image_caption": null
	},
	"locale": "en-us"
}