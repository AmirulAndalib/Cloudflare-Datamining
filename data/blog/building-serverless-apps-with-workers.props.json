{
	"post": {
		"id": "5d16453b41acde0011a957f8",
		"uuid": "4c89b0de-c0bb-4d7d-a8be-8fa242fba4af",
		"title": "Eating Dogfood at Scale: How We Build Serverless Apps with Workers",
		"slug": "building-serverless-apps-with-workers",
		"html": "<figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2019/04/ZG9nZm9vZEAyeC5wbmc-.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p></p><p>You’ve had a chance to build a <a href=\"https://developers.cloudflare.com/workers/about/\">Cloudflare Worker</a>. You’ve tried <a href=\"https://developers.cloudflare.com/workers/kv/\">KV Storage</a> and have a great use case for your Worker. You’ve even demonstrated the usefulness to your product or organization. Now you need to go from writing a single file in the Cloudflare Dashboard UI Editor to source controlled code with multiple environments deployed using your favorite CI tool.</p><p>Fortunately, we have a powerful and flexible <a href=\"https://developers.cloudflare.com/workers/api/\">API</a> for managing your workers. You can customize your deployment to your heart’s content. Our blog has already featured many things made possible by that API:</p><ul><li><a href=\"http://blog.cloudflare.com/introducing-wrangler-cli/\">The Wrangler CLI</a></li><li><a href=\"http://blog.cloudflare.com/a-ci/\">CI/CD Pipeline</a></li><li><a href=\"http://blog.cloudflare.com/deploying-workers-with-github-actions-serverless/\">Github Actions</a></li><li><a href=\"http://blog.cloudflare.com/create-cloudflare-worker-bootstrap-your-cloudflare-worker/\">Worker bootstrap template</a></li></ul><p>These tools make deployments easier to configure, but it still takes time to manage. The <a href=\"https://serverless.com/\">Serverless Framework</a> <a href=\"https://serverless.com/plugins/serverless-cloudflare-workers/\">Cloudflare Workers plugin</a> removes that deployment overhead so you can spend more time working on your application and less on your deployment.</p><h3 id=\"focus-on-your-application\">Focus on your application</h3><p>Here at Cloudflare, we’ve been working to rebuild our Access product to run entirely on Workers. The move will allow Access to take advantage of the resiliency, performance, and flexibility of Workers. We’ll publish a more detailed post about that migration once complete, but the experience required that we retool some of our process to match or existing development experience as much as possible.</p><p>To us this meant:</p><ul><li>Git</li><li>Easily deploy</li><li>Different environments</li><li>Unit Testing</li><li>CI Integration</li><li>Typescript/Multiple Files</li><li>Everything Must Be Automated</li></ul><p>The Cloudflare Access team looked at three options for automating all of these tools in our pipeline. All of the options will work and could be right for you, but custom scripting can be a chore to maintain and Terraform lacked some extensibility.</p><ol><li>Custom Scripting</li><li><a href=\"https://www.terraform.io/docs/providers/cloudflare/index.html\">Terraform</a></li><li>Serverless Framework</li></ol><p>We decided on the Serverless Framework. Serverless Framework provided a tool to mirror our existing process as closely as possible without too much DevOps overhead. Serverless is extremely simple and doesn’t interfere with the application code. You can get a project set up and deployed in seconds. It’s obviously less work than writing your own custom management scripts. But it also requires less boiler plate than Terraform because the Serverless Framework is designed for the “serverless” niche. However, if you are already using Terraform to manage other Cloudflare products, Terraform might be the best fit.</p><h3 id=\"walkthrough\">Walkthrough</h3><p>Everything for the project happens in a YAML file called serverless.yml. Let’s go through the features of the configuration file.</p><p>To get started, we need to install serverless from npm and generate a new project.</p><p></p><!--kg-card-begin: markdown--><pre><code>npm install serverless -g\nserverless create --template cloudflare-workers --path myproject\ncd myproject\nnpm install\n</code></pre>\n<!--kg-card-end: markdown--><p></p><p>If you are an enterprise client, you want to use the cloudflare-workers-enterprise template as it will set up more than one worker (but don’t worry, you can add more to any template). Also, I’ll touch on this later, but if you want to write your workers in Rust, use the cloudflare-workers-rust template.</p><p>You should now have a project that feels familiar, ready to be added to your favorite source control. In the project should be a serverless.yml file like the following.</p><p></p><!--kg-card-begin: markdown--><pre><code class=\"language-YAML\">service:\n    name: hello-world\n\nprovider:\n  name: cloudflare\n  config:\n    accountId: CLOUDFLARE_ACCOUNT_ID\n    zoneId: CLOUDFLARE_ZONE_ID\n\nplugins:\n  - serverless-cloudflare-workers\n\nfunctions:\n  hello:\n    name: hello\n    script: helloWorld  # there must be a file called helloWorld.js\n    events:\n      - http:\n          url: example.com/hello/*\n          method: GET\n          headers:\n            foo: bar\n            x-client-data: value\n</code></pre>\n<!--kg-card-end: markdown--><p></p><p>The service block simply contains the name of your service. This will be used in your Worker script names if you do not overwrite them.</p><p>Under provider, name must be ‘cloudflare’  and you need to add your account and zone IDs. You can find them in the Cloudflare Dashboard.</p><p>The plugins section adds the Cloudflare specific code.</p><p>Now for the good part: functions. Each block under functions is a Worker script. </p><p><strong>name</strong>: (optional) If left blank it will be STAGE-service.name-script.identifier. If I removed name from this file and deployed in production stage, the script would be named production-hello-world-hello.</p><p><strong>script</strong>: the relative path to the javascript file with the worker script. I like to organize mine in a folder called handlers.</p><p><strong>events</strong>: Currently Workers only support http events. We call these routes. The example provided says that GET https://example.com/hello/&lt;anything here&gt; will  cause this worker to execute. The headers block is for testing invocations.</p><p>At this point you can deploy your worker!<br></p><!--kg-card-begin: markdown--><pre><code class=\"language-YAML\">CLOUDFLARE_AUTH_EMAIL=you@yourdomain.com CLOUDFLARE_AUTH_KEY=XXXXXXXX serverless deploy\n</code></pre>\n<!--kg-card-end: markdown--><p></p><p>This is very easy to deploy, but it doesn’t address our requirements. Luckily, there’s just a few simple modifications to make.</p><h3 id=\"maturing-our-yaml-file\">Maturing our YAML File</h3><p>Here’s a more complex YAML file.</p><p></p><!--kg-card-begin: markdown--><pre><code class=\"language-YAML\">service:\n  name: hello-world\n\npackage:\n  exclude:\n    - node_modules/**\n  excludeDevDependencies: false\n\ncustom:\n  defaultStage: development\n  deployVars: ${file(./config/deploy.${self:provider.stage}.yml)}\n\nkv: &amp;kv\n  - variable: MYUSERS\n    namespace: users\n\nprovider:\n  name: cloudflare\n  stage: ${opt:stage, self:custom.defaultStage}\n  config:\n    accountId: ${env:CLOUDFLARE_ACCOUNT_ID}\n    zoneId: ${env:CLOUDFLARE_ZONE_ID}\n\nplugins:\n  - serverless-cloudflare-workers\n\nfunctions:\n  hello:\n    name: ${self:provider.stage}-hello\n    script: handlers/hello\n    webpack: true\n    environment:\n      MY_ENV_VAR: ${self:custom.deployVars.env_var_value}\n      SENTRY_KEY: ${self:custom.deployVars.sentry_key}\n    resources: \n      kv: *kv\n    events:\n      - http:\n          url: &quot;${self:custom.deployVars.SUBDOMAIN}.mydomain.com/hello&quot;\n          method: GET\n      - http:\n          url: &quot;${self:custom.deployVars.SUBDOMAIN}.mydomain.com/alsohello*&quot;\n          method: GET\n</code></pre>\n<!--kg-card-end: markdown--><p></p><p>We can add a custom section where we can put custom variables to use later in the file.</p><p><strong>defaultStage</strong>: We set this to development so that forgetting to pass a stage doesn’t trigger a production deploy. Combined with the <strong>stage</strong> option under provider we can set the stage for deployment.</p><p><strong>deployVars</strong>: We use this custom variable to load another YAML file dependent on the stage. This lets us have different values for different stages. In development, this line loads the file <code>./config/deploy.development.yml</code>. Here’s an example file:</p><!--kg-card-begin: markdown--><pre><code class=\"language-YAML\">env_var_value: true\nsentry_key: XXXXX\nSUBDOMAIN: dev\n</code></pre>\n<!--kg-card-end: markdown--><p></p><p><strong>kv</strong>:<strong> </strong>Here we are showing off a feature of YAML. If you assign a name to a block using the ‘&amp;’, you can use it later as a YAML variable. This is very handy in a multi script account. We could have named this variable anything, but we are naming it kv since it holds our Workers Key Value storage settings to be used in our function below.</p><p>Inside of the <strong>kv</strong> block we're creating a namespace and binding it to a variable available in your Worker. It will ensure that the namespace “users” exists and is bound to MYUSERS.</p><!--kg-card-begin: markdown--><pre><code class=\"language-YAML\">kv: &amp;kv\n  - variable: MYUSERS\n    namespace: users\n</code></pre>\n<!--kg-card-end: markdown--><p></p><p><strong>provider</strong>: The only new part of the provider block is <strong>stage</strong>. </p><!--kg-card-begin: markdown--><pre><code class=\"language-YAML\">stage: ${opt:stage, self:custom.defaultStage}\n</code></pre>\n<!--kg-card-end: markdown--><p></p><p>This line sets stage to either the command line option or custom.defaultStage if opt:stage is blank. When we deploy, we pass —stage=production to serverless deploy.</p><p>Now under our function we have added webpack, resources, and environment. </p><p><strong>webpack</strong>: If set to true, will simply bundle each handler into a single file for deployment. It will also take a string representing a path to a webpack config file so you can customize it. This is how we add Typescript support to our projects.</p><p><strong>resources</strong>: This block is used to automate resource creation. In resources we're linking back to the kv block we created earlier.<br><br><em>Side note: If you would like to include WASM bindings in your project, it can be done in a very similar way to how we included Workers KV. For more information on WASM, see the <a href=\"https://serverless.com/plugins/serverless-cloudflare-workers/\">documentation</a>.</em></p><p><strong>environment</strong>: This is the butter for the bread that is managing configuration for different stages. Here we can specify values to bind to variables to use in worker scripts. Combined with YAML magic, we can store our values in the aforementioned config files so that we deploy different values in different stages. With environments, we can easily tie into our CI tool. The CI tool has our deploy.production.yml. We simply run the following command from within our CI.<br></p><!--kg-card-begin: markdown--><pre><code>sls deploy --stage=production\n</code></pre>\n<!--kg-card-end: markdown--><p></p><p>Finally, I added a route to demonstrate that a script can be executed on multiple routes.</p><p>At this point I’ve covered (or hinted) at everything on our original list except Unit Testing. There are a few ways to do this.</p><p>We have a previous blog post about <a href=\"http://blog.cloudflare.com/unit-testing-worker-functions/\">Unit Testing</a> that covers using <a href=\"https://github.com/dollarshaveclub/cloudworker\">cloud worker</a>, a great tool built by <a href=\"https://www.dollarshaveclub.com/\">Dollar Shave Club</a>.</p><p>My team opted to use the classic node frameworks mocha and sinon. Because we are using Typescript, we can build for node or build for v8. You can also make mocha work for non-typescript projects if you use an <a href=\"https://nodejs.org/api/esm.html\">experimental feature that adds import/export support to node</a>.</p><!--kg-card-begin: markdown--><pre><code>--experimental-modules\n</code></pre>\n<!--kg-card-end: markdown--><p>We’re excited about moving more and more of our services to Cloudflare Workers, and the Serverless Framework makes that easier to do. If you’d like to learn even more or get involved with the project, see us on <a href=\"https://github.com/cloudflare/serverless-cloudflare-workers\">github.com</a>. For additional information on using Serverless Framework with Cloudflare Workers, check out our <a href=\"https://developers.cloudflare.com/workers/deploying-workers/serverless/\">documentation on the Serverless Framework</a>.</p>",
		"comment_id": "5cb7b4bdada87e00c06fb5f1",
		"feature_image": "http://blog.cloudflare.com/content/images/2019/04/ZG9nZm9vZEAyeC5wbmc--1.png",
		"featured": false,
		"visibility": "public",
		"created_at": "2019-04-18T00:20:29.000+01:00",
		"updated_at": "2024-02-12T21:23:35.000+00:00",
		"published_at": "2019-04-19T14:00:00.000+01:00",
		"custom_excerpt": "You’ve had a chance to build a Cloudflare Worker. You’ve tried KV Storage and have a great use case for your Worker. You’ve even demonstrated the usefulness to your product or organization. ",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"tags": [
			{
				"id": "5d16450341acde0011a95252",
				"name": "Serverless",
				"slug": "serverless",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Serverless.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Serverless",
				"meta_description": "Cloudflare blog posts tagged 'serverless'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/serverless/"
			},
			{
				"id": "5d16450341acde0011a95253",
				"name": "Cloudflare Workers",
				"slug": "workers",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/workers/"
			},
			{
				"id": "5d16450341acde0011a95214",
				"name": "Programming",
				"slug": "programming",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/programming/"
			},
			{
				"id": "5d16450341acde0011a95194",
				"name": "API",
				"slug": "api",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/api/"
			},
			{
				"id": "5d16450341acde0011a95291",
				"name": "CLI",
				"slug": "cli",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/cli/"
			},
			{
				"id": "5d16450341acde0011a951f1",
				"name": "GitHub",
				"slug": "github",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/github/"
			},
			{
				"id": "64a3e2b834124c000b00b717",
				"name": "Developer Platform",
				"slug": "developer-platform",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developer-platform/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			}
		],
		"authors": [
			{
				"id": "5d1644b141acde0011a95019",
				"name": "Jonathan Spies",
				"slug": "jonathan-spies",
				"profile_image": "http://blog.cloudflare.com/content/images/2022/09/19532e3ffeb770f1fcf6a94c8fd5449e.jpg",
				"cover_image": "http://blog.cloudflare.com/content/images/2019/06/general@2x-9.png",
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": null,
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/jonathan-spies/"
			}
		],
		"primary_author": {
			"id": "5d1644b141acde0011a95019",
			"name": "Jonathan Spies",
			"slug": "jonathan-spies",
			"profile_image": "http://blog.cloudflare.com/content/images/2022/09/19532e3ffeb770f1fcf6a94c8fd5449e.jpg",
			"cover_image": "http://blog.cloudflare.com/content/images/2019/06/general@2x-9.png",
			"bio": null,
			"website": null,
			"location": null,
			"facebook": null,
			"twitter": null,
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/jonathan-spies/"
		},
		"primary_tag": {
			"id": "5d16450341acde0011a95252",
			"name": "Serverless",
			"slug": "serverless",
			"description": null,
			"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Serverless.png",
			"visibility": "public",
			"meta_title": "Cloudflare Blog: Serverless",
			"meta_description": "Cloudflare blog posts tagged 'serverless'.",
			"og_image": null,
			"og_title": null,
			"og_description": null,
			"twitter_image": null,
			"twitter_title": null,
			"twitter_description": null,
			"codeinjection_head": null,
			"codeinjection_foot": null,
			"canonical_url": null,
			"accent_color": null,
			"url": "http://blog.cloudflare.com/tag/serverless/"
		},
		"url": "http://blog.cloudflare.com/building-serverless-apps-with-workers/",
		"excerpt": "You’ve had a chance to build a Cloudflare Worker. You’ve tried KV Storage and have a great use case for your Worker. You’ve even demonstrated the usefulness to your product or organization. ",
		"reading_time": 6,
		"access": true,
		"comments": false,
		"og_image": null,
		"og_title": null,
		"og_description": null,
		"twitter_image": null,
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": null,
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	},
	"locale": "en-us"
}