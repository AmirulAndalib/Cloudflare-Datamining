<div class="mb2 gray5">7 min read</div>
<div class="post-content lh-copy gray1"><!--kg-card-begin: markdown-->
	<p><small>This post is also available in <a href="https://blog.cloudflare.com/de-de/workers-ai-update-hello-mistral-7b-de-de">Deutsch</a>, <a href="https://blog.cloudflare.com/fr-fr/workers-ai-update-hello-mistral-7b-fr-fr">FranÃ§ais</a> and <a href="https://blog.cloudflare.com/nl-nl/workers-ai-update-hello-mistral-7b-nl-nl">Nederlands</a>.</small></p>
	<!--kg-card-end: markdown-->
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/11/Mistral-1.png" class="kg-image" alt="Workers AI Update: Hello Mistral 7B" loading="lazy" width="1600" height="900"></figure>
	<p>Today weâ€™re excited to announce that weâ€™ve added the Mistral-7B-v0.1-instruct to Workers AI. Mistral 7B is a 7.3 billion parameter language model with a number of unique advantages. With some help from the founders of Mistral AI, weâ€™ll look at some of the highlights of the Mistral 7B model, and use the opportunity to dive deeper into â€œattentionâ€ and its variations such as multi-query attention and grouped-query attention.</p>
	<h2 id="mistral-7b-tldr">Mistral 7B tl;dr:</h2>
	<p>Mistral 7B is a 7.3 billion parameter model that puts up <a href="https://mistral.ai/news/announcing-mistral-7b">impressive numbers on benchmarks</a>. The model:</p>
	<ul>
		<li>Outperforms comparable 13B model on all benchmarks</li>
		<li>Outperforms comparable 34B on many benchmarks,</li>
		<li>Approaches CodeLlama 7B performance on code, while remaining good at English tasks, and</li>
		<li>The chat fine-tuned version weâ€™ve deployed outperforms comparable 2 13B chat in the benchmarks provided by Mistral.</li>
	</ul>
	<p>Hereâ€™s an example of using streaming with the <a href="https://developers.cloudflare.com/workers-ai/get-started/rest-api">REST API</a>:</p><!--kg-card-begin: markdown-->
	<pre><code>curl -X POST \
â€œhttps://api.cloudflare.com/client/v4/accounts/{account-id}/ai/run/@cf/mistral/mistral-7b-instruct-v0.1â€ \
-H â€œAuthorization: Bearer {api-token}â€ \
-H â€œContent-Type:application/jsonâ€ \
-d '{ â€œpromptâ€: â€œWhat is grouped query attentionâ€, â€œstreamâ€: true }'

API Response: { response: â€œGrouped query attention is a technique used in natural language processing  (NLP) and machine learning to improve the performance of modelsâ€¦â€ }
</code></pre>
	<!--kg-card-end: markdown-->
	<p>And hereâ€™s an example using a Worker script:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-JavaScript">import { Ai } from '@cloudflare/ai';
export default {
    async fetch(request, env) {
        const ai = new Ai(env.AI);
        const stream = await ai.run('@cf/mistral/mistral-7b-instruct-v0.1', {
            prompt: 'What is grouped query attention',
            stream: true
        });
        return Response.json(stream, { headers: { â€œcontent-typeâ€: â€œtext/event-streamâ€ } });
    }
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Mistral takes advantage of <a href="https://arxiv.org/abs/2305.13245">grouped-query attention</a> for faster inference. This recently-developed technique improves the speed of inference without compromising output quality. For 7 billion parameter models, we can generate close to 4x as many tokens per second with Mistral as we can with Llama, thanks to Grouped-Query attention.</p>
	<p>You donâ€™t need any information beyond this to start using Mistral-7B, you can test it out today <a href="https://ai.cloudflare.com">ai.cloudflare.com</a>. To learn more about attention and Grouped-Query attention, read on!</p>
	<h2 id="so-what-is-%E2%80%9Cattention%E2%80%9D-anyway">So what is â€œattentionâ€ anyway?</h2>
	<p>The basic mechanism of attention, specifically â€œScaled Dot-Product Attentionâ€ as introduced in the landmark paper <a href="https://arxiv.org/abs/1706.03762">Attention Is All You Need</a>, is fairly simple:</p>
	<blockquote>We call our particular attention â€œScale Dot-Product Attentionâ€. The input consists of query and keys of dimension d_k, and values of dimension d_v. We compute the dot products of the query with all the keys, divide each by sqrt(d_k) and apply a softmax function to obtain the weights on the values.</blockquote>
	<p>More concretely, this looks like this:</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/11/Screenshot-2023-11-21-at-09.12.30.png" class="kg-image" alt="" loading="lazy" width="1882" height="680">
		<figcaption><a href="https://arxiv.org/abs/1706.03762">source</a></figcaption>
	</figure>
	<p>In simpler terms, this allows models to focus on important parts of the input. Imagine you are reading a sentence and trying to understand it. Scaled dot product attention enables you to pay more attention to certain words based on their relevance. It works by calculating the similarity between each word (K) in the sentence and a query (Q). Then, it scales the similarity scores by dividing them by the square root of the dimension of the query. This scaling helps to avoid very small or very large values. Finally, using these scaled similarity scores, we can determine how much attention or importance each word should receive. This attention mechanism helps models identify crucial information (V) and improve their understanding and translation capabilities.</p>
	<p>Easy, right? To get from this simple mechanism to an AI that can write a â€œSeinfeld episode in which Jerry learns the bubble sort algorithm,â€ weâ€™ll need to make it more complex. In fact, everything weâ€™ve just covered doesnâ€™t even have any learned parameters â€” constant values learned during model training that customize the output of the attention block!<br>Attention blocks in the style of <em>Attention is All You Need</em> add mainly three types of complexity:</p>
	<h3 id="learned-parameters">Learned parameters</h3>
	<p>Learned parameters refer to values or weights that are adjusted during the training process of a model to improve its performance. These parameters are used to control the flow of information or attention within the model, allowing it to focus on the most relevant parts of the input data. In simpler terms, learned parameters are like adjustable knobs on a machine that can be turned to optimize its operation.</p>
	<h3 id="vertical-stackinglayered-attention-blocks">Vertical stacking - layered attention blocks</h3>
	<p>Vertical layered stacking is a way to stack multiple attention mechanisms on top of each other, with each layer building on the output of the previous layer. This allows the model to focus on different parts of the input data at different levels of abstraction, which can lead to better performance on certain tasks.</p>
	<h3 id="horizontal-stackingaka-multi-head-attention">Horizontal stacking - aka Multi-Head Attention</h3>
	<p>The figure from the paper displays the full multi-head attention module. Multiple attention operations are carried out in parallel, with the Q-K-V input for each generated by a unique linear projection of the same input data (defined by a unique set of learned parameters). These parallel attention blocks are referred to as â€œattention headsâ€. The weighted-sum outputs of all attention heads are concatenated into a single vector and passed through another parameterized linear transformation to get the final output.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/11/Screenshot-2023-11-21-at-09.13.49.png" class="kg-image" alt="" loading="lazy" width="1806" height="722">
		<figcaption><a href="https://arxiv.org/abs/1706.03762">source</a></figcaption>
	</figure>
	<p>This mechanism allows a model to focus on different parts of the input data concurrently. Imagine you are trying to understand a complex piece of information, like a sentence or a paragraph. In order to understand it, you need to pay attention to different parts of it at the same time. For example, you might need to pay attention to the subject of the sentence, the verb, and the object, all simultaneously, in order to understand the meaning of the sentence. Multi-headed attention works similarly. It allows a model to pay attention to different parts of the input data at the same time, by using multiple "heads" of attention. Each head of attention focuses on a different aspect of the input data, and the outputs of all the heads are combined to produce the final output of the model.</p>
	<h2 id="styles-of-attention">Styles of attention</h2>
	<p>There are three common arrangements of attention blocks used by large language models developed in recent years: multi-head attention, grouped-query attention and multi-query attention. They differ in the number of K and V vectors relative to the number of query vectors. <strong>Multi-head attention</strong> uses the same number of K and V vectors as Q vectors, denoted by â€œNâ€ in the table below. <strong>Multi-query attention</strong> uses only a single K and V vector. <strong>Grouped-query attention</strong>, the type used in the Mistral 7B model, divides the Q vectors evenly into groups containing â€œGâ€ vectors each, then uses a single K and V vector for each group for a total of N divided by G sets of K and V vectors. This summarizes the differences, and weâ€™ll dive into the implications of these below.</p><!--kg-card-begin: html-->
	<table cellspacing="0" style="border-collapse:collapse; border:none; width:100%">
		<tbody>
			<tr>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:232px">&nbsp;</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:189px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000"><strong>Number of Key/Value Blocks</strong></span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:83px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000"><strong>Quality</strong></span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:99px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000"><strong>Memory Usage</strong></span></span></span></p>
				</td>
			</tr>
			<tr>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:232px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000"><strong>Multi-head attention (MHA)</strong></span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:189px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">N</span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:83px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">Best</span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:99px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">Most</span></span></span></p>
				</td>
			</tr>
			<tr>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:232px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000"><strong>Grouped-query attention (GQA)</strong></span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:189px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">N / G</span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:83px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">Better</span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:99px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">Less</span></span></span></p>
				</td>
			</tr>
			<tr>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:232px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000"><strong>Multi-query attention (MQA)</strong></span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:189px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">1</span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:83px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">Good</span></span></span></p>
				</td>
				<td style="border-bottom:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000; border-top:1px solid #000000; vertical-align:top; width:99px">
					<p><span style="font-size:11pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">Least</span></span></span></p>
				</td>
			</tr>
		</tbody>
	</table>
	<p style="text-align:center"><span style="font-size:9pt"><span style="font-family:Arial,sans-serif"><span style="color:#000000">Summary of attention styles</span></span></span></p><!--kg-card-end: html-->
	<p>And this diagram helps illustrate the difference between the three styles:</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/11/image1-6.png" class="kg-image" alt="" loading="lazy" width="1112" height="388">
		<figcaption><a href="https://arxiv.org/pdf/2305.13245.pdf">source</a></figcaption>
	</figure>
	<h3 id="multi-query-attention">Multi-Query Attention</h3>
	<p>Multi-query attention was described in 2019 in the paper from Google: <a href="https://arxiv.org/abs/1911.02150">Fast Transformer Decoding: One Write-Head is All You Need</a>. The idea is that instead of creating separate K and V entries for every Q vector in the attention mechanism, as in multi-head attention above, only a single K and V vector is used for the entire set of Q vectors. Thus the name, multiple queries combined into a single attention mechanism. In the paper, this was benchmarked on a translation task and showed performance equal to multi-head attention on the benchmark task.</p>
	<p>Originally the idea was to reduce the total size of memory that is accessed when performing inference for the model. Since then, as generalized models have emerged and grown in number of parameters, the GPU memory needed is often the bottleneck which is the strength of multi-query attention, as it requires the least accelerator memory of the three types of attention. However, as models grew in size and generality, performance of multi-query attention fell relative to multi-head attention.</p>
	<h3 id="grouped-query-attention">Grouped-Query Attention</h3>
	<p>The newest of the bunch â€” and the one used by Mistral â€” is grouped-query attention, as described in the paper <a href="https://arxiv.org/abs/2305.13245">GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints</a> that was published on arxiv.org in May 2023. Grouped-query attention combines the best of both worlds: the quality of multi-headed attention with the speed and low memory usage of multi-query attention. Instead of either a single set of K and V vectors or one set for every Q vector, a fixed ratio of 1 set of K and V vectors for every Q vector is used, reducing memory usage but retaining high performance on many tasks.</p>
	<p>Often choosing a model for a production task is not just about picking the best model available because we must consider tradeoffs between performance, memory usage, batch size, and available hardware (or cloud costs). Understanding these three styles of attention can help guide those decisions and understand when we might choose a particular model given our circumstances.</p>
	<h2 id="enter-mistral-%E2%80%94-try-it-today">Enter Mistral â€” try it today</h2>
	<p>Being one of the first large language models to leverage grouped-query attention and combining it with sliding window attention, Mistral seems to have hit the goldilocks zone â€” itâ€™s low latency, high-throughput, and it performs really well on benchmarks even when compared to bigger models (13B). All this to say is that it packs a punch for its size, and we couldn't be more excited to make it available to all developers today, via Workers AI.</p>
	<p>Head over to our <a href="https://developers.cloudflare.com/workers-ai/models/text-generation">developer docs</a> to get started, and if you need help, want to give feedback, or want to share what youâ€™re building just pop into our <a href="https://discord.com/invite/cloudflaredev">Developer Discord</a>!</p>
	<p>The Workers AI team is also expanding and hiring; check our <a href="https://www.cloudflare.com/careers/jobs">jobs page</a> for open roles if youâ€™re passionate about AI engineering and want to help us build and evolve our global, serverless GPU-powered inference platform.</p>
</div>