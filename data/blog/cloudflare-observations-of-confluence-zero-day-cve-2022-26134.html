<div class="post-content lh-copy gray1">
	<p>On 2022-06-02 at 20:00 UTC<a href="https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html?ref=blog.cloudflare.com" target="_blank"> Atlassian released a Security Advisory</a> relating to a remote code execution (RCE) vulnerability affecting Confluence Server and Confluence Data Center products. This post covers our current analysis of this vulnerability.</p>
	<p>When we learned about the vulnerability, Cloudflare’s internal teams <a href="https://blog.cloudflare.com/cloudflare-customers-are-protected-from-the-atlassian-confluence-cve-2022-26134/">immediately engaged</a> to ensure all our customers and our own infrastructure were protected:</p>
	<ul>
		<li>Our Web Application Firewall (WAF) teams started work on our first <a href="https://blog.cloudflare.com/cloudflare-customers-are-protected-from-the-atlassian-confluence-cve-2022-26134/">mitigation rules</a> that were deployed on 2022-06-02 at 23:38 UTC for all customers.</li>
		<li>Our internal security team started reviewing our Confluence instances to ensure Cloudflare itself was not impacted.</li>
	</ul>
	<h3 id="what-is-the-impact-of-this-vulnerability">What is the impact of this vulnerability?</h3>
	<p><a href="https://www.volexity.com/blog/2022/06/02/zero-day-exploitation-of-atlassian-confluence/?ref=blog.cloudflare.com" target="_blank">According to Volexity</a>, the vulnerability results in full unauthenticated RCE, allowing an attacker to fully take over the target application.</p>
	<p>Active exploits of this vulnerability leverage command injections using specially crafted strings to load a malicious class file in memory, allowing attackers to subsequently plant a webshell on the target machine that they can interact with.</p>
	<p>Once the vulnerability is exploited, attackers can implant additional malicious code such as <a href="https://github.com/Freakboy/Behinder?ref=blog.cloudflare.com" target="_blank">Behinder</a>; a custom webshell called noop.jsp, which replaces the legitimate noop.jsp file located at Confluence root&gt;/confluence/noop.jsp; and another open source webshell called <a href="https://github.com/tennc/webshell/blob/master/caidao-shell/%E8%8F%9C%E5%88%80jsp%E4%BF%AE%E6%94%B9.jsp?ref=blog.cloudflare.com" target="_blank">Chopper</a>.</p>
	<h3 id="our-observations-of-exploit-attempts-in-the-wild">Our observations of exploit attempts in the wild</h3>
	<p>Once we learned of the vulnerability, we began reviewing &nbsp;our WAF data to identify activity related to exploitation of the vulnerability. We identified requests matching potentially malicious payloads as early as 2022-05-26 00:33 UTC, indicating that knowledge of the exploit was realized by some attackers prior to the Atlassian security advisory.</p>
	<p>Since our mitigation rules were put in place, we have seen a large spike in activity starting from 2022-06-03 10:30 UTC — a little more than 10 hours after the new WAF rules were first deployed. This large spike coincides with the increased awareness of the vulnerability and release of public proof of concepts. Attackers are actively scanning for vulnerable applications at time of writing.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/06/image2-1.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Although we have seen valid attack payloads since 2022-05-26, many payloads that started matching our initial WAF mitigation rules once the advisory was released were not valid against this specific vulnerability. Examples provided below:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/06/Screenshot-2022-06-05-at-21.27.02.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>The activity above indicates that actors were using scanning tools to try and identify the attack vectors. Exact knowledge of how to exploit the vulnerability may have been consolidated amongst select attackers and may not have been widespread.</p>
	<p>The decline in WAF rule matches in the graph above after 2022-06-03 23:00 UTC is due to us releasing improved WAF rules. The new, updated rules greatly improved accuracy, reducing the number of false positives, such as the examples above.</p>
	<p>A valid malicious URL targeting a vulnerable Confluence application is shown below:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/06/Screenshot-2022-06-05-at-21.31.21-1.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>(Where <code>$HOSTNAME</code> is the host of the target application.)</p>
	<p>The URL above will run the contents of the HTTP request post body <code>eval(#parameters.data[0])</code>. Normally this will be a script that will download a web shell to the local server allowing the attacker to run arbitrary code on demand.</p>
	<p>Other example URLs, omitting the schema and hostname, include:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/06/Screenshot-2022-06-05-at-21.35.24.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Some of the activity we are observing is indicative of malware campaigns and botnet behavior. It is important to note that given the payload structure, other WAF rules have also been effective at mitigating particular variations of the attack. These include rule <strong>PHP100011</strong> and <strong>PLONE0002</strong>.</p>
	<h3 id="cloudflare-s-response-to-cve-2022-26134">Cloudflare's response to CVE-2022-26134</h3>
	<p>We have a defense-in-depth approach which uses Cloudflare to protect Cloudflare. We had &nbsp;high confidence that we were not impacted by this vulnerability due to the security measures in place. We confirmed this by leveraging our detection and response capabilities to sweep all of our internal assets and logs for signs of attempted compromise.</p>
	<p>The main actions we took in response to this incident were:</p>
	<ol>
		<li>Gathered as much information as possible about the attack.</li>
		<li>Engaged our WAF team to start working on mitigation rules for this CVE.</li>
		<li>Searched our logs for any signs of compromise.</li>
		<li>We searched the logs from our internal Confluence instances for any signs of attempted exploits. We supplemented our assessment with the pattern strings provided by Atlassian: "<code>${</code>".</li>
		<li>Any matches were reviewed to find out if they could be actual exploits. We found no signs that our systems were targeted by actual exploits.</li>
		<li>As soon as the WAF team was confident of the quality of the new rules, we started deploying them to all our servers to start protecting our customers as soon as possible. As we also use the WAF for our internal systems, our Confluence instances are also protected by the new WAF rules.</li>
		<li>We scrutinized our Confluence servers for signs of compromise and the presence of malicious implants. No signs of compromise were detected.</li>
		<li>We deployed rules to our SIEM and monitoring systems to detect any new exploitation attempt against our Confluence instances.</li>
	</ol>
	<h3 id="how-cloudflare-uses-confluence">How Cloudflare uses Confluence</h3>
	<p>Cloudflare uses Confluence internally as our main wiki platform. Many of our teams use Confluence as their main knowledge-sharing platform. Our internal instances are protected by Cloudflare Access. In previous blog posts, we described <a href="https://blog.cloudflare.com/dogfooding-from-home/">how we use Access to protect internal resources</a>. This means that every request sent to our Confluence servers must be authenticated and validated in accordance with our Access policies. No unauthenticated access is allowed.</p>
	<p>This allowed us to be confident that only Cloudflare users are able to submit requests to our Confluence instances, thus reducing the risk of external exploitation attempts.</p>
	<h3 id="what-to-do-if-you-are-using-confluence-on-prem">What to do if you are using Confluence on-prem</h3>
	<p>If you are an Atlassian customer for their on-prem products, you should patch to their latest fixed versions. We advise the following actions:</p>
	<ol>
		<li>Add Cloudflare Access as an extra protection layer for all your websites. Easy-to-follow instructions to enable Cloudflare Access are available <a href="https://developers.cloudflare.com/cloudflare-one/applications/configure-apps/self-hosted-apps/?ref=blog.cloudflare.com" target="_blank">here</a>.</li>
		<li>Enable a WAF that includes protection for CVE-2022-26134 in front of your Confluence instances. For more information on how to enable Cloudflare's WAF and other security products, check <a href="https://developers.cloudflare.com/fundamentals/get-started/task-guides/secure-your-website/?ref=blog.cloudflare.com" target="_blank">here</a>.</li>
		<li>Check the logs from your Confluence instances for signs of exploitation attempts. Look for the strings <code>/wiki/</code> and <code>${</code> in the same request.</li>
		<li>Use forensic tools and check for signs of post-exploitation tools such as webshells or other malicious implants.</li>
	</ol>
	<h3 id="indicators-of-compromise-and-attack">Indicators of compromise and attack</h3>
	<p>The following indicators are associated with activity observed in the wild by Cloudflare, as described above. These indicators can be searched for against logs to determine if there is compromise in the environment associated with the Confluence vulnerability.</p>
	<p><strong>Indicators of Compromise (IOC)</strong></p><!--kg-card-begin: html-->
	<style type="text/css">
		.tg {
			border-collapse: collapse;
			border-spacing: 0;
		}

		.tg td {
			border-color: black;
			border-style: solid;
			border-width: 1px;
			font-family: Arial, sans-serif;
			font-size: 14px;
			overflow: hidden;
			padding: 10px 5px;
			word-break: normal;
		}

		.tg th {
			border-color: black;
			border-style: solid;
			border-width: 1px;
			font-family: Arial, sans-serif;
			font-size: 14px;
			font-weight: normal;
			overflow: hidden;
			padding: 10px 5px;
			word-break: normal;
		}

		.tg .tg-c3ow {
			border-color: inherit;
			text-align: center;
			vertical-align: top
		}

		.tg .tg-0pky {
			border-color: inherit;
			text-align: left;
			vertical-align: top
		}
	</style>
	<table class="tg" width="100%">
		<thead>
			<tr>
				<th class="tg-c3ow">#</th>
				<th class="tg-c3ow">Type</th>
				<th class="tg-0pky">Value</th>
				<th class="tg-0pky">Filename/Hash</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td class="tg-0pky"><br>1</td>
				<td class="tg-0pky"><br>File</td>
				<td class="tg-0pky">50f4595d90173fbe8b85bd78a460375d8d5a869f1fef190f72ef993c73534276</td>
				<td class="tg-0pky">Filename: 45.64.json <br>Malicious file associated with exploit</td>
			</tr>
			<tr>
				<td class="tg-0pky"><br>2</td>
				<td class="tg-0pky"><br>File </td>
				<td class="tg-0pky">b85c16a7a0826edbcddbd2c17078472169f8d9ecaa7209a2d3976264eb3da0cc</td>
				<td class="tg-0pky">Filename: 45.64.rar<br>Malicious file associated with exploit</td>
			</tr>
			<tr>
				<td class="tg-0pky"><br>3</td>
				<td class="tg-0pky"><br>File </td>
				<td class="tg-0pky">90e3331f6dd780979d22f5eb339dadde3d9bcf51d8cb6bfdc40c43d147ecdc8c</td>
				<td class="tg-0pky">Filename: 45.640.txt<br>Malicious file associated with exploit</td>
			</tr>
			<tr>
				<td class="tg-c3ow">4</td>
				<td class="tg-c3ow">File </td>
				<td class="tg-0pky">1905fc63a9490533dc4f854d47c7cb317a5f485218173892eafa31d7864e2043</td>
				<td class="tg-0pky">Filename: 45.647.txt<br>Malicious file associated with exploit</td>
			</tr>
			<tr>
				<td class="tg-c3ow">5</td>
				<td class="tg-c3ow">File </td>
				<td class="tg-0pky">5add63588480287d1aee01e8dd267340426df322fe7a33129d588415fd6551fc</td>
				<td class="tg-0pky">Filename: lan (perl script)<br>Malicious file associated with exploit</td>
			</tr>
			<tr>
				<td class="tg-c3ow">6</td>
				<td class="tg-c3ow">File </td>
				<td class="tg-0pky">67c2bae1d5df19f5f1ac07f76adbb63d5163ec2564c4a8310e78bcb77d25c988</td>
				<td class="tg-0pky">Filename: jui.sh<br>Malicious file associated with exploit</td>
			</tr>
			<tr>
				<td class="tg-c3ow">7</td>
				<td class="tg-c3ow">File</td>
				<td class="tg-0pky">281a348223a517c9ca13f34a4454a6fdf835b9cb13d0eb3ce25a76097acbe3fb</td>
				<td class="tg-0pky">Filename: conf<br>Malicious file associated with exploit</td>
			</tr>
		</tbody>
	</table><!--kg-card-end: html-->
	<p><strong><strong>Indicators of Attack (IOA)</strong></strong></p><!--kg-card-begin: markdown-->
	<table>
		<thead>
			<tr>
				<th style="text-align:center">#</th>
				<th style="text-align:center">Type</th>
				<th>Value</th>
				<th>Description</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td style="text-align:center">1</td>
				<td style="text-align:center">URL String</td>
				<td><code>${</code></td>
				<td>String used to craft malicious payload</td>
			</tr>
			<tr>
				<td style="text-align:center">2</td>
				<td style="text-align:center">URL String</td>
				<td><code>javax.script.ScriptEngineManager</code></td>
				<td>String indicative of ScriptEngine manager to craft malicious payloads</td>
			</tr>
		</tbody>
	</table>
	<!--kg-card-end: markdown-->
</div>