<div class="mb2 gray5">5 min read</div>
<div class="mt4">This post is also available in <a href="https://blog.cloudflare.com/zh-cn/moobot-vs-gatebot-cloudflare-automatically-blocks-botnet-ddos-attack-topping-at-654-gbps">简体中文</a>.</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6SYhHA9eMPIJcEVqPmJYJX/3db523248e03e12fd0a2141d81b85b1d/moobot-vs-gatebot-cloudflare-automatically-blocks-botnet-ddos-attack-topping-at-654-gbps.png" alt="">
<div class="post-content lh-copy gray1">
	<p>On July 3, Cloudflare’s global DDoS protection system, <a href="https://blog.cloudflare.com/meet-gatebot-a-bot-that-allows-us-to-sleep">Gatebot</a>, automatically detected and mitigated a <a href="https://www.cloudflare.com/learning/ddos/udp-flood-ddos-attack">UDP-based DDoS attack</a> that peaked at 654 Gbps. The attack was part of a ten-day multi-vector DDoS campaign targeting a <a href="https://www.cloudflare.com/magic-transit">Magic Transit</a> customer and was mitigated without any human intervention. The DDoS campaign is believed to have been generated by Moobot, a <a href="https://blog.cloudflare.com/inside-mirai-the-infamous-iot-botnet-a-retrospective-analysis">Mirai</a>-based botnet. No downtime, service degradation, or false positives were reported by the customer.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5tZOVVWcnoNircFk2dzvgB/f4360a467a489cd7ee38f976e2e4dc1d/image7-3.png" alt="" class="kg-image" width="1926" height="1122" loading="lazy">

	</figure>
	<p><b>Moobot Targets 654 Gbps towards a Magic Transit Customer</b></p>
	<p>Over those ten days, our systems automatically detected and mitigated over 5,000 DDoS attacks against this one customer, mainly UDP floods, SYN floods, ACK floods, and GRE floods. The largest DDoS attack was a UDP flood and lasted a mere 2 minutes. This attack targeted only one IP address but hit multiple ports. The attack originated from 18,705 unique IP addresses, each believed to be a Moobot-infected IoT device.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1SBAfKZG8YJHkfEBJnZyHV/655adca6d9f31d78fcc714e9fb49e4ac/image2-3.png" alt="" class="kg-image" width="1999" height="964" loading="lazy">

	</figure>
	<p><b>Attack Distribution by Country - From 100 countries</b></p>
	<p>The attack was observed in Cloudflare’s data centers in 100 countries around the world. Approximately 89% of the attack traffic originated from just 10 countries with the US leading at 41%, followed by South Korea and Japan in second place (12% each), and India in third (10%). What this likely means is that the malware has infected at least 18,705 devices in 100 countries around the world.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4L3iXSkvCp4kDRwUkyjr3d/61490559c472b36b1aa959be999e65d5/image5-4.png" alt="" class="kg-image" width="1281" height="873" loading="lazy">

	</figure>
	<p><b>Attack Distribution by Country - Top 10</b></p>
	<div class="flex anchor relative">
		<h2 id="moobot-self-propagating-malware">Moobot - Self Propagating Malware</h2>
		<a href="https://blog.cloudflare.com/#moobot-self-propagating-malware" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>‘Moobot’ sounds like a cute name, but there’s nothing cute about it. According to <a href="https://blog.netlab.360.com/ddos-botnet-moobot-en">Netlab 360</a>, Moobot is the codename of a self-propagating Mirai-based <a href="https://www.cloudflare.com/learning/ddos/glossary/malware">malware</a> first discovered in 2019. It infects IoT (Internet of Things) devices using remotely exploitable vulnerabilities or weak default passwords. IoT is a term used to describe smart devices such as security hubs and cameras, smart TVs, smart speakers, smart lights, sensors, and even refrigerators that are connected to the Internet.</p>
	<p>Once a device is infected by Moobot, control of the device is transferred to the operator of the command and control (C2) server, who can issue commands remotely such as attacking a target and locating additional vulnerable IoT devices to infect (self-propagation).</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7YKDGZ9yqbvb1TuYFqqYM/e72ce62dd004ea672ad3272f70b40c6e/image9.gif" alt="" class="kg-image" width="1999" height="1049" loading="lazy">

	</figure>
	<p>Moobot is a Mirai-based botnet, and has <a href="https://blog.cloudflare.com/inside-mirai-the-infamous-iot-botnet-a-retrospective-analysis">similar capabilities (modules) as Mirai</a>:</p>
	<ol>
		<li>
			<p><b>Self-propagation</b> - The self-propagation module is in charge of the botnet’s growth. After an IoT device is infected, it randomly scans the Internet for open telnet ports and reports back to the C2 server. Once the C2 server gains knowledge of open telnet ports around the world, it tries to leverage known vulnerabilities or brute force its way into the IoT devices with common or default credentials.</p>
		</li>
	</ol>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7ve4CTJV9L3BAVMbNMfo0a/a116c9059f8699a408cef7c13b38fe89/image6-3.png" alt="" class="kg-image" width="1255" height="808" loading="lazy">

	</figure>
	<p>Self-propagation</p>
	<p>2. <b>Synchronized attacks</b> - The C2 server orchestrates a coordinated flood of packets or HTTP requests with the goal of creating a denial of service event for the target's website or service.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/43xBoL19Y8IoRYqMdCmGio/e92ef9bd26ae5420d18e119166617553/image3-7.png" alt="" class="kg-image" width="1256" height="670" loading="lazy">

	</figure>
	<p>Synchronized attacks</p>
	<p>The botnet operator may use multiple C2 servers in various locations around the world in order to reduce the risk of exposure. Infected devices may be assigned to different C2 servers varying by region and module; one server for self-propagation and another for launching attacks. Thus if a C2 server is compromised and taken down by law enforcement authorities, only parts of the botnet are deactivated.</p>
	<div class="flex anchor relative">
		<h2 id="why-this-attack-was-not-successful">Why this attack was not successful</h2>
		<a href="https://blog.cloudflare.com/#why-this-attack-was-not-successful" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>This is the second large scale attack in the past few months that we observed on Cloudflare's network. The previous one peaked at <a href="https://blog.cloudflare.com/mitigating-a-754-million-pps-ddos-attack-automatically">754M packets per second</a> and attempted to take down our routers with a high packet rate. Despite the high packet rate, the 754Mpps attack peaked at a <i>mere</i> 253 Gbps.</p>
	<p>As opposed to the high packet rate attack, this attack was a high bit rate attack, peaking at 654 Gbps. Due to the high bit rates of this attack, it seems as though the attacker tried (and failed) to cause a denial of service event by saturating our Internet link capacity. So let’s explore why this attack was not successful.</p>
	<div class="flex anchor relative">
		<h3 id="avoiding-link-saturation-keeping-appliances-running">Avoiding link saturation &amp; keeping appliances running</h3>
		<a href="https://blog.cloudflare.com/#avoiding-link-saturation-keeping-appliances-running" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>Cloudflare’s global <a href="https://www.cloudflare.com/network">network</a> capacity is over 42 Tbps and growing. Our network spans more than 200 cities in over 100 countries, including 17 cities in mainland China. It interconnects with over 8,800 networks globally, including major ISPs, cloud services, and enterprises. This level of interconnectivity along with the use of <a href="https://www.cloudflare.com/learning/cdn/glossary/anycast-network">Anycast</a> ensures that our network can easily absorb even the largest attacks.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2kvrwYIA87fmnWCTKdl7Wi/67748d4b866d2042e2b5fb40b90207d8/image4-7.png" alt="" class="kg-image" width="1907" height="1161" loading="lazy">

	</figure>
	<p>The Cloudflare Network</p>
	<p>After traffic arrives at an edge data center, it is then load-balanced efficiently using our own Layer 4 load-balancer that we built, <a href="https://blog.cloudflare.com/unimog-cloudflares-edge-load-balancer">Unimog</a>, which uses our appliances' health and other metrics to load-balance traffic intelligently within a data center to avoid overwhelming any single server.</p>
	<p>Besides the use of Anycast for inter-data center load balancing and Unimog for intra-data center load balancing, we also utilize various forms of traffic engineering in order to deal with sudden changes in traffic loads across our network. We utilize both automatic and manual traffic engineering methods that can be employed by our 24/7/365 Site Reliability Engineering (SRE) team.</p>
	<p>These combined factors significantly reduce the likelihood of a denial of service event due to link saturation or appliances being overwhelmed -- and as seen in this attack, no link saturation occurred.</p><!--kg-card-begin: html-->
	<h2 id="ddos-detect-mitigate">Detecting &amp; Mitigating DDoS attacks</h2><!--kg-card-end: html-->
	<p>Once traffic arrives at our edge, it encounters our three software-defined <a href="https://www.cloudflare.com/ddos">DDoS protection</a> systems:</p>
	<ol>
		<li>
			<p><a href="https://blog.cloudflare.com/meet-gatebot-a-bot-that-allows-us-to-sleep">Gatebot</a> - Cloudflare’s centralized DDoS protection systems for detecting and mitigating globally distributed volumetric DDoS attacks. Gatebot runs in our network’s core data center. It receives samples from every one of our edge data centers, analyzes them, and automatically sends mitigation instructions when attacks are detected. Gatebot is also synchronized to each of our customers’ web servers to identify its health and triggers mitigation accordingly.</p>
		</li>
		<li>
			<p><a href="https://blog.cloudflare.com/rolling-with-the-punches-shifting-attack-tactics-dropping-packets-faster-cheaper-at-the-edge">dosd</a> (denial of service daemon) - Cloudflare’s decentralized DDoS protection systems. dosd runs autonomously in each server in every Cloudflare data center around the world, analyzing traffic and applying local mitigation rules when needed. Besides being able to detect and mitigate attacks at super-fast speeds, dosd significantly improves our network resilience by delegating the detection and mitigation capabilities to the edge.</p>
		</li>
		<li>
			<p><a href="https://blog.cloudflare.com/announcing-flowtrackd">flowtrackd</a> (flow tracking daemon) - Cloudflare’s TCP state tracking machine for detecting and mitigating the most randomized and sophisticated TCP-based DDoS attacks in unidirectional routing topologies (such as the case for <a href="https://www.cloudflare.com/magic-transit">Magic Transit</a>). flowtrackd is able to identify the state of a TCP connection and then drops, challenges, or rate-limits packets that don’t belong to a legitimate connection.</p>
		</li>
	</ol>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/78iByRWxPrVk9LKN9jJede/e4fb1f012c8e781fe35a2b9c41f4c175/image1-9.png" alt="" class="kg-image" width="1999" height="1197" loading="lazy">

	</figure>
	<p>Cloudflare DDoS Protection Lifecycle</p>
	<p>The three DDoS protection systems collect traffic samples in order to detect DDoS attacks. The types of traffic data that they sample include:</p>
	<ol>
		<li>
			<p><b>Packet fields</b> such as the source IP, source port, destination IP, destination port, protocol, TCP flags, sequence number, options, and packet rate.</p>
		</li>
		<li>
			<p><b>HTTP request metadata</b> such as HTTP headers, user agent, query-string, path, host, HTTP method, HTTP version, TLS cipher version, and request rate.</p>
		</li>
		<li>
			<p><b>HTTP response metrics</b> such as error codes returned by customers’ origin servers and their rates.</p>
		</li>
	</ol>
	<p>Our systems then crunch these sample data points together to form a real-time view of our network’s security posture and our customer’s origin server health. They look for attack patterns and traffic anomalies. When found, a mitigation rule with a dynamically crafted attack signature is generated in real-time. Rules are propagated to the most optimal place for cost-effective mitigation. For example, an L7 HTTP flood might be dropped at L4 to reduce the CPU consumption.</p>
	<p>Rules that are generated by dosd and flowtrackd are propagated within a single data center for rapid mitigation. Gatebot’s rules are propagated to all of the edge data centers which then take priority over dosd’s rules for an even and optimal mitigation. Even if the attack is detected in a subset of edge data centers, Gatebot propagates the mitigation instructions to all of Cloudflare’s edge data centers -- effectively sharing the threat intelligence across our network as a form of proactive protection.</p>
	<p>In the case of this attack, in each edge data center, dosd generated rules to mitigate the attack promptly. Then as Gatebot received and analyzed samples from the edge, it determined that this was a globally distributed attack. Gatebot propagated unified mitigation instructions to the edge, which prepared each and every one of our 200+ data centers to tackle the attack as the attack traffic may shift to a different data center due to Anycast or traffic engineering.</p>
	<div class="flex anchor relative">
		<h3 id="no-inflated-bills">No inflated bills</h3>
		<a href="https://blog.cloudflare.com/#no-inflated-bills" aria-hidden="true" class="relative sm:absolute sm:-left-5">
			<svg width="16" height="16" viewBox="0 0 24 24">
				<path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path>
			</svg>
		</a>
	</div>
	<p>DDoS attacks obviously pose the risk of an outage and service disruption. But there is another risk to consider -- the cost of mitigation. During these ten days, more than 65 Terabytes of attack traffic were generated by the botnet. However, as part of Cloudflare’s <a href="https://blog.cloudflare.com/unmetered-mitigation">unmetered DDoS protection</a> guarantee, Cloudflare mitigated and absorbed the attack traffic without billing the customer. The customer doesn't need to submit a retroactive credit request. Attack traffic is automatically excluded from our billing system. We eliminated the financial risk.</p>
</div>