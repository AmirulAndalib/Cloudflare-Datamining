<div class="mb2 gray5">4 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/09/image2-4.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>On August 25, 2021, Atlassian released a <a href="https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html">security advisory for their Confluence Server and Data Center</a>. The advisory highlighted an Object-Graph Navigation Language (OGNL) injection that would result in an unauthenticated attacker being able to execute arbitrary code.</p>
	<p>A full proof of concept (PoC) of the attack <a href="https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md">was made available by a security researcher</a> on August 31, 2021. Cloudflare immediately reviewed the PoC and prepared a mitigation rule via an <a href="https://developers.cloudflare.com/waf/change-log/2021-09-01---emergency-release">emergency release</a>. The rule, once tested, was deployed on September 1, 2021, at 15:32 UTC with a default action of <code>BLOCK</code> and the following IDs:</p>
	<ul>
		<li><code>100400</code> (for our legacy WAF)</li>
		<li><code>e8c550810618437c953cf3a969e0b97a</code> (for our <a href="https://blog.cloudflare.com/new-cloudflare-waf">new WAF</a>)</li>
	</ul>
	<p>All customers using the <a href="https://www.cloudflare.com/waf">Cloudflare WAF</a> to protect their self-hosted Confluence applications have automatically been protected since the new rule was deployed last week. Additionally, the Cloudflare WAF started blocking a high number of potentially malicious requests to Confluence applications even before the rule was deployed.</p>
	<p>And customers who had deployed <a href="https://www.cloudflare.com/teams/access">Cloudflare Access</a> in front of their Confluence applications were already protected even before the emergency release. Access checks every request made to a protected hostname for a JSON Web Token (<a href="https://developers.cloudflare.com/cloudflare-one/identity/users/validating-json">JWT</a>) containing a user’s identity. Any unauthenticated users attempting this exploit would have been blocked before they could reach the Confluence server.</p>
	<p>Customers must, however, immediately update their self-hosted Confluence installations to the versions listed in <a href="https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html">the advisory</a> to ensure full protection.</p>
	<p>This vulnerability was assigned the <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-26084">CVE number 2021-26084</a> and has a base score of 9.8 — critical. A detailed technical write-up of the vulnerability along with the PoC can <a href="https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md">be found on GitHub</a>.</p>
	<h3 id="timeline-of-events">Timeline of Events</h3>
	<p>A timeline of events is provided below:</p><!--kg-card-begin: markdown-->
	<table>
		<thead>
			<tr>
				<th>2021-08-25 at 17:00 UTC</th>
				<th>Atlassian security advisory released</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>2021-08-28</td>
				<td>Cloudflare WAF starts seeing and blocking malicious traffic targeting vulnerable endpoints related to the security advisory</td>
			</tr>
			<tr>
				<td>2021-08-31 at 22:22 UTC</td>
				<td>A PoC becomes widely available</td>
			</tr>
			<tr>
				<td>2021-09-01 at 15:32 UTC</td>
				<td>Additional Cloudflare WAF rule to target CVE-2021-26084</td>
			</tr>
		</tbody>
	</table>
	<!--kg-card-end: markdown-->
	<h3 id="how-soon-were-attackers-probing-vulnerable-endpoints">How soon were attackers probing vulnerable endpoints?</h3><!--kg-card-begin: markdown-->
	<p>High profile vulnerabilities tend to be exploited very quickly by attackers once a PoC or a patch becomes available. Cloudflare maintains aggregated and sampled data on WAF blocks<sup>1</sup> that can be used to explore how quickly vulnerable endpoints start receiving malicious traffic, highlighting the importance of deploying patches as quickly as possible.</p>
	<!--kg-card-end: markdown-->
	<p>Cloudflare data suggests that scanning for the vulnerability started up to three days before the first publicly available PoC was published, as high WAF activity was observed on vulnerable endpoints beginning August 28, 2021. This activity may indicate that attackers or researchers had successfully reverse engineered the patch within that time frame.</p>
	<p>It also shows that, even without the specific WAF rule that we rolled out for this vulnerability, Cloudflare was blocking attempts to exploit it. Other WAF rules picked up the suspect behavior.</p>
	<p>For this vulnerability, two endpoints are highlighted that can be used to explore attack traffic:</p>
	<ul>
		<li><code>/pages/doenterpagevariables.action</code></li>
		<li><code>/pages/createpage-entervariables.action</code></li>
	</ul>
	<p>The following graph shows traffic matching Cloudflare’s WAF security feature from August 21 to September 5, 2021. Specifically:</p>
	<ul>
		<li>In blue: HTTP requests blocked by Cloudflare’s WAF matching the two chosen paths.</li>
		<li>In red: HTTP requests blocked by Cloudflare’s WAF matching the two paths and the specific rule deployed to cover this vulnerability.</li>
	</ul>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/09/image1-3.png" class="kg-image" alt="Line chart showing traffic trends to the vulnerable endpoints from the August 21 to September 5" loading="lazy" title="Chart"></figure>
	<p>By looking at the data, an increase in activity can be seen starting from August 28, 2021 — far beyond normal Internet background noise levels. Additionally, more than 64% of the traffic increase was detected and blocked by the Cloudflare WAF as malicious on the day the PoC was available.</p>
	<h3 id="what-were-attackers-trying-before-a-poc-was-widely-available">What were attackers trying before a PoC was widely available?</h3>
	<p>Just before a PoC became widely available, an increasing number of requests were blocked by customer configured IP based rules, followed by our <a href="https://developers.cloudflare.com/waf/managed-rulesets">Managed Rulesets</a> and rate limiting. Most custom WAF rules and IP based rules are created by customers either in response to malicious activity in the WAF logs, or as a positive security model to lock down applications that should simply not have public access from the Internet.</p>
	<p>We can zoom into the Managed WAF rule matches to explore what caused the WAF to trigger before the specific rule was deployed:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/09/image3-2.png" class="kg-image" alt="bar chart distribution of attack types detected from the August 28 to of September 1" loading="lazy" title="Chart"></figure>
	<p>Command injection based attacks were the most common vector attempted before a PoC was made widely available, indicating again that some attackers may have been at least partially aware of the nature of the vulnerability. These attacks are aimed at executing remote code on the target application servers and are often platform specific. Other attack types observed, in order of frequency were:</p>
	<ul>
		<li>Request Port Anomalies: these are HTTP requests to uncommon ports that are normally not exposed for HTTP traffic.</li>
		<li>Fake Bot Signatures: these requests matched many of our rules aimed at detecting user agents spoofing themselves as popular bots such as Google, Yandex, Bing and others.</li>
		<li>OWASP Inbound Anomaly Score Exceeded: these are requests that were flagged by our implementation of the <a href="https://owasp.org/www-project-modsecurity-core-rule-set">OWASP ModSecurity Core Ruleset</a>. The OWASP ruleset is a score based system that scans requests for patterns of characters that normally identify malicious requests;</li>
		<li>HTTP Request Anomalies: these requests triggered many of our HTTP based validation checks including but not limited to RFC compliance checks.</li>
	</ul>
	<h3 id="conclusions">Conclusions</h3>
	<p>Patching zero-day attacks as quickly as possible is vital for security. No single approach can be 100% successful at mitigating intrusion attempts. By observing patterns and triggers for this specific CVE, it is clear that a layered approach is most effective for protecting critical infrastructure. Cloudflare data also implies that, at least in part, some attackers or researchers were aware of the nature of the vulnerability at least since August 28, 2021, three days before a PoC was made widely available.</p>
	<p>...</p><!--kg-card-begin: markdown-->
	<p><sup>1</sup>The WAF block data consists of sampled matches of request fields including path, geography, rule ID, timestamp and other similar metadata.</p>
	<!--kg-card-end: markdown-->
</div>