<div class="mb2 gray5">19 min read</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/6WNpBsAcAwehplOT4Hiuub/39aea7528abc818c4d792a523c8f8652/1622-1-Hero.png" alt="">
<div class="post-content lh-copy gray1">
	<p>Cloudflare handles over 60 million HTTP requests per second globally, with <a href="https://radar.cloudflare.com/adoption-and-usage"><u>approximately 70%</u></a> received over <a href="https://datatracker.ietf.org/doc/html/rfc9293"><u>TCP</u></a> connections (the remaining are <a href="https://datatracker.ietf.org/doc/html/rfc9000"><u>QUIC</u></a>/<a href="https://datatracker.ietf.org/doc/html/rfc768"><u>UDP</u></a>). Ideally, every new TCP connection to Cloudflare would carry at least one request that results in a successful data exchange, but that is far from the truth. In reality, we find that, globally, <a href="https://radar.cloudflare.com/security-and-attacks/#tcp-resets-and-timeouts"><u>approximately 20%</u></a> of new TCP connections to Cloudflare’s servers time out or are closed with a TCP “abort” message either before any request can be completed or immediately after an initial request.</p>
	<p>This post explores those connections that, for various reasons, appear to our servers to have been halted unexpectedly before any useful data exchange occurs. Our work reveals that while connections are normally ended by clients, they can also be closed due to third-party interference. Today we’re excited to launch a new <a href="https://radar.cloudflare.com/security-and-attacks#tcp-resets-and-timeouts"><u>dashboard</u></a> and <a href="https://developers.cloudflare.com/api/operations/radar-get-tcp-resets-timeouts-summary"><u>API endpoint</u></a> on Cloudflare Radar that shows a near real-time view of TCP connections to Cloudflare’s network that terminate within the first 10 ingress packets due to resets or timeouts, which we’ll refer to as <i>anomalous</i> TCP connections in this post. Analyzing this anomalous behavior provides insights into scanning, connection tampering, DoS attacks, connectivity issues, and other behaviors.</p>
	<p>Our ability to generate and share this data via Radar follows from a global investigation into <a href="https://blog.cloudflare.com/connection-tampering"><u>connection tampering</u></a>. Readers are invited to read the technical details in the peer-review <a href="https://research.cloudflare.com/publications/SundaraRaman2023"><u>study</u></a>, or see its <a href="https://youtu.be/RD73IgzQMFo?si=OWvNnlNNLalbhygV&amp;t=2984"><u>corresponding presentation</u></a>. Read on for a primer on how to use and interpret the data, as well as how we designed and deployed our detection mechanisms so that others might replicate our approach.</p>
	<p>To begin, let’s discuss our classification of normal vs anomalous TCP connections.</p>
	<h2>TCP connections from establishment to close</h2>
	<p>The Transmission Control Protocol (TCP) is a protocol for reliably transmitting data between two hosts on the Internet (<a href="https://datatracker.ietf.org/doc/rfc9293"><u>RFC 9293</u></a>). A TCP connection passes through several distinct stages, from connection establishment, to data transfer, to connection close.</p>
	<p>A TCP connection is established with a 3-way handshake. The handshake begins when one party, called the client, sends a packet marked with the ‘SYN’ flag to initialize the connection process. The server responds with a “SYN+ACK” packet where the ‘ACK’ flag acknowledges the client’s initialization ‘SYN’. Additional synchronization information is included in both the initialization packet and its acknowledgement. . Finally, the client acknowledges the server’s SYN+ACK packet with a final ACK packet to complete the handshake.</p>
	<p>The connection is then ready for data transmission. Typically, the client will set the PSH flag on the first data-containing packet to signal to the server’s TCP stack to forward the data immediately up to the application. Both parties continue to transfer data and acknowledge received data until the connection is no longer needed, at which point the connection is closed.</p>
	<p><a href="https://datatracker.ietf.org/doc/html/rfc9293#section-3.6"><u>RFC 9293</u></a> describes two ways in which a TCP connection may be closed:</p>
	<ul>
		<li>
			<p>The normal and graceful TCP close sequence uses a FIN exchange. Either party can send a packet with the FIN flag set to indicate that they have no more data to transmit. Once the other party acknowledges that FIN packet, that direction of the connection is closed. When the acknowledging party is finished transmitting data, it transmits its own FIN packet to close, since each direction of the connection must be closed independently.</p>
		</li>
		<li>
			<p>An abort or “reset” signal in which one party transmits RST packets, instructing the other party to immediately close and discard any connection state. Resets are generally sent when some unrecoverable error has occurred.</p>
		</li>
	</ul>
	<p>The full lifetime of a connection that closes gracefully with a FIN is captured in the following sequence diagram.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/eh8fIM3Ei3Y9WapGgRuhC/7368c0c590846a42822b930958d4ddae/1622-2.png" alt="1622-2" class="kg-image" width="1060" height="1064" loading="lazy">

	</figure>
	<p><i><sub>A normal TCP connection starts with a 3-way handshake and ends with a FIN handshake</sub></i></p>
	<p>Additionally, a TCP connection may be terminated by a <a href="https://blog.cloudflare.com/when-tcp-sockets-refuse-to-die"><u>timeout</u></a> which specifies the maximum duration that a connection can be active without receiving data or acknowledgements. An inactive connection, for example, can be kept open with <a href="https://blog.cloudflare.com/when-tcp-sockets-refuse-to-die"><u>keepalive</u></a> messages. Unless overridden, the global default duration specified in RFC 9293 is five minutes.</p>
	<p>We consider TCP connections <i>anomalous</i> when they close via either a reset or timeout from the client side.</p>
	<h2>Sources of anomalous connections</h2>
	<p>Anomalous TCP connections may not themselves be problematic but they can be a symptom of larger issues, especially when occurring at early (pre-data) stages of TCP connections. Below is a non-exhaustive list of potential reasons that we might observe resets or timeouts:</p>
	<ul>
		<li>
			<p><b>Scanners: </b>Internet scanners may send a SYN packet to probe if a server responds on a given port, but otherwise fail to clean up a connection once the probe has elicited a response from the server.</p>
		</li>
		<li>
			<p><b>Sudden Application Shutdowns: </b>Applications might abruptly close open connections if they are no longer required. For example, web browsers may send RSTs to terminate connections after a tab is closed, or connections can time out if devices lose power or connectivity.</p>
		</li>
		<li>
			<p><b>Network Errors: </b>Unstable network conditions (e.g., a severed cable connection could result in connection timeouts)</p>
		</li>
		<li>
			<p><b>Attacks: </b>A malicious client may send attack traffic that appears as anomalous connections. For instance, in a <a href="https://www.cloudflare.com/learning/ddos/syn-flood-ddos-attack"><u>SYN flood</u></a> (half-open) attack, an attacker repeatedly sends SYN packets to a target server in an attempt to overwhelm resources as it maintains these half-opened connections.</p>
		</li>
		<li>
			<p><b>Tampering:</b> Firewalls or other middleboxes capable of intercepting packets between a client and server may drop packets, causing timeouts at the communicating parties. Middleboxes capable of deep packet inspection (DPI) might also leverage the fact that the TCP protocol is unauthenticated and unencrypted to <a href="https://en.wikipedia.org/wiki/Packet_injection"><i><u>inject</u></i><u> packets</u></a> to disrupt the connection state. See our <a href="https://blog.cloudflare.com/connection-tampering"><u>accompanying blog post</u></a> for more details on connection tampering.</p>
		</li>
	</ul>
	<p>Understanding the scale and underlying reasons for anomalous connections can help us to mitigate failures and build a more robust and reliable network. We hope that sharing these insights publicly will help to improve transparency and accountability for networks worldwide.</p>
	<h2 id="dataset">How to use the dataset</h2>
	<p>In this section, we provide guidance and examples of how to interpret the TCP resets and timeouts dataset by broadly describing three use cases: confirming previously-known behaviors, exploring new targets for followup study, and longitudinal studies to capture changes in network behavior over time.</p>
	<p>In each example, the plot lines correspond to the stage of the connection in which the anomalous connection closed, which provides valuable clues into what might have caused the anomaly. We place each incoming connection into one of the following stages:</p>
	<p><b>Post-SYN (mid-handshake)</b>: Connection resets or timeouts after the server received a client’s SYN packet. Our servers will have replied, but no acknowledgement ACK packet has come back from the client before the reset or timeout. <a href="https://www.cloudflare.com/learning/ddos/glossary/ip-spoofing"><u>Packet spoofing</u></a> is common at this connection stage, so geolocation information is especially unreliable.</p>
	<p><b>Post-ACK (immediately post-handshake)</b>: Connection resets or timeouts after the handshake completes and the connection is established successfully. Any subsequent data, that may have been transmitted, never reached our servers.</p>
	<p><b>Post-PSH (after first data packet)</b>: Connection resets or timeouts after the server received a packet with the PSH flag set. The PSH flag indicates that the TCP packet contains data (such as a <a href="https://www.cloudflare.com/en-gb/learning/ssl/what-happens-in-a-tls-handshake/#:~:text=The%20%27client%20hello%27%20message%3A"><u>TLS Client Hello</u></a> message) that is ready to be delivered to the application.</p>
	<p><b>Later (after multiple data packets)</b>: Connection resets within the first 10 packets from the client, but after the server has received multiple data packets.</p>
	<p><b>None</b>: All other connections.</p>
	<p>To keep focus on legitimate connections, the dataset is constructed after connections are processed and filtered by Cloudflare’s attack mitigation systems.&nbsp; For more details on how we construct the dataset, see <a href="https://blog.cloudflare.com/#anomalousTCP"><u>below.</u></a></p>
	<h3>Start with a self-evaluation</h3>
	<p>To start, we encourage readers to visit the <a href="https://radar.cloudflare.com/security-and-attacks#tcp-resets-and-timeouts"><u>dashboard on Radar</u></a> to view the results worldwide, and for their own country and ISP.</p>
	<p>Globally, as shown below, about 20% of new TCP connections to Cloudflare’s network are closed by a reset or timeout within the first 10 packets from the client. While this number seems astonishingly high, it is in-line with prior studies. As we’ll see, rates of resets and timeouts vary widely by country and network, and this variation is lost in the global averages.</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2cR6Nfm1H3juXU6oB9RS9o/50826cdcb0babc77f5abcdf41b5126c4/1622-3.png" alt="1622-3" class="kg-image" width="1999" height="1125" loading="lazy">
	</figure>
	<p><i><sub>via </sub></i><a href="https://radar.cloudflare.com/security-and-attacks?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><i><sub>Cloudflare Radar</sub></i></a></p>
	<p>The <a href="https://radar.cloudflare.com/us"><u>United States</u></a>, my home country, shows anomalous connection rates slightly lower than the worldwide averages, largely due to lower rates for connections closing in the Post-ACK and Post-PSH stages (those stages are more reflective of middlebox <a href="https://blog.cloudflare.com/connection-tampering"><u>tampering</u></a> behavior). The elevated rates of Post-SYN are typical in most networks due to scanning, but may include packets that spoof the true client’s IP address. Similarly, high rates of connection resets in the Later connection stage (after the initial data exchange, but still within the first 10 packets) might be applications responding to human actions, such as browsers using RSTs to close unwanted TCP connections after a tab is closed.</p>
	<figure class="kg-card kg-image-card">
		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2hRm0W9UEhzZ9olt89yvgx/18be0248bfd1b95da6159a9887dd0f81/1622-4.png" alt="1622-4" class="kg-image" width="1999" height="1125" loading="lazy">
	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/us?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>My home ISP <a href="https://radar.cloudflare.com/as22773"><u>AS22773 (Cox Communications)</u></a> shows rates comparable to the US as a whole. This is typical of most residential ISPs operating in the United States.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/SYQfFbeBYgrlv4p6q75l8/54fa5ecc6aad1c7fdf4942896cba4092/1622-5.png" alt="1622-5" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS22773?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Contrast this against <a href="https://radar.cloudflare.com/as15169"><u>AS15169 (Google LLC)</u></a>, which originates many of Google’s <a href="https://developers.google.com/search/docs/crawling-indexing/overview-google-crawlers"><u>crawlers and fetchers</u></a>. This network shows significantly lower rates of resets in the “Later" connection stage, which may be explained by the larger proportion of automated traffic, not driven by human user actions (such as closing browser tabs).</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/CXdHL80q8qjJ3zbQUOJXT/490310bf5d656feeb753bb28fe9ab408/1622-6.png" alt="1622-6" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS15169?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Indeed, our <a href="https://radar.cloudflare.com/traffic"><u>bot detection system</u></a> classifies over 99% of HTTP requests from AS15169 as automated. This shows the value of collating different types of data on Radar.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/cTokDpCivHG1RLV2vHZaj/ea32037b7a74a7a77685713a06d54e23/1622-7.png" alt="1622-7" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/traffic/AS15169?dateStart=2024-07-28&amp;dateEnd=2024-08-26#bot-vs-human"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>The new anomalous connections dataset, like most that appear on Radar, is passive – it only reports on observable events, not what causes them. In this spirit, the graphs above for Google’s network reinforce the reason for corroborating observations, as we discuss next.</p>
	<h2>One view for a signal, more views for corroboration</h2>
	<p>Our passive measurement approach works at Cloudflare scale. However, it does not identify root causes or ground truth on its own. There are many plausible explanations for why a connection closed in a particular stage, especially when the closure is due to reset packets and timeouts. Attempts to explain by relying solely on this data source can only lead to speculation.&nbsp;</p>
	<p>However, this limitation can be overcome by combining with other data sources such as active measurements. For example, corroborating with reports from <a href="https://ooni.org"><u>OONI</u></a> or <a href="https://censoredplanet.org"><u>Censored Planet</u></a>, or with on-the-ground reports, can give a more complete story. Thus, one of the major use cases for the TCP resets and timeouts dataset is to understand the scale and impact of previously-documented phenomena.</p>
	<h3>Corroborating Internet-scale measurement projects</h3>
	<p>Looking at <a href="https://radar.cloudflare.com/as398324"><u>AS398324</u></a> would suggest something terribly wrong, with more than half of connections showing up as anomalous in the Post-SYN stage. However, this network turns out to be CENSYS-ARIN-01, from Internet scanning company <a href="https://censys.com"><u>Censys</u></a>. Post-SYN anomalies can be the result of network-layer scanning, where the scanner sends a single SYN packet to probe the server, but does not complete the TCP handshake. There are also high rates of Later anomalies, which could be indicative of application-layer scanning, as indicated by the near 100% proportion of connections being classified as automated.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2D4kF4Uphgq33pPsjEHbwS/afdd7f0b55d1f8d42a615f86cb36933f/1622-8.png" alt="1622-8" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS398324?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Indeed, similar to AS15169, we classify over 99% of requests from AS398324 as automated.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/7hmzGC09VELKJpeX5tx7Eq/ea9b6c54ab27e46452037e6028b3923d/1622-9.png" alt="1622-9" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/traffic/AS398324?dateStart=2024-07-28&amp;dateEnd=2024-08-26#bot-vs-human"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>So far, we’ve looked at networks that generate high volumes of scripted or automated traffic. It’s time to look further afield.</p>
	<h3>Corroborating connection tampering</h3>
	<p>The starting point of this dataset was a research project to understand and detect active connection tampering, in a similar spirit to our work on <a href="https://blog.cloudflare.com/monsters-in-the-middleboxes"><u>HTTPS interception</u></a>. The reasons we set out to do are explained in detail in our <a href="https://blog.cloudflare.com/connection-tampering"><u>accompanying blog post</u></a>.</p>
	<p>A <a href="https://go.gale.com/ps/anonymous?id=GALE%7CA175630128&amp;it=r&amp;linkaccess=abs&amp;issn=10727825"><u>well-documented</u></a> technique in the wild to force connections to close is <a href="https://www.ndss-symposium.org/wp-content/uploads/2017/09/weav.pdf"><u>reset injection</u></a>. With reset injection, middleboxes on the path to the destination inspect data portions of packets. When the middlebox sees a packet to a forbidden domain name, it injects forged TCP Reset (RST) packets to one or both communicating parties to cause them to abort the connection. If the middlebox did not drop the forbidden packet first, then the server will receive both the client packet that triggered the middlebox tampering – perhaps containing a TLS Client Hello message with a <a href="https://www.cloudflare.com/en-gb/learning/ssl/what-is-sni"><u>Server Name Indication (SNI)</u></a> field – followed soon afterwards by the forged RST packet.</p>
	<p>In the TCP resets and timeouts dataset, a connection disrupted via reset injection would typically appear as a Post-ACK, Post-PSH, or Later anomaly (but, as a reminder, not all anomalies are due to reset injection).</p>
	<p>As an example, the reset injection technique is <a href="https://go.gale.com/ps/anonymous?id=GALE%7CA175630128&amp;it=r&amp;linkaccess=abs&amp;issn=10727825"><u>known</u></a> and commonly associated with the so-called Great Firewall of China (GFW). Indeed, looking at Post-PSH anomalies in connections originating from IPs geolocated to <a href="https://radar.cloudflare.com/cn"><u>China</u></a>, we see higher rates than the worldwide average. However, looking at individual networks in China, the Post-PSH rates vary widely, perhaps due to the types of traffic carried or different implementations of the technique. In contrast, rates of Post-SYN anomalies are consistently high across most major Chinese ASes; this may be scanners, spoofed SYN flood attacks, or <a href="https://www.usenix.org/conference/usenixsecurity23/presentation/wu-mingshi"><u>residual</u></a> <a href="https://gfw.report/publications/usenixsecurity23/en"><u>blocking</u></a> with <a href="https://blog.cloudflare.com/consequences-of-ip-blocking"><u>collateral impact</u></a>.&nbsp;</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/ICLRlfg97CA9e716TJSwE/9627f83f37b994d30cc495e63e7567bd/1622-10.png" alt="1622-10" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/cn?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p><a href="https://radar.cloudflare.com/as4134"><u>AS4134 (CHINANET-BACKBONE)</u></a> shows lower rates of Post-PSH anomalies than other Chinese ASes, but still well above the worldwide average.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/4NL6vTD9cXtVxQYfp3OvHT/cf05e079d33d47fe16e26b8dbc90adb0/1622-11.png" alt="1622-11" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS4134?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Networks <a href="https://radar.cloudflare.com/as9808"><u>AS9808 (CHINAMOBILE-CN)</u></a> and <a href="https://radar.cloudflare.com/as56046"><u>AS56046 (CMNET-Jiangsu-AP)</u></a> both show double-digit percentages of connections matching Post-PSH anomalies.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2jQVLR8Shiz0NsMJuUhG4N/cb4ee2c55aac3f8a4fcc95dc62a47476/1622-12.png" alt="1622-12" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS9808?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2fSHO4hANqymOvbjSIL6Uw/3e3d087f0ffa74b88f98efa3d7858ff4/1622-13.png" alt="1622-13" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS56046?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>See our <a href="https://blog.cloudflare.com/connection-tampering"><u>deep-dive blog post</u></a> for more information about connection tampering.</p>
	<h2>Sourcing new insights and targets for followup study</h2>
	<p>TCP resets and timeouts dataset may also be a source for identifying new or previously understudied network behaviors, by helping to find networks that “stick out” and merit further investigation.</p>
	<h3>Unattributable ZMap scanning</h3>
	<p>Here is one we’re unable to explain: Every day during the same 18-hour interval, over 10% of connections from UK clients never progress past the initial SYN packets, and just time out.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/4qPaXL6ViEyuJ3UhUi0kpG/4d52b3b9e37ad76890b7e48835810efd/1622-14.png" alt="1622-14" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/gb?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Internal inspection revealed that almost all of the Post-SYN anomalies come from a scanner using <a href="https://zmap.io"><u>ZMap</u></a> at <a href="https://radar.cloudflare.com/as396982"><u>AS396982 (GOOGLE-CLOUD-PLATFORM)</u></a>, in what appears to be a full port scan across all IP address ranges. (The ZMap client responsibly self-identifies, based on ZMap’s responsible self-identification as discussed later.) We see a similar level of scan traffic from IP prefixes in AS396982 geolocated to the United States.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/756bijZU4xJpMvc78ZdbYl/a2e156e2159f8870acf90e34f7940134/1622-15.png" alt="1622-15" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS396982?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<h3>Zero-rating in mobile networks</h3>
	<p>A cursory look at anomaly rates at the country level reveals some interesting findings. For instance, looking at connections from <a href="https://radar.cloudflare.com/mx"><u>Mexico</u></a>, the rates of Post-ACK and Post-PSH anomalies often associated with connection tampering are higher than the global average. The profile for Mexico connections is also similar to others in the region. However, Mexico is a country with “<a href="https://freedomhouse.org/country/mexico/freedom-net/2023"><u>no documented evidence that the government or other actors block or filter internet content.</u></a>”</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/5bZjzlkqtRzmB5097m6z6S/0132e0b929aa0ca77a2041fb62ea914c/1622-16.png" alt="1622-16" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/mx?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Looking at each of the top ASes by HTTP traffic volume in Mexico, we find that close to 50% of connections from <a href="https://radar.cloudflare.com/as28403"><u>AS28403 (RadioMovil Dipsa, S.A. de C.V., operating as Telcel)</u></a> are terminated via a reset or timeout directly after the completion of the TCP handshake (Post-ACK connection stage). In this stage, it’s possible a middlebox has seen and dropped a data packet before it gets to Cloudflare.</p>
	<p>One explanation for this behavior may be <a href="https://en.wikipedia.org/wiki/Zero-rating"><u>zero-rating</u></a>, in which a cellular network provider allows access to certain resources (such as messaging or social media apps) at no cost. When users exceed their data transfer limits on their account, the provider might still allow traffic to zero-rated destinations while blocking connections to other resources.</p>
	<p>To enforce a zero-rating policy, an ISP might use the <a href="https://www.cloudflare.com/en-gb/learning/ssl/what-is-sni"><u>TLS Server Name Indication (SNI)</u></a> to determine whether to block or allow connections. The SNI is sent in a data-containing packet immediately following the TCP handshake. Thus, if an ISP drops the packet containing the SNI, the server would still see the SYN and ACK packets from the client but no subsequent packets, which is consistent with a Post-ACK connection anomaly.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/7KUfARxvDEogTFeh7PL4n5/ce6f43a2812055ae67962b886328272b/1622-17.png" alt="1622-17" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS28403?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Turning to <a href="https://radar.cloudflare.com/pe"><u>Peru</u></a>, another country with a similar profile in the dataset, there are even higher rates of Post-ACK and Post-PSH anomalies compared to Mexico.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/1vLO0sP2Ap3206PX4Ysdim/c9721d8bfbf859275351dba077fdf785/1622-18.png" alt="1622-18" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/pe?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Focusing on specific ASes, we see that <a href="https://radar.cloudflare.com/as12252"><u>AS12252 (Claro Peru)</u></a> shows high rates of Post-ACK anomalies similar to AS28403 in Mexico. Both networks are operated by the same parent company, <a href="https://www.americamovil.com/English/overview/default.aspx"><u>América Móvil</u></a>, so one might expect similar network policies and network management techniques to be employed.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/1doJKHsOHyYlY6t3LLVmdm/d04626dac5e5bb13f66e681769fb8e7a/1622-19.png" alt="1622-19" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/AS12252?dateStart=2024-07-28&amp;dateEnd=2024-08-26#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Interestingly, <a href="https://radar.cloudflare.com/as6147"><u>AS6147 (Telefónica Del Perú)</u></a> instead shows high rates of Post-PSH connection anomalies. This could indicate that this network uses different techniques at the network layer to enforce its policies.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/44i6wdU8oWl8CTl1YDZVES/890339f85f9a18a5ab80c38b350a314a/1622-20.png" alt="1622-20" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/dz?dateStart=2024-06-06&amp;dateEnd=2024-06-19#tcp-resets-and-attacks"><sub><i>Cloudflare Radar</i></sub></a></p>
	<h2>Changes over time, a longitudinal view</h2>
	<p>One of the most powerful aspects of our continuous passive measurement is the ability to measure networks over longer periods of time.</p>
	<h3>Internet shutdowns</h3>
	<p>In our June 2024 blog post “<a href="https://blog.cloudflare.com/syria-iraq-algeria-exam-internet-shutdown"><u>Examining recent Internet shutdowns in Syria, Iraq, and Algeria</u></a>”, we shared the view of exam-related nationwide Internet shutdowns from the perspective of Cloudflare’s network. At that time we were preparing the TCP resets and timeouts dataset, which was helpful to confirm outside reports and get some insight into the specific techniques used for the shutdowns.</p>
	<p>As examples of changing behavior, we can go “back in time” to observe exam-related blocking as it happened. In <a href="https://radar.cloudflare.com/sy"><u>Syria</u></a>, during the exam-related shutdowns we see spikes in the rate of Post-SYN anomalies. In reality, we see a <a href="https://radar.cloudflare.com/traffic/sy?dateStart=2024-05-20&amp;dateEnd=2024-06-19"><u>near-total drop in traffic</u></a> (including SYN packets) during these periods.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/3K5o8qI2wzozKrFlSm9x9S/a4cd6ff63a28b75f8d1970e5d1cb78ba/1622-21.png" alt="1622-21" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/sy?dateStart=2024-05-20&amp;dateEnd=2024-06-19#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>
		A <a href="https://x.com/CloudflareRadar/status/1816438072768078078"><u>second round</u></a> of shutdowns starting the last week of July are quite prominent as well.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/3YJVpto9QJBCkDm5DVLiVN/08e9a80ab9ec4a22fd069112f1db2b35/1622-22.png" alt="1622-21" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/sy?dateStart=2024-07-20&amp;dateEnd=2024-08-19#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>Looking at connections from <a href="https://radar.cloudflare.com/iq"><u>Iraq</u></a>, Cloudflare’s view of exam-related shutdowns appears similar to those in Syria, with multiple Post-SYN spikes, albeit much less pronounced.</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/2KZyGLIOyoEFH3sYTiuHzK/bdfd431785ee8859e309ada8bceb15f1/1622-23.png" alt="1622-23" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/iq?dateStart=2024-05-17&amp;dateEnd=2024-06-10#tcp-resets-and-timeouts"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>The <a href="https://blog.cloudflare.com/syria-iraq-algeria-exam-internet-shutdown"><u>exams shutdown blog</u></a> also describes how <a href="https://radar.cloudflare.com/dz"><u>Algeria</u></a> took a more nuanced approach for restricting access to content during exam times: instead of full Internet shutdowns, evidence suggests that Algeria instead targeted specific connections. Indeed, during exam periods we see an increase in Post-ACK connection anomalies. This behavior would be expected if a middlebox selectively drops packets that contain forbidden content, while leaving other packets alone (like the initial SYN and ACK).</p>
	<figure class="kg-card kg-image-card ">

		<img src="https://cf-assets.www.cloudflare.com/slt3lc6tev37/67LrJ8cb1XpYsEpzENs54M/6e7581713541cbd94f68230dc2256848/1622-24.png" alt="1622-24" class="kg-image" width="1999" height="1125" loading="lazy">

	</figure>
	<p><sub><i>via </i></sub><a href="https://radar.cloudflare.com/security-and-attacks/dz?dateStart=2024-06-06&amp;dateEnd=2024-06-19#tcp-resets-and-attacks"><sub><i>Cloudflare Radar</i></sub></a></p>
	<p>The examples above reinforce that this data is most useful when correlated with other signals. The data is also available via the <a href="https://developers.cloudflare.com/api/operations/radar-get-tcp-resets-timeouts-summary"><u>API</u></a>, so others can dive in more deeply. Our detection techniques are also transferable to other servers and operators, as described next.</p>
	<h2 id="anomalousTCP">How to detect anomalous TCP connections at scale</h2>
	<p>In this section, we discuss how we constructed the TCP resets and timeouts dataset. The scale of Cloudflare’s global network presents unique challenges for data processing and analysis. We share our techniques to help readers to understand our methodology, interpret the dataset, and replicate the mechanisms in other networks or servers.</p>
	<p>Our methodology can be summarized as follows:</p>
	<ol>
		<li>
			<p>Log a sample of connections arriving at our client-facing servers. This sampling system is completely passive, meaning that it has no ability to decrypt traffic and only has access to existing packets sent over the network.&nbsp;</p>
		</li>
		<li>
			<p>Reconstruct connections from the captured packets. A novel aspect of our design is that only one direction needs to be observed, from client to server.</p>
		</li>
		<li>
			<p>Match reconstructed connections against a set of signatures for anomalous connections terminated by resets or timeouts. These signatures consist of two parts: a <i>connection stage</i>, and a set of <i>tags</i> that indicate specific behaviors derived from the literature and our own observations.</p>
		</li>
	</ol>
	<p>These design choices keep encrypted packets safe and can be replicated anywhere, without needing access to the destination server.</p>
	<h2>First, sample connections</h2>
	<p>Our main goal was to design a mechanism that scales, and gives us broad visibility into all connections arriving at Cloudflare’s network. Running traffic captures on each client-facing server works, but does not scale. We would also need to know exactly where and when to look, making continuous insights hard to capture. Instead, we sample connections from all of Cloudflare’s servers and log them to a central location where we could perform offline analysis.</p>
	<p>This is where we hit the first roadblock: existing packet logging pipelines used by Cloudflare’s analytics systems log individual packets, but a connection consists of many packets. To detect connection anomalies we needed to see all, or at least enough, packets in a given connection. Fortunately, we were able to leverage a flexible logging system built by Cloudflare’s DoS team for <a href="https://developers.cloudflare.com/ddos-protection/about/how-ddos-protection-works"><u>analyzing packets involved in DDoS attacks</u></a> in conjunction with a carefully crafted invocation of two <a href="https://manpages.debian.org/bookworm/iptables/iptables.8.en.html"><code><u>iptables</u></code></a> rules to achieve our goal.</p>
	<p>The first <code>iptables</code> rule randomly selects and marks new connections for sampling. In our case, we settled on sampling one in every 10,000 ingress TCP connections. There’s nothing magical about this number, but at Cloudflare’s scale it strikes a balance between capturing enough without straining our data processing and analytics pipelines. The <code>iptables</code> rules only apply to packets after they have passed the DDoS mitigation system. As TCP connections can be long-lived, we sample only new TCP connections. Here is the <code>iptables</code> rule for marking connections to be sampled:</p>
	<pre class="language-bash"><code class="language-bash">-t mangle -A PREROUTING -p tcp --syn -m state 
--state NEW -m statistic --mode random 
--probability 0.0001 -m connlabel --label &lt;label&gt; 
--set -m comment --comment "Label a sample of ingress TCP connections"
</code></pre>
	<p></p>
	<p>Breaking this down, the rule is installed in the <code>mangle</code> table (for modifying packets) in the chain that handles incoming packets (<code>-A PREROUTING</code>). Only TCP packets with the SYN flag set are considered (<code>-p tcp --syn</code>) where there is no prior state for the connection (<code>--state NEW</code>). The filter selects one in every 10,000 SYN packets (<code>-m statistic –mode random --probability 0.0001</code>) and applies a label to the connection (<code>-m connlabel --label &lt;label&gt; --set</code>).</p>
	<p>The second iptables rule logs subsequent packets in the connection, to a maximum of 10 packets. Again, there’s nothing magic about the number 10 other than that it’s generally enough to capture the connection establishment, subsequent request packets, and resets on connections that close before expected.</p>
	<pre class="language-bash"><code class="language-bash">-t mangle -A PREROUTING -m connlabel --label 
&lt;label&gt; -m connbytes ! --connbytes 11 
--connbytes-dir original --connbytes-mode packets 
-j NFLOG --nflog-prefix "&lt;logging flags&gt;" -m 
comment --comment "Log the first 10 incoming packets of each sampled ingress connection"
</code></pre>
	<p></p>
	<p>This rule is installed in the same chain as the previous rule. It matches only packets from sampled connections <code>(-m connlabel --label &lt;label&gt;)</code>, and only the first 10 packets from each connection (<code>-m connbytes ! --connbytes 11 --connbytes-dir original --connbytes-mode packets</code>). Matched packets are sent to NFLOG (<code>-j NFLOG --nflog-prefix "&lt;logging flags&gt;"</code>) where they’re picked up by the logging system and saved to a centralized location for offline analysis.</p>
	<h2>Reconstructing connections from sampled packets</h2>
	<p>Packets logged on our servers are inserted into <a href="https://blog.cloudflare.com/tag/clickhouse"><u>ClickHouse</u></a> tables as part of our analytics pipeline. Each logged packet is stored in its own row in the database. The next challenge is to reassemble packets into the corresponding connections for further analysis. Before we go further, we need to define what a “connection” is for the purpose of this analysis.</p>
	<p>We use the standard definition of a connection defined by the network 5-tuple of <code>protocol</code>, <code>source IP address</code>, <code>source port</code>, <code>destination IP address</code>, <code>destination port</code> with the following tweaks:</p>
	<ul>
		<li>
			<p>We only sample packets on the <i>ingress</i> (client-to-server) half of a connection, so do not see the corresponding response packets from server to client. In most cases, we can infer what the server response will be based on our knowledge of how our servers are configured. Ultimately, the ingress packets are sufficient to learn anomalous TCP connection behaviors.</p>
		</li>
		<li>
			<p>We query the ClickHouse dataset in 15-minute intervals, and group together packets sharing the same network 5-tuple within that interval. This means that connections may be truncated towards the end of the query interval. When analyzing connection timeouts, we exclude incomplete flows where the latest packet timestamp is within 10 seconds of the query cutoff.</p>
		</li>
		<li>
			<p>Since resets and timeouts are most likely to affect <i>new</i> connections, we only consider sequences of packets starting with a SYN packet marking the beginning of a new TCP handshake. Thus, existing long-lived connections are excluded.</p>
		</li>
		<li>
			<p>The logging system does not guarantee precise packet interarrival timestamps, so we consider only the set of packets that arrive, not ordered by their arrival time. In some cases, we can determine packet ordering based on TCP sequence numbers but it turns out not to significantly impact the results.</p>
		</li>
		<li>
			<p>We filter out a small fraction of connections with multiple SYN packets to reduce noise in the analysis.</p>
		</li>
	</ul>
	<p>With the above conditions for how we define a connection, we’re now ready to describe our analysis pipeline in more detail.</p>
	<h2>Mapping connection close events to stages</h2>
	<p>TCP connections transition through a series of stages from connection establishment through eventual close. The stage at which an anomalous connection closes provides clues as to <i>why</i> the anomaly occurred. Based on the packets that we receive at our servers, we place each incoming connection into one of four stages (Post-SYN, Post-ACK, Post-PSH, Later), described in more detail <a href="https://blog.cloudflare.com/#dataset"><u>above</u></a>.</p>
	<p>The connection close stage alone provides useful insights into anomalous TCP connections from various networks, and this is what is shown today on Cloudflare Radar. However, in some cases we can provide deeper insights by matching connections against more specific signatures.</p>
	<h2>Applying tags to describe more specific connection behaviors</h2>
	<p>The grouping of connections into stages as described above is done solely based on the TCP flags of packets in the connection. Considering other factors such as packet inter-arrival timing, exact combinations of TCP flags, and other packet fields (IP identification, IP TTL, TCP sequence and acknowledgement numbers, TCP window size, etc.) can allow for more fine-grained matching to specific behaviors.</p>
	<p>For example, the popular <a href="http://zmap.io"><u>ZMap</u></a> scanner software fixes the IP identification field to 54321 and the TCP window size to 65535 in SYN packets that it generates (<a href="https://github.com/zmap/zmap/blob/c88db2917612328c843561101495e5263ef7ac5b/src/probe_modules/packet.c"><u>source code</u></a>). When we see packets arriving to our network that have these exact fields set, it is likely that the packet was generated by a scanner using ZMap.</p>
	<p>Tags can also be used to match connections against known signatures of tampering middleboxes. A large body of active measurements work (for instance, <a href="https://www.ndss-symposium.org/wp-content/uploads/2017/09/weav.pdf"><u>Weaver, Sommer, and Paxson</u></a>) has found that some middleboxes deployments exhibit consistent behaviors when disrupting connections via reset injection, such as setting an IP TTL field that differs from other packets sent by the client, or sending both a RST packet and a RST+ACK packet. For more details on specific connection tampering signatures, see the <a href="https://blog.cloudflare.com/connection-tampering"><u>blog post</u></a> and the <a href="https://research.cloudflare.com/publications/SundaraRaman2023"><u>peer-reviewed paper</u></a>.</p>
	<p>Currently, we define the following tags, which we intend to refine and expand over time. Some tags only apply if another tag is also set, as indicated by the hierarchical presentation below (e.g., the <code>fin</code> tag can only apply when the <code>reset</code> tag is also set).</p>
	<ul>
		<li>
			<p><code>timeout</code>: terminated due to a timeout</p>
		</li>
		<li>
			<p><code>reset</code>: terminated due to a reset (packet with RST flag set)</p>
			<ul>
				<li>
					<p>fin: at least one FIN packet was received alongside one or more RST packets</p>
				</li>
				<li>
					<p><code>single_rst</code>: terminated with a single RST packet</p>
				</li>
				<li>
					<p><code>multiple_rsts</code>: terminated with multiple RST packets</p>
					<ul>
						<li>
							<p><code>acknumsame</code>: the acknowledgement numbers in the RST packets were all the same and non-zero</p>
						</li>
						<li>
							<p><code>acknumsame0</code>: the acknowledgement numbers in the RST packets were all zero</p>
						</li>
						<li>
							<p><code>acknumdif</code>f: the acknowledgement numbers in the RST packets were different and all non-zero</p>
						</li>
						<li>
							<p><code>acknumdiff0</code>: the acknowledgement numbers in the RST packets were different and one was zero</p>
						</li>
					</ul>
				</li>
				<li>
					<p><code>single_rstack</code>: terminated with a single RST+ACK packet (both RST and ACK flags set)</p>
				</li>
				<li>
					<p><code>multiple_rstacks</code>: terminated with a multiple RST+ACK packets</p>
				</li>
				<li>
					<p><code>rst_and_rstacks</code>: terminated with a combination of RST and RST+ACK packets</p>
				</li>
			</ul>
		</li>
		<li>
			<p><code>zmap</code>: SYN packet matches those generated by the ZMap scanner</p>
		</li>
	</ul>
	<p>Connection tags are not currently visible in the Radar <a href="https://radar.cloudflare.com/security-and-attacks#tcp-resets-and-timeouts"><u>dashboard</u></a> and <a href="https://developers.cloudflare.com/api/operations/radar-get-tcp-resets-timeouts-summary"><u>API</u></a>, but we plan to release this additional functionality in the future.</p>
	<h2>What’s next?</h2>
	<p>Cloudflare’s mission is to help build a better Internet, and we consider transparency and accountability to be a critical part of that mission. We hope that the insights and tools we are sharing help to shed light on anomalous network behaviors around the world.</p>
	<p>While the current TCP resets and timeouts dataset should immediately prove useful to network operators, researchers, and Internet citizens as a whole, we’re not stopping here. There are several improvements we’d like to add in the future:</p>
	<ul>
		<li>
			<p>Expand the set of tags for capturing specific network behaviors and expose them in the <a href="https://developers.cloudflare.com/api/operations/radar-get-tcp-resets-timeouts-summary"><u>API</u></a> and <a href="https://radar.cloudflare.com/security-and-attacks#tcp-resets-and-timeouts"><u>dashboard</u></a>.</p>
		</li>
		<li>
			<p>Extend insights to connections from Cloudflare to customer origin servers.</p>
		</li>
		<li>
			<p>Add support for QUIC, which is currently used for over <a href="https://radar.cloudflare.com/adoption-and-usage"><u>30% of HTTP requests</u></a> to Cloudflare worldwide.</p>
		</li>
	</ul>
	<p>If you’ve found this blog interesting, we encourage you to read the accompanying <a href="https://blog.cloudflare.com/connection-tampering"><u>blog post</u></a> and <a href="https://research.cloudflare.com/publications/SundaraRaman2023"><u>paper</u></a> for a deep dive on connection tampering, and to explore the TCP resets and timeouts <a href="https://radar.cloudflare.com/security-and-attacks#tcp-resets-and-timeouts"><u>dashboard</u></a> and <a href="https://developers.cloudflare.com/api/operations/radar-get-tcp-resets-timeouts-summary"><u>API</u></a> on Cloudflare Radar. We welcome you to reach out to us with your own questions and observations at <a href="mailto:radar@cloudflare.com"><u>radar@cloudflare.com</u></a>.</p>
</div>