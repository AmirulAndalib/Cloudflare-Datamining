<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/04/image3-4.png" class="kg-image"></figure>
	<p>In this blog post we’re going to look at how you can optimize the page experience of your AMP pages by running AMP Optimizer in a Cloudflare Worker.</p>
	<h2 id="towards-a-better-user-experience-on-the-web">Towards a better user experience on the web</h2>
	<p>A great user experience on the web means more than just having a website that loads fast (although that continues to be a critical part of the user experience). There are many factors that contributing to a great experience, such as:</p>
	<ul>
		<li>Loading speed</li>
		<li>Responsiveness</li>
		<li>Content stability</li>
	</ul>
	<p>Traditionally, these have been hard to measure, but with <a href="https://web.dev/vitals" target="_blank">Core Web Vitals</a> we now have a new way to measure user experience on the web. The key is: Core Web Vitals are based on <a href="https://web.dev/vitals-measurement-getting-started/" target="_blank">real world user data</a>. To score well on Core Web Vitals you need to make sure that your website performs well - for all your users around the world.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2021/04/image1-16.png" class="kg-image">
		<figcaption><a href="https://lh5.googleusercontent.com/HlrpevA1hZKx35h2SQdwOBdCO4FOC0YOqie9eMTiGDZx5MdSVTxY2VwPwdL58Pi68cuuG0ooeRTs3RJQEfU5woNRpgq1ZLV4SrWkzHIOH4kTnLS32i62Qf7UibEcz2xm8Gb4nT_e" target="_blank">Image URL</a></figcaption>
	</figure>
	<p>This becomes even more important soon, as <a href="https://www.cloudflare.com/learning/performance/what-are-core-web-vitals/" target="_blank">Core Web Vitals</a> are also going to be a signal in the upcoming <a href="https://developers.google.com/search/docs/guides/page-experience" target="_blank">page experience ranking update in Google Search</a>. You can find more details in the <a href="https://support.google.com/webmasters/thread/104436075?hl=en" target="_blank">page experience FAQ</a>.</p>
	<h2 id="how-to-achieve-a-great-page-experience-with-amp">How to achieve a great page experience with AMP</h2>
	<p><a href="https://amp.dev" target="_blank">AMP</a> is an <a href="https://github.com/ampproject/amphtml" target="_blank">open source</a> web components framework that has been <a href="https://blog.amp.dev/2020/05/06/amp-web-vitals-a-better-web-together/" target="_blank">developed with page experience in mind</a>. AMP ensures a good page experience by providing guardrails that help avoid common performance pitfalls. For example, AMP features a static layout system, which <a href="https://blog.amp.dev/2020/04/16/cumulative-layout-shift-in-amp/" target="_blank">avoids content shifts by design</a>.</p>
	<p>However, AMP pages can still fail Core Web Vitals. The reason for this is clear: some performance best practices required for performing well on Core Web Vitals can’t be implemented at client-side. For example, image optimization, fast server-response times and effective font-loading are all critical for a good user experience, but need to be done on the server. Even AMP documents themselves can be further optimized. For example, <a href="https://amp.dev/documentation/guides-and-tutorials/optimize-and-measure/amp-optimizer-guide/explainer/?format=websites#server-side-rendering-amp-layouts" target="_blank">AMP’s layout system can be pre-rendered at build or serving time</a> which greatly <a href="https://blog.amp.dev/2018/10/08/how-to-make-amp-even-faster/" target="_blank">improves page load times</a> while still ensuring that there are no content jumps.</p>
	<p>The good news is, if an AMP page is surfaced in Google Search or Bing, it’ll be served from an AMP Cache which performs all these optimizations for you. But when someone visits your AMP page directly, for example through a link shared on social media, they won’t get the same experience. In order to ensure that you are getting great Core Web Vitals scores for all your users, it is very important to optimize your AMP pages on your origin as well!</p>
	<p>To help with this, the AMP team has created <a href="https://amp.dev/documentation/guides-and-tutorials/optimize-and-measure/amp-optimizer-guide/?format=websites" target="_blank">AMP Optimizers</a>, which will automatically perform common performance best practices for you. Using AMP Optimizers combined with Cloudflare Workers makes it super easy to serve optimized AMP pages on your own origin.</p>
	<h2 id="introducing-amp-optimizer-for-cloudflare-workers">Introducing AMP Optimizer for Cloudflare Workers</h2>
	<p>We are happy to announce a new AMP Optimizer integration for Cloudflare Workers. So far, there are two AMP Optimizer versions available: one for NodeJS and one for PHP. Both take an AMP HTML document as input and turn it into an optimized AMP HTML document. Depending on when your pages are created, one of these needs to be run either as part of your build system or in on your backend as part of your rendering pipeline. However, integrating an AMP Optimizer is not always straightforward, for example if you’re not using PHP or NodeJS in your backend or when you don’t control the hosting environment.</p>
	<p>With the Cloudflare Worker integration for AMP Optimizer you can seamlessly optimize all your AMP pages. You can find installation instructions on the <a href="https://github.com/ampproject/cloudflare-amp-optimizer" target="_blank">Github repository</a>.</p>
	<h2 id="looking-under-the-hood">Looking under the hood</h2>
	<p>Let’s dive into how the Cloudflare Worker works, so that we can get a better understanding of where it optimises things.</p>
	<h3 id="request-flow">Request Flow</h3>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/04/image5-5.png" class="kg-image"></figure>
	<p>Whenever a request comes in for an HTML file (1), the Worker will first check in the global cache if an optimised version has already been generated (2). If that is not the case (3), the Worker will request the version of the file from your origin (4)(5), optimize the document if it is using AMP (6), and return that to the user (7). Only after the response has been fully streamed to the user will we start saving the generated version in the cache (8).</p>
	<p>For subsequent requests, in a Worker anywhere else in the world, the result will be retrieved from the global KV cache, cached locally in that data center and returned straight away.</p>
	<h3 id="automatic-preloading">Automatic preloading</h3>
	<p>Because the AMP Optimizer parses the HTML document, it will discover what other resources are used, and will add preload tags for external resources such as fonts and hero images.</p>
	<h3 id="responsive-images-out-of-the-box">Responsive images out of the box</h3>
	<p>Images are often the biggest contributors to the total download size of a web page. Customers on the Business or Enterprise plans can automatically make use of the Cloudflare Image Optimization functionality. For those customers, the AMP Optimizer can automatically generate <a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images" target="_blank">image source sets</a> with links for the <a href="https://developers.cloudflare.com/images/" target="_blank">Cloudflare Image Optimizer</a>.</p>
	<p>Image sourcesets give the browser different options to pick the most appropriate image size for that particular browser viewport. This can greatly reduce the size of the image downloads for, say, a low end mobile phone, which needs much smaller images than a 4K desktop monitor.</p>
	<h2 id="peace-of-mind-with-cloudflare-workers-unbound">Peace of mind with Cloudflare Workers Unbound</h2>
	<p>While most of the requests will be handled very quickly, even the ones that need optimising, the optimisation of large files can take more than 50ms of CPU time. Which is why Workers Unbound is a perfect match for the AMP Optimizer Worker.</p>
	<p>Workers Unbound allows Workers to execute for up to 30 seconds, so that even if it does take a bit longer than 50ms to optimize a document, your users will never see any errors.</p>
	<h2 id="what-are-the-performance-gains">What are the performance gains?</h2>
	<p>Web performance is much more complex than any synthetic test can prove, so you should absolutely do your own performance testing on your own sites. But here is an example of a regular AMP page with and without the Cloudflare Worker AMP Optimizer in front of it. This is tested on a simulated Moto G4 on a fast 3G network.</p>
	<!--kg-card-begin: html-->
	<div style="position: relative; padding-top: 72.54901960784314%;"><iframe src="https://iframe.videodelivery.net/b3667911002a162eedc4932fa19be186?preload=true&amp;loop=true&amp;autoplay=true" style="border: none; position: absolute; top: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe></div>
	<p></p>
	<!--kg-card-end: html-->
	<p>Here is the full <a href="https://www.webpagetest.org/video/compare.php?tests=210414_AiDcZY_f5be5cec9691704310f8659401bf27df,210414_BiDcZ1_f16da211a5c7f589237b5c2b0e72634d" target="_blank">WegPageTest data</a> if you want to explore this example further.</p>
	<p>There is also an <a href="https://github.com/ampproject/amp-toolbox/blob/main/packages/cloudflare-optimizer-scripts/benchmark/index.js" target="_blank">example benchmark script</a> you can adapt if you want to run performance tests on your own site.</p>
	<h2 id="summary">Summary</h2>
	<p>Cloudflare Workers offer a simple way to prepare your AMP pages for Google’s upcoming page experience launch. They offer a seamless integration that doesn’t require any changes in your CMS or server. Even better — with the new Cloudflare Workers Unbound, it becomes possible to perform even more advanced optimizations. Check out the <a href="https://github.com/ampproject/cloudflare-amp-optimizer" target="_blank">cloudflare-amp-optimizer</a> repository for more details on how to get started.</p>
</div>