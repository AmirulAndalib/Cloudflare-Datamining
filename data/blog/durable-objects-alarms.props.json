{
	"locale": "en-us",
	"post": {
		"access": true,
		"authors": [
			{
				"id": "5d5ae406143b210505020827",
				"name": "Matt Alonso",
				"slug": "matt-alonso",
				"profile_image": "https://blog-cloudflare-com-assets.storage.googleapis.com/2019/08/photo.jpg",
				"cover_image": null,
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": null,
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/matt-alonso/"
			},
			{
				"id": "5faea9f4f6597501bc80ca67",
				"name": "Greg McKeon",
				"slug": "greg",
				"profile_image": "http://blog.cloudflare.com/content/images/2022/05/Screen-Shot-2022-05-10-at-2.50.56-PM.png",
				"cover_image": null,
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": "@wegmckeon",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/greg/"
			}
		],
		"canonical_url": null,
		"codeinjection_foot": null,
		"codeinjection_head": null,
		"comment_id": "627a81915b2938000ab4897d",
		"comments": false,
		"created_at": "2022-05-10T16:15:29.000+01:00",
		"custom_excerpt": "Durable Object alarms let you call a function at a defined point in the future, unlocking deeper use-cases for Durable Objects like reliable queuing",
		"custom_template": null,
		"email_subject": null,
		"excerpt": "Durable Object alarms let you call a function at a defined point in the future, unlocking deeper use-cases for Durable Objects like reliable queuing",
		"feature_image": "http://blog.cloudflare.com/content/images/2022/05/Durable-Object-Alarms-1.png",
		"feature_image_alt": null,
		"feature_image_caption": null,
		"featured": false,
		"frontmatter": null,
		"html": "<figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2022/05/Durable-Object-Alarms.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Since we launched Durable Objects, developers have leveraged them as a novel building block for distributed applications. </p><p>Durable Objects provide globally unique instances of a JavaScript class a developer writes, accessed via a unique ID. The Durable Object associated with each ID implements some fundamental component of an application — a banking application might have a Durable Object representing each bank account, for example. The bank account object would then expose methods for incrementing a balance, transferring money or any other actions that the application needs to do on the bank account.</p><p>Durable Objects work well as a stateful backend for applications — while Workers can instantiate a new instance of your code in any of Cloudflare’s data centers in response to a request, Durable Objects guarantee that all requests for a given Durable Object will reach the same instance on Cloudflare’s network.</p><p>Each Durable Object is single-threaded and has access to a stateful storage API, making it easy to build consistent and highly-available distributed applications on top of them.</p><p>This system makes distributed systems’ development easier — we’ve seen some impressive applications launched atop Durable Objects, from collaborative whiteboarding tools to conflict-free replicated data type (CRDT) systems for coordinating distributed state launch.</p><p>However, up until now, there’s been a piece missing — how do you invoke a Durable Object when a client Worker is not making requests to it?</p><p>As with any distributed system, Durable Objects can become unavailable and stop running. Perhaps the machine you were running on was unplugged, or the datacenter burned down and is never coming back, or an individual object exceeded its memory limit and was reset. Before today, a subsequent request would reinitialize the Durable Object on another machine, but there was no way to programmatically wake up an Object.</p><p>Durable Objects Alarms are here to change that, unlocking new use cases for Durable Objects like queues and deferred processing.</p><h3 id=\"what-is-a-durable-object-alarm\">What is a Durable Object Alarm?</h3><p>Durable Object Alarms allow you, from within your Durable Object, to schedule the object to be woken up at a time in the future. When the alarm’s scheduled time comes, the Durable Object’s <code>alarm()</code> handler will be called. If this handler throws an exception, the alarm will be automatically retried using exponential backoff until it succeeds — alarms have guaranteed at-least-once execution.</p><h3 id=\"how-are-alarms-different-from-workers-cron-triggers\">How are Alarms different from Workers Cron Triggers?</h3><p>Alarms are more fine-grained than Cron Triggers. While a Workers service can have up to three Cron Triggers configured at once, it can have an unlimited amount of Durable Objects, each of which can have a single alarm active at a time.</p><p>Alarms are directly scheduled from and invoke a function within your Durable Object. Cron Triggers, on the other hand, are not programmatic — they execute based on their schedules, which have to be configured via the Cloudflare Dashboard or centralized configuration APIs.</p><h3 id=\"how-do-i-use-alarms\">How do I use Alarms?</h3><p>First, you’ll need to add the <code>durable_object_alarms</code> compatibility flag to your <code>wrangler.toml</code>.</p><!--kg-card-begin: markdown--><pre><code class=\"language-toml\">compatibility_flags = [&quot;durable_object_alarms&quot;]\n</code></pre>\n<!--kg-card-end: markdown--><p>Next, implement an <code>alarm()</code> handler in your Durable Object that will be called when the alarm executes. From anywhere else in your Durable Object, call <code>state.storage.setAlarm()</code> and pass in a time for the alarm to run at. You can use <code>state.storage.getAlarm()</code> to retrieve the currently set alarm time.</p><p>In this example, we implemented an alarm handler that wakes the Durable Object up once every 10 seconds to batch requests to a single Durable Object, deferring processing until there is enough work in the queue for it to be worthwhile to process them.</p><!--kg-card-begin: markdown--><pre><code class=\"language-js\">export default {\n  async fetch(request, env) {\n    let id = env.BATCHER.idFromName(&quot;foo&quot;);\n    return await env.BATCHER.get(id).fetch(request);\n  },\n};\n\nconst SECONDS = 1000;\n\nexport class Batcher {\n  constructor(state, env) {\n    this.state = state;\n    this.storage = state.storage;\n    this.state.blockConcurrencyWhile(async () =&gt; {\n      let vals = await this.storage.list({ reverse: true, limit: 1 });\n      this.count = vals.size == 0 ? 0 : parseInt(vals.keys().next().value);\n    });\n  }\n  async fetch(request) {\n    this.count++;\n\n    // If there is no alarm currently set, set one for 10 seconds from now\n    // Any further POSTs in the next 10 seconds will be part of this kh.\n    let currentAlarm = await this.storage.getAlarm();\n    if (currentAlarm == null) {\n      this.storage.setAlarm(Date.now() + 10 * SECONDS);\n    }\n\n    // Add the request to the batch.\n    await this.storage.put(this.count, await request.text());\n    return new Response(JSON.stringify({ queued: this.count }), {\n      headers: {\n        &quot;content-type&quot;: &quot;application/json;charset=UTF-8&quot;,\n      },\n    });\n  }\n  async alarm() {\n    let vals = await this.storage.list();\n    await fetch(&quot;http://example.com/some-upstream-service&quot;, {\n      method: &quot;POST&quot;,\n      body: Array.from(vals.values()),\n    });\n    await this.storage.deleteAll();\n    this.count = 0;\n  }\n}\n</code></pre>\n<!--kg-card-end: markdown--><p>Once every 10 seconds, the <code>alarm()</code> handler will be called. In the event an unexpected error terminates the Durable Object, it will be re-instantiated on another machine, following a short delay, after which it can continue processing.</p><p>Under the hood, Alarms are implemented by making reads and writes to the storage layer. This means Alarm <code>get</code> and <code>set</code> operations follow the same rules as any other storage operation – writes are coalesced with other writes, and reads have a defined ordering. See <a href=\"http://blog.cloudflare.com/durable-objects-easy-fast-correct-choose-three/\">our blog post</a> on the caching layer we implemented for Durable Objects for more information.</p><h3 id=\"durable-objects-alarms-guarantee-fault-tolerance\">Durable Objects Alarms guarantee fault-tolerance</h3><p>Alarms are designed to have no single point of failure and to run entirely on our edge – every Cloudflare data center running Durable Objects is capable of running alarms, including migrating Durable Objects from unhealthy data centers to healthy ones as necessary to ensure that their Alarm executes. Single failures should resolve in under 30 seconds, while multiple failures may take slightly longer.</p><p>We achieve this by storing alarms in the same distributed datastore that backs the Durable Object storage API. This allows alarm reads and writes to behave identically to storage reads and writes and to be performed atomically with them, and ensures that alarms are replicated across multiple datacenters.</p><p>Within each data center capable of running Durable Objects, there are multiple processes responsible for tracking upcoming alarms and triggering them, providing fault tolerance and scalability within the data center. A single elected leader in each data center is responsible for detecting failure of other data centers and assigning responsibility of those alarms to healthy local processes in its own data center. In the event of leader failure, another leader will be elected and become responsible for executing Alarms in the data center. This allows us to guarantee at-least-once execution for all Alarms.</p><h3 id=\"how-do-i-get-started\">How do I get started?</h3><p>Alarms are a great way to build new distributed primitives, like queues, atop Durable Objects. They also provide a method for guaranteeing work within a Durable Object will complete, without relying on a client request to “kick” the Object.</p><p>You can get started with Alarms now by enabling Durable Objects in the Cloudflare <a href=\"https://dash.cloudflare.com/\">dashboard</a>. For more info, check the developer docs or jump in our Discord.</p>",
		"id": "627a81915b2938000ab4897d",
		"meta_description": "Durable Object alarms let you call a function at a defined point in the future, unlocking deeper use-cases for Durable Objects like reliable queuing.",
		"meta_title": null,
		"og_description": null,
		"og_image": "http://blog.cloudflare.com/content/images/2022/05/Durable-Objects-Alarms-OG-1.png",
		"og_title": null,
		"primary_author": {
			"id": "5d5ae406143b210505020827",
			"name": "Matt Alonso",
			"slug": "matt-alonso",
			"profile_image": "https://blog-cloudflare-com-assets.storage.googleapis.com/2019/08/photo.jpg",
			"cover_image": null,
			"bio": null,
			"website": null,
			"location": null,
			"facebook": null,
			"twitter": null,
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/matt-alonso/"
		},
		"primary_tag": null,
		"published_at": "2022-05-11T13:59:17.000+01:00",
		"reading_time": 5,
		"slug": "durable-objects-alarms",
		"tags": [
			{
				"id": "627af7395b2938000ab48b04",
				"name": "#BLOG-1067",
				"slug": "hash-blog-1067",
				"description": null,
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			},
			{
				"id": "6276b1455b2938000ab48480",
				"name": "Platform Week",
				"slug": "platform-week",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/platform-week/"
			},
			{
				"id": "606373480c4aa103f3124dcb",
				"name": "Durable Objects",
				"slug": "durable-objects",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/durable-objects/"
			},
			{
				"id": "5d16450341acde0011a951ee",
				"name": "Product News",
				"slug": "product-news",
				"description": "Product News (EN)",
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Product-News-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Product News",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Product News'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/product-news/"
			},
			{
				"id": "5d16450341acde0011a95252",
				"name": "Serverless",
				"slug": "serverless",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Serverless.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Serverless",
				"meta_description": "Cloudflare blog posts tagged 'serverless'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/serverless/"
			},
			{
				"id": "5d16450341acde0011a95253",
				"name": "Cloudflare Workers",
				"slug": "workers",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/workers/"
			},
			{
				"id": "60e48c195458ba01ba85eea6",
				"name": "Notifications",
				"slug": "notifications",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/notifications/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			},
			{
				"id": "64a3e2b834124c000b00b717",
				"name": "Developer Platform",
				"slug": "developer-platform",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developer-platform/"
			}
		],
		"title": "Durable Objects Alarms — a wake-up call for your applications",
		"twitter_description": null,
		"twitter_image": "http://blog.cloudflare.com/content/images/2022/05/Durable-Objects-Alarms-OG.png",
		"twitter_title": null,
		"updated_at": "2024-02-15T23:54:02.000+00:00",
		"url": "http://blog.cloudflare.com/durable-objects-alarms/",
		"uuid": "287923d4-99fd-434f-9887-55b583ac0ce1",
		"visibility": "public"
	}
}