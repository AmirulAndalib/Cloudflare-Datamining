<div class="post-content lh-copy gray1">
	<p>Cloudflare powers <a href="https://cdnjs.com/" target="_blank">cdnjs</a>, an open-source project that accelerates websites by delivering popular JavaScript libraries and resources via <a href="https://www.cloudflare.com/cdn/" target="_blank">Cloudflare’s network</a>. Since <a href="https://blog.cloudflare.com/an-update-on-cdnjs/">our major update in December</a>, we focused on remodelling cdnjs for scalability and resilience. Today, we are excited to announce how Cloudflare delivers cdnjs—a migration to a serverless infrastructure using <a href="https://developers.cloudflare.com/workers/" target="_blank">Cloudflare Workers</a> and its distributed key-value store <a href="https://developers.cloudflare.com/workers/reference/storage" target="_blank">Workers KV</a>!</p>
	<h3 id="what-is-cdnjs">What is cdnjs?</h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/09/imagesmall.png" class="kg-image"></figure>
	<p>For those unfamiliar, cdnjs is an acronym describing a Content Delivery Network (CDN) for JavaScript (JS). A <a href="https://www.cloudflare.com/learning/cdn/what-is-a-cdn/" target="_blank">CDN</a> simply refers to a geographically distributed network of servers that provide Internet content, whether it is memes, cat videos, or HTML pages. In our case, the CDN refers to Cloudflare’s ever <a href="https://blog.cloudflare.com/cloudflare-network-expands-to-more-than-100-countries/">expanding network</a> of over 200 globally distributed data centers.</p>
	<p>And here’s why this is relevant to you: it makes page load times lightning-fast. Virtually every website you visit needs to fetch JS libraries in order to load, including this one. Let’s say you visit a Sydney-based website that contains a local file from jQuery, a popular library found in <a href="https://w3techs.com/technologies/details/js-jquery" target="_blank">76.2%</a> of websites. If you are located in New York, you may notice a delay, as it can easily exceed 300ms to fetch the file—not to mention the time it takes for the round trips involved with the <a href="https://blog.cloudflare.com/tls-1-3-overview-and-q-and-a/">TLS handshake</a>. However, if the website references jQuery using <a href="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" target="_blank">cdnjs.cloudflare.com</a>, you can retrieve the file from the closest Cloudflare data center in Buffalo, reducing the latency to a blazing 20ms.</p>
	<p>While cdnjs operates behind the scenes, it is used by <a href="https://w3techs.com/technologies/overview/content_delivery" target="_blank">over 11%</a> of websites, making the Internet a much faster and more reliable place. In July, cdnjs served almost <a href="https://github.com/cdnjs/cf-stats/blob/master/2020/cdnjs_July_2020.md" target="_blank">190 billion requests</a>—an enormous 3.46PB of data.</p>
	<h3 id="where-are-the-files-stored">Where are the files stored?</h3>
	<!--kg-card-begin: html-->
	<p><img style="border-width: 0px;" src="https://blog.cloudflare.com/content/images/2020/09/image5-2.png" alt="" width="400" height="333"></p>
	<!--kg-card-end: html-->
	<p>While cdnjs speeds up the Internet, it certainly isn’t magic!</p>
	<p>Historically, a number of <a href="https://www.cloudflare.com/load-balancing/" target="_blank">load-balanced</a> machines at one of Cloudflare’s core data centers would periodically pull cdnjs files from a backing store, acting as the origin for cdnjs.cloudflare.com. When a new file is requested, it is <a href="https://www.cloudflare.com/learning/cdn/what-is-caching/" target="_blank">cached</a> by Cloudflare, allowing it to be fetched quickly from any of our data centers.</p>
	<p>The backing store is a catalogue of JS, CSS, and other web libraries in the form of an open-source <a href="https://github.com/" target="_blank">GitHub</a> repository. What this means is that anyone—including you—can contribute to it, subject to review and other processes.</p>
	<p>However, until recently, these existing operations were very labor intensive and fragile. </p>
	<p>This blog post will explain why we changed the infrastructure behind cdnjs to make it faster, more reliable, and easier to maintain. First, we will discuss how the community used to contribute to cdnjs, outlining the pains and concerns of the old system. Then, we will explore the benefits of migrating to Workers KV. After, we will dive into the new architecture, as well as upgrades to the website and cdnjs API. Finally, we will review the history of cdnjs, and where it is headed in the future.</p>
	<h3 id="if-you-think-you-know-how-to-make-a-pr-think-again">If you think you know how to make a PR, think again<br></h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/09/image1-1.png" class="kg-image"></figure>
	<p>For the non-technical reader, a pull request (PR) is a request to merge changes you’ve made to a repository. Traditionally, if you wanted to include your JavaScript library in cdnjs, you would first create a PR on GitHub to <a href="https://github.com/cdnjs/cdnjs" target="_blank">cdnjs/cdnjs</a> with a JSON file describing your package and additional files for any version you wished to include. Once your PR was approved by our <a href="https://github.com/PeterBot" target="_blank">old bot</a>, manually reviewed, and then merged by a maintainer, your package would be integrated with cdnjs.</p>
	<p>Sounds easy, right? You can just fork the repo, clone it, and copy paste a few files, no?</p>
	<p>Exactly. Contributing was easy if you had several hours to burn, a case-sensitive file system, and a couple hundred gigabytes of free disk space to <a href="https://git-scm.com/docs/git-clone" target="_blank">git clone</a> the 300GB repo. If you were short on time—no problem, you could always use your advanced knowledge of <a href="https://git-scm.com/docs/git-sparse-checkout" target="_blank">git sparse-checkout</a> to get the job done. Don’t know git? Just add one file at a time manually through GitHub’s UI.</p>
	<p>I think you get the point. I know I certainly did when I naively spent 10 hours cloning the repo, only to discover that macOS is case-insensitive by default. </p>
	<p>However, updating cdnjs was not only difficult for the contributors, but also the maintainers. Historically, the community was able to contribute version files directly, which could potentially be malicious. This created lots of work for maintainers, requiring them to inspect each file manually, <a href="https://man7.org/linux/man-pages/man1/diff.1.html" target="_blank">diffing</a> files against the official library source and running malware checks. <br>So how did packages update once they were in cdnjs? In the JSON file describing each package, there was an optional auto-update definition telling the bot where to look for new versions of the library. If present, when your package released a new version from npm or GitHub, the bot would download it, pushing the files to <a href="https://github.com/cdnjs/cdnjs" target="_blank">cdnjs/cdnjs</a> and computed <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" target="_blank">Subresource Integrity</a> (SRI) hashes to <a href="https://github.com/cdnjs/SRIs" target="_blank">cdnjs/SRIs</a>. If the auto-update property was missing, it would be your responsibility to make manual PRs to update cdnjs with any future versions. </p>
	<h3 id="a-wake-up-call-for-cdnjs">A wake-up call for cdnjs</h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/11/image6-1-4.png" class="kg-image"></figure>
	<p>In April, during maintenance at one of our core data centers, a technician accidentally disconnected the cables supplying all external connections to our other data centers, causing the data center to go offline for approximately four hours. <a href="https://blog.cloudflare.com/cloudflare-dashboard-and-api-outage-on-april-15-2020/">This incident</a> served as the first wake-up call for cdnjs, especially since the affected data center housed the primary cdnjs origin web servers. In this case, we did have a backup running on an external provider, but what really saved us was Cloudflare’s global cache, which minimized the impact of the outage as only uncached assets failed to load.</p>
	<p>We started to think about how we can improve both the reliability and performance of how we serve cdnjs. We went straight to <a href="https://workers.cloudflare.com/" target="_blank">Cloudflare Workers</a>, our own platform for developing on the <a href="https://www.cloudflare.com/learning/cdn/glossary/edge-server/" target="_blank">edge</a>. One powerful tool built into Workers is <a href="https://developers.cloudflare.com/workers/reference/storage" target="_blank">Workers KV</a>—a low-latency, globally distributed key-value store optimized for high-read applications.</p>
	<p>We put two and two together, realizing that instead of pulling the <a href="https://github.com/cdnjs/cdnjs" target="_blank">cdnjs/cdnjs</a> repository and serving files from disk, we could cut the physical machines out entirely, distributing the data around the world and serving files straight from the edge. That way, cdnjs would be able to recover from any origin data center failure, while also increasing its scalability.</p>
	<h3 id="workers-kv-to-the-rescue">Workers KV to the rescue</h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/09/image3-3.png" class="kg-image"></figure>
	<p>At first glance, the decision to use Workers KV was a no-brainer. Since files in cdnjs never change but require frequent reads, Workers KV was a perfect fit.</p>
	<p>However, as we planned our migration, we became concerned that with over 7 million assets in cdnjs, there would undoubtedly exist files that exceed <a href="https://developers.cloudflare.com/workers/about/limits/" target="_blank">Workers KV’s 10MiB value limit</a>. After investigating, we discovered that several hundred cdnjs files were oversized, the majority being <a href="https://developer.mozilla.org/en-US/docs/Tools/Debugger/How_to/Use_a_source_map" target="_blank">JavaScript Source Maps</a>. </p>
	<p>Then the idea hit us. We could store compressed versions of cdnjs files in Workers KV, not only solving our oversized file issue, but also optimizing how we serve files.</p>
	<p>If you pay the Internet bill, you’ll know that <a href="https://blog.cloudflare.com/the-relative-cost-of-bandwidth-around-the-world/">bandwidth is expensive</a>! For this reason, all modern browsers will try to <a href="https://blog.cloudflare.com/efficiently-compressing-dynamically-generated-53805/">fetch compressed web content</a> whenever it is available. Similarly, within Cloudflare we often <a href="https://blog.cloudflare.com/results-experimenting-brotli/">experiment with on-the-fly compression</a> to reduce our bandwidth, always serving compressed content to the eyeball when it is accepted. As a result, we decided to compress all cdnjs files ahead of time, writing them to Workers KV with both optimal <a href="https://github.com/google/brotli" target="_blank">Brotli</a> and <a href="https://www.gzip.org/" target="_blank">gzip</a> forms. That way, we could increase the compression level compared to on-the-fly compression as we no longer have the latency requirements. </p>
	<p>This means we now serve cdnjs files faster and smaller!</p>
	<h3 id="a-complete-makeover-for-cdnjs">A complete makeover for cdnjs</h3>
	<!--kg-card-begin: html-->
	<p><a href="https://blog.cloudflare.com/content/images/2020/09/image7-1.png" target="_blank" rel="noopener"><img style="border-width: 0px;" src="https://blog.cloudflare.com/content/images/2020/09/image7-1.png" width="800" height="498"></a></p>
	<!--kg-card-end: html-->
	<p>Today, if you want to include your JavaScript library in cdnjs, you first create a PR on GitHub to our new repository <a href="https://github.com/cdnjs/packages" target="_blank">cdnjs/packages</a>. The repo is easily cloneable at 50MB and consists of thousands of JSON files, each describing a cdnjs package and how it is auto-updated from npm or git. Once your file is validated by our automated CI—powered by a <a href="https://github.com/cdnjs/tools" target="_blank">new bot</a>—and merged by a maintainer, your package would be automatically enrolled in our auto-update service.</p>
	<p>In the new system, security and maintainability are prioritized. For starters, cdnjs version files are<em> </em>created by our bot, minimizing the possibility of human error when merging a new version. While the JSON files in <a href="https://github.com/cdnjs/packages" target="_blank">cdnjs/packages</a> are added by error-prone humans, they are inspected by our bot before being approved by a maintainer. Each file is automatically validated against a <a href="https://github.com/cdnjs/tools/blob/master/schema_human.json" target="_blank">JSON schema</a>, as well as checked for popularity on npm or GitHub.</p>
	<p>When the bot discovers a new release, it pushes Brotli and gzip-compressed versions of the files to a files namespace in Workers KV. With each entry, the bot writes some <a href="https://blog.cloudflare.com/catching-up-with-workers-kv/">metadata in Workers KV</a> for the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag" target="_blank">ETag</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified" target="_blank">Last-Modified</a> HTTP headers. Similar to before, the bot also computes <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" target="_blank">Subresource Integrity</a> (SRI) hashes of the uncompressed files, but now pushes them instead to a SRIs namespace in Workers KV. </p>
	<p>Then, when a new file is requested from cdnjs.cloudflare.com, a <a href="https://developers.cloudflare.com/workers/" target="_blank">Cloudflare Worker</a> will inspect the client’s <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Encoding" target="_blank">Accept-Encoding</a> header, fetching either the Brotli or gzip-compressed version with its ETag and Last-Modified metadata from Workers KV. As the compressed file travels back through Cloudflare, it is cached for future requests and uncompressed on-the-fly if needed.</p>
	<p>At the moment, there are still a handful of files exceeding Workers KV’s size limit. Consequently, if the Cloudflare Worker fails to retrieve a file from Workers KV, it is fetched from the origin backed by the original git repo. In the coming months, we plan on gradually removing this infrastructure.</p>
	<h3 id="scaling-the-website-and-api">Scaling the website and API</h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/09/image2.gif" class="kg-image"></figure>
	<p>Besides the core cdnjs infrastructure, many of its other components received upgrades as well!</p>
	<p>On the cdnjs project’s <a href="https://cdnjs.com/" target="_blank">homepage</a>, you will be greeted by a slick <a href="https://github.com/cdnjs/static-website" target="_blank">new beta website</a> built by <a href="https://github.com/mattipv4" target="_blank">Matt</a>. Constructed with <a href="https://vuejs.org/" target="_blank">Vue</a> and <a href="https://nuxtjs.org/" target="_blank">Nuxt</a>, the beta website is powered entirely by the <a href="https://cdnjs.com/api" target="_blank">cdnjs API</a>. As a result, it is always up-to-date with the latest package information and requires low resource usage to serve the site—which runs completely on the client-side after the first page load—helping us scale with cdnjs’s never-ending growth. </p>
	<p>In fact, the cdnjs API also strengthened its scalability, benefitting from a serverless architecture close to the one we have seen with cdnjs and Workers KV. </p>
	<p>Before migrating to Workers KV, the cdnjs API relied on a regularly scheduled process that involved generating about 300MB of metadata. The cdnjs API’s backend would then fetch this enormous “package.min.js” file into memory and use it to operate the API. If you are curious, the file is still being hosted <a href="https://storage.googleapis.com/cdnjs-assets/package.min.js" target="_blank">here</a>, but be warned—it may lag your browser! Similarly, file SRIs were pushed to <a href="https://github.com/cdnjs/SRIs" target="_blank">cdnjs/SRIs</a>, which was cloned by the API locally to serve SRI responses.</p>
	<p>After all cdnjs files (within the permitted size limit) were moved to Workers KV, these legacy processes became unsustainable, requiring millions of reads and an unreasonable amount of time. Therefore, we decided to upload all metadata found into Workers KV. We split the metadata into four namespaces—one for package-level metadata, one for version-specific metadata, one containing aggregated metadata, and one for file SRIs.</p>
	<p>Similar to cdnjs’s serverless design, a Cloudflare Worker sits on top of <a href="http://metadata.speedcdnjs.com/packages" target="_blank">metadata.speedcdnjs.com</a>, serving data from Workers KV using several public endpoints. Currently, the cdnjs API is fully integrated with these endpoints, which provide an elegant solution as cdnjs continues to scale.</p>
	<h3 id="transparency-and-the-future-of-cdnjs">Transparency and the future of cdnjs</h3>
	<p>Since its birth in January 2011, cdnjs has always been deeply rooted in transparency, deriving its strength from the community. Even when cdnjs exploded in size and its founders Ryan Kirkman and Thomas Davis <a href="https://blog.cloudflare.com/cdnjs-community-moderated-javascript-librarie/">teamed up with us in June 2011</a>, the project remained entirely open-source on <a href="https://github.com/cdnjs/" target="_blank">GitHub</a>.</p>
	<p>As the years passed, it became harder for the founders to stay active, heavily depending on the community for support. With a nearly nonexistent budget and little access to the repository, core cdnjs maintainers were challenged every day to keep the project alive.</p>
	<p>Last year, this led us to contact the founders, <a href="https://news.ycombinator.com/item?id=21416614" target="_blank">who were happy to have our assistance with the project</a>. With Cloudflare’s increased role, cdnjs is as stable as ever, with <a href="https://cdnjs.com/about" target="_blank">active members</a> from both Cloudflare and the community. </p>
	<p>However, as we remove our reliance on the legacy system and store files in Workers KV, there are concerns that cdnjs will become proprietary. Don’t worry, we are working hard to ensure that cdnjs remains as transparent and open-source as possible. To help the community audit updates to Workers KV, there is a new repository, <a href="https://github.com/cdnjs/logs" target="_blank">cdnjs/logs</a>, which is used by the bot to log all Workers KV-related events. Furthermore, anyone can validate the integrity of cdnjs files by fetching SRIs from the cdnjs API. <br></p>
	<h3 id="conclusion">Conclusion</h3>
	<p>Overall, this past year has been a turbulent time for cdnjs, but all of its shortcomings have acted as red flags to help us build a better system. Most recently, we have mitigated the risks of depending on physical machines at a single location, migrating cdnjs to a serverless infrastructure where its files are stored in <a href="https://developers.cloudflare.com/workers/reference/storage" target="_blank">Workers KV</a>.</p>
	<p>Today, cdnjs is in good hands, and is not going away anytime soon. Shout out especially to the maintainers <a href="https://github.com/xtuc" target="_blank">Sven</a> and <a href="https://github.com/mattipv4" target="_blank">Matt</a> for creating tons of momentum with the project, working on everything from scaling cdnjs to editing this post.</p>
	<p>Moving forward, we are committed to making cdnjs as transparent as possible. As we continue to improve cdnjs, we will release more blog posts to keep the community up to date. If you are interested, please subscribe to our blog. After all, it is the community that makes cdnjs possible! A special thanks to our active GitHub contributors and members of the <a href="https://github.com/cdnjs/cdnjs/discussions/" target="_blank">cdnjs Community Forum</a> for sticking with us!</p>
</div>