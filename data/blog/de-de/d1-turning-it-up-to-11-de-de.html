<div class="mb2 gray5">9 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/image1-51.png" class="kg-image" alt="D1: We turned it up to 11" loading="lazy" width="1999" height="1125"></figure>
	<p>Wir wollen nicht lange um den heißen Brei herumreden: Wir freuen uns, ein größeres Update für unsere D1-Datenbank vorzustellen, das die Performance und Skalierbarkeit erheblich verbessert. Alpha-Nutzer (d.h. <em>alle</em> Workers-Nutzer) können ab sofort mit dem folgenden Befehl neue Datenbanken mit dem neuen Speicher-Backend erstellen:</p><!--kg-card-begin: markdown-->
	<pre><code>$ wrangler d1 create your-database --experimental-backend
</code></pre>
	<!--kg-card-end: markdown-->
	<p>In den kommenden Wochen wird die neue Version standardmäßig für alle verfügbar sein, aber wir möchten Entwickler dazu einladen, bereits jetzt mit der neuen Version von D1 ein wenig zu experimentieren. In Kürze werden wir auch mehr darüber berichten, wie wir das neue Speichersubsystem von D1 entwickelt haben und wie es vom verteilten Netzwerk von Cloudflare profitiert..</p>
	<h3 id="zur-erinnerung-was-ist-d1">Zur Erinnerung: Was ist D1?</h3>
	<p>D1 ist die native serverlose Datenbank von Cloudflare, die wir im November letzten Jahres <a href="https://blog.cloudflare.com/d1-open-alpha">in die Alpha-Phase gebracht</a> haben. Entwickler haben komplexe Anwendungen mit Workers, KV, Durable Objects und neuerdings auch Queues &amp; R2 erstellt, aber sie haben uns auch immer wieder um eines gebeten: eine abfragbare Datenbank.</p>
	<p>Wir haben auch immer wieder gehört, dass es SQL-basiert und skalierbar sein sollte und (genau wie Workers selbst) dem Ansatz von „Region: Erde“ folgen sollte. Wir haben dieses Feedback aufgegriffen und uns daran gemacht, D1 zu entwickeln. Mit SQLite verfügen wir über einen vertrauten SQL-Dialekt, eine robuste Abfrage-Engine und eine der am besten getesteten Code-Basen, auf die wir aufbauen können.</p>
	<p>Wir haben die erste Version von D1 als „echte“ Alpha-Version herausgebracht: eine Möglichkeit für uns, offen zu entwickeln, direktes Feedback von den Entwicklern einzuholen und besser zu priorisieren, was wichtig ist. Und wie es sich für eine Alpha-Version gehört, gab es Bugs, Performance-Probleme und einen ziemlich engen „Happy Path“.</p>
	<p>Trotzdem haben wir beobachtet, dass Entwickler Tausende von Datenbanken eingerichtet und Milliarden von Abfragen durchgeführt haben. Beliebte ORMs wie <a href="https://github.com/drizzle-team/drizzle-orm">Drizzle</a> und <a href="https://github.com/kysely-org/kysely">Kysely</a> unterstützen D1 (bereits!), und auch <a href="https://github.com/jose-donato/race-stack">Remix-</a> und <a href="https://github.com/Atinux/nuxt-todos-edge">Nuxt</a>-Vorlagen bauen direkt darauf auf.</p>
	<h3 id="wir-setzen-eins-drauf">Wir setzen eins drauf</h3>
	<p>Wenn Sie D1 bisher in der Alphaversion genutzt haben: vergessen Sie alles, was Sie bisher kannten. D1 ist jetzt wesentlich schneller: bis zu 36x schneller in der bekannten <a href="https://github.com/cloudflare/d1-northwind">Northwind Traders-Demo</a>, die wir <a href="https://northwind.d1sql.com">gerade</a> auf unser neues Speicher-Backend umgestellt haben:<br></p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/image5-12.png" class="kg-image" alt="" loading="lazy" width="1226" height="402"></figure>
	<p>Unsere neue Architektur erhöht auch die Performance bei Schreibvorgängen: Ein einfacher Benchmark, bei dem 1.000 Zeilen (jede Zeile ist etwa 200 Byte breit) eingefügt werden, ist etwa 6,8-mal schneller als die vorherige Version von D1.</p>
	<p>Bei größeren Batches (10.000 Zeilen mit einer Breite von ~200 Byte) ist die Verbesserung sogar noch deutlicher: zwischen 10- und 11-mal, wobei die Latenz des neuen Speicher-Backends auch deutlich einheitlicher ist. Dabei haben wir noch gar nicht damit begonnen, unseren gesamten Schreibdurchsatz zu optimieren, sodass wir erwarten, dass D1 hier noch schneller wird.</p>
	<p>Mit unserem neuen Speicher-Backend möchten wir auch klarstellen, dass D1 nicht irgendein Spielzeug ist. Wir führen ständig Benchmarking-Tests unserer Performance mit anderen serverlosen Datenbanken durch. Bei einer Abfrage einer 500.000 Zeilen umfassenden Key-Value-Datenbank (wobei zu berücksichtigen ist, dass Benchmarks naturgemäß synthetisch sind) ist D1 etwa 3,2x schneller als ein beliebter serverloser Postgres-Anbieter:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/download-14.png" class="kg-image" alt="" loading="lazy" width="1600" height="525"></figure>
	<p>Wir haben die Postgres-Abfragen mehrmals ausgeführt, um den Seiten-Cache vorzubereiten, und dann die vom Server gemessene mittlere Abfragezeit ermittelt. Wir werden unseren Performance-Vorsprung auch in Zukunft weiter ausbauen.</p>
	<p>Entwickler mit bestehenden Datenbanken können Daten in eine neue Datenbank importieren, die von der Storage-Engine unterstützt wird, indem sie die Schritte zum <a href="https://developers.cloudflare.com/d1/learning/backups/#downloading-a-backup-locally">Exportieren ihrer Datenbank</a> und anschließendem <a href="https://developers.cloudflare.com/d1/learning/importing-data/#import-an-existing-database">Importieren</a> in unserer Dokumentation befolgen.<br></p>
	<h3 id="was-habe-ich-verpasst">Was habe ich verpasst?</h3>
	<p>Wir haben auch an einer Reihe von Verbesserungen der D1-Entwicklererfahrung gearbeitet:</p>
	<ul>
		<li>Eine neue Konsole, die es Ihnen ermöglicht, Abfragen direkt vom Dashboard aus zu erstellen, was den Einstieg erleichtert und/oder einmalige Abfragen ermöglicht.<br></li>
		<li>Formale <a href="https://developers.cloudflare.com/d1/learning/querying-json">Unterstützung für JSON-Funktionen</a>, die JSON direkt in Ihrer Datenbank abfragen.<br></li>
		<li><a href="https://developers.cloudflare.com/d1/learning/data-location">Location Hints</a> (Standorthinweise), mit denen Sie beeinflussen können, wo sich Ihr Leader (der für Schreibvorgänge zuständig ist) weltweit befindet.<br></li>
	</ul>
	<p>Obwohl D1 so konzipiert ist, dass es nativ in Cloudflare Workers funktioniert, ist uns klar, dass es oft notwendig ist, beim Prototyping oder bei der Erkundung einer Datenbank schnell einmalige Abfragen über CLI oder einen Webeditor zu erstellen. Zusätzlich zur <a href="https://developers.cloudflare.com/workers/wrangler/commands/#execute">Wrangler-Unterstützung für die Ausführung von Abfragen</a> (und Dateien) haben wir einen Konsolen-Editor eingeführt, mit dem Sie Abfragen erstellen, Tabellen prüfen und sogar Daten im laufenden Betrieb bearbeiten können:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/image3-20.png" class="kg-image" alt="" loading="lazy" width="1999" height="960"></figure>
	<p><a href="https://developers.cloudflare.com/d1/learning/querying-json/#extracting-values">JSON-Funktionen</a> ermöglichen Ihnen die Abfrage von JSON-Daten, die in TEXT-Spalten in D1 gespeichert ist: So können Sie flexibel entscheiden, welche Daten ausschließlich mit Ihrem relationalen Datenbankschema verknüpft sind und welche nicht, während Sie dennoch in der Lage sind, alle Daten über SQL abzufragen (bevor sie Ihre Anwendung erreichen).</p>
	<p>Nehmen wir zum Beispiel an, Sie speichern die Zeitstempel der letzten Anmeldung als JSON-Array in einer login_history TEXT-Spalte: Ich kann Unterobjekte oder Array-Elemente direkt abfragen (und extrahieren), indem ich einen Pfad zu ihrem Schlüssel angebe:</p><!--kg-card-begin: markdown-->
	<pre><code>SELECT user_id, json_extract(login_history, '$.[0]') as latest_login FROM users
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Die Unterstützung von D1 für JSON-Funktionen ist äußerst flexibel und nutzt den SQLite-Core, auf dem D1 aufbaut. </p>
	<p>Wenn Sie zum ersten Mal eine Datenbank mit D1 erstellen, leiten wir den Standort automatisch daraus ab, von wo aus Sie sich gerade verbinden. Es gibt jedoch einige Fälle, in denen Sie das beeinflussen möchten – vielleicht sind Sie auf Reisen oder Sie haben ein verteiltes Team, das sich von der Region unterscheidet, aus der Sie die meisten Ihrer Schreibvorgänge erwarten.</p>
	<p>Die D1-Unterstützung für Location Hints macht das ganz einfach:</p><!--kg-card-begin: markdown-->
	<pre><code># Automatically inferred based your location
$ wrangler d1 create user-prod-db --experimental-backend

# Indicate a preferred location to create your database
$ wrangler d1 create eu-users-db --location=weur --experimental-backend
</code></pre>
	<!--kg-card-end: markdown-->
	<p><a href="https://developers.cloudflare.com/d1/learning/data-location">Location Hints</a> sind jetzt auch im Cloudflare Dashboard verfügbar:<br></p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/image4-20.png" class="kg-image" alt="" loading="lazy" width="1988" height="1802"></figure>
	<p>Wir haben auch <a href="https://developers.cloudflare.com/d1">mehr Dokumentation</a> veröffentlicht, um Entwicklern nicht nur den Einstieg, sondern auch die Nutzung der erweiterten Funktionen von D1 zu erleichtern. In den kommenden Monaten wird die Dokumentation von D1 noch erheblich erweitert werden. </p>
	<h3 id="wird-sie-kein-verm%C3%B6gen-kosten">Wird Sie kein Vermögen kosten</h3>
	<p>Seit der Ankündigung der Alpha-Phase haben uns viele Entwickler gefragt, wie die Preise für D1 aussehen werden. Wir sind nun bereit, Ihnen nähere Infos zu den Preisen mitzuteilen. Wir wissen, dass Sie die Kosten kennen sollten, <em>bevor</em> Sie mit der Entwicklung beginnen, um später nicht überrascht zu werden.<br></p>
	<p>Auf den Punkt gebracht:</p>
	<ul>
		<li>Wir geben die Preise bekannt, sodass Sie schon im Voraus modellieren können, wie viel D1 für Ihren Anwendungsfall kosten wird. Die endgültige Preisgestaltung kann sich noch ändern, obwohl wir davon ausgehen, dass die Änderungen relativ gering ausfallen werden.<br></li>
		<li>Wir werden die Abrechnung erst zu einem späteren Zeitpunkt in diesem Jahr aktivieren und bestehende Nutzer von D1 per E-Mail über diese Änderung informieren. Bis dahin bleibt die Nutzung von D1 kostenlos.<br></li>
		<li>D1 wird eine dauerhaft kostenlose Tarifstufe beinhalten, die Nutzung ist in unserem 5 USD/Monat Workers-Abonnement inbegriffen, und die Abrechnung erfolgt auf der Grundlage von Lese- und Schreibvorgängen und Speicherplatz.<br></li>
	</ul>
	<p>Wenn Sie Workers bereits abonniert haben, müssen Sie keinen Finger rühren: Ihr bestehendes Abonnement wird die D1-Nutzung einschließen, wenn wir die Abrechnung in Zukunft aktivieren.</p>
	<p>Hier ist eine Zusammenfassung (bewusst einfach gehalten):</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/Screenshot-2023-05-19-at-10.14.58.png" class="kg-image" alt="" loading="lazy" width="1584" height="488"></figure>
	<p></p>
	<p>Wichtig ist, <strong>dass Sie, wenn wir die globale Lesereplikation aktivieren, weder extra dafür bezahlen müssen, noch wird die Replikation Ihren Speicherverbrauch vervielfachen</strong>. Wir sind der Meinung, dass eine integrierte, automatische Replikation wichtig ist und dass Entwickler keine multiplikativen Kosten (Replikate x Speichergebühren) zahlen sollten, um ihre Datenbank <em>überall</em> zu beschleunigen. </p>
	<p>Darüber hinaus wollten wir sicherstellen, dass D1 die besten Aspekte der serverlosen Preisgestaltung nutzt: Skalierung bis zum Nullpunkt und nutzungsbasierte Abrechnung. So müssen Sie nicht versuchen zu ermitteln, wie viele CPUs und/oder wie viel Arbeitsspeicher Sie für Ihre Arbeitslast benötigen, oder Skripte schreiben, um Ihre Infrastruktur in den ruhigeren Stunden herunterzufahren.</p>
	<p>Die D1-Preise für Lesevorgänge basieren auf dem bekannten Konzept einer Leseeinheit (pro 4 KB gelesen) und einer Schreibeinheit (pro 1 KB geschrieben). Eine Abfrage, die ~10.000 Zeilen zu je 64 Byte liest (scannt), würde 160 Leseeinheiten verbrauchen. Schreiben Sie eine große 3KB-Zeile in eine „blog_posts“-Tabelle, die eine Menge Markdown enthält, so sind das drei Schreibeinheiten. Und wenn Sie <a href="https://developers.cloudflare.com/d1/learning/using-indexes">Indizes für Ihre beliebtesten Abfragen erstellen</a>, um die Performance zu verbessern und die Datenmenge zu reduzieren, die diese Abfragen durchsuchen müssen, senken Sie auch die Kosten, die wir Ihnen in Rechnung stellen. Wir glauben, dass es der richtige Ansatz ist, den schnellen Pfad standardmäßig kosteneffizienter zu machen.</p>
	<p>Wichtig: Wir werden auch weiterhin Feedback zu unserer Preisgestaltung einholen, bevor wir die Abrechnung aktivieren.</p>
	<h3 id="time-travel">Time Travel</h3>
	<p>Wir führen auch eine neue Backup-Funktion ein: die Point-in-Time-Wiederherstellung, die wir Time Travel nennen, weil sie sich genau so anfühlt. <strong>Mit Time Travel können Sie Ihre D1-Datenbank bis zu einer beliebigen Minute innerhalb der letzten 30 Tage wiederherstellen. Die Funktion wird in D1-Datenbanken integriert, die unser neues Speichersystem nutzen</strong>. Wir gehen davon aus, dass wir Time Travel in naher Zukunft für neue D1-Datenbanken aktivieren werden.<br></p>
	<p>Was Time Travel wirklich leistungsstark macht, ist, dass Sie <em>nicht mehr in Panik geraten</em> und sich fragen müssen: „Oh, Moment einmal, habe ich ein Backup gemacht, bevor ich diese wichtige Änderung vorgenommen habe?“ – weil wir das für Sie tun. Wir zeichnen alle Änderungen an Ihrer Datenbank auf (das <a href="https://www.sqlite.org/wal.html">Write-Ahead Log</a>), und können so Ihre Datenbank zu einem <em>bestimmten Zeitpunkt wiederherstellen</em>, indem wir die Änderungen bis zu diesem Zeitpunkt nacheinander abspielen.<br></p>
	<p>Hier ist ein Beispiel (vorbehaltlich einiger kleinerer API-Änderungen):</p><!--kg-card-begin: markdown-->
	<pre><code class="language-javascript"># Using a precise Unix timestamp (in UTC):
$ wrangler d1 time-travel my-database --before-timestamp=1683570504

# Alternatively, restore prior to a specific transaction ID:
$ wrangler d1 time-travel my-database --before-tx-id=01H0FM2XHKACETEFQK2P5T6BWD
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Und obwohl die Idee der Point-in-Time-Wiederherstellung nicht neu ist, handelt es sich dabei oft um ein kostenpflichtiges Add-on, wenn es überhaupt verfügbar ist. Wenn Sie feststellen, dass Sie die Funktion hätten aktivieren sollen, nachdem Sie etwas gelöscht oder einen anderen Fehler gemacht haben, ist es oft schon zu spät.</p>
	<p>Stellen Sie sich zum Beispiel vor, ich würde den klassischen Fehler machen, ein WHERE bei einer UPDATE-Anweisung zu vergessen:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-javascript">-- Don't do this at home
UPDATE users SET email = 'matt@example.com' -- missing: WHERE id = "abc123"
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Ohne Time Travel müsste ich hoffen, dass entweder kürzlich ein geplantes Backup durchgeführt wurde oder dass ich immer daran denke, kurz zuvor ein manuelles Backup zu erstellen. Mit Time Travel kann ich zu einem Punkt zurückkehren, der etwa eine Minute vor diesem Fehler liegt (und hoffentlich daraus für das nächste Mal lernen).</p>
	<p>Wir arbeiten auch an Funktionen, mit denen größere Änderungen am Zustand Ihrer Datenbank sichtbar gemacht werden können. Dazu gehört, dass Schemaänderungen, die Anzahl der Tabellen, große Deltas in den gespeicherten Daten <em>und sogar bestimmte Abfragen </em>(über Transaktions-IDs) — leichter identifiziert werden können – damit Sie besser verstehen, zu welchem Zeitpunkt Sie Ihre Datenbank wiederherstellen müssen.</p>
	<h3 id="in-vorbereitung">In Vorbereitung</h3>
	<p>Wie geht es weiter mit D1?</p>
	<ul>
		<li><strong>Open Beta</strong>: Wir stellen sicher, dass wir unser neues Speichersubsystem unter Last (und in der realen Nutzung) beobachtet haben, bevor wir es standardmäßig für alle `d1 create` – Befehle einsetzen. Wir legen die Messlatte für Haltbarkeit und Verfügbarkeit hoch, selbst für eine „Beta“, und wir wissen auch, dass der Zugang zu Backups (Time Travel) wichtig ist, damit die Benutzer einer neuen Datenbank vertrauen. Schauen Sie in den kommenden Wochen regelmäßig in den Cloudflare-Blog, um weitere Neuigkeiten zu erfahren!<br></li>
		<li><strong>Größere Datenbanken</strong>: Wir sind uns bewusst, dass sich viele Nutzer diese Funktion besonders dringend wünschen. Wir arbeiten auch schon hart an der Implementierung. Entwickler mit dem <a href="https://developers.cloudflare.com/workers/platform/pricing/#workers">Workers Paid-Tarif</a> werden in naher Zukunft Zugang zu 1 GB großen Datenbanken erhalten, und wir werden die maximale Größe pro Datenbank im Laufe der Zeit weiter erhöhen.<br></li>
		<li><strong>Metriken und Beobachtbarkeit</strong>: Sie können das Gesamtabfragevolumen nach Datenbank, fehlgeschlagenen Abfragen, verbrauchtem Speicherplatz und Lese-/Schreibeinheiten sowohl über das D1-Dashboard als auch über <a href="https://developers.cloudflare.com/analytics/graphql-api">unsere GraphQL-API</a> einsehen, sodass Sie einfacher Probleme beheben und Ausgaben verfolgen können.<br></li>
		<li><strong>Automatische Lese-Replikation</strong>: Unser neues Speichersubsystem wurde mit Blick auf die Replikation entwickelt, und wir arbeiten daran, dass unsere Replikationsschicht sowohl schnell als auch zuverlässig ist, bevor wir sie für Entwickler bereitstellen. Die Replikation von Lesevorgängen soll nicht nur die Abfragelatenz verbessern, indem Kopien – Replikate – Ihrer Daten an mehreren Orten in der Nähe Ihrer Nutzer gespeichert werden, sondern sie ermöglicht uns auch die horizontale Skalierung von D1-Datenbanken für diejenigen, die größere Arbeitslasten haben.<br>In der Zwischenzeit können Sie <a href="https://developers.cloudflare.com/d1/get-started">mit D1 Prototypen erstellen und experimentieren</a>, unser D1 + Drizzle + Remix <a href="https://github.com/rozenmd/d1-drizzle-remix-example">Beispielprojekt</a> erkunden, oder dem <a href="https://discord.cloudflare.com">#d1 channel</a> im Cloudflare Developers Discord Server beitreten, um sich direkt mit dem D1-Team und anderen, die an D1 arbeiten, auszutauschen.</li>
	</ul>
</div>