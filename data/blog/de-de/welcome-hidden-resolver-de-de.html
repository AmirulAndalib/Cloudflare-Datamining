<div class="mb2 gray5">9 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_0.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Falls Sie es noch nicht gehört haben, Cloudflare hat am 1. April einen <a href="https://www.cloudflare.com/learning/dns/what-is-dns">DNS</a> Resolver-Dienst <a href="https://blog.cloudflare.com/dns-resolver-1-1-1-1">gestartet</a>, bei dem die Privatsphäre an erster Stelle steht. Das war kein Aprilscherz! Dieser Dienst, bei dem es sich um unseren ersten verbraucherorientierten Dienst handelt, unterstützt neue DNS-Standards wie DNS über HTTPS:443 und TLS:853, neben traditionellen Protokollen über UDP:53 und TCP:53, alles in einer einzigen, leicht zu merkenden Adresse: <a href="https://1.1.1.1">1.1.1.1</a>.</p>
	<p>Wie bereits im ursprünglichen Blogbeitrag erwähnt, ist unser Grundsatz, garantiert niemals Client-IP-Adressen auf Festplatten zu speichern und alle Protokolle innerhalb von 24 Stunden zu löschen. Dennoch wollen ganz besonders auf ihre Privatsphäre bedachte Leute ihre IP-Adresse vielleicht nicht einmal dem Resolver mitteilen, was wir respektieren. Aus diesem Grund starten wir unter <a href="https://dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion">dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion</a> einen Tor Onion Service für unseren Resolver, der über <a href="https://tor.cloudflare-dns.com">tor.cloudflare-dns.com</a> erreichbar ist.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/tor.gif" class="kg-image" alt="" loading="lazy"></figure>
	<p><strong>HINWEIS:</strong> Der versteckte Resolver ist noch ein experimenteller Dienst und sollte erst dann in der Produktion oder für andere kritische Anwendungen verwendet werden, wenn er ausgiebiger getestet wurde.</p>
	<h3 id="crashkurs-in-sachen-tor"><strong>Crashkurs in Sachen Tor</strong><br></h3>
	<h4 id="was-ist-tor"><strong>Was ist </strong><a href="https://www.torproject.org"><strong>Tor</strong></a><strong>?</strong></h4>
	<p>Stellen Sie sich ein alternatives Internet vor, in dem Sie, um eine Verbindung zu www.cloudflare.com herzustellen, die Aufgabe, einen Weg zu unseren Servern zu finden, nicht an Ihren Internetanbieter delegieren würden, sondern die folgenden Schritte durchführen müssten, um Cloudflare zu erreichen:</p>
	<ol>
		<li>Sie berechnen einen Weg zu Ihrem Ziel, so wie hier:<br><code>Sie -&gt; Ihr ISP -&gt; X -&gt; Y -&gt; Z -&gt; www.cloudflare.com.</code><br></li>
		<li>Sie verschlüsseln Ihr Paket mit dem öffentlichen Schlüssel von Z, dann mit dem von Y und schließlich mit dem von X.</li>
		<li>Sie senden das Ergebnis an X, der es mit seinem privaten Schlüssel entschlüsselt;</li>
		<li>X sendet das Ergebnis an Y, der es mit seinem privaten Schlüssel entschlüsselt;</li>
		<li>Y sendet das Ergebnis an Z, der es mit seinem privaten Schlüssel entschlüsselt, um das Originalpaket zu erhalten;</li>
		<li>Z sendet das Paket an <a href="https://blog.cloudflare.com/welcome-hidden-resolver/www.cloudflare.com">www.cloudflare.com</a>.</li>
	</ol>
	<p>Wenn jeder seine Rolle richtig spielt, kann man sicherstellen, dass nur der Eintrittsserver X Ihre IP-Adresse kennt und nur der Austrittsserver Z die Website kennt, mit der Sie eine Verbindung herstellen, wodurch Ihre Privatsphäre und Anonymität gewahrt bleiben. Das ist eine vereinfachte Version von Tor: eine Reihe von Computern und Servern von Freiwilligen auf der ganzen Welt, die als Knoten für ein riesiges Netzwerk fungieren, das auf das Internet draufgesattelt ist und bei dem bei jeder Etappe von einem Knoten zum nächsten eine Verschlüsselungsschicht abgezogen wird. Daher der Name: The Onion Router (englisch <em>onion</em> für Zwiebel).</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/exit-node.png" class="kg-image" alt="" loading="lazy"></figure>
	<h4 id="was-sind-tor-onion-services"><strong>Was sind Tor Onion Services?</strong></h4>
	<p>Die Anonymität von Internetnutzern zu wahren, ist nicht die einzige Funktion des Tor-Netzwerks. Ein Vorbehalt gegen das oben beschriebene Verfahren besteht insbesondere darin, dass sowohl der Austrittsserver als auch jeder, der zwischen ihm und dem Ziel sitzt (einschließlich der Netzbetreiber), weiterhin auf die Verbindung zugreifen kann. Um dieses Problem zu lösen und auch um die Anonymität für Anbieter von Informationen zu gewährleisten, ermöglicht Tor versteckte Dienste, sog. Onion Services. Onion Services sind Tor-Knoten, die ihren öffentlichen Schlüssel, der als Adresse mit der TLD .onion kodiert ist, anbieten und Verbindungen vollständig innerhalb des Tor-Netzwerks herstellen:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_3.png" class="kg-image" alt="" loading="lazy"></figure>
	<h4 id="wie-l-st-man-eine-domain-auf-w-hrend-man-tor-benutzt"><strong>Wie löst man eine Domain auf, während man Tor benutzt?</strong></h4>
	<p>Der Prozess der Ausgabe einer IP-Adresse für einen Domainnamen wird als <em>DNS-Auflösung</em> bezeichnet. Da Tor immer noch IP-Adressen verwendet, muss man noch immer eine DNS-Auflösung durchführen, um über Tor im Internet zu surfen. Es gibt zwei gängige Methoden, um einen Domainnamen aufzulösen, wenn man Tor verwendet:</p>
	<ol>
		<li>Den Namen direkt auflösen und dann über Tor mit der IP-Adresse sprechen;</li>
		<li>Einen Tor-Austrittsserver bitten, den Namen öffentlich aufzulösen und sich mit der IP zu verbinden.</li>
	</ol>
	<p>Offensichtlich wird bei der ersten Option Ihre IP an Ihren DNS Resolver weitergegeben, und wenn Ihr Client nicht DNS-over-HTTPS oder DNS-over-TLS verwendet, wird auch der Name Ihres Ziels an Ihren ISP weitergegeben. Weniger offensichtlich ist, dass Sie durch die zweite Option für manipulative <a href="https://arstechnica.com/information-technology/2014/01/scientists-detect-spoiled-onions-trying-to-sabotage-tor-privacy-network">Angriffe</a> wie DNS-Poisoning oder sslstrip durch <a href="https://trac.torproject.org/projects/tor/wiki/doc/ReportingBadRelays">schlechte Server</a> anfällig sein können. Hier setzt unser neuer Dienst an:</p>
	<p> 3. &nbsp;Lassen Sie das einen .onion-basierten Resolver-Dienst machen!</p>
	<h3 id="wie-funktioniert-der-versteckte-resolver-von-cloudflare"><strong>Wie funktioniert der versteckte Resolver von Cloudflare?</strong></h3>
	<p>In wenigen Worten: Unser .onion-basierter Resolver-Dienst ist ein Tor Onion Service, der die gesamte Kommunikation über DNS-Ports an die entsprechenden Ports auf 1.1.1.1 weiterleitet, sodass die scheinbare Client-IP eine interne IP anstatt Ihrer ist. Es steckt jedoch mehr dahinter, als man auf den ersten Blick sieht.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_4.png" class="kg-image" alt="" loading="lazy"></figure>
	<h4 id="ist-der-versteckte-resolver-sicher"><strong>Ist der versteckte Resolver sicher?</strong></h4>
	<p>Ein eklatanter Unterschied zwischen der Verwendung von 1.1.1.1 und diesem Dienst ist, dass die .onion-Adresse aus „dns4tor“ plus 49 scheinbar zufälligen alphanumerischen Zeichen besteht. Diese 56 Zeichen lange Zeichenkette enthält tatsächlich einen vollständigen öffentlichen Ed25519-Schlüssel, der zur sicheren Kommunikation mit dem Onion Service verwendet wird. Dies birgt eine Reihe von Herausforderungen hinsichtlich nutzbarer Sicherheit:</p>
	<ol>
		<li>Wie können die Nutzer sicherstellen, dass die Adresse korrekt ist?</li>
	</ol>
	<p>Wir haben einfach ein <a href="https://crt.sh/?id=439705277">Zertifikat</a> mit tor.cloudflare-dns.com als Name des Antragstellers und der .onion-Adresse als Alternativnamen gekauft. Auf diese Weise sollten Sie Folgendes sehen, wenn Sie am richtigen Ort sind:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_5.png" class="kg-image" alt="" loading="lazy"></figure>
	<p> &nbsp;2. &nbsp;Wie können sich die Nutzer diese Adresse merken?</p>
	<p>Wir denken nicht, dass man sich an diese Adresse erinnern muss. Im Idealfall müssen Sie lediglich auf <a href="https://tor.cloudflare-dns.com">https://tor.cloudflare-dns.com</a> gehen und den Browser Ihre Anfrage an die .onion-Adresse weiterleiten lassen. Dies ist mit dem HTTP-Header „<a href="https://tools.ietf.org/html/rfc7838">Alt-Svc</a>“ möglich, der als optionaler Header den Browser darüber informiert, dass auf die Ressourcen von einem anderen Netzwerkstandort aus zugegriffen werden kann, möglicherweise mit einem anderen Protokoll. Dank <a href="https://hacks.mozilla.org/2018/05/a-cartoon-intro-to-dns-over-https">Mozilla</a> ist die Verwendung von .onion-Adressen für alternative Dienste nun in <a href="https://nightly.mozilla.org">Firefox Nightly</a> möglich.</p>
	<p>Stellen Sie sich diese Funktion wie <a href="https://blog.cloudflare.com/opportunistic-encryption-bringing-http-2-to-the-unencrypted-web">opportunistische Verschlüsselung</a> vor: Sobald Ihr Browser einen Alt-Svc-Header erhält, der angibt, dass eine .onion-Adresse für tor.cloudflare-dns.com verfügbar ist, und er weiß, dass auf .onion-Adressen zugegriffen werden kann (z.B. über einen SOCKS-Proxy), versucht er zu überprüfen, ob der alternative Dienst das gleiche oder ein höheres Sicherheitsniveau hat. Dazu gehört auch, sicherzustellen, dass man sich mit dem gleichen Zertifikat und <a href="https://tools.ietf.org/html/rfc6066#section-3">Servernamen</a> mit dem Onion Service verbinden kann. Wenn das der Fall ist, verwendet der Browser den alternativen Dienst und stellt so sicher, dass Ihre zukünftigen Anfragen das Tor-Netzwerk nicht verlassen.</p>
	<h4 id="ist-der-versteckte-resolver-schnell"><strong>Ist der versteckte Resolver schnell?</strong></h4>
	<p>Hier ist ein Gedankenexperiment: Angenommen, zwischen jeweils zwei Punkten auf der Erde befindet sich ein Glasfaserkabel, das Pakete mit Lichtgeschwindigkeit verlustfrei übertragen kann.</p>
	<p></p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2019/04/image_6.png" class="kg-image" alt="" loading="lazy"></figure>
	<p></p>
	<p>Mithilfe einer Überschlagsrechnung lässt sich leicht erkennen, dass jedes Paket im Durchschnitt eine Entfernung, die einem <strong>Viertel</strong> des Erdumfangs entspricht, in etwa <strong>33 ms</strong> zurücklegt, während jedes Tor-Paket etwa <strong>200 ms</strong> benötigt, um <strong>anderthalbmal</strong> die Erde zu umrunden, bevor es einen Onion Service erreicht; das sind drei Umrundungen für einen Hin- und Rückweg, der die Anonymität beider Parteien gewährleistet.</p>
	<p>Cloudflare benötigt jedoch keine Anonymität für seine Server, weshalb wir die Anzahl der Knoten auf nur drei reduzieren können. Dazu aktivieren wir eine <a href="https://trac.torproject.org/projects/tor/ticket/17178">optionale</a> <a href="https://gitweb.torproject.org/torspec.git/tree/proposals/260-rend-single-onion.txt">Einstellung</a> für Onion Services, die einer geringeren Latenzzeit Vorrang vor der Standortanonymität des Dienstes einräumt. Wir möchten betonen, dass dies keinerlei Auswirkungen auf die Privatsphäre oder Anonymität des Clients hat. Wie Sie vielleicht bemerkt haben, liegt der Ursprung im ersten Bild des Onion Services drei Etappen vom Rendezvous-Punkt entfernt, während unser Onion Service nur eine Etappe entfernt ist.</p>
	<p>Wir arbeiten intensiv daran, diesen Dienst schneller zu machen und sicherzustellen, dass er so wenig Ausfallzeiten wie möglich hat.</p>
	<h4 id="warum-sollte-ich-cloudflares-versteckten-resolver-nutzen"><strong>Warum sollte ich Cloudflares versteckten Resolver nutzen?</strong></h4>
	<p>Zunächst einmal garantiert die Auflösung von DNS-Anfragen über das Tor-Netzwerk, z. B. durch die Verbindung mit dem 8.8.8.8-Resolver von Google, ein deutlich höheres Maß an Anonymität als die direkte Ausführung der Anfragen. Dadurch wird nicht nur verhindert, dass der Resolver jemals Ihre IP-Adresse sieht, auch Ihr ISP wird nicht erfahren, dass Sie versucht haben, einen Domainnamen aufzulösen.</p>
	<p>Dennoch, solange das Ziel kein Onion Service ist, können passive Angreifer Pakete erfassen, die das Tor-Netzwerk verlassen, und böswillige Austrittsknoten können DNS-Abfragen verfälschen oder die Verschlüsselung durch <a href="https://moxie.org/software/sslstrip">SSL-Stripping</a> herabsetzen. Selbst wenn Sie Ihr Surfen <a href="https://www.eff.org/pages/tor-and-https">auf HTTPS-Seiten beschränken</a>, können passive Angreifer herausfinden, welche Adressen Sie aufgerufen haben. Noch schwerwiegender ist, dass Akteure, die den Datenverkehr sowohl vor dem Eintritt in das Tor-Netzwerk als auch nach dem Verlassen des Netzwerks vergleichen können, den Client potenziell mithilfe der Metadaten (Größe, Zeit usw.) <a href="https://nymity.ch/tor-dns">de-anonymisieren</a> könnten. Die einzige Lösung besteht also darin, Austrittsknoten überflüssig zu machen, indem man stattdessen Onion Services verwendet. Das ist es, was unser .onion-basierter Resolver bietet.</p>
	<p>Wenn Ihr Client keine verschlüsselten DNS-Abfragen unterstützt, kann die Verwendung eines .onion-basierten Resolvers die Verbindung außerdem vor On-Path-Angriffen, einschließlich BGP-Hijacking-Angriffen, schützen. Das bedeutet, dass die Sicherheit für DNS-over-UDP und DNS-over-TCP die gleiche ist wie für DNS-over-HTTPS und DNS-over-TLS.</p>
	<p>Ihre persönliche Anonymität ist jedoch nicht der einzige Grund, warum Sie diesen Dienst nutzen sollten. Die Stärke von Tor, die Anonymität aller Beteiligten sicherzustellen, hängt von der Anzahl der Personen ab, die es nutzen. Wenn beispielsweise nur Whistleblower das Tor-Netzwerk nutzen würden, dann würde jeder, der sich mit dem Tor-Netzwerk verbindet, automatisch als Whistleblower verdächtigt werden. Je mehr Menschen Tor nutzen, um im Internet Meme anzusehen oder Katzenvideos zu schauen, desto einfacher wird es für diejenigen, die wirklich Anonymität brauchen, sich unter den Datenverkehr zu mischen.</p>
	<p>Eine Sache, die viele Nutzer von der Verwendung von Tor abhält, ist, dass es einfach langsam ist, und ich kann nachvollziehen, dass es Menschen gibt, die nicht auf schnelle Ladezeiten verzichten würden, um mitzuhelfen, dass Aktivisten und Dissidenten anonym bleiben. Allerdings sind DNS-Anfragen klein und da die meisten Browser und Betriebssysteme DNS-Ergebnisse zwischenspeichern, ist der gesamte Datenverkehr nicht signifikant. Infolgedessen verlangsamt die Verwendung des .onion-basierten Resolvers Ihre erste DNS-Anfrage nur geringfügig, ohne dabei etwas anderes zu verlangsamen, während Sie gleichzeitig zur allgemeinen Anonymität des Tor-Netzwerks und seiner Nutzer beitragen.</p>
	<h3 id="warum-sollte-ich-cloudflares-verstecktem-resolver-trauen"><strong>Warum sollte ich Cloudflares verstecktem Resolver trauen?</strong></h3>
	<p>Die Verwendung eines .onion-basierten Resolvers stellt sicher, dass Ihr ISP nie herausfindet, dass Sie eine Domain auflösen, die Austrittsknoten keine Chance haben, DNS-Antworten zu manipulieren, und der Resolver nie Ihre IP-Adresse herausfindet. Der einzigartige Vorteil der Verwendung des .onion-basierten Resolvers von Cloudflare besteht jedoch darin, dass er die Leistung von Tor mit allen die Privatsphäre schützenden Funktionen des 1.1.1.1-Resolvers kombiniert, wie z. B. Minimierung von Abfragenamen, sowie auf ein Team von Entwicklern bauen kann, die daran arbeiten, ihn auf allen Ebenen zu verbessern, einschließlich Standards wie DNS-over-HTTPS und DNS-over-TLS.</p>
	<p>Wie unser CEO Matthew Prince <a href="https://blog.cloudflare.com/the-trouble-with-tor">vor etwa zwei Jahren</a> schrieb, ist Anonymität im Internet eine Sache, die wir bei Cloudflare schätzen. Darüber hinaus haben wir uns bei der Ankündigung des 1.1.1.1-Resolvers <a href="https://developers.cloudflare.com/1.1.1.1/commitment-to-privacy">verpflichtet</a>, alle technischen Maßnahmen zu ergreifen, um sicherzustellen, dass wir nicht wissen können, was Sie im Internet tun. Eine Möglichkeit zu bieten, den Resolver über das Tor-Netzwerk zu nutzen, und ihn so schnell wie möglich zu machen, ist ein großer Schritt in diese Richtung.</p>
	<h3 id="wie-richtet-man-ihn-ein"><strong>Wie richtet man ihn ein?</strong></h3>
	<p>Der .onion-basierte Resolver unterstützt alle DNS-Protokolle, die 1.1.1.1 unterstützen, nur eben über das Tor-Netzwerk. Da sich jedoch nicht jeder DNS-Client mit dem Tor-Netzwerk verbinden kann, ist ein bisschen Feinarbeit erforderlich, damit es funktioniert. Hier erklären wir, wie man DNS-over-HTTPS einrichtet, das vom .onion-basierten Resolver bereitgestellt wird. Für alle anderen Szenarien besuchen Sie bitte unsere <a href="https://developers.cloudflare.com/1.1.1.1/fun-stuff/dns-over-tor">Entwicklerseite</a>. Dort erfahren Sie die Details zur Verwendung des .onion-basierten Resolvers.</p>
	<h4 id="erinnern-sie-sich-an-cloudflared"><strong>Erinnern Sie sich an cloudflared?</strong></h4>
	<p>So richten Sie <code>cloudflared</code> ein, um einen DNS-Client zu starten, der DNS-over-HTTPS verwendet und über das Tor-Netzwerk geleitet wird:</p>
	<ol>
		<li>Laden Sie zunächst <code>cloudflared</code> herunter. Dazu folgen Sie einfach der regulären Anleitung zum <a href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/cloudflared-proxy">Ausführen eines DNS-over-HTTPS-Client</a>.</li>
		<li>Starten Sie einen Tor-SOCKS-Proxy und verwenden Sie socat, um den Port TCP:443 an localhost weiterzuleiten:</li>
	</ol><!--kg-card-begin: markdown-->
	<pre><code>socat TCP4-LISTEN:443,reuseaddr,fork SOCKS4A:127.0.0.1:dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion:443,socksport=9150
</code></pre>
	<!--kg-card-end: markdown-->
	<p>3. Weisen Sie Ihren Computer an, die .onion-Adresse als localhost zu behandeln:</p><!--kg-card-begin: markdown-->
	<pre><code>cat &lt;&lt; EOF &gt;&gt; /etc/hosts 
127.0.0.1 dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion 
128.EOF
</code></pre>
	<!--kg-card-end: markdown-->
	<p>4. Starten Sie zu guter Letzt einen lokalen DNS-over-UDP-Daemon:</p><!--kg-card-begin: markdown-->
	<pre><code>cloudflared proxy-dns --upstream "https://dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion/dns-query"
INFO[0000] Adding DNS upstream                           url="https://dns4torpnlfs2ifuz2s2yf3fc7rdmsbhm6rw75euj35pac6ap25zgqad.onion/dns-query"
INFO[0000] Starting DNS over HTTPS proxy server          addr="dns://localhost:53"
INFO[0000] Starting metrics server                       addr="127.0.0.1:35659"
</code></pre>
	<!--kg-card-end: markdown-->
	<p>5. Profitieren Sie!<br></p>
</div>