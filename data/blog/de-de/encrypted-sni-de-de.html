<div class="post-content lh-copy gray1">
	<p></p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2018/09/esni-3@3.5x-1.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Heute haben wir die <a href="https://blog.cloudflare.com/esni">Unterstützung verschlüsselter SNI</a> angekündigt, <a href="https://tools.ietf.org/html/draft-ietf-tls-esni" target="_blank">eine Erweiterung</a> des <a href="https://blog.cloudflare.com/rfc-8446-aka-tls-1-3/">TLS 1.3</a>-Protokolls, die die Privatsphäre von Internetbenutzern besser schützt, indem sie verhindert, dass On-Path-Beobachter (einschließlich ISPs, Café-Besitzer und Firewalls) die Server Name Indication-Erweiterung (SNI) für TLS abfangen und verwenden, um zu ermitteln, welche Webseiten die Benutzer besuchen.</p>
	<p>Verschlüsselte SNI (<em>encrypted SNI</em> – ESNI) wird es zusammen mit anderen bereits von Cloudflare kostenlos angebotenen Internet-Sicherheitsfunktionen schwieriger machen, Inhalte zu zensieren und Benutzer im Internet zu verfolgen. Lesen Sie weiter, um zu erfahren, wie es funktioniert.</p>
	<h3 id="snwarum"><strong>SNWarum?</strong></h3>
	<p>Die Erweiterung Server Name Indication (SNI) für TLS wurde <a href="https://tools.ietf.org/html/rfc3546" target="_blank">ursprünglich im Jahr 2003 standardisiert</a> und ermöglicht es Servern, mehrere TLS-fähige Webseiten auf demselben Satz von IP-Adressen zu hosten, indem sie von den Clients verlangt, während des ersten TLS-Handshakes anzugeben, mit welcher Website sie sich verbinden möchten. Ohne SNI wüsste der Server beispielsweise nicht, welches Zertifikat er dem Client liefern oder welche Konfiguration für die Verbindung gelten soll.</p>
	<p>Der Client fügt der ClientHello-Nachricht die SNI-Erweiterung hinzu, die den Hostnamen der Seite enthält, mit der er sich verbinden möchte. Er sendet ClientHello während des TLS-Handshakes an den Server. Leider wird die ClientHello-Nachricht unverschlüsselt gesendet, da Client und Server zu diesem Zeitpunkt noch keinen gemeinsamen Verschlüsselungsschlüssel nutzen.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2018/09/tls13_unencrypted_server_name_indication-2.png" class="kg-image" alt="" loading="lazy">
		<figcaption><em>TLS 1.3 with Unencrypted SNI</em></figcaption>
	</figure>
	<p><em><em>TLS 1.3 mit unverschlüsselter SNI</em></em></p>
	<p>Das bedeutet, dass ein On-Path-Beobachter (z. B. ein ISP, ein Café-Besitzer oder eine Firewall) die ClientHello-Nachricht als Klartext abfangen und ermitteln kann, mit welcher Webseite der Client eine Verbindung herstellen will. Dadurch kann der Beobachter verfolgen, welche Websites ein Benutzer besucht.</p>
	<p>Aber mit SNI-Verschlüsselung verschlüsselt der Client die SNI, obwohl der Rest von ClientHello als Klartext gesendet wird.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2018/09/tls13_encrypted_server_name_indication-1.png" class="kg-image" alt="" loading="lazy">
		<figcaption><em>TLS 1.3 with Encrypted SNI</em></figcaption>
	</figure>
	<p><em><em>TLS 1.3 mit verschlüsselter SNI</em></em></p>
	<p>Wie kommt es, dass die ursprüngliche SNI vorher nicht verschlüsselt werden konnte, es jetzt aber möglich ist? Und woher kommt der Verschlüsselungsschlüssel, wenn Client und Server noch keinen ausgehandelt haben?</p>
	<h3 id="woher-kommt-die-henne-wenn-sie-vor-dem-ei-da-sein-muss"><strong>Woher kommt die Henne, wenn sie vor dem Ei da sein muss?</strong></h3>
	<p>Wie bei <a href="https://datatracker.ietf.org/meeting/101/materials/slides-101-dnsop-sessa-the-dns-camel-01" target="_blank">vielen anderen Internet-Features</a> lautet die Antwort einfach „DNS“.</p>
	<p>Der Server veröffentlicht einen <a href="https://en.wikipedia.org/wiki/Public-key_cryptography" target="_blank">öffentlichen Schlüssel</a> auf einem bekannten DNS-Eintrag, der vom Client vor dem Herstellen einer Verbindung abgerufen werden kann (wie bereits für A, AAAA und andere Einträge). Der Client ersetzt dann die SNI-Erweiterung im ClientHello durch eine „verschlüsselte SNI“-Erweiterung. Bei dieser handelt es sich um die ursprüngliche SNI-Erweiterung, die aber mit einem symmetrischen Verschlüsselungsschlüssel verschlüsselt wird, der wie unten beschrieben mithilfe des öffentlichen Schlüssels des Servers abgeleitet wurde. Der Server, dem der private Schlüssel gehört und der ebenfalls in der Lage ist, den symmetrischen Verschlüsselungsschlüssel abzuleiten, kann dann die Erweiterung entschlüsseln und somit die Verbindung beenden (oder an einen Back-End-Server weiterleiten). Da nur der Client und der Server, mit dem er eine Verbindung herstellt, den Verschlüsselungsschlüssel ableiten können, kann die verschlüsselte SNI nicht von Dritten entschlüsselt und angerufen werden.</p>
	<p>Es ist wichtig zu beachten, dass es sich um eine Erweiterung für TLS Version 1.3 und höher handelt, die nicht mit früheren Versionen des Protokolls funktioniert. Der Grund ist ganz einfach: Eine der Änderungen,die mit TLS 1.3 (<a href="https://blog.cloudflare.com/you-get-tls-1-3-you-get-tls-1-3-everyone-gets-tls-1-3/">nicht ohne Probleme</a>) eingeführt wurden, bedeutete, dass die vom Server gesendete Zertifikatsnachricht in den verschlüsselten Teil des TLS-Handshakes verschoben wurde (vor 1.3 wurde sie als Klartext gesendet). Ohne diese grundlegende Änderung des Protokolls wäre ein Angreifer immer noch in der Lage, die Identität des Servers zu bestimmen, indem er einfach während der Übertragung das gesendete Klartextzertifikat beobachtet.</p>
	<p>Der zugrunde liegende kryptografische Vorgang verwendet den <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange" target="_blank">Diffie-Hellman-Schlüsselaustauschalgorithmus</a>, der es Client und Server ermöglicht, einen gemeinsamen Verschlüsselungsschlüssel über einen nicht vertrauenswürdigen Kanal zu generieren. Der Verschlüsselungsschlüssel für die verschlüsselte SNI wird dabei auf der Clientseite berechnet, indem der öffentliche Schlüssel des Servers (der eigentlich der öffentliche Teil eines halbstatischen Diffie-Hellman-Schlüsselaustausches ist) und der private Teil eines <em>ephemeral</em> (flüchtigen) Diffie-Hellman-Austausches verwendet werden, wobei letzterer vom Client selbst generiert und sofort nach dem Senden des ClientHello an den Server verworfen wird. Außerdem werden aus Sicherheitsgründen auch zusätzliche Daten (z. B. einige der kryptografischen Parameter, die der Client als Teil seiner ClientHello-Nachricht sendet) in den kryptografischen Prozess eingebracht.</p>
	<p>Die ESNI-Erweiterung des Clients beinhaltet dann nicht nur die tatsächlich verschlüsselten SNI-Bit, sondern auch den öffentlichen Schlüsselanteil des Clients, die Verschlüsselungssuite, die er zur Verschlüsselung verwendet hat, und den Digest des ESNI-DNS-Eintrags des Servers. Auf der anderen Seite verwendet der Server seinen eigenen privaten Schlüsselanteil und den öffentlichen Anteils des Clients, um den Verschlüsselungsschlüssel zu generieren und die Erweiterung zu entschlüsseln.</p>
	<p>Obwohl dies übermäßig kompliziert erscheinen mag, stellt es sicher, dass der Verschlüsselungsschlüssel kryptografisch an die spezifische TLS-Sitzung gebunden ist, für die er generiert wurde, und nicht über mehrere Verbindungen wiederverwendet werden kann. Dadurch wird verhindert, dass ein Angreifer die vom Client gesendete verschlüsselte Erweiterung einfach abfängt und in einer separaten Sitzung mit dem Server wiederverwendet, um die Identität der Webseite zu ermitteln, mit der der Benutzer eine Verbindung herstellen wollte (dies wird als „Cut-and-Paste“-Angriff bezeichnet).</p>
	<p>Ein unerlaubter Zugriff auf den privaten Schlüssel des Servers würde jedoch alle symmetrischen ESNI-Schlüssel gefährden, die von ihm generiert wurden (und Beobachtern ermöglichen, zuvor gesammelte verschlüsselte Daten zu entschlüsseln). Aus diesem Grund wechselt die Implementierung der SDI-Verschlüsselung von Cloudflare die Serverschlüssel stündlich, wodurch zukünftiger Schutz gewährleistet wird. Gleichzeitig werden die Schlüssel der letzten Stunden weiterhin aufbewahrt, um DNS-Caching und Replikationsverzögerungen zu ermöglichen, sodass Clients mit leicht veralteten Schlüsseln ESNI weiterhin problemlos verwenden können (schließlich werden jedoch alle Schlüssel verworfen und vergessen).</p>
	<h3 id="moment-mal-dns-wirklich"><strong>Moment mal, DNS? Wirklich?</strong></h3>
	<p>Der aufmerksame Leser hat sicherlich erkannt, dass die einfache Verwendung des DNS (das standardmäßig unverschlüsselt ist) die gesamte verschlüsselte SNI-Idee völlig sinnlos machen würde: Ein On-Path-Beobachter wäre in der Lage zu ermitteln, zu welcher Website der Client eine Verbindung herstellt, indem er einfach die vom Client selbst gesendeten Klartext-DNS-Abfragen beobachtet, unabhängig davon, ob verschlüsselte SNI verwendet wurde oder nicht.</p>
	<p>Aber seit der Einführung von DNS-Funktionen wie DNS-over-TLS (DoT) und DNS-over-HTTPS (DoH) und von öffentlichen DNS-Resolvern, die ihren Benutzern diese Funktionen zur Verfügung stellen (wie Cloudflares eigener <a href="https://blog.cloudflare.com/announcing-1111/">1.1.1.1</a>), können DNS-Abfragen nun verschlüsselt und vor den neugierigen Augen von Zensoren und Trackern gleichermaßen geschützt werden.</p>
	<p>Obwohl (trotz böser Resolver) den Antworten von DoT/DoH-DNS-Resolvern bis zu einem gewissen Grad vertraut werden kann, ist es einem entschlossenen Angreifer dennoch möglich, den Cache des Resolvers zu vergiften, indem er dessen Kommunikation mit dem autoritativen DNS-Server unterbricht und bösartige Daten injiziert. Das heißt, es sei denn, sowohl der autoritative Server als auch der Resolver unterstützen <a href="https://www.cloudflare.com/dns/dnssec/" target="_blank">DNSSEC</a>[1]. Übrigens können die autoritativen DNS-Server von Cloudflare Antworten signieren, die an Resolver zurückgegeben werden, und der 1.1.1.1.-Resolver kann sie überprüfen.</p>
	<h3 id="was-ist-mit-der-ip-adresse"><strong>Was ist mit der IP-Adresse?</strong></h3>
	<p>Während sowohl DNS-Abfragen als auch die SNI-Erweiterungen für TLS jetzt vor On-Path-Angreifern geschützt werden können, ist es eventuell dennoch möglich zu ermitteln, welche Webseiten von Benutzern besucht werden, indem man einfach die Ziel-IP-Adressen des Datenverkehrs, der von den Geräten der Benutzer ausgeht, betrachtet. Einige unserer Kunden sind bis zu einem gewissen Grad dadurch geschützt, dass viele Cloudflare-Domains die gleichen Adresssätze haben, aber dies reicht nicht aus und es ist noch mehr Arbeit erforderlich, um die Endbenutzer in größerem Umfang zu schützen. Bleiben Sie dran, um in Zukunft weitere Updates von Cloudflare zu diesem Thema zu erhalten.</p>
	<h3 id="wo-melde-ich-mich-an"><strong>Wo melde ich mich an?</strong></h3>
	<p>Verschlüsselte SNI ist jetzt für alle Cloudflare-Zonen, die unsere Nameserver nutzen, kostenlos aktiviert, sodass Sie nichts tun müssen, um sie auf Ihrer Cloudflare-Webseite zu aktivieren. Was Browser anbetrifft, haben uns unsere Freunde von Firefox mitgeteilt, dass sie vorhaben, Unterstützung für verschlüsselte SNI in dieser Woche zu <a href="https://www.mozilla.org/firefox/channel/desktop/" target="_blank">Firefox Nightly</a> hinzufügen (beachten Sie, dass sich die Spezifikationen für verschlüsselte SNI noch in der Entwicklung befinden und sie daher noch nicht stabil ist).</p>
	<p>Unter <a href="https://encryptedsni.com/" target="_blank">encryptedsni.com</a> können Sie überprüfen, wie sicher Ihr Surferlebnis ist. Verwenden Sie ein sicheres DNS? Validiert Ihr Resolver DNSSEC-Signaturen? Unterstützt Ihr Browser TLS 1.3? Hat Ihr Browser die SNI verschlüsselt? Wenn die Antwort auf all diese Fragen „ja“ lautet, dann können Sie ruhig schlafen mit dem Wissen, dass Sie beim Surfen vor neugierigen Blicken geschützt sind.</p>
	<h3 id="fazit"><strong>Fazit</strong></h3>
	<p>Verschlüsselte SNI schließt zusammen mit TLS 1.3, DNSSEC und DoT/DoH eine der wenigen verbliebenen Lücken, die Überwachung und Zensur im Internet ermöglichen. Um zu einem überwachungsfreien Internet zu gelangen, ist noch mehr Arbeit erforderlich, aber wir nähern uns (langsam) an.</p>
	<p>[1]: Es ist wichtig zu erwähnen, dass DNSSEC durch BGP-Routen-Hijacking zwischen einem DNS-Resolver und dem TLD-Server deaktiviert werden könnte. Letzte Woche haben wir unser Engagement für RPKI <a href="https://blog.cloudflare.com/rpki/">angekündigt</a>, und wenn DNS-Resolver und TLDs ebenfalls RPKI implementieren, wird diese Art von Hijacking viel schwieriger sein.</p>
	<p><a href="https://blog.cloudflare.com/subscribe/"><em>Abonnieren Sie den Blog</em></a> <em>und Sie erhalten tägliche Updates zu allen unseren Mitteilungen der Geburtstagswoche.</em></p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2018/09/Cloudflare-Birthday-Week-3.png" class="kg-image" alt="" loading="lazy"></figure>
</div>