<div class="mb2 gray5">7 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/11/image3-28.png" class="kg-image" alt="The most programmable Supercloud with Cloudflare Snippets" loading="lazy"></figure>
	<h2 id="ihr-traffic-ganz-nach-ihrem-geschmack">Ihr Traffic ganz nach Ihrem Geschmack</h2>
	<p>Der Kundenstamm von Cloudflare ist sehr breit gefächert. Wir bieten benutzerfreundliche Produkte für alle Aufgaben, HTTP-Header einstellen, URL-Pfad umschreiben, URL-Umleitungen durchführen und vieles mehr. Aber manchmal müssen Kunden über die Standardfunktionalität hinausgehen, sie möchten z. B. nicht nur einen HTTP-Header hinzufügen, sondern eine erweiterte Berechnung durchführen, um die Ausgabe zu erstellen. Heute müssten sie dafür eine Feature-Anfrage erstellen und auf die Auslieferung warten, einen <a href="https://workers.cloudflare.com" target="_blank">Cloudflare Worker</a> schreiben oder diese Änderung „on origin“ – auf ihrer eigenen Infrastruktur – durchführen.</p>
	<p>Wir freuen uns, eine einfachere Lösung vorstellen zu können: Cloudflare Snippets. Snippets sind eine neue Art Traffic-Änderungen vorzunehmen, und zwar solche, die Nutzer entweder nicht über unsere produktspezifischen Angebote vornehmen können oder die sie programmatisch vornehmen möchten. Und das Beste daran? Die überwiegende Mehrheit der Kunden wird für die Nutzung von Snippets <em>nichts extra</em> bezahlen.</p>
	<p>Die Nutzer haben jetzt die Wahl. Sie können die Aktion über eine Regel ausführen. Oder, wenn mehr Funktionalität benötigt wird, ein Snippet schreiben. &nbsp;Beides erfordert keine Wartezeit und keine Zusatzkosten (es gilt eine hohe Obergrenze für faire Nutzung). Mit Snippets tun Nutzer, was sie wollen und wann sie wollen. Alles über Cloudflare.</p>
	<p>Snippets unterstützt den Import von Code, der in verschiedenen Sprachen geschrieben wurde, wie JavaScript (modern), VCL (veraltet) und Apache .htaccess-Dateien (veraltet). Damit können Kunden veralteten Betriebscode auf unsere Plattform migrieren – und gleichzeitig ihren JavaScript-Betrieb konsolidieren.</p>
	<p>Wenn Sie an einem Test interessiert sind, schreiben Sie sich bitte über das Anmeldeformular in die Warteliste für Snippets ein. Wir hoffen, Anfang 2023 die ersten Nutzer für die geschlossene Betaversion zuzulassen.</p>
	<h2 id="warum-snippets-bauen">Warum Snippets bauen?</h2>
	<p>In den letzten 18 Monaten haben wir eine Reihe von neuen Rules-Produkten veröffentlicht, darunter <a href="https://blog.cloudflare.com/introducing-transform-rules-with-url-rewriting-at-the-edge">Transform Rules,</a> <a href="https://blog.cloudflare.com/introducing-cache-rules">Cache Rules</a>, <a href="https://blog.cloudflare.com/origin-rules">Origin Rules</a>, <a href="https://blog.cloudflare.com/configuration-rules">Config Rules</a> und <a href="https://blog.cloudflare.com/dynamic-redirect-rules">Redirect Rules</a>. Mit diesen neuen Produkten können unsere Kunden besser kontrollieren, wie wir ihren Traffic auf dem Weg durch unser globales Netzwerk verarbeiten. Die bisherige Resonanz ist überwältigend positiv. Dennoch möchten unsere Kunden gelegentlich über die Standardfunktionalität hinausgehen.</p>
	<p>Es gibt immer wieder Anwendungsfälle, bei denen ein Produkt nicht die Funktionalität für die spezielle Situation bietet. &nbsp;Während beispielsweise Tausende unserer Kunden ihre HTTP-Header-Modifikation mit Transform Rules vornehmen, gibt es immer noch eine kleine Anzahl von Anwendungsfällen, die nicht möglich sind, wie z. B. das Setzen von dynamischen Ablaufzeiten mit Cookies oder das Hashing von Token mit einem Schlüssel.</p>
	<p>Genau hier helfen Cloudflare Snippets. Kunden müssen für die Implementierung dieser relativ einfachen Anwendungsfälle nicht mehr die gesamte Cloudflare Workers-Plattform nutzen. Sie müssen auch nicht mehr darauf warten, dass wir ihre Feature-Anfragen entwickeln. Stattdessen können sie einfach ein Snippet von JavaScript ausführen.</p>
	<h2 id="veralteten-code-zu-snippets-migrieren">Veralteten Code zu Snippets migrieren</h2>
	<p><a href="https://varnish-cache.org/docs/trunk/users-guide/vcl.html" target="_blank">Die Varnish Control Language</a> (VCL) wird nur im Kontext von Varnish verwendet. Sie wurde vor etwa 16 Jahren eingeführt und in der Vergangenheit zur Konfiguration von Traffic und Routing für Content Delivery Networks verwendet, da sie für eine Vielzahl von Anwendungsfällen erweiterbar war.</p>
	<p>Noch immer nehmen viele Unternehmen mit VCL Routing- und Traffic-Änderungen vor. Während andere Provider die Unterstützung für VCL auslaufen lassen, möchten wir für alle, die diese Sprache gerne verwenden, weiterhin Unterstützung anbieten.</p>
	<p>Snippets werden keine reine VCL ausführen. Stattdessen werden wir VCL in einfach zu pflegende Regeln oder Snippets umwandeln. Dafür entwickeln wir einen einfach zu bedienenden Self-Serve-VCL-Konverter, der hochgeladenen VCL-Code analysiert und automatisch Snippets vorschlägt. Und wenn wir eine Übereinstimmung finden, generiert er auch Regelvorschläge für Produkte wie Transform Rules oder Cache Rules.</p>
	<p>Dieses Thema wurde zunächst über <a href="https://blog.cloudflare.com/announcing-turpentine">Project Turpentine</a> gehandhabt, eine Reihe von Tools, mit denen Cloudflare-Mitarbeiter die VCL eines Kunden in eine vorgeschlagene JavaScript-Konfiguration parsen konnten. Dieses JavaScript konnte dann in einen Worker oder eine Reihe von Workern geladen werden.</p>
	<p>Snippets führt die Idee und die Prinzipien von Turpentine weiter. Viel weiter. Durch die direkte Integration eines Parsers in das Dashboard bekommen die Nutzer die Zügel direkt in die Hand und haben die Wahl. Sie können uns anweisen, möglichst alles in Rules zu migrieren, während der Restcode in Snippets migriert wird – oder Sie weisen uns an, alles in diskrete Snippets zu migrieren. Sie entscheiden selbst.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/11/image1-55.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Apache <a href="https://developer.mozilla.org/en-US/docs/Learn/Server-side/Apache_Configuration_htaccess" target="_blank">htaccess</a>- und NGINX-<a href="https://www.nginx.com/resources/wiki/start/topics/examples/full" target="_blank">Konfigurationsdateien</a> behandeln wir auf die gleiche Weise. Das Ziel: Nutzer laden einfach die Dateien aus der Apache- oder NGINX-Konfiguration ihrer Website hoch und wir generieren vorgeschlagene Snippets und/oder Regeln.</p>
	<p>Die Zeiten, in denen veralteter Code für operative Aufgaben verwendet werden musste, neigen sich dem Ende zu. Mit Snippets können Nutzer diese Workloads zu Cloudflare migrieren und sich auf die größeren Probleme des Unternehmens konzentrieren, anstatt veraltete Systeme zu pflegen.</p>
	<h2 id="der-unterschied-zwischen-snippets-und-workern">Der Unterschied zwischen Snippets und Workern</h2>
	<p>Die meisten Leser werden bereits mit Cloudflare Workers vertraut sein, unserer leistungsstarken Entwicklerplattform, mit der Unternehmen ganze Produkte und Lösungen auf dem globalen Netzwerk von Cloudflare betreiben und aufbauen können. Snippets basiert ebenfalls auf dieser Plattform, aber mit einigen wichtigen Unterschieden.</p>
	<p>Der erste große Unterschied: Ein Snippet wird als Teil der <a href="https://developers.cloudflare.com/ruleset-engine" target="_blank">Regelsatz-Engine</a> als eigene neue <em>Phase</em> ausgeführt, ähnlich wie Transform Rules und Cache Rules. Kunden werden ein Snippet auf der Grundlage eines beliebigen <a href="https://developers.cloudflare.com/ruleset-engine/rules-language/fields" target="_blank">Filters der Regelsatz-Engine</a> auswählen und ausführen können. So können Kunden ein Snippet für jede Anfrage ausführen oder auf der Grundlage der von uns angebotenen Felder nach bestimmtem HTTP-Traffic filtern, z. B. nach Traffic mit einem bestimmten Bot Score, aus einem bestimmten Land oder mit einem bestimmten Cookie. Snippets werden additiv sein, d. h. Nutzer können mit einem Snippet einen HTTP-Header hinzufügen und mit einem anderen die URL umschreiben, und beide werden bei Übereinstimmung ausgeführt:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/11/image2-39.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Ein weiterer großer Unterschied: Cloudflare Snippets sind für alle Tarifstufen verfügbar, ohne zusätzliche Kosten. 99 % der Nutzer werden keinen einzigen Cent für die Nutzung dieser Lösung bezahlen – weder jetzt, noch in Zukunft. So können Kunden ihre einfachen Workloads von veralteten Lösungen wie VCL auf die Cloudflare-Plattform migrieren und ihre monatlichen Ausgaben aktiv senken.</p><!--kg-card-begin: html-->
	<table>
		<thead>
			<tr>
				<th></th>
				<th>Free-Tarife</th>
				<th>Pro-Tarife</th>
				<th>Business-Tarife</th>
				<th>Enterprise-Tarife</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Verfügbare Snippets</td>
				<td>5 Snippets pro Zone.</td>
				<td>20 Snippets pro Zone.</td>
				<td>50 Snippets pro Zone.</td>
				<td>200 Snippets pro Zone*
					(Kunden können diese Zahl in Absprache mit ihrem Customer Success Team erhöhen lassen).</td>
			</tr>
		</tbody>
	</table><!--kg-card-end: html-->
	<p>Cloudflare Snippets sind im Vergleich zu Workers leichtgewichtig und bieten eine maximale Ausführungszeit von 5 ms, einen maximalen Arbeitsspeicher von 2 MB und eine Gesamtpaketgröße von 32 KB. Dank dieses vergleichsweise geringen Platzbedarfs bieten wir 99 % der Nutzer diese Lösung ohne zusätzliche Kosten an. Gleichzeitig reicht sie aus für die identifizierten Anwendungsfälle wie die Änderung von HTTP Headern, das Umschreiben von URLs und das Routing des Traffics, die alle nicht die enormen Ressourcen der Cloudflare Workers benötigen.<br></p><!--kg-card-begin: html-->
	<table>
		<thead>
			<tr>
				<th></th>
				<th>Cloudflare Snippets</th>
				<th>Cloudflare Workers Unbound<br>(zum Vergleich)</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Runtime-Unterstützung</td>
				<td>JavaScript</td>
				<td>JavaScript und WASM</td>
			</tr>
			<tr>
				<td>Ausführungsort</td>
				<td>Global – Alle Cloudflare-Standorte</td>
				<td>Global – Alle Cloudflare-Standorte</td>
			</tr>
			<tr>
				<td>Unterstützte Trigger</td>
				<td>Filter der Regelsatz-Engine</td>
				<td>HTTP-Anfrage<br>HTTP-Antwort<br>Cron Trigger</td>
			</tr>
			<tr>
				<td>Maximale Ausführungszeit</td>
				<td>5ms</td>
				<td>30 Sek. HTTP<br>15 Min. (Cron Trigger)</td>
			</tr>
			<tr>
				<td>Maximaler Arbeitsspeicher</td>
				<td>2MB</td>
				<td>128MB</td>
			</tr>
			<tr>
				<td>Gesamtpaketgröße</td>
				<td>32KB</td>
				<td>5MB</td>
			</tr>
			<tr>
				<td>Umgebungsvariablen</td>
				<td>8/Snippet</td>
				<td>64/Worker</td>
			</tr>
			<tr>
				<td>Größe der Umgebungsvariablen</td>
				<td>1KB</td>
				<td>5KB</td>
			</tr>
			<tr>
				<td>Unteranfragen</td>
				<td>1/Anfrage</td>
				<td>1000/Anfrage</td>
			</tr>
			<tr>
				<td>Terraform-Unterstützung</td>
				<td>✅</td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Wrangler-Unterstützung</td>
				<td></td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Cron Triggers</td>
				<td></td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Key Value Store</td>
				<td></td>
				<td>✅</td>
			</tr>
			<tr>
				<td>Durable Objects</td>
				<td></td>
				<td>✅</td>
			</tr>
			<tr>
				<td>R2-Integration</td>
				<td></td>
				<td>✅</td>
			</tr>
		</tbody>
	</table><!--kg-card-end: html-->
	<h2 id="was-wird-man-mit-cloudflare-snippets-entwickeln-k-nnen">Was wird man mit Cloudflare Snippets entwickeln können?</h2>
	<p>Snippets werden Kunden die Migration ihrer bestehenden Workloads zu Cloudflare ermöglichen. Außerdem eröffnen sie eine Reihe neuer Anwendungsfälle für Kunden. Nachfolgend haben wir drei gängige Beispiele aufgeführt, aber es gibt noch viele weitere.</p>
	<h3 id="beispiel-1-verd-chtige-bots-an-einen-honeypot-senden">Beispiel 1: Verdächtige Bots an einen Honeypot senden</h3>
	<p>Bei der Erstellung von Snippets können Kunden auf Cloudflare-<a href="https://developers.cloudflare.com/workers/runtime-apis/request" target="_blank">Features</a> zugreifen, die in der Workers-Runtime verfügbar sind, wie zum Beispiel das Bot Score-Feld. Damit können Kunden eine HTTP-Anfrage an einen Honeypot weiterleiten oder mit der Javascript-Funktion RegExp das URL-Konstrukt ändern, das an den Nutzer zurückgesendet wird, wenn der Traffic einen Bot Score unter einem bestimmten Threshold (z. B. <a href="https://developers.cloudflare.com/bots/concepts/bot-score/#:~:text=A%20bot%20score%20is%20a,request%20came%20from%20a%20human." target="_blank">29 und niedriger</a>) aufweist.</p><!--kg-card-begin: markdown-->
	<pre><code class="language-javascript">…
if (request.cf.botManagement.score &lt; 30) {
const honeypot = "https://example.com/";
return await fetch(honeypot, request);
…
}
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="beispiel-2-nderung-eines-cookies">Beispiel 2: Änderung eines Cookies</h3>
	<p>Ein weiterer häufiger Anwendungsfall, für den wir Snippets erwarten, ist die Änderung von Cookies. Die Einsatzmöglichkeiten reichen vom einfachen Setzen einer Ablaufzeit von fünf Minuten mit den JavaScript-Funktionen <code>getTime</code> und <code>setTime</code> bis hin zum Setzen eines dynamischen Cookies auf der Grundlage der Anfragesteller-Attribute des Nutzers zu A/B-Testzwecken.</p><!--kg-card-begin: markdown-->
	<pre><code class="language-javascript">…
{
let res = await fetch(request);
res = new Response(res.body, res);
// 24h * 60m * 60s * 1000ms = 86400000ms
const expiry = new Date(Date.now() + 7 * 86400000).toUTCString();
const group = request.headers.get("userGroup") == "premium" ? "A" : "B";
res.headers.append(
      "Set-Cookie",
`testGroup=${group}; Expires=${expiry}; path=/`
    );
…
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="beispiel-3-verwaltung-von-url-abfragen">Beispiel 3: Verwaltung von URL-Abfragen</h3>
	<p>Kunden können Cloudflare Snippets auch für komplexe Operationen einsetzen, z. B. um den Wert der URL-Abfrage zu splicen und selektiv zusätzliche Parameter zu entfernen oder einzufügen. Die Bearbeitung von Abfrage-Strings erfolgt in der Regel mit Transform Rules. Bei Transform Rules ist die <code>set/</code>-Aktion jedoch effektiv eine <code>replace</code>-Aktion. Wenn diese Aktion auf die URL-Abfrage angewandt wird, wird der gesamte Wert, sofern vorhanden, entfernt und auf den vom Nutzer angegebenen Wert gesetzt, d. h. er wird überschrieben. Dies ist ein Problem für Kunden, die gezielt bestimmte Abfrageparameter für passenden Traffic einfügen möchten. Wie das Setzen einer zusätzlichen Abfrage, z. B. <code>?utm_campaign=facebook</code>, wenn gängige Social Media-Plattformen im User Agent erkannt werden. Mit Snippets können Kunden dieses selektive Entfernen und Einfügen mit einem einfachen Stück JavaScript durchführen, z B.</p><!--kg-card-begin: markdown-->
	<pre><code class="language-javascript">…
if (userAgent.includes("Facebook")) {
      const url = new URL(request.url);
      const params = new URLSearchParams(url.search);
      params.set("utm_campaign", "facebook");
      url.search = params.toString();
      const transformedRequest = new Request(url, request)
…
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Wir sind gespannt, welche weiteren Anwendungsfälle Cloudflare Snippets für unsere Kunden erschließen werden.</p>
	<h2 id="hei-t-es-keine-neuen-aktionen-zu-regels-tzen-mehr">Heißt es, keine neuen Aktionen zu Regelsätzen mehr?</h2>
	<p>Die einfache Antwort ist nein! Wir werden unsere No-Code-Aktionen innerhalb der Regelsatz-Engine weiter ausbauen und neue Produkte für die Anforderungen unserer Kunden entwickeln.</p>
	<p>Es mag offensichtlich klingen – aber alle Feature-Verbesserungen ergeben sich aus Gesprächen mit Kunden. Durch Gespräche mit den Nutzern von Snippets erfahren wir, welche Anwendungsfälle Snippets in der Praxis lösen und welche Feature-Lücken in unserer Produktpalette noch offen sind. Dann können wir prüfen, ob es sinnvoll ist, diesen Anwendungsfall in ein Produkt zu überführen, oder es bei Snippets zu belassen.</p>
	<p>Wir verstehen auch, dass nicht alle Leute Softwareentwickler sind. Wir arbeiten daher daran, Snippets für alle zugänglich zu machen, indem wir Vorlagen in einer Bibliothek bereitstellen, die von den Kunden kopiert und verändert werden können, wobei nur minimale Programmierkenntnisse erforderlich sind. Mit Snippets bedeutet „leistungsstark“ nicht gleich „kompliziert“.</p>
	<h2 id="auf-cloudflare-snippets-zugreifen">Auf Cloudflare Snippets zugreifen</h2>
	<p>Snippets befinden sich derzeit in der Entwicklung. <a href="https://www.cloudflare.com/lp/cloudflare-snippets" target="_blank">Hier</a> können Sie sich auf die Warteliste setzen lassen.</p>
	<p>Wir hoffen, ab Anfang 2023 Nutzer in die geschlossene Betaphase aufnehmen zu können, eine offene Betaphase wird folgen.</p>
</div>