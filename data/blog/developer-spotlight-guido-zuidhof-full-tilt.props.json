{
	"post": {
		"id": "618eb0f34524da02a9c237a5",
		"uuid": "89c03892-c6b2-4ce3-8752-59429972fbf4",
		"title": "Developer Spotlight: Winning a Game Jam with Jamstack and Durable Objects",
		"slug": "developer-spotlight-guido-zuidhof-full-tilt",
		"html": "<figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2021/11/image1-18.png\" class=\"kg-image\" alt loading=\"lazy\"></figure><p>Welcome to a new blog post series called Developer Spotlight. In this series we will be showcasing interesting applications built on top of the Cloudflare Workers Ecosystem.</p><p>And to celebrate <a href=\"http://blog.cloudflare.com/durable-objects-ga/\">Durable Objects going GA</a>, what better to kick off the series than with a really cool tech demo of Durable Objects called Full Tilt?</p><p>Full Tilt by <a href=\"https://github.com/gzuidhof\">Guido Zuidhof</a> is a game jam entry for Ludum Dare, one of the biggest and oldest game jams around, where he won first place in the innovation category. A game jam is like a hackathon for games, where you have a very short amount of time (usually 48-72 hours) to create a game from scratch.</p><p>We love Full Tilt, not just because Guido used Workers and Durable Objects to build a cool game where you control a game on your computer via your phone, but especially because it shows how powerful Durable Objects are. In less than 48 hours Guido was able to write all the logic to instantly spin up a personal gaming server anywhere in the world, as close to that player as possible. And it is so fast that you feel like you are controlling the computer directly.</p><p>But here is Guido, to tell you about his experience developing Full Tilt.</p><!--kg-card-begin: html--><div style=\"position: relative; padding-top: 76.28865979381443%;\"><iframe src=\"https://iframe.videodelivery.net/9443c301ad57eb58d2068b3db7bb9bec?preload=true\" style=\"border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;\"  allow=\"accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;\" allowfullscreen=\"true\"></iframe></div><!--kg-card-end: html--><p>Last October I participated in the Ludum Dare 49 game jam. The thing I love about game jams is that the time constraint forces you to work quickly, iterate often, and most importantly cut scope.</p><p>In this game jam I created <a href=\"https://ldjam.com/events/ludum-dare/49/full-tilt\">Full Tilt</a>, a game in which you seamlessly use your phone as a Wiimote-like motion controller for a game that is run on your laptop in a web browser. The secret sauce to making it so smooth was in combining a game jam with Jamstack and mixing in some Durable Objects.</p><p>You can try the game <a href=\"https://ld49.pages.dev\">right here</a>.</p><h3 id=\"phone-as-a-controller\">Phone as a controller</h3><p>Full Tilt is a browser game in which you move the player character by moving your hand around. There are a few different ways we can do that. One idea would be to use your computer's webcam to track a marker object through 3D space. While that is possible, it is tricky to get it working in any situation (a dark room can be problematic!) and also some players may feel uncomfortable turning on their webcam for a simple web game.</p><p>A smartphone has a bunch of sensors built in, including a magnetometer and gyroscope — those sensors are exactly what we need, and we can assume that the majority of our potential players have a smartphone within arm's reach. When a native mobile application uses these sensors, it adds a lot of friction (users now have to install an app), as well as a bunch of implementation work. Fortunately modern web browsers allow you to read from these sensors through the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/DeviceMotionEvent\">DeviceMotion API</a>: a small web app will do the job perfectly!</p><p>The next challenge is communicating the sensor readings from the phone to the game running on the main computer. For that we will use a combination of Cloudflare Workers and Durable Objects. There needs to be some shared contact (i.e., a game server) that both the main computer and the smartphone talk to. Using a serverless solution makes a lot of sense for a web game. And as we only have 48 hours here, less stuff to worry about is a big selling point too. Workers and Durable Objects also make it easy to keep the game running after the game jam, without having to pay for — and more importantly worry about — keeping servers running.</p><h3 id=\"setting-up-a-line-of-communication\">Setting up a line of communication</h3><p>There are roughly two ways for browsers to communicate: through a shared connection (a game server somewhere) or a peer to peer connection, so browsers can talk directly to each other without a middleman by leveraging <a href=\"https://webrtc.org/\">WebRTC</a> DataChannels.</p><p>WebRTC can be very challenging to make reliable and may still need a proxy server for some especially problematic network setups behind multiple NATs. Setting up a WebRTC connection may have been the perfect solution for the lowest possible latency, but it was out of scope for such a short game jam.</p><p>The game we are creating has low latency requirements, when I tilt my phone the game should respond quickly. We can probably get away with anything under 100ms, although low double digits or less is definitely preferred! If I'm geographically located in one place and the game server is geographically close enough, then this game server will be able to pass messages from my smartphone to my laptop without too much delay. Edge computing is hot nowadays, and for this gaming use case it is not just a nice-to-have but also a necessity.</p><p>Enough background, let's architect the system.</p><h3 id=\"on-demand-game-rooms\">On-demand game rooms</h3><p>The first thing I needed to set up was game rooms. Something that both the phone and the computer browsers could connect to, so they can pass messages between them.</p><p>Durable Objects allow us to create a large amount of small stateful \"mini servers\" or \"rooms\" that multiple clients can connect to simultaneously over WebSockets, providing perfect small on-demand game servers. Think of Durable Objects as a single thread of Javascript that runs in a data center close to where the user first asked for it to be created.</p><p>After the browser on the computer starts the game, it asks our Cloudflare Worker API to create a room for the current game session. This API request is a simple POST request, the server responds with a four character room code that uniquely identifies the room that was created. The reason we want the room code to be short is because the user may need to copy this code and type it into their smartphone if they are unable to scan a QR code.</p><p>Humans are notoriously bad at copying random character strings as different characters look alike, so we use a limited character set that excludes the most commonly confused characters:</p><!--kg-card-begin: markdown--><pre><code class=\"language-javascript\">const DICTIONARY = &quot;2345679ADEFGHJKLMNPQRSTUVWXYZ&quot;; // 29 chars (no 0, O, I, 1, B, 8)\n</code></pre>\n<!--kg-card-end: markdown--><p>A four character code will allow us to uniquely point to ~700,000 different rooms, that seems like it would be enough even if our game got quite popular! What's more: these game sessions don't last forever. After some period of time (say 24 hours) we can be certain enough that the game session has ended, and we can re-use that room code.</p><h3 id=\"room-code-coordination\">Room code coordination</h3><p>In your Cloudflare Worker script, there are two ways to create a Durable Object: either we ask for one to be created with an ID generated from a name, or we ask for one to be created with a random unique ID. The naive solution would be to create a Durable Object with an ID generated from the room code. However, that is not a good idea here because a Durable Object gets created in a data center that is geographically close to the end user.</p><p>A problematic situation would be if a user in Mumbai requests a room and gets room code ABCD. Initially, they play the game for a bit, and it works great.</p><p>The issue comes a week later when that room code is reused for another player based in Los Angeles, The game room Durable Object will be revived in Mumbai and latency will be awful for our Los Angeles player. In the future, Durable Objects may get migrated between data centers, but that's not yet guaranteed.</p><p>Instead, what we can do is create a new Durable Object with a random ID for every new game session and keep a mapping from the four character room code to this random ID. We are introducing some state in our system: we will need a central source of truth which is where Durable Objects can come to the rescue again.</p><p>We will solve this by creating a single \"Room Hub\" Durable Object that keeps track of this mapping from room code to Durable Object ID. This Durable Object will have two endpoints, one to request a new room and another to look up a room's information.</p><p>Here's our request handler for the Room Request endpoint (the argument is a <a href=\"https://sunderjs.com/docs/context\">Sunder Context</a>, Sunder is the web framework I used for this project):</p><!--kg-card-begin: markdown--><pre><code class=\"language-typescript\">export async function handleRoomRequest(ctx: Context&lt;Env&gt;) {\n    const now = Date.now();    \n    const reqBody = await ctx.request.json();\n\n    // We make some attempts to find a room that is available..\n    const attempts = 5\n\n    let roomCode: string;\n    let roomStorageKey: string;\n\n    for (let i = 0; i &lt; attempts; i++) {\n        roomCode = generateRoomCode();\n        roomStorageKey = ROOM_STATE_PREFIX + roomCode;\n        const room = await ctx.state.storage.get&lt;RoomData&gt;(roomStorageKey);\n        if (room === undefined) {\n            break;\n        } else if (now - room.createdAt &gt; MAX_ROOM_AGE) {\n            await ctx.state.storage.delete(roomStorageKey);\n            break;\n        }\n        if (i === attempts-1) {\n            return ctx.throw(&quot;Couldn't find available room code :(&quot;);\n        }\n    }\n\n    const roomData: RoomData = {\n        roomCode: roomCode,\n        durableObjectId: reqBody.durableObjectId,\n        createdAt: now,\n    }\n\n    await ctx.state.storage.put&lt;RoomData&gt;(roomStorageKey, roomData);\n\n    ctx.response.body = {\n        room: roomData\n    };\n    ctx.response.status = HttpStatus.Created;\n}\n</code></pre>\n<!--kg-card-end: markdown--><p>In a nutshell, we generate a few room codes until we find one that has never been used or hasn't been used in a long enough time.</p><p>There is a subtle but important nuance in this code: the Durable Object gets created in the Cloudflare Worker that talks to our Room Hub, not in the Room Hub itself. Our Room Hub will run in a single data center somewhere on Cloudflare's network. If we create the game room from there it may still be far away from our end user!</p><p>Looking up a room's information is simpler, we return either the room data or status 404.</p><!--kg-card-begin: markdown--><pre><code class=\"language-typescript\">export async function handleRoomLookup(ctx: Context&lt;Env, {roomCode: string}&gt;) {\n    const now = Date.now();\n\n    let roomStorageKey = ROOM_STATE_PREFIX + ctx.params.roomCode;\n    const roomData = await ctx.state.storage.get&lt;RoomData&gt;(roomStorageKey);\n\n    if (roomData === undefined) {\n        ctx.throw(404, &quot;Room not found&quot;);\n        return;\n    }\n\n    if (now - roomData.createdAt &gt; MAX_ROOM_AGE) {\n        // About time we cleaned it up.\n        await ctx.state.storage.delete(roomStorageKey);\n        ctx.response.status = HttpStatus.NotFound;\n        return;\n    }\n\n    ctx.response.body = {\n        room: roomData\n    };\n}\n</code></pre>\n<!--kg-card-end: markdown--><p>The smartphone browser needs to connect to that same room. To make things easy for the user we generate a four character room code which points at that specific \"Game Room\" Durable Object. This way the user can take their smartphone, navigate to the website address <code>https://ld49.pages.dev</code>, and enter the code \"ABCD\" (or more commonly, they scan a QR code with the link <code>https://ld49.pages.dev?room=ABCD</code>).</p><h3 id=\"game-room-durable-object\">Game Room Durable Object</h3><p>Our game room Durable Object can be pretty simple since it is only responsible for passing along messages from the smartphone to the laptop with the latest sensor readings. I was able to modify the <a href=\"https://github.com/cloudflare/workers-chat-demo\">Durable Objects chat room example</a> to do exactly this — a good time saver for a game jam!</p><p>When a browser connects, they either connect as a \"peer\" or as a \"host\" role. Any messages sent by peers are forwarded to the host, and all messages from the host get forwarded to all peers. In this case, our host is the laptop browser running the game and the peer is the smartphone controller. Implementation-wise this means that we keep two lists of users: the peers and the hosts. Whenever a message comes in, we loop over the list to broadcast it to all connections of the other role. In practice, <a href=\"https://github.com/gzuidhof/LD49/blob/master/beamerserver/src/durableObjects/room/handler.ts\">the code</a> is a bit more involved to deal with users disconnecting.</p><p>Full Tilt is a singleplayer game, but adapting it to be a multiplayer game would be easy with this setup. Imagine a Mario Kart-like game that runs in your browser in which multiple friends can join using their smartphones as their steering wheel controller! Unfortunately there was not enough time in this game jam to make a polished game.</p><h3 id=\"front-end\">Front end</h3><p>With the backend ready, we still need to create the actual game and the controller web app.</p><p>My initial plan was to create a game in which you fly a 3D plane by tilting your phone, collecting stars and completing aerobatic tricks. It would fit the theme \"Unstable\" as I expected this control method to be pretty flimsy! Since there was no time left to create anything close to that, it was time to cut scope.</p><p>I ended up using the Phaser game engine and put the entire system together in a Svelte app.   This was certainly a challenge, as I had only used Phaser once before many years ago and had never used Svelte. Luckily, I was able to put together something simple quickly enough: a snake-like game in which you move a thingy to collect blips that appear randomly on the screen.</p><p>In order for a game to be a game there needs to be some goal for the user, usually some game over condition. I changed the game to go faster and faster over time, added a score counter, and added a game over condition where you lose the game if you touch the edge of the screen. I made my \"art\" in MS Paint, generated some sound effects using the online tool <a href=\"https://sfxr.me/\">sfxr</a>, and \"composed\" the music soundtrack in <a href=\"https://musiclab.chromeexperiments.com/Song-Maker\">Chrome's Music Lab Song Maker</a>.</p><p>Simultaneously I wrote a small client for my game server and duct-taped together the <a href=\"https://github.com/gzuidhof/LD49/blob/master/beamer-gamepad/src/components/Rotato.svelte\">smartphone controller app</a> which is powered by the browser's DeviceMotion APIs. To distribute my game I used Cloudflare Pages, which worked like a charm the first time.</p><h3 id=\"all-done\">All done</h3><p>And then the deadline was there — I barely made it, but I submitted something I was proud of. A not-so-great game, but with an interesting backend system and a novel input method. Do try the game yourself <a href=\"https://ld49.pages.dev\">here</a>, and the source code is available <a href=\"https://github.com/gzuidhof/LD49\">here</a> (<strong>warning</strong>: it's pretty hacky code of course!).</p><p>The reception of my co-jammers was great. While everybody agreed the game itself and its graphics were awful, it was novel. The game ended up rated first in the *Innovation* category for this game jam, out of hundreds of other games!</p><p>Finally, is this the future of game servers? For indie developers and smaller studios, setting up and maintaining a globally distributed fleet of game servers is both a huge distraction and cost. Serverless and in particular Durable Objects can provide an amazing solution.</p><p>But not every game is well-suited for a WebSocket-based backend. In some real-time games you are not interested in what happened a second ago and only the latest information matters. This is where the reliable and ordered nature of WebSockets can get in the way.</p><p>All in all my first impressions of Durable Objects are very positive, it is a great tool to have in your toolbelt for all kinds of web projects. You can now tackle problems that would otherwise take days in mere minutes. I am very excited to see what other problems will be made easy by Durable Objects, even those I haven’t even thought of yet.</p>",
		"comment_id": "618eb0f34524da02a9c237a5",
		"feature_image": "http://blog.cloudflare.com/content/images/2021/11/image1-19.png",
		"featured": false,
		"visibility": "public",
		"created_at": "2021-11-12T18:22:43.000+00:00",
		"updated_at": "2023-05-02T02:14:35.000+01:00",
		"published_at": "2021-11-15T13:59:19.000+00:00",
		"custom_excerpt": "Guido won the innovative category in one of the biggest Game Jams with a combination of Pages, Durable Objects, modern browser APIs, and a hefty amount of ingenuity.",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "6074c68ed70b2301ba26c444",
				"name": "Erwin van der Koogh",
				"slug": "erwin",
				"profile_image": "http://blog.cloudflare.com/content/images/2021/04/twitter-profile-photo.jpeg",
				"cover_image": null,
				"bio": null,
				"website": null,
				"location": "Melbourne",
				"facebook": null,
				"twitter": "@evanderkoogh",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/erwin/"
			},
			{
				"id": "618a4acc015c6002aaf44670",
				"name": "Guido Zuidhof (Guest Blogger)",
				"slug": "guido",
				"profile_image": "http://blog.cloudflare.com/content/images/2021/11/Guido-Zuidhof.png",
				"cover_image": null,
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": null,
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/guido/"
			}
		],
		"tags": [
			{
				"id": "618eb1534524da02a9c237ab",
				"name": "#BLOG-801",
				"slug": "hash-blog-801",
				"description": null,
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			},
			{
				"id": "618ab476015c6002aaf44684",
				"name": "Full Stack Week",
				"slug": "full-stack-week",
				"description": "This week, as we do in our Innovation Weeks, we’ll make a series of announcements to help paint a vision for how we see the future of compute, and giving our developers the tools they need to build their next application on our network.",
				"feature_image": "http://blog.cloudflare.com/content/images/2021/11/image2-8.png",
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/full-stack-week/"
			},
			{
				"id": "618eb1534524da02a9c237ac",
				"name": "Developer Spotlight",
				"slug": "developer-spotlight",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2021/11/Dev-Spotlight-OG-blog-TAG.png",
				"visibility": "public",
				"meta_title": "Developer Spotlight on Cloudflare Blog",
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developer-spotlight/"
			},
			{
				"id": "5d16450341acde0011a95253",
				"name": "Cloudflare Workers",
				"slug": "workers",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/workers/"
			},
			{
				"id": "606373480c4aa103f3124dcb",
				"name": "Durable Objects",
				"slug": "durable-objects",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/durable-objects/"
			},
			{
				"id": "6450636642d421000a133298",
				"name": "Guest Post",
				"slug": "guest-post",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/guest-post/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			},
			{
				"id": "64a3e2b834124c000b00b717",
				"name": "Developer Platform",
				"slug": "developer-platform",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developer-platform/"
			}
		],
		"primary_author": {
			"id": "6074c68ed70b2301ba26c444",
			"name": "Erwin van der Koogh",
			"slug": "erwin",
			"profile_image": "http://blog.cloudflare.com/content/images/2021/04/twitter-profile-photo.jpeg",
			"cover_image": null,
			"bio": null,
			"website": null,
			"location": "Melbourne",
			"facebook": null,
			"twitter": "@evanderkoogh",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/erwin/"
		},
		"primary_tag": null,
		"url": "http://blog.cloudflare.com/developer-spotlight-guido-zuidhof-full-tilt/",
		"excerpt": "Guido won the innovative category in one of the biggest Game Jams with a combination of Pages, Durable Objects, modern browser APIs, and a hefty amount of ingenuity.",
		"reading_time": 10,
		"access": true,
		"comments": false,
		"og_image": null,
		"og_title": null,
		"og_description": null,
		"twitter_image": null,
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": "Guido won the innovative category in one of the biggest Game Jams with a combination of Pages, Durable Objects, modern browser APIs, and a hefty amount of ingenuity.",
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	},
	"locale": "en-us"
}