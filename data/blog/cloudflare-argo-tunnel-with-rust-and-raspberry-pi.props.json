{
	"locale": "en-us",
	"post": {
		"id": "5d16453b41acde0011a956d0",
		"uuid": "09dadfbb-74c5-4f18-864d-1f4bb7ceb319",
		"title": "Cloudflare Argo Tunnel with Rust+Raspberry Pi",
		"slug": "cloudflare-argo-tunnel-with-rust-and-raspberry-pi",
		"html": "<!--kg-card-begin: markdown--><p>Yesterday Cloudflare launched <a href=\"https://developers.cloudflare.com/argo-tunnel/\">Argo Tunnel</a>. In the words of the product team:</p>\n<blockquote>\n<p>Argo Tunnel exposes applications running on your local web server, on any network with an Internet connection, without adding DNS records or configuring a firewall or router. It just works.</p>\n</blockquote>\n<p>Once I grokked this, the first thing that came to mind was that I could actually use one of my Raspberry Pi's sitting around to serve a website, without:</p>\n<ul>\n<li>A flaky DDNS running on my router</li>\n<li>Exposing my home network to the world</li>\n<li>A cloud VM</li>\n</ul>\n<p>Ooooh... so exciting.</p>\n<h3 id=\"therig\">The Rig</h3>\n<p>I'll assume you already have a Raspberry Pi with Raspbian on it.</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/03/rig.JPG\" alt=\"My rig\" loading=\"lazy\"></p>\n<p>Plug the Pi into your router. It should now have an IP address. Look that up in your router’s admin UI:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/03/devices.png\" alt=\"Attached devices\" loading=\"lazy\"></p>\n<p>OK, that's promising. Let's connect to that IP using the default pi/raspberry credentials:</p>\n<pre><code>$ ssh 192.168.8.26 -l pi\npi@192.168.8.26's password: \n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\nLast login: Sun Mar 18 23:24:11 2018 from stevens-air-2.lan\npi@raspberrypi:~ $ \n</code></pre>\n<p>We're in!</p>\n<p><strong>Pro tip: quick way to figure it out which type you have is</strong></p>\n<pre><code>pi@raspberrypi:~ $ cat /proc/cpuinfo | grep 'Revision' | awk '{print $3}' | sed 's/^1000//'\na22082\n</code></pre>\n<p>Then look up the value in the <a href=\"https://elinux.org/RPi_HardwareHistory\">Raspbery Pi revision history</a>. I have Raspberry Pi 3 Model B</p>\n<h3 id=\"internetconnectivity\">Internet connectivity</h3>\n<p>OK, so we have a Pi connected to our router. Let's make 100% sure it can connect to the Internet.</p>\n<pre><code>pi@raspberrypi:~$ $ curl -I https://www.cloudflare.com\nHTTP/2 200\ndate: Tue, 20 Mar 2018 22:54:20 GMT\ncontent-type: text/html; charset=utf-8\nset-cookie: __cfduid=dfb9c369ae12fe6eace48ed9b51aedbb01521586460; expires=Wed, 20-Mar-19 22:54:20 GMT; path=/; domain=.cloudflare.com; HttpOnly\nx-powered-by: Express\ncache-control: no-cache\nx-xss-protection: 1; mode=block\nstrict-transport-security: max-age=15780000; includeSubDomains\nx-content-type-options: nosniff\nx-frame-options: SAMEORIGIN\nserved-in-seconds: 0.025\nset-cookie: __cflb=3128081942; path=/; expires=Wed, 21-Mar-18 21:54:20 GMT\nexpect-ct: max-age=604800, report-uri=&quot;https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct&quot;\nserver: cloudflare\ncf-ray: 3febc2914beb7f06-SFO-DOG\n</code></pre>\n<p>That first line HTTP/2 200 is the OK status code, which is enough to tell us we can connect out to the Internet. Normally this wouldn't be particularly exciting, as it's allowing connections <strong>in</strong> that causes problems. That's the promise of Argo Tunnels however, it says on the tin we don't need to poke any firewall holes or configure any DNS. Big claim, let's test it.</p>\n<h3 id=\"installtheagent\">Install the Agent</h3>\n<p>Go to <a href=\"https://developers.cloudflare.com/argo-tunnel/downloads/\">https://developers.cloudflare.com/argo-tunnel/downloads/</a> to get the url for the ARM build for your Pi. At the time of writing it was <a href=\"https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-arm.tgz\">https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-arm.tgz</a></p>\n<pre><code>$ wget https://bin.equinox.io/c/VdrWdbjqyF/cloudflared-stable-linux-arm.tgz\nResolving bin.equinox.io (bin.equinox.io)... 54.243.137.45, 107.22.233.132, 50.19.252.69, ...\nConnecting to bin.equinox.io (bin.equinox.io)|54.243.137.45|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 5293773 (5.0M) [application/octet-stream]\nSaving to: ‘cloudflared-stable-linux-arm.tgz’\n...\n</code></pre>\n<p>Untar it</p>\n<pre><code>$ mkdir argo-tunnel\n$ tar -xvzf cloudflared-stable-linux-arm.tgz -C ./argo-tunnel\ncloudflared\n$ cd argo-tunnel\n</code></pre>\n<p>Check you can execute it.</p>\n<pre><code>$ ./cloudflared --version\ncloudflared version 2018.3.0 (built 2018-03-02-1820 UTC)\n</code></pre>\n<p>Looks OK. Now, we're hoping that the agent will magically connect from the Pi out to the nearest Cloudflare POP. We obviously want that to be secure. Furthermore, we're expecting that when a request comes inbound, it magically gets routed through Cloudflare's network and back to my Raspberry Pi.</p>\n<p>Seems unlikely, but let’s have faith. Here is my mental model of what's happening:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/03/Argo-Tunnel-Diagram.png\" alt=\"My mental model of Argo Tunnel\" loading=\"lazy\"></p>\n<p>So let's create that secure tunnel. I guess we need some sort of certificate or credentials...</p>\n<pre><code>$ ./cloudflared login\n</code></pre>\n<p>You'll see output in the command window similar to this:</p>\n<pre><code>A browser window should have opened at the following URL:\n\nhttps://www.cloudflare.com/a/warp?callback=&lt;some token&gt;\n\nIf the browser failed to open, open it yourself and visit the URL above.\n</code></pre>\n<p>Our headless Pi doesn't have a web browser, so let's copy the url from the console into the browser on our host dev machine.</p>\n<p><mark>This part assumes you already have a domain on Cloudflare</mark> If you don't go to the <a href=\"https://support.cloudflare.com/hc/en-us/articles/201720164\">setup guide</a> to get started.</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/03/authorize-choose-domain.png\" alt=\"authorize-choose-domain\" loading=\"lazy\"></p>\n<p>We're being asked which domain we want this tunnel to sit behind. I've chosen <strong>pacman.wiki</strong>. Click Authorize.</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/03/authorize-confirm.png\" alt=\"authorize-confirm\" loading=\"lazy\"></p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/03/authorize-complete.png\" alt=\"authorize-complete\" loading=\"lazy\"></p>\n<p>You should now see this back on your pi:</p>\n<pre><code>You have successfully logged in.\nIf you wish to copy your credentials to a server, they have been saved to:\n/home/pi/.cloudflared/cert.pem\n</code></pre>\n<p>Aha! That answers how the tunnel gets secured. The agent has created a certificate and will use that to secure the connection back to Cloudflare. Now let's create the tunnel and serve some content!</p>\n<p><code>$ cloudflared --hostname [hostname] --hello-world</code></p>\n<p><strong>hostname</strong> is a fully-qualified domain name under the domain you chose to Authorize for Argo Tunnels earlier. I'm going to use <strong>tunnel.pacman.wiki</strong></p>\n<pre><code>$ ./cloudflared --hostname tunnel.pacman.wiki --hello-world\nINFO[0002] Proxying tunnel requests to https://127.0.0.1:46727 \nINFO[0000] Starting Hello World server at 127.0.0.1:53030 \nINFO[0000] Starting metrics server                       addr=&quot;127.0.0.1:53031&quot;\nINFO[0005] Connected to LAX                             \nINFO[0010] Connected to SFO-DOG                         \nINFO[0012] Connected to LAX                             \nINFO[0012] Connected to SFO-DOG  \n</code></pre>\n<p>Huh, interesting. So, we've connected to my nearest POP(s). I'm in the San Francisco Bay Area, so SJC and LAX seems reasonable. What now though? Surely that's not it? If I'm reading this right, I can go to my browser, enter <a href=\"https://tunnel.pacman.wiki\">https://tunnel.pacman.wiki</a> and I'll get a hello world page... surely not.</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/03/success-1.png\" alt=\"Success!\" loading=\"lazy\"><br>\nAnd back on the Pi</p>\n<pre><code>INFO[0615] GET https://127.0.0.1:62627/ HTTP/1.1 CF-RAY=4067701b598e8184-LAX\nINFO[0615] 200 OK  CF-RAY=4067701b598e8184-LAX\n</code></pre>\n<p>Mind. Blown. So what happened here exactly...</p>\n<ol>\n<li>The agent on the Pi created a secure tunnel (a persistent http2 connection) back to the nearest Cloudflare Argo Tunnels server</li>\n<li>The tunnel was secured with the certificate generated by the agent.</li>\n<li>A request for <a href=\"https://tunnel.pacman.wiki\">https://tunnel.pacman.wiki</a> went from my browser out through the Internet and was routed to the nearest Cloudflare <a href=\"https://www.cloudflare.com/learning/cdn/glossary/anycast-network/\">datacenter</a></li>\n<li>Cloudflare received the request, saw the domain was Cloudflare managed and saw a tunnel set up to that hostname</li>\n<li>The request got routed over that http2 connection back to my Pi</li>\n</ol>\n<p>I'm serving traffic over the Internet, from my Pi, with no ports opened on my home router. That is so cool.</p>\n<h3 id=\"morethanhelloworld\">More than hello world</h3>\n<p>If you're reading this, I've won my battle with the Cloudflare blog editing team about long form vs short form content :p</p>\n<p>Serving hello world is great, but I want to expose a real web server. If you're like me, if you can find any vaguely relevant reason to use Rust, then you use Rust. If you're also like me, you want to try one of these async web servers the cool kids talk about on <a href=\"https://www.reddit.com/r/rust/\">/r/rust</a> like <a href=\"https://gotham.rs/\">gotham</a>. Let's do it.</p>\n<p>First, install rust using <a href=\"https://www.rustup.rs/\">rustup</a>.</p>\n<p><code>$ curl https://sh.rustup.rs -sSf | sh</code></p>\n<p>When prompted, just hit enter</p>\n<pre><code>1) Proceed with installation (default)\n2) Customize installation\n3) Cancel installation\n...\n  stable installed - rustc 1.24.1 (d3ae9a9e0 2018-02-27)\n...\n</code></pre>\n<p>OK, Rust is installed. Now clone Gotham and build the hello_world example:</p>\n<pre><code>$ git clone https://github.com/gotham-rs/gotham\n$ cd gotham/examples/hello_world\n$ cargo build\n</code></pre>\n<p><strong>Pro tip:</strong> if cargo is not found, run <code>source $HOME/.cargo/env</code>. It will be automatic in future sessions.</p>\n<p>As cargo does its magic, you can think to yourself about how it's a great package manager, how there really are a lot of dependencies and how OSS really is standing on the shoulders of giants of giants of giants of giants—eventually you'll have the example built.</p>\n<pre><code>...\nCompiling gotham_examples_hello_world v0.0.0 (file:///home/pi/argo-tunnel/gotham/examples/hello_world)\n    Finished dev [unoptimized + debuginfo] target(s) in 502.83 secs\n    \n$ cd ../../target/debug\n$ ./gotham_examples_hello_world \nListening for requests at http://127.0.0.1:7878\n</code></pre>\n<p>We have a rust web server listening on a local port. Let's connect the tunnel to that.</p>\n<p><code>./cloudflared --hostname gotham.pacman.wiki http://127.0.0.1:7878</code></p>\n<p>Type <strong>gotham.pacman.wiki</strong> into your web browser and you'll see those glorious words, &quot;Hello, world&quot;.</p>\n<h2 id=\"waitthispostwasmeanttobemorethanhelloworld\">Wait, this post was meant to be <em>more</em> than hello world.</h2>\n<p>OK, challenge accepted. Rust being fancy and modern is OK with Unicode. Let's serve some of that.</p>\n<pre><code>$ cd examples/hello_world/src/\n$ nano src/main.rs \n</code></pre>\n<p>Replace the hello world string:</p>\n<p><code>Some((String::from(&quot;Hello World!&quot;).into_bytes(), mime::TEXT_PLAIN)),</code></p>\n<p>with some Unicode and a content-type hint so the browser know how to render it:</p>\n<p><code>Some((String::from(&quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv='Content-Type' content='text/html; charset=UTF-8'&gt;&lt;/head&gt;&lt;body&gt;&lt;marquee&gt;Pᗣᗧ•••MᗣN&lt;/marquee&gt;&lt;/body&gt;&lt;/html&gt;&quot;).into_bytes(), mime::TEXT_HTML)),</code></p>\n<p>Build and run</p>\n<pre><code>$ cargo build\n...\n./gotham_examples_hello_world \nListening for requests at http://127.0.0.1:7878\n</code></pre>\n<p><code>$ ./cloudflared --hostname gotham.pacman.wiki http://127.0.0.1:7878</code></p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/03/pacman-2.gif\" alt=\"pacman\" loading=\"lazy\"></p>\n<p>And now we have some unicode served from our Pi at home over the Internet by a highly asynchronous web server written in a fast, safe, high-level language. Cool.</p>\n<h3 id=\"arewedone\">Are we done?</h3>\n<p>We should probably auto start both the agent and the web server on boot so they don't die when we end our ssh session.</p>\n<pre><code>$ sudo ./cloudflared service install\nINFO[0000] Failed to copy user configuration. Before running the service, \nensure that /etc/cloudflared contains two files, cert.pem and config.yml  \nerror=&quot;open cert.pem: no such file or directory&quot;\n</code></pre>\n<p>Nice error! OK, the product team have helpfully documented what to put in that file <a href=\"https://developers.cloudflare.com/argo-tunnel/reference/config/\">here</a></p>\n<pre><code>$ sudo cp ~/.cloudflared/cert.pem /etc/cloudflared\n$ sudo nano /etc/cloudflared/config.yml\n</code></pre>\n<pre><code>#config.yml\nhostname: gotham.pacman.wiki\nurl: http://127.0.0.1:7878\n</code></pre>\n<h4 id=\"autostartfortheagent\">Autostart for the Agent</h4>\n<pre><code>$ sudo ./cloudflared service install\nINFO[0000] Using Systemd                                \nERRO[0000] systemctl: Created symlink from /etc/systemd/system/multi-user.target.wants/cloudflared.service to /etc/systemd/system/cloudflared.service.\nINFO[0000] systemctl daemon-reload       \n</code></pre>\n<h4 id=\"autostartforthewebserver\">Autostart for the Web Server</h4>\n<p>Copy the web server executable somewhere outside the gotham source tree so you can play around with the source code. I copied mine to <code>/home/pi/argo-tunnel/server/bin/</code></p>\n<p><code>nano /etc/rc.local</code></p>\n<p>Add line: <code>/home/pi/argo-tunnel/server/bin/gotham_examples_hello_world &amp;</code> just before <code>exit 0</code></p>\n<p><code>sudo reboot</code></p>\n<p>On restart, ssh back in again and check both the agent and server are running.</p>\n<pre><code>$ sudo ps -aux | grep tunnel\nroot       501  0.1  0.2  37636  1976 ?        Sl   06:30   0:00 /home/pi/argo-tunnel/server/bin/gotham_examples_hello_world\nroot       977 15.7  1.4 801292 13972 ?        Ssl  06:30   0:01 /home/pi/argo-tunnel/cloudflared --config /etc/cloudflared/config.yml --origincert /etc/cloudflared/cert.pem --no-autoupdate\n</code></pre>\n<p>Profit.</p>\n<!--kg-card-end: markdown-->",
		"comment_id": "5aafeeb7c1ea2100226c6b72",
		"feature_image": "http://blog.cloudflare.com/content/images/2018/03/Argo-Tunnel-Diagram-1.png",
		"featured": false,
		"visibility": "public",
		"created_at": "2018-03-19T17:09:11.000+00:00",
		"updated_at": "2021-06-02T18:29:25.000+01:00",
		"published_at": "2018-04-06T15:00:00.000+01:00",
		"custom_excerpt": "Serving content from a Rust web server running on a Raspberry Pi from your home to the world, with a Cloudflare Argo Tunnels.",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "5d1644b141acde0011a94fc5",
				"name": "Steven Pack",
				"slug": "stevenpack",
				"profile_image": "http://blog.cloudflare.com/content/images/2022/08/steven-pack.png",
				"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-123.png",
				"bio": "Partner Engineering Director",
				"website": null,
				"location": "San Francisco Bay Area, California",
				"facebook": null,
				"twitter": "@steven_pack",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/stevenpack/"
			}
		],
		"tags": [
			{
				"id": "5d16450341acde0011a9523c",
				"name": "Rust",
				"slug": "rust",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/rust/"
			},
			{
				"id": "5d16450341acde0011a95206",
				"name": "Argo Smart Routing",
				"slug": "argo",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/argo/"
			},
			{
				"id": "5d16450341acde0011a9525e",
				"name": "Raspberry Pi",
				"slug": "raspberry-pi",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/raspberry-pi/"
			},
			{
				"id": "5d16450341acde0011a95265",
				"name": "Security",
				"slug": "security",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Security.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Security",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Security'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/security/"
			},
			{
				"id": "5d16450341acde0011a95160",
				"name": "Speed & Reliability",
				"slug": "speed-and-reliability",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Speed---Reliability-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Speed & Reliability",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Speed & Reliability'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/speed-and-reliability/"
			},
			{
				"id": "5d16450341acde0011a95214",
				"name": "Programming",
				"slug": "programming",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/programming/"
			},
			{
				"id": "609916252d012001babc67eb",
				"name": "Cloudflare Tunnel",
				"slug": "cloudflare-tunnel",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/cloudflare-tunnel/"
			}
		],
		"primary_author": {
			"id": "5d1644b141acde0011a94fc5",
			"name": "Steven Pack",
			"slug": "stevenpack",
			"profile_image": "http://blog.cloudflare.com/content/images/2022/08/steven-pack.png",
			"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-123.png",
			"bio": "Partner Engineering Director",
			"website": null,
			"location": "San Francisco Bay Area, California",
			"facebook": null,
			"twitter": "@steven_pack",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/stevenpack/"
		},
		"primary_tag": {
			"id": "5d16450341acde0011a9523c",
			"name": "Rust",
			"slug": "rust",
			"description": null,
			"feature_image": null,
			"visibility": "public",
			"meta_title": null,
			"meta_description": null,
			"og_image": null,
			"og_title": null,
			"og_description": null,
			"twitter_image": null,
			"twitter_title": null,
			"twitter_description": null,
			"codeinjection_head": null,
			"codeinjection_foot": null,
			"canonical_url": null,
			"accent_color": null,
			"url": "http://blog.cloudflare.com/tag/rust/"
		},
		"url": "http://blog.cloudflare.com/cloudflare-argo-tunnel-with-rust-and-raspberry-pi/",
		"excerpt": "Serving content from a Rust web server running on a Raspberry Pi from your home to the world, with a Cloudflare Argo Tunnels.",
		"reading_time": 8,
		"access": true,
		"comments": false,
		"og_image": null,
		"og_title": null,
		"og_description": null,
		"twitter_image": null,
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": null,
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	}
}