<div class="mb2 gray5 ">17 min. de leitura</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/10/image6-19.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Em grandes escalas operacionais, o endereçamento de IP emperra a inovação em serviços de rede e na web. Para cada mudança na arquitetura, e sem dúvida ao começar a projetar novos sistemas, somos forçados a fazer estas perguntas:</p>
	<ul>
		<li>Qual bloco de endereços de IP iremos ou podemos usar?</li>
		<li>Temos o suficiente em IPv4? Se não, onde e como vamos adquirir mais?</li>
		<li>Como usar endereços IPv6 e isso afeta outros usos do IPv6?</li>
		<li>E, por fim, em que devemos prestar mais atenção em termos de planos, controles, tempo e equipe para a migração?</li>
	</ul>
	<p>Quando você para e se preocupa com endereços de IP, gasta tempo, dinheiro e recursos. Isso pode parecer surpreendente, porque o <a href="https://datatracker.ietf.org/doc/html/rfc791">advento do IP</a>, há mais de 40 anos, foi visionário e resiliente. Por design, os endereços de IP devem ser o último elo na cadeia de coisas com as quais uma rede precisa se preocupar. No entanto, se a Internet revelou algo, é que fragilidades pequenas ou supostamente sem importância (muitas vezes invisíveis ou impossíveis de detectar no momento do design) acabam sempre aparecendo em uma escala significativa.</p>
	<p>​Uma das coisas de que temos certeza, entretanto, é que "mais endereços" nunca deve ser a resposta. No IPv4, esse tipo de raciocínio só pode levar à sua escassez e à disparada dos preços de mercado. O formato IPv6 é absolutamente necessário, mas é apenas parte da solução. Por exemplo, no IPv6, a boa prática estipula que a menor alocação, reservada somente para uso pessoal, é /56, ou seja, 272 ou cerca de 4.722.000.000.000.000.000.000 de endereços. Pessoalmente, não consigo pensar em números tão grandes. E você?</p>
	<p>Nesta postagem do blog, vamos explicar porque o endereço de IP é um problema para serviços da web, bem como as causas estruturais desse problema. Além disso, vamos descrever uma solução inovadora que chamamos de "Agilidade de Endereçamento", bem como as lições que aprendemos. A melhor parte dessa abordagem é a variedade de novos sistemas e arquiteturas que a Agilidade de Endereçamento torna possível. Todos os detalhes estão disponíveis em nosso <a href="https://research.cloudflare.com/publications/Fayed2021">artigo</a> mais recente, da ACM SIGCOMM 2021. Confira um resumo do que aprendemos:</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/11/1.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>É verdade! Não há limite para o número de nomes que podem aparecer em um determinado endereço. O endereço de qualquer nome pode mudar a cada nova consulta, <em>em qualquer lugar</em>. Da mesma forma, os endereços podem ser alterados por qualquer motivo, seja para a prestação de um serviço, política, avaliação de desempenho ou qualquer outro caso ainda não encontrado…</p>
	<p>Veja a seguir uma explicação dos princípios em ação por trás de todas essas realizações, como raciocinamos nesta área e por que essas lições são importantes para serviços HTTP e TLS<em> de qualquer tamanho</em>. O principal insight sobre o qual estamos desenvolvendo todo o nosso pensamento é: assim como no sistema de correios, de acordo com o design do protocolo da Internet (IP, na sigla em inglês), um endereço nunca tem, nunca deve e nunca precisa representar nomes. Mas, às vezes, atribuímos essas responsabilidades aos endereços. Em vez disso, este estudo mostra que todos os nomes devem compartilhar seu conjunto de endereços, um determinado conjunto de endereços ou até mesmo um único endereço.</p>
	<h2 id="essa-camisa-de-for-a-um-funil-e-tamb-m-um-gargalo"><strong>Essa "camisa de força" é um funil e também um gargalo</strong></h2>
	<p>Convenções criadas há muitas décadas associam artificialmente os endereços de IP a nomes e recursos. Isso é compreensível, porque a arquitetura e o software que impulsionam a Internet são o resultado de um design em que um computador tinha um nome e (na maioria das vezes) uma placa de interface de rede. Portanto, seria natural que a Internet evoluísse de tal modo que um determinado endereço de IP fosse vinculado a nomes e processos de software.</p>
	<p>Essas vinculações de IP têm pouco impacto sobre os clientes finais e operadoras de rede, que não precisam de nomes e menos ainda de processos de escuta. No entanto, as convenções de nomes e processos criam fortes limitações para <em>todos</em> os provedores de serviços de hospedagem, distribuição e conteúdo (CSPs). Uma vez atribuídos a nomes, interfaces e soquetes, os endereços se tornam inerentemente estáticos e qualquer mudança neles requer esforço, planejamento e atenção, se é que uma mudança é possível.</p>
	<p>Essa "camisa de força" do IP permitiu o desenvolvimento da Internet, mas como o TCP para protocolos de transporte e o HTTP para protocolos de aplicativo, o protocolo IP se transformou em um freio à inovação. Essa ideia é representada pela figura abaixo, em que podemos ver o estabelecimento de relações transitivas entre vinculações de comunicação (com nomes) e vinculações de conexão (com interfaces e soquetes) que antes ficavam separados.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/11/2.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>É difícil desfazer esse bloqueio transitivo, porque alterar um dos dois elementos pode afetar o outro. Além disso, os provedores de serviços costumam usar endereços de IP para representar políticas e níveis de serviço que existem por si próprios, independentemente dos nomes. Em última análise, as vinculações de IP são um novo elemento a ser levado em consideração — e por um motivo ruim.</p>
	<p>Vamos olhar essa questão de outro ângulo. Ao pensar em novos designs, novas arquiteturas ou simplesmente melhores maneiras de alocar recursos, as primeiras perguntas a serem feitas não devem ser "Quais endereços de IP vamos usar?" ou "Temos os endereços de IP para fazer isso?". Esse tipo de questionamento e as respostas associadas a ele dificultam o desenvolvimento e a inovação.</p>
	<p>Percebemos que as vinculações de IP não eram somente artificiais, mas também se mostraram incorretas, do ponto de vista das RFCs e dos padrões originais. Na verdade, a própria noção de um endereço de IP como parte de uma representação de qualquer coisa que não seja acessibilidade vai contra sua concepção original. No <a href="https://datatracker.ietf.org/doc/html/rfc791#section-2.3">RFC</a> original e documentos relacionados, os arquitetos são muito claros: "Uma distinção deve ser feita entre nomes, endereços e rotas. Um nome designa o elemento que observamos. O endereço indica onde este elemento está localizado. A rota mostra como chegar a esse local". Qualquer associação de informações ao IP, como SNI ou host HTTP nos protocolos de camada superior é uma nítida violação do princípio de camadas.</p>
	<p>Claro, nosso trabalho não existe de maneira isolada. No entanto, ele encerra um longo processo evolutivo que visa desassociar os endereços de IP de seu uso convencional, uma evolução que, em última instância, consiste em <a href="https://blog.cloudflare.com/cloudflare-research-two-years-in">desenvolver</a> nosso próprio conhecimento.</p>
	<h3 id="uma-evolu-o-do-passado-"><strong>Uma evolução do passado…</strong></h3>
	<p>Olhando para os últimos 20 anos, podemos ver que essa busca por agilidade no endereçamento acontece há algum tempo, e que a Cloudflare está muito envolvida na questão.</p>
	<p>A vinculação um para um entre o IP e as interfaces da placa de rede já é antiga e foi quebrada pela primeira vez há alguns anos, quando o projeto <a href="https://research.google/pubs/pub44824">Maglev</a> do Google combinou a estratégia de roteamento de vários caminhos de custo igual (ECMP, na sigla em inglês) com um hash constante para disseminar o tráfego proveniente de um endereço de IP "virtual" entre vários servidores. Como anedota, de acordo com os RFCs originais do protocolo da Internet, esse uso do IP é proibido e nada virtual.</p>
	<p>Muitos sistemas semelhantes surgiram desde então no GitHub, no Facebook e em outros lugares, incluindo nossa própria solução, o <a href="https://blog.cloudflare.com/unimog-cloudflares-edge-load-balancer">Unimog</a>. Mais recentemente, a Cloudflare projetou uma nova arquitetura de soquetes programáveis chamada <a href="https://blog.cloudflare.com/its-crowded-in-here">bpf_sk_lookup</a> para desassociar endereços de IP de soquetes e processos.</p>
	<p>Mas e os nomes? O conceito de "hospedagem virtual" foi estabelecido em 1997, quando o HTTP 1.1 definiu o campo host como obrigatório. Esse foi o primeiro reconhecimento oficial de que vários nomes poderem coexistir no mesmo endereço de IP, constatação necessariamente reproduzida pelo TLS no campo Indicação de Nome do Servidor. São requisitos absolutos, porque o número de nomes possíveis é maior do que o número de endereços de IP.</p>
	<h3 id="-revela-um-futuro-gil"><strong>…revela um futuro Ágil</strong></h3>
	<p>Em perspectiva, a pergunta de Shakespeare "O que é que há, pois, num nome?" acaba sendo particularmente astuta. Se a Internet pudesse falar, diria: "Este nome pelo qual caracterizamos um endereço seria tão acessível quanto qualquer outro".</p>
	<p>Se Shakespeare tivesse perguntado em vez disso, "O que há em um endereço?", a Internet certamente responderia do mesmo jeito "Este nome pelo qual caracterizamos um endereço seria tão acessível quanto qualquer outro".</p>
	<p>Uma forte conclusão surge da verdade dessas respostas: o mapeamento entre nomes e endereços é realizado ponto a ponto (any-to-any). Se isso for verdade, qualquer endereço pode ser usado para acessar um nome, desde que esse nome possa ser acessado em um endereço.</p>
	<p>Na verdade, uma versão do formato "vários endereços para um nome" está disponível desde 1995 com a introdução do <a href="https://datatracker.ietf.org/doc/html/rfc1794">balanceamento de carga baseado em DNS</a>. Então, por que não "todos os endereços para todos os nomes" ou "qualquer endereço a qualquer momento para todos os nomes"? Ou (como descobriremos em breve) "um endereço para todos os nomes"! Mas vamos primeiro discutir como alcançar Agilidade de Endereçamento.</p>
	<h2 id="para-ter-agilidade-de-endere-amento-ignore-nomes-mapeie-pol-ticas"><strong>Para ter Agilidade de Endereçamento: ignore nomes, mapeie políticas</strong></h2>
	<p>O segredo da Agilidade de Endereçamento está no DNS autoritativo, mas não nos mapeamentos estáticos "nome para IP" armazenados em um registro ou tabela de pesquisa. Considere que, do ponto de vista do cliente, a vinculação só aparece "mediante consulta". Para todos os fins práticos de mapeamento, a resposta à consulta é o último momento em que um nome pode ser vinculado a um endereço durante o ciclo de vida de uma solicitação.</p>
	<p>Assim, concluímos que os mapeamentos de nomes são criados no momento em que a resposta é retornada, e não em um arquivo de registro ou zona. É uma diferença sutil, mas importante. Os sistemas DNS de hoje usam um nome para pesquisar um conjunto de endereços e, às vezes, usam políticas para decidir qual endereço retornar. O conceito é mostrado na figura abaixo. Quando uma consulta é recebida, os endereços associados ao nome são revelados e um ou mais desses endereços são retornados. Muitas vezes, outros filtros de política ou lógica são usados para restringir a seleção de endereços, como o nível de serviço ou a cobertura geográfica. É importante que os endereços sejam primeiro identificados com um nome e que as políticas só sejam aplicadas depois.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2021/11/3.png" class="kg-image" alt="" loading="lazy">
		<figcaption>(a) DNS autoritativo convencional</figcaption>
	</figure>
	<p></p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2021/11/4.png" class="kg-image" alt="" loading="lazy">
		<figcaption>(b) Agilidade de Endereçamento</figcaption>
	</figure>
	<p></p>
	<p>A Agilidade de Endereçamento é conquistada ao inverter essa relação. Em vez de endereços de IP já atribuídos a um nome, nossa arquitetura começa com uma política que pode (ou não, em nosso caso) incluir um nome. Por exemplo, uma política pode ser representada por atributos como local e tipo de conta, enquanto o nome é ignorado (o que fizemos quando o implantamos). Os atributos identificam um pool de endereços associados a esta política. O próprio pool pode ser isolado a esta política ou ter elementos em comum com outros pools e políticas. Além disso, todos os endereços no pool são equivalentes. Isso significa que qualquer endereço pode ser retornado ou mesmo selecionado aleatoriamente sem verificar o nome da consulta DNS.</p>
	<p>Agora pare por um momento, pois há duas conclusões muito notáveis que emergem das respostas por consulta:</p>
	<p>i. Os endereços de IP podem ser (e são) calculados e atribuídos em tempo de execução ou tempo de consulta.</p>
	<p>ii. O ciclo de vida do mapeamento de IP para nome corresponde à duração da conexão subsequente ou ao TTL em caches downstream — o que for maior.</p>
	<p>O resultado é impressionante, o que significa que a vinculação em si é efêmera e pode ser alterada independentemente de vinculações, resolvedores, clientes ou objetivos anteriores. A escala também não é um problema, e sabemos disso porque implantamos na borda.</p>
	<h3 id="ipv6-a-roupa-nova-do-imperador"><strong>IPv6 — a roupa nova do imperador</strong></h3>
	<p>Antes de falarmos sobre nossa implementação, vamos primeiro abordar o IPv6. Em primeiro lugar, deve ficar claro que tudo — <em>tudo</em> — que foi discutido aqui em relação ao IPv4 também se aplica ao IPv6. Assim como no sistema mundial de correios, endereços são endereços, seja em Camarões, no Camboja, no Canadá, no Chile ou na China — e isso inclui sua natureza relativamente estática e inflexível.</p>
	<p>Apesar da equivalência, a questão óbvia permanece: todas as razões para buscar Agilidade de Endereçamento não foram alcançadas com a mudança para o IPv6? Por mais absurda que seja, a resposta é um não absoluto e retumbante! O IPv6 pode mitigar o esgotamento de endereços, pelo menos durante a vida de todas as pessoas vivas hoje, mas a abundância de prefixos e endereços IPv6 torna difícil pensar em vincular nomes e recursos.</p>
	<p>A abundância de endereços IPv6 também acarreta o risco de ineficiência, uma vez que as operadoras podem usar o tamanho do bit e os grandes tamanhos de prefixo para inserir um significado no endereço de IP. Esse é um recurso poderoso do IPv6, mas também significa que muitos, muitos endereços em cada prefixo não são usados.</p>
	<p>Para ser claro: a Cloudflare é comprovadamente uma das maiores defensoras do IPv6, e por bons motivos, até porque a abundância de endereços garante longevidade. Ainda assim, o IPv6 muda pouco a maneira como os endereços são vinculados a nomes e recursos, enquanto a Agilidade de Endereçamento garante flexibilidade e capacidade de resposta em todo o seu ciclo de vida.</p>
	<h3 id="uma-observa-o-agilidade-para-todos"><strong>Uma observação: agilidade é para todos</strong></h3>
	<p>Uma última observação sobre a arquitetura e sua transferibilidade — Agilidade de Endereçamento é útil, até mesmo desejável, para qualquer serviço que opere DNS autoritativo. Outros provedores de serviços de conteúdo são concorrentes óbvios, mas operadores menores também são. Universidades, empresas e agências governamentais são apenas alguns exemplos de organizações que podem realizar seus próprios serviços autoritativos. Enquanto os operadores puderem aceitar conexões por meio dos endereços de IP retornados, todos serão potenciais beneficiários da Agilidade de Endereçamento.</p>
	<h2 id="endere-os-aleat-rios-baseados-em-pol-ticas-em-escala"><strong>Endereços aleatórios baseados em políticas — em escala</strong></h2>
	<p>Desde junho de 2020, trabalhamos com Agilidade de Endereçamento no tráfego de produção ativo na borda, da seguinte maneira:</p>
	<ul>
		<li>Mais de 20 milhões nomes de host e serviços</li>
		<li>Todos os data centers no Canadá (com uma população razoável e vários fusos horários)</li>
		<li>/20 (4.096 endereços) em IPv4 e /44 em IPv6</li>
		<li>/24 (256 endereços) em IPv4 de janeiro a junho de 2021</li>
		<li>Uma seção de host aleatória dentro do prefixo gerada para cada consulta</li>
	</ul>
	<p>Afinal, o verdadeiro teste de agilidade atinge seu limite máximo quando um endereço aleatório é gerado para cada consulta que chega aos nossos servidores. Em seguida, decidimos testar a ideia. Em junho de 2021, em nosso data center de Montreal e logo após no de Toronto, todas as mais de 20 milhões de zonas foram atribuídas a um único endereço.</p>
	<p>Ao longo de um ano, cada consulta para um domínio coberto pela política recebeu um endereço aleatório — primeiro 4.096, depois 256 e, finalmente, um. Internamente, chamamos o conjunto de endereços de um como Ao1, mas falaremos sobre ele mais adiante.</p>
	<h3 id="a-medida-do-sucesso-n-o-h-nada-para-ver-aqui"><strong>A medida do sucesso: "Não há nada para ver aqui"</strong></h3>
	<p>Pode haver uma série de perguntas que nossos leitores se fazem silenciosamente:</p>
	<ul>
		<li>O que isso quebrou na Internet?</li>
		<li>Como isso afetou os sistemas da Cloudflare?</li>
		<li>O que eu faria, se pudesse?</li>
	</ul>
	<p>A resposta mais fácil para as perguntas acima é: <em>nada</em>. Mas — e isso é importante — a randomização de endereços revela os pontos fracos no design de sistemas que dependem da Internet. As vulnerabilidades <em>sempre</em> ocorrem (cada uma!) porque os desenvolvedores atribuem um significado diferente aos endereços de IP, que vai além da acessibilidade. E cada uma dessas vulnerabilidades é contornada, mesmo que de forma aleatória, com o uso de um endereço, ou "Ao1").</p>
	<p>Para entender melhor a natureza do "nada", devemos responder às perguntas acima da última para a primeira.</p>
	<h4 id="o-que-eu-faria-se-pudesse"><strong>O que eu faria, se pudesse?</strong></h4>
	<p>A resposta é mostrada no exemplo da figura a seguir. Em todos os data centers no "resto do mundo" fora de nossa implementação, uma consulta para uma zona retorna os mesmos endereços (este é o sistema Anycast global da Cloudflare). Em contraste, toda consulta que chega a um data center de implementação recebe um endereço aleatório. Isso pode ser visto abaixo em comandos dig consecutivos para dois data centers diferentes.<br></p>
	<p>Caso você esteja pensando no tráfego de solicitações abaixo: sim, isso significa que os servidores estão configurad</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/11/5.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>os para aceitar solicitações de conexão de <em>qualquer um</em> dos mais de 20 milhões de domínios em <em>todos</em> os endereços no pool de endereços.</p>
	<h4 id="tudo-bem-mas-certamente-os-sistemas-circundantes-da-cloudflare-tiveram-que-ser-alterados"><strong>Tudo bem, mas certamente os sistemas circundantes da Cloudflare tiveram que ser alterados?</strong></h4>
	<p>Não. Esta é uma mudança transparente no pipeline de dados para DNS autoritativo. Todos os anúncios de prefixo de roteamento em BGP, DDoS, balanceadores de carga, cache distribuído etc. não precisaram ser alterados.</p>
	<p>No entanto, há um efeito colateral fascinante: a randomização é para endereços de IP o que uma boa função hash é para uma tabela hash — atribui uma entrada de qualquer tamanho uniformemente a um número fixo de saídas. O efeito fica claro ao observar a carga por IP antes e depois da randomização, conforme mostrado nos gráficos abaixo, onde os dados vêm de 1% da amostra de solicitações em um data center em sete dias.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2021/10/image4-24.png" class="kg-image" alt="Before Addressing Agility" loading="lazy">
		<figcaption>Antes da Agilidade de Endereçamento</figcaption>
	</figure>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2021/10/image2-26.png" class="kg-image" alt="Randomization on /20" loading="lazy">
		<figcaption>Randomização em /20</figcaption>
	</figure>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2021/10/image1-40.png" class="kg-image" alt="Randomization on /24" loading="lazy">
		<figcaption>Randomização em /24</figcaption>
	</figure>
	<p></p>
	<p>Antes da randomização, em apenas uma pequena parte do espaço de IP da Cloudflare, (a) a diferença entre o maior e o menor número de solicitações por IP (eixo y1 à esquerda) é de três classes de tamanho; da mesma forma, a diferença em bytes por IP (eixo y2 à direita) é de quase seis classes de tamanho. Após a randomização, (b) em todas as áreas em um único /20 que anteriormente ocupavam vários /20, houve uma redução de duas ou três classes de tamanho. Já em /24, (c) a randomização por consulta de mais de 20 milhões de zonas para 256 endereços reduz as diferenças na carga a pequenos fatores constantes.</p>
	<p>Isso pode ser importante para qualquer provedor de serviços de conteúdo que considere o provisionamento de recursos por endereço de IP. Pode ser difícil prever a priori a carga gerada por um cliente. Os gráficos acima mostram que a melhor maneira é <em>atribuir todos os endereços a todos os nomes</em>.</p>
	<h4 id="certamente-isso-leva-a-interrup-es-na-internet-como-um-todo-n-o-"><strong>Certamente isso leva a interrupções na Internet como um todo, não é?</strong></h4>
	<p>Também não. Bem, para ser mais preciso: "Não, a randomização não interrompe nada… mas pode revelar os pontos fracos dos sistemas e seus designs".</p>
	<p>Todo sistema que <em>pode</em> ser afetado pela randomização de endereço parece ter um pré-requisito: o endereço de IP recebe um significado que vai além da mera acessibilidade. A Agilidade de Endereçamento retém e até recupera a semântica dos endereços de IP e da arquitetura central da Internet, mas impede que os sistemas de software façam suposições sobre seu significado.</p>
	<p>Primeiro, vamos ver alguns exemplos e por que eles não importam. Em seguida, faça uma pequena mudança na Agilidade de Endereçamento que contorna as vulnerabilidades (usando um único endereço de IP):</p>
	<ul>
		<li>A união de conexões HTTP permite que um cliente reutilize conexões existentes para solicitar recursos de diferentes origens. Clientes como o Firefox, que permitem uma união quando a autoridade do URI corresponde à conexão, não são afetados. No entanto, os clientes que solicitarem que um host URI resolva para o mesmo endereço de IP da conexão especificada falharão.</li>
		<li>Serviços não baseados em TLS ou HTTP podem ser afetados. Um exemplo é o ssh, que gerencia uma atribuição de nomes de host a endereços de IP em known_hosts. Essa associação é compreensível, mas desatualizada, pois muitos registros de DNS atualmente geram mais de um endereço de IP.</li>
		<li>Os certificados TLS não SNI exigem seu próprio endereço IP. Os provedores são forçados a cobrar uma sobretaxa porque cada endereço só é compatível com um único certificado sem SNI. Independentemente do IP, o maior problema é usar TLS sem um SNI. Iniciamos esforços para entender os que não usam SNI e esperamos que esse infeliz legado chegue ao fim.</li>
		<li>As proteções contra DDoS que dependem de IPs de destino podem ser prejudicadas inicialmente. Acreditamos que a Agilidade de Endereçamento é benéfica por dois motivos. Em primeiro lugar, a randomização de IP distribui a carga de ataque por todos os endereços usados, atuando efetivamente como um balanceador de carga da Camada 3. Em segundo lugar, as mitigações de DoS geralmente funcionam com a alteração dos endereços de IP — uma habilidade que está incluída na Agilidade de Endereçamento.</li>
	</ul>
	<h2 id="um-por-todos-e-todos-por-um"><strong>Um por todos, e todos por um</strong></h2>
	<p>Começamos com mais de 20 milhões de zonas vinculadas a dezenas de milhares de endereços e os provisionamos com êxito 4.096 endereços em um /20 e 256 endereços em um /24. Esta tendência certamente levanta a seguinte questão:</p>
	<blockquote><strong>Se a randomização funciona em <em>n</em> endereços, por que não funciona em 1 endereço?</strong></blockquote>
	<p>É mesmo. Por que não? Lembre-se da observação acima sobre a randomização em IPs, que corresponde a uma função de hash perfeita em uma tabela de hash. O legal das estruturas hash bem projetadas é que elas retêm suas propriedades em qualquer tamanho de estrutura, mesmo que o tamanho seja de 1. Essa redução seria um verdadeiro teste das premissas sobre as quais a Agilidade de Endereçamento se desenvolve.</p>
	<p>É por isso que conduzimos um teste. De um conjunto de endereços /20, para um /24 e, a partir de junho de 2021, para um conjunto de endereços de 1 a /32, e equivalente a /128 (Ao1). Funcionou. E funcionou <em>muito</em> bem. O Ao1 elimina todas preocupações que possam surgir com a randomização. Por exemplo, serviços não TLS ou não HTTP têm um endereço de IP confiável (ou pelo menos um não aleatório e até que a política de nomenclatura seja alterada). Além disso, a união de conexões HTTP também falha por si só e, sim, vemos um nível maior de união quando Ao1 é usado.</p>
	<h3 id="mas-por-que-no-ipv6-onde-existem-tantos-endere-os"><strong>Mas por que no IPv6, onde existem tantos endereços?</strong></h3>
	<p>Um argumento contra a vinculação a um único endereço IPv6 é que isso não é necessário, porque é improvável que os endereços se esgotem. Este é um posicionamento pré-CIDR que acreditamos ser benigno na melhor das hipóteses e irresponsável na pior. Conforme mencionado anteriormente, o número de endereços IPv6 torna difícil o julgamento. Em vez de perguntar por que um único endereço IPv6 deve ser usado, devemos perguntar: "Por que não?".</p>
	<h3 id="existem-efeitos-upstream-sim-e-oportunidades-"><strong>Existem efeitos upstream? Sim, e oportunidades!</strong></h3>
	<p>O Ao1 revela um conjunto totalmente diferente de efeitos de randomização de IP, o que sem dúvida nos dá um vislumbre do futuro do roteamento e acessibilidade da Internet, amplificando os efeitos de atos aparentemente pequenos.</p>
	<p>Por quê? O número de nomes de comprimento variável possíveis no universo sempre será maior do que o número de endereços de comprimento fixo. Isso significa que, de acordo com o <a href="https://en.wikipedia.org/wiki/Pigeonhole_principle">princípio da casa dos pombos</a>, um único endereço de IP deve ser compartilhado por vários nomes e diferentes conteúdos de partes não relacionadas.</p>
	<p>Vale a pena falar sobre os possíveis efeitos upstream amplificados pelo Ao1, descritos abaixo. Até agora, no entanto, não encontramos nenhum desses problemas em nossas avaliações ou na comunicação com as redes upstream.</p>
	<ul>
		<li>Os erros de roteamento upstream são imediatos e totais. Se todo o tráfego chegar a um único endereço (ou prefixo), os erros de roteamento upstream afetarão todo o conteúdo igualmente. (Este é o motivo pelo qual a Cloudflare retorna dois endereços em intervalos de endereços não contíguos.) No entanto, o mesmo se aplica ao bloqueio de ameaças.</li>
		<li>Medidas de proteção contra DoS upstream podem ser acionadas. É concebível que a concentração de solicitações e tráfego em um único endereço upstream seja percebida como um ataque DoS e desencadeie as medidas de proteção que possam estar em vigor.</li>
	</ul>
	<p>Em ambos os casos, as medidas são mitigadas pela capacidade da Agilidade de Endereçamento de alterar endereços em massa e rapidamente. A prevenção também é possível, mas requer comunicação e discurso abertos.</p>
	<p>Um último efeito upstream permanece:</p>
	<ul>
		<li>O esgotamento de portas no IPv4 NAT pode ser acelerado e é resolvido pelo IPv6! Do lado do cliente, o número de conexões simultâneas permitidas para um endereço é limitado pelo tamanho do campo de porta do protocolo de transporte, por exemplo, cerca de 65 mil para TCP.</li>
	</ul>
	<p>Com o TCP no Linux, por exemplo, isso era um problema até recentemente. (Veja este <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=90c337da1524863838658078ec34241f45d8394d">commit</a> e SO_BIND_ADDRESS_NO_PORT na página de manual <a href="https://www.man7.org/linux/man-pages/man7/ip.7.html">ip(7) man page</a>.) O problema persiste com UDP. No QUIC, os identificadores de conexão podem evitar o esgotamento de portas, mas devem ser usados. No entanto, até agora não vimos qualquer indicação de que isso seja um problema.</p>
	<p>Mesmo assim — e esta é a melhor parte —, até onde sabemos, <em>esse é o único risco de usar um único endereço e a mudança para o IPv6 irá corrigi-lo imediatamente</em>. (Portanto, ISPs e administradores de rede, não se enganem e implementem o IPv6!)</p>
	<h2 id="estamos-s-come-ando-"><strong>Estamos só começando!</strong></h2>
	<p>E terminamos da mesma forma que começamos. O que <em>você</em> conseguiria desenvolver se não houvesse um limite máximo para o número de nomes em um único endereço de IP e existisse a capacidade de alterar o endereço por qualquer motivo mediante solicitação?</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/11/6.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>Na verdade, estamos apenas no começo! A flexibilidade e sustentabilidade possibilitadas pela Agilidade de Endereçamento nos dá a oportunidade de imaginar, projetar e construir novos sistemas e arquiteturas. Planejamos a detecção e mitigação de vazamento na rota BGP para sistemas Anycast, plataformas de medição e muito mais.</p>
	<p>Para saber mais detalhes técnicos sobre todos os itens acima, bem como agradecer todos que ajudaram a tornar isso possível, consulte este <a href="https://research.cloudflare.com/publications/Fayed2021">artigo</a> e uma breve <a href="https://youtu.be/zg6944L-B3M?t=2137">conversa</a>. Mesmo com essas novas possibilidades, os desafios permanecem. Existem muitas questões em aberto, incluindo, entre outros, o seguinte:</p>
	<ul>
		<li>Quais políticas podem ser formuladas ou implementadas com sensatez?</li>
		<li>Existe alguma sintaxe ou gramática abstrata que pode ser usada para expressá-las?</li>
		<li>Podemos usar métodos formais e verificação para prevenir políticas errôneas ou conflitantes?</li>
	</ul>
	<p>A Agilidade de Endereçamento é para todos e é necessária para que essas ideias tenham sucesso em uma escala mais ampla. Aguardamos sugestões e ideias em ask-research@cloudflare.com.</p>
	<p>Se você é um aluno matriculado em um programa de doutorado ou de pesquisa equivalente e está procurando um estágio nos <a href="https://boards.greenhouse.io/cloudflare/jobs/1976547?gh_jid=1976547">EUA ou no Canadá</a> ou na <a href="https://boards.greenhouse.io/cloudflare/jobs/2525989?gh_jid=2525989">UE ou no Reino Unido</a>.</p>
	<p>Se você tem interesse em contribuir com projetos como este ou ajudar a Cloudflare a desenvolver seus sistemas de gerenciamento de tráfego e endereços, <a href="https://boards.greenhouse.io/cloudflare/jobs/2428325">nossa equipe de Agilidade de Endereçamento está contratando novos funcionários</a>!</p>
</div>