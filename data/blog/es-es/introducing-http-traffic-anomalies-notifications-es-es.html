<div class="mb2 gray5">5 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/10/Traffic-anomalies-1.png" class="kg-image" alt="Introducing notifications for HTTP Traffic Anomalies" loading="lazy" width="2401" height="1350"></figure>
	<p>Cuando se trata de gestionar propiedades de Internet, lo que marca la diferencia entre una pequeña dificultad técnica y un incidente grave suele ser la rapidez. Las alertas proactivas desempeñan una función fundamental. Por este motivo, nos complace lanzar las <a href="https://www.google.com/url?q=https%3A%2F%2Fblog.cloudflare.com%2Fsmarter-origin-service-level-monitoring%2F&amp;sa=D&amp;source=docs&amp;ust=1698694388627308&amp;usg=AOvVaw1WK7Q5k0aSP-e4N0VwjL7v" target="_blank">notificaciones de tasa de error HTTP</a>, con las que los administradores pueden ver cuándo los usuarios finales obtienen errores.</p>
	<p>Sin embargo, ¿y si algunos problemas no se muestran como errores, por ejemplo, un pico o una caída repentina del tráfico?</p>
	<p>Hoy nos complace anunciar el lanzamiento de las notificaciones de anomalías de tráfico, disponibles para todos los clientes Enterprise. Estas notificaciones se activan cuando Cloudflare detecta cambios inesperados en el tráfico, y ofrecen otra valiosa perspectiva del estado de tus sistemas.</p>
	<p>Los cambios inesperados del tráfico pueden indicar muchas cosas. Si operas un sitio de comercio electrónico y observas un pico de tráfico, esto podría ser una buena noticia: quizás los clientes están acudiendo en masa a tu venda o simplemente se acaba de emitir un anuncio tuyo en un conocido programa televisivo. Sin embargo, también podría significar que algo va mal: quizás alguien ha desactivado accidentalmente una regla de firewall, y ahora ves más tráfico malicioso. En cualquier caso, posiblemente desearás saber que algo ha cambiado.</p>
	<p>De la misma forma, una caída repentida del tráfico podría significar muchas cosas. Quizás es viernes por la tarde y todos tus empleados están cerrando sus sesiones y han dejado de acceder al sitio web de la empresa. O quizás un enlace a tu sitio no funciona, y ahora los clientes potenciales no pueden acceder a él. Si hay poco tráfico, lo querrás saber lo antes posible a fin de investigar las causas, puesto que cada minuto que pase podría significar la pérdida de ingresos potenciales.</p>
	<h3 id="%C2%BFc%C3%B3mo-podemos-saber-cu%C3%A1ndo-enviar-una-alerta">¿Cómo podemos saber cuándo enviar una alerta?</h3>
	<p>Es difícil calcular bien las anomalías en conjuntos de datos de series temporales. El método más sencillo es mediante umbrales básicos. No obstante, como ya hemos <a href="https://blog.cloudflare.com/smarter-origin-service-level-monitoring">mencionado anteriormente en el blog</a>, los umbrales simples no son muy precisos para intentar determinar cuándo algo realmente falla. Existen demasiados casos límite para que funcionen con eficacia.</p>
	<p>Calcular las anomalías en los errores HTTP es relativamente fácil. Sabemos que, en general, debería haber un número muy pequeño de errores, por lo que cualquier pico es malo y por lo tanto motivo de alerta. Por esta razón, utilizamos <a href="https://sre.google/workbook/alerting-on-slos" target="_blank">objetivos de nivel de servicio (SLO)</a> para calcular las anomalías de nuestras <a href="https://developers.cloudflare.com/notifications/notification-available/#traffic-monitoring" target="_blank">notificaciones de tasa de error HTTP</a>.</p>
	<p>No obstante, el análisis del tráfico HTTP global es más similar al de los <a href="https://blog.cloudflare.com/introducing-thresholds-in-security-event-alerting-a-z-score-love-story">sucesos de seguridad de Cloudflare</a>: hay alguna línea base general de sucesos que se calcula a partir de las tendencias históricas. Cualquier desviación de esa línea base es motivo de alerta. A causa de estas similitudes, hemos decidido utilizar los mismos cálculos para las notificaciones de las anomalías de tráfico que los que hemos utilizado anteriormente para las notificaciones de los sucesos de seguridad: las <a href="https://blog.cloudflare.com/get-notified-when-your-site-is-under-attack">puntuaciones z</a>. Esto implica comparar el valor actual con la media a lo largo de un periodo de tiempo. La puntuación z indica a cuántas desviaciones estándar de la media está el valor actual.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image4-6.png" class="kg-image" alt="" loading="lazy" width="1292" height="898">
		<figcaption><em>Gráfico del tráfico HTTP en relación con las puntuaciones z. La línea azul es el tráfico HTTP, la morada es el límite de la puntuación z positiva del tráfico, y la verde es el límite de la puntuación z negativa del tráfico.</em></figcaption>
	</figure>
	<p>Para las notificaciones de las anomalías de tráfico, comparamos el tráfico de los últimos 5 minutos (la ventana corta) con la media del tráfico durante las últimas 4 horas (la ventana larga). Las puntuaciones z positivas indican un pico, y las puntuaciones z negativas indican una caída. Si el valor actual está a más de 3,5 desviaciones estándar de la media, enviamos una alerta. Realizamos la medición cada 5 minutos, por lo que podemos enviar cualquier alerta sobre picos o caídas del tráfico sin demora.</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image2-9.png" class="kg-image" alt="" loading="lazy" width="1375" height="125">
		<figcaption><em>El grupo verde es la ventana larga y el grupo rojo es la ventana corta.</em></figcaption>
	</figure>
	<p>Mientras que nuestras notificaciones de sucesos de seguridad solo se activan cuando hay un pico en los sucesos de seguridad (una caída es casi siempre una buena señal), en el caso de las anomalías de tráfico enviamos notificaciones para picos <em>y</em> para caídas. Esto se debe a que una caída del tráfico HTTP probablemente indica un problema, y un pico podría ser bueno o malo.</p>
	<p>Al igual que con los sucesos de seguridad, las anomalías de tráfico admiten los <a href="https://blog.cloudflare.com/introducing-thresholds-in-security-event-alerting-a-z-score-love-story">umbrales mínimos</a>. Esto significa que, incluso si determinamos que un suceso esta a más de las 3,5 desviaciones estándar, en el caso de que el número de sucesos no sea significativo, no enviamos ninguna alerta. Ya se trate de un pico o de una caída, estos deben representar al menos 200 solicitudes. Esto reduce el ruido de notificaciones, puesto que no enviamos alertas acerca de picos o caídas pequeños.</p>
	<h3 id="un-an%C3%A1lisis-m%C3%A1s-detallado">Un análisis más detallado</h3>
	<p>Cloudflare almacena la muestra de estadísticas de las solicitudes que atraviesan su red <a href="https://blog.cloudflare.com/http-analytics-for-6m-requests-per-second-using-clickhouse">en Clickhouse</a>. Cada minuto, tomamos el tráfico HTTP de Clickhouse y lo almacenamos en una instancia de VictoriaMetrics, una solución de almacenamiento de datos de series temporales. VictoriaMetrics nos proporciona de forma gratuita funciones algorítmicas listas para usar, y se ajusta a nuestro caso de uso. Elegimos VictoriaMetrics por diversas razones.</p>
	<p>En primer lugar, es fácil de configurar y operar. Como equipo, queremos optimizar la carga operativa, y VictoriaMetrics ha sido una gran ayuda hasta la fecha. En segundo lugar, VictoriaMetrics dispone de escalabilidad horizontal, lo que significa que podemos ejecutar esta solución en modo de alta disponibilidad. Para un sistema de este tipo, donde queremos una herramienta fiable para calcular información urgente para nuestros clientes, la alta disponibilidad es un requisito fundamental. Por último, en nuestras pruebas constatamos que VictoriaMetrics, para el mismo caso de uso, utilizaba aproximadamente una tercera parte de la memoria que Prometheus, un producto alternativo similar.</p>
	<p>Una vez que tenemos los datos en VictoriaMetrics, podemos ejecutar consultas en ellos y determinar si necesitamos enviar alertas a nuestros clientes, en función de las configuraciones de notificación que estos hayan creado previamente. Para ello, utilizamos nuestro sistema de notificación de alertas existente, <a href="https://blog.cloudflare.com/new-tools-to-monitor-your-server-and-avoid-downtime">acerca del que hablamos por primera vez en el blog en 2019</a>. Sabemos que podemos depender de nuestro sistema de notificación actual en la última milla para la entrega de estas notificaciones críticas a nuestros clientes.</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image1-9.png" class="kg-image" alt="" loading="lazy" width="1999" height="387">
		<figcaption><em>Flujo de datos de una solicitud HTTP a una notificación</em></figcaption>
	</figure>
	<h6 id="setting-up-the-notification"><em>Setting up the Notification </em></h6>
	<p>Para configurar esta notificación, ve a la pestaña "Notificaciones" del panel de control. Selecciona Anomalías de tráfico como tipo de notificación. Al igual que con todas las notificaciones de Cloudflare, puedes asignar un nombre y una descripción a tu notificación, y elegir cómo deseas recibirla.</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2023/10/image5-3.png" class="kg-image" alt="" loading="lazy" width="1999" height="482">
		<figcaption><em>Notificación de anomalías de tráfico en el panel de control</em></figcaption>
	</figure>
	<p>Puedes elegir en qué dominios deseas supervisar las anomalías de tráfico, si deseas incluir tráfico que ya mitigan los productos de DoS o WAF de Cloudflare, y si hay códigos de estado específicos que deseas incluir o excluir. También puedes seleccionar si deseas recibir alertas acerca de picos de tráfico, acerca de caídas del tráfico, o en ambos casos.</p>
	<p>Nos complace utilizar este sistema para entregar a nuestros clientes Enterprise valiosas notificaciones acerca del estado global de sus sistemas. Ve a la pestaña Notificaciones del panel de control para echar ahora un vistazo a esta nueva notificación.</p>
</div>