{
	"post": {
		"id": "5d16453b41acde0011a95531",
		"uuid": "f17d212e-9da8-43b7-961b-8afa4991ab9b",
		"title": "Setting Go variables from the outside",
		"slug": "setting-go-variables-at-compile-time",
		"html": "<!--kg-card-begin: markdown--><p>CloudFlare's DNS server, <a href=\"http://blog.cloudflare.com/tag/rrdns/\">RRDNS</a>, is written in Go and the DNS team used to generate a file called <code>version.go</code> in our Makefile. <code>version.go</code> looked something like this:</p>\n<pre><code class=\"language-go\">// THIS FILE IS AUTOGENERATED BY THE MAKEFILE. DO NOT EDIT.\n\n// +build\tmake\n\npackage version\n\nvar (\n\tVersion   = &quot;2015.6.2-6-gfd7e2d1-dev&quot;\n\tBuildTime = &quot;2015-06-16-0431 UTC&quot;\n)\n</code></pre>\n<p>and was used to embed version information in RRDNS. It was built inside the Makefile using <code>sed</code> and <code>git describe</code> from a template file. It worked, but was pretty ugly.</p>\n<p>Today we noticed that another Go team at CloudFlare, the <a href=\"http://blog.cloudflare.com/tag/data/\">Data</a> team, had <strong>a much smarter way to bake version numbers into binaries using the <code>-X</code> linker option</strong>.</p>\n<p>The <code>-X</code> <a href=\"https://golang.org/cmd/ld/\">Go linker option</a>, which you can set with <code>-ldflags</code>, sets the value of a string variable in the Go program being linked. You use it like this: <code>-X main.version 1.0.0</code>.</p>\n<p>A simple example: let's say you have this source file saved as <code>hello.go</code>.</p>\n<pre><code class=\"language-go\">package main\n\nimport &quot;fmt&quot;\n\nvar who = &quot;World&quot;\n\nfunc main() {\n    fmt.Printf(&quot;Hello, %s.\\n&quot;, who)\n}\n</code></pre>\n<p>Then you can use <code>go run</code> (or other build commands like <code>go build</code> or <code>go install</code>) with the <code>-ldflags</code> option to modify the value of the <code>who</code> variable:</p>\n<pre><code>$ go run hello.go\nHello, World.\n$ go run -ldflags=&quot;-X main.who CloudFlare&quot; hello.go\nHello, CloudFlare.\n</code></pre>\n<p>The format is <code>importpath.name string</code>, so it's possible to set the value of any string anywhere in the Go program, not just in main. Note that from Go 1.5 the syntax has <a href=\"https://tip.golang.org/cmd/link/\">changed</a> to <code>importpath.name=string</code>. The old style is still supported but the linker will complain.</p>\n<p>I was worried this would not work with external linking (<a href=\"https://docs.google.com/document/d/1nr-TQHw_er6GOQRsF6T43GGhFDelrAP0NqSS_00RgZQ/view\">for example when using cgo</a>) but as we can see with <code>-ldflags=&quot;-linkmode=external -v&quot;</code> the Go linker runs first anyway and takes care of our <code>-X</code>.</p>\n<pre><code>$ go build -x -ldflags=&quot;-X main.who CloudFlare -linkmode=external -v&quot; hello.go\nWORK=/var/folders/v8/xdj2snz51sg2m2bnpmwl_91c0000gn/T/go-build149644699\nmkdir -p $WORK/command-line-arguments/_obj/\ncd /Users/filippo/tmp/X\n/usr/local/Cellar/go/1.4.2/libexec/pkg/tool/darwin_amd64/6g -o $WORK/command-line-arguments.a -trimpath $WORK -p command-line-arguments -complete -D _/Users/filippo/tmp/X -I $WORK -pack ./hello.go\ncd .\n/usr/local/Cellar/go/1.4.2/libexec/pkg/tool/darwin_amd64/6l -o hello -L $WORK -X main.hi hi -linkmode=external -v -extld=clang $WORK/command-line-arguments.a\n# command-line-arguments\nHEADER = -H1 -T0x2000 -D0x0 -R0x1000\nsearching for runtime.a in $WORK/runtime.a\nsearching for runtime.a in /usr/local/Cellar/go/1.4.2/libexec/pkg/darwin_amd64/runtime.a\n 0.06 deadcode\n 0.07 pclntab=284969 bytes, funcdata total 49800 bytes\n 0.07 dodata\n 0.08 symsize = 0\n 0.08 symsize = 0\n 0.08 reloc\n 0.09 reloc\n 0.09 asmb\n 0.09 codeblk\n 0.09 datblk\n 0.09 dwarf\n 0.09 sym\n 0.09 headr\nhost link: clang -m64 -gdwarf-2 -Wl,-no_pie,-pagezero_size,4000000 -o hello -Qunused-arguments /var/folders/v8/xdj2snz51sg2m2bnpmwl_91c0000gn/T//go-link-mFNNCD/000000.o /var/folders/v8/xdj2snz51sg2m2bnpmwl_91c0000gn/T//go-link-mFNNCD/000001.o /var/folders/v8/xdj2snz51sg2m2bnpmwl_91c0000gn/T//go-link-mFNNCD/go.o -g -O2 -g -O2 -lpthread\n 0.17 cpu time\n33619 symbols\n64 sizeof adr\n216 sizeof prog\n23412 liveness data\n</code></pre>\n<p><em>Do you want to work next to Go developers that can always make you learn a new trick? <a href=\"https://www.cloudflare.com/join-our-team\">We are hiring in London, San Francisco and Singapore</a>.</em></p>\n<!--kg-card-end: markdown-->",
		"comment_id": "4680",
		"feature_image": null,
		"featured": false,
		"visibility": "public",
		"created_at": "2015-07-01T13:48:12.000+01:00",
		"updated_at": "2018-08-24T18:55:41.000+01:00",
		"published_at": "2015-07-01T14:26:37.000+01:00",
		"custom_excerpt": "CloudFlare's DNS server, RRDNS, is written in Go and the DNS team used to generate a file called version.go in our Makefile. version.go looked something like this.",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "5d1644b141acde0011a94f51",
				"name": "Filippo Valsorda",
				"slug": "filippo",
				"profile_image": "http://blog.cloudflare.com/content/images/2018/02/K6rX3ZSn_400x400.jpg",
				"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-26.png",
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": "@filosottile",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/filippo/"
			}
		],
		"tags": [
			{
				"id": "5d16450341acde0011a95161",
				"name": "RRDNS",
				"slug": "rrdns",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/rrdns/"
			},
			{
				"id": "5d16450341acde0011a95214",
				"name": "Programming",
				"slug": "programming",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/programming/"
			},
			{
				"id": "5d16450341acde0011a95215",
				"name": "Go",
				"slug": "go",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/go/"
			},
			{
				"id": "5d16450341acde0011a951ce",
				"name": "Reliability",
				"slug": "reliability",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/reliability/"
			}
		],
		"primary_author": {
			"id": "5d1644b141acde0011a94f51",
			"name": "Filippo Valsorda",
			"slug": "filippo",
			"profile_image": "http://blog.cloudflare.com/content/images/2018/02/K6rX3ZSn_400x400.jpg",
			"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-26.png",
			"bio": null,
			"website": null,
			"location": null,
			"facebook": null,
			"twitter": "@filosottile",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/filippo/"
		},
		"primary_tag": {
			"id": "5d16450341acde0011a95161",
			"name": "RRDNS",
			"slug": "rrdns",
			"description": null,
			"feature_image": null,
			"visibility": "public",
			"meta_title": null,
			"meta_description": null,
			"og_image": null,
			"og_title": null,
			"og_description": null,
			"twitter_image": null,
			"twitter_title": null,
			"twitter_description": null,
			"codeinjection_head": null,
			"codeinjection_foot": null,
			"canonical_url": null,
			"accent_color": null,
			"url": "http://blog.cloudflare.com/tag/rrdns/"
		},
		"url": "http://blog.cloudflare.com/setting-go-variables-at-compile-time/",
		"excerpt": "CloudFlare's DNS server, RRDNS, is written in Go and the DNS team used to generate a file called version.go in our Makefile. version.go looked something like this.",
		"reading_time": 2,
		"access": true,
		"comments": false,
		"og_image": null,
		"og_title": null,
		"og_description": null,
		"twitter_image": null,
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": null,
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	},
	"locale": "en-us"
}