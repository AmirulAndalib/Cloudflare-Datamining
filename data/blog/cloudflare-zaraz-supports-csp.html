<div class="mb2 gray5 ">5 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/03/image1-35.png" class="kg-image" alt="Cloudflare Zaraz supports CSP" loading="lazy"></figure>
	<p>Cloudflare Zaraz can be used to manage and load third-party tools <em>on the cloud</em>, achieving significant speed, privacy and security improvements. <a href="https://wiki.mozilla.org/index.php?title=Security%2FCSP%2FSpec&amp;oldid=133465">Content Security Policy (CSP)</a> configuration prevents malicious content from being run on your website.</p>
	<p>If you have Cloudflare Zaraz enabled on your website, you don’t have to ask yourself twice if you should enable CSP because there’s no harmful collision between CSP &amp; Cloudflare Zaraz.</p>
	<h3 id="why-would-cloudflare-zaraz-collide-with-csp">Why would Cloudflare Zaraz collide with CSP?</h3>
	<p>Cloudflare Zaraz, at its core, injects a &lt;script&gt; block on every page where it runs. If the website enforces CSP rules, the injected script can be automatically blocked if <em>inline </em>scripts are not allowed. To prevent this, at the moment of script injection, Cloudflare Zaraz adds<em> a nonce to the script-src policy</em> in order for everything to work smoothly.</p>
	<p>Cloudflare Zaraz supports CSP enabled by using both <em>Content-Security-Policy headers</em> or <em>Content-Security-Policy &lt;meta&gt; blocks.</em></p>
	<h2 id="what-is-csp">What is CSP?</h2>
	<p><a href="https://wiki.mozilla.org/index.php?title=Security%2FCSP%2FSpec&amp;oldid=133465">Content Security Policy (CSP)</a> is a security standard meant to protect websites from <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">Cross-site scripting (XSS)</a> or <a href="https://en.wikipedia.org/wiki/Clickjacking">Clickjacking</a> by providing the means to list approved origins for scripts, styles, images or other web resources.</p>
	<p>Although CSP is a reasonably mature technology with most modern browsers already implementing the standard, <a href="https://www.bitsight.com/blog/content-security-policy-limits-dangerous-activity-so-why-isnt-everyone-doing-it">less than 10% of websites</a> use this extra layer of security. <em>A Google study says that more than 90% of the websites using CSP are still </em><a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf"><em>leaving some doors open for attackers</em></a><em>.</em></p>
	<p>Why this low adoption and poor configuration? An <a href="https://wkr.io/publication/raid-2014-content_security_policy.pdf">early study on ‘why CSP adoption is failing’</a> says that the initial setup for a website is tedious and can generate errors, risking doing more harm for the business than an occasional XSS attack.</p>
	<p>We’re writing this to confirm that <strong>Cloudflare Zaraz will comply with your CSP settings</strong> without any other additional configuration from your side and <strong>to share some interesting findings </strong>from our research regarding how CSP works.</p>
	<h2 id="what-is-cloudflare-zaraz">What is Cloudflare Zaraz?</h2>
	<p>Cloudflare Zaraz aims to make the web faster by moving third-party script bloat away from the browser.</p>
	<p>There are tens of third-parties loaded by almost every website on the Internet (analytics, tracking, chatbots, banners, embeds, widgets etc.). Most of the time, the third parties have a slightly small role on a particular website compared to the high-volume and complex code they provide (for a good reason, because it’s meant to deal with all the issues that particular tool can tackle). This code, loaded a huge number of times on every website is simply <em>inefficient.</em></p>
	<p>Cloudflare Zaraz reduces the amount of code executed on the client side and the amount of time consumed by the client with anything that is not directly serving the user and their experience on the web.</p>
	<p>At the same time, Cloudflare Zaraz does the integration between website owners and third-parties by providing a common management interface with an easy ‘one-click’ method.</p>
	<h2 id="cloudflare-zaraz-csp">Cloudflare Zaraz &amp; CSP</h2>
	<p>When auto-inject is enabled, Cloudflare Zaraz ‘bootstraps’ on your website by running a small inline script that collects basic information from the browser (Screen Resolution, User-Agent, Referrer, page URL) and also provides the main <a href="https://developers.cloudflare.com/zaraz/web-api/zaraz-track">`track` function</a>. The `track` function allows you to <em>track</em> the actions your users are taking on your website, and other events that might happen in real time. Common user actions a website will probably be interested in tracking are <em>successful sign-ups, calls-to-action clicks, and purchases</em>.</p>
	<p><em>Before adding CSP support, Cloudflare Zaraz would’ve been blocked on any website that implemented CSP and didn’t include ‘unsafe-inline’ in the script-src policy or default-src policy. </em>Some of our users have signaled collisions between CSP and Cloudflare Zaraz so we decided to make peace with CSP once and forever.</p>
	<p><em>To solve the issue, when Cloudflare Zaraz is automatically injected on a website implementing CSP, it enhances the response header by appending a nonce value in the script-src policy. This way we make sure we’re not harming any security that was already enforced by the website owners, and we are still able to perform our duties - making the website faster and more secure by asynchronously running third parties on the server side instead of clogging the browser with irrelevant computation from the user’s point of view.</em></p>
	<h2 id="csp-edge-cases">CSP - Edge Cases</h2>
	<p>In the following paragraphs we’re describing some interesting CSP details we had to tackle to bring Cloudflare Zaraz to a trustworthy state. The following paragraphs assume that you already know what CSP is, and you know how <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP#examples_common_use_cases">a simple CSP configuration</a> looks like.</p>
	<h3 id="dealing-with-multiple-csp-headers-meta-elements">Dealing with multiple CSP headers/&lt;meta&gt; elements</h3>
	<p>The CSP standard allows multiple CSP headers but, on a first look, it’s slightly unclear how the multiple headers will be handled.</p>
	<p>You would think that the CSP rules will be somehow merged and the final CSP rule will be a combination of all of them but in reality the rule is much more simple - the most restrictive policy among all the headers will be applied. Relevant examples can be found in the <a href="https://www.w3.org/TR/CSP2/#enforcing-multiple-policies">w3c’s standard description</a> and in this <a href="https://chrisguitarguy.com/2019/07/05/working-with-multiple-content-security-policy-headers">multiple CSP headers example</a>.</p>
	<p>The rule of thumb is that “<em>A connection will be allowed only if all the CSP headers will allow it</em>”.</p>
	<p>In order to make sure that the Cloudflare Zaraz script is always running, <strong>we’re adding the nonce value to</strong> <strong>all the existing CSP headers and/or &lt;meta http-equiv=”Content-Security-Policy”&gt; blocks</strong>.</p>
	<h3 id="adding-a-nonce-to-a-csp-header-that-already-allows-unsafe-inline">Adding a nonce to a CSP header that already allows unsafe-inline</h3>
	<p>Just like when sending multiple CSP headers, when configuring one policy with multiple values, the most restrictive value has priority.</p>
	<p>An illustrative example for a given CSP header:</p>
	<p><em>Content-Security-Policy: default-src ‘self’; script-src ‘unsafe-inline’ ‘nonce-12345678’</em></p>
	<p>If ‘unsafe-inline’ is set in the script-src policy, adding <code>nonce-123456789</code> will disable the effect of <code>unsafe-inline</code> and will allow only the inline script that mentions that nonce value.</p>
	<p>This is a mistake we already made while trying to make Cloudflare Zaraz compliant with CSP. However, we solved it by adding the nonce only in the following situations:</p>
	<ul>
		<li>if ‘unsafe-inline’ is not already present in the header</li>
		<li>If ‘unsafe-inline’ is present in the header but next to it, a ‘nonce-...’ or ‘sha…’ value is already set (because in this situation ‘unsafe-inline’ is practically disabled)</li>
	</ul>
	<h3 id="adding-the-script-src-policy-if-it-doesn-t-exist-already">Adding the script-src policy if it doesn’t exist already</h3>
	<p>Another interesting case we had to tackle was handling a CSP header that didn't include the script-src policy, a policy that was relying only on the default-src values. In this case, we’re copying all the default-src values to a new script-src policy, and we’re appending the nonce associated with the Cloudflare Zaraz script to it(keeping in mind the previous point of course)</p>
	<h2 id="notes">Notes</h2>
	<p>Cloudflare Zaraz is still not 100% compliant with CSP because some tools still need to use <em>eval() </em>- usually for setting cookies, but we’re already working on a different approach so, stay tuned!</p>
	<p>The Content-Security-Policy-Report-Only header is not modified by Cloudflare Zaraz yet - you’ll be seeing error reports regarding the Cloudflare Zaraz &lt;script&gt; element if Cloudflare Zaraz is enabled on your website.</p>
	<p>Content-Security-Policy Report-Only can not be set using a &lt;meta&gt; element</p>
	<h2 id="conclusion">Conclusion</h2>
	<p>Cloudflare Zaraz supports the evolution of a more secure web by seamlessly complying with CSP.</p>
	<p>If you encounter any issue or potential edge-case that we didn’t cover in our approach, don’t hesitate to write on <a href="https://discord.gg/2TRr6nSxdd">Cloudflare Zaraz’s Discord Channel</a>, we’re always there fixing issues, listening to feedback and announcing exciting product updates.</p>
	<p>For more details on how Cloudflare Zaraz works and how to use it, check out the <a href="https://developers.cloudflare.com/zaraz">official documentation</a>.</p>
	<h3 id="resources-">Resources:</h3>
	<p>[1] <a href="https://wiki.mozilla.org/index.php?title=Security%2FCSP%2FSpec&amp;oldid=133465">https://wiki.mozilla.org/index.php?title=Security/CSP/Spec&amp;oldid=133465</a><br>[2] <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf">https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45542.pdf</a><br>[3] <a href="https://en.wikipedia.org/wiki/Content_Security_Policy">https://en.wikipedia.org/wiki/Content_Security_Policy</a><br>[4] <a href="https://www.w3.org/TR/CSP2/#enforcing-multiple-policies">https://www.w3.org/TR/CSP2/#enforcing-multiple-policies</a><br>[5] <a href="https://chrisguitarguy.com/2019/07/05/working-with-multiple-content-security-policy-headers">https://chrisguitarguy.com/2019/07/05/working-with-multiple-content-security-policy-headers/</a><br>[6]<a href="https://www.bitsight.com/blog/content-security-policy-limits-dangerous-activity-so-why-isnt-everyone-doing-it">https://www.bitsight.com/blog/content-security-policy-limits-dangerous-activity-so-why-isnt-everyone-doing-it</a><br>[7]<a href="https://wkr.io/publication/raid-2014-content_security_policy.pdf">https://wkr.io/publication/raid-2014-content_security_policy.pdf</a></p>
</div>