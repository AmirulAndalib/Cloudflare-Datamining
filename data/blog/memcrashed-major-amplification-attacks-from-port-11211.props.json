{
	"post": {
		"id": "5d16453b41acde0011a956bd",
		"uuid": "9ef7a900-d574-4b39-b58f-077ee23db5fc",
		"title": "Memcrashed - Major amplification attacks from UDP port 11211",
		"slug": "memcrashed-major-amplification-attacks-from-port-11211",
		"html": "<!--kg-card-begin: markdown--><p>Over last couple of days we've seen a big increase in an obscure amplification attack vector - using the <a href=\"https://github.com/memcached/memcached/blob/master/doc/protocol.txt\">memcached protocol</a>, coming from UDP port 11211.</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/3829936641_f112ed1665_b.jpg\" alt=\"3829936641_f112ed1665_b\" loading=\"lazy\"><small><a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC BY-SA 2.0</a> <a href=\"https://www.flickr.com/photos/trawin/3829936641/\">image</a> by <a href=\"https://www.flickr.com/photos/trawin/\">David Trawin</a></small><br>\nIn the past, we have talked a lot about amplification attacks happening on the internet. Our most recent two blog posts on this subject were:</p>\n<ul>\n<li><a href=\"http://blog.cloudflare.com/ssdp-100gbps/\">SSDP amplifications crossing 100Gbps</a>. Funnily enough, since then we were a target of an 196Gbps SSDP attack.</li>\n<li><a href=\"http://blog.cloudflare.com/reflections-on-reflections/\">General statistics about various amplification attacks we see</a>.</li>\n</ul>\n<p>The general idea behind all amplification attacks is the same. <a href=\"https://idea.popcount.org/2016-09-20-strange-loop---ip-spoofing/\">An IP-spoofing capable attacker</a> sends forged requests to a vulnerable UDP server. The UDP server, not knowing the request is forged, politely prepares the response. The problem happens when thousands of responses are delivered to an unsuspecting target host, overwhelming its resources - most typically the network itself.</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/spoofing-1.png\" alt=\"spoofing-1\" loading=\"lazy\"></p>\n<p>Amplification attacks are effective, because often the response packets are much larger than the request packets. A carefully prepared technique allows an attacker with limited IP spoofing capacity (such as 1Gbps) to launch very large attacks (reaching 100s Gbps) &quot;amplifying&quot; the attacker's bandwidth.</p>\n<h3 id=\"memcrashed\">Memcrashed</h3>\n<p>Obscure amplification attacks happen all the time. We often see &quot;chargen&quot; or &quot;call of duty&quot; packets hitting our servers.</p>\n<p>A discovery of a new amplification vector though, allowing very great amplification, happens rarely. This new memcached UDP DDoS is definitely in this category.</p>\n<p>The <a href=\"https://ddosmon.net/insight/\">DDosMon from Qihoo 360</a> monitors  amplification attack vectors and this chart shows recent memcached/11211 attacks:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/memcached-ddosmon.png\" alt=\"memcached-ddosmon\" loading=\"lazy\"></p>\n<p>The number of memcached attacks was relatively flat, until it started spiking just a couple days ago. Our charts also confirm this, here are attacks in packets per second over the last four days:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/memcached-pps.png\" alt=\"memcached-pps\" loading=\"lazy\"></p>\n<p>While the packets per second count is not that impressive, the bandwidth generated is:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/memcached-gpb.png\" alt=\"memcached-gpb\" loading=\"lazy\"></p>\n<p>At peak we've seen 260Gbps of inbound UDP memcached traffic. This is massive for a new amplification vector. But the numbers don't lie. It's possible because all the reflected packets are very large. This is how it looks in tcpdump:</p>\n<pre><code>$ tcpdump -n -t -r memcrashed.pcap udp and port 11211 -c 10\nIP 87.98.205.10.11211 &gt; 104.28.1.1.1635: UDP, length 13\nIP 87.98.244.20.11211 &gt; 104.28.1.1.41281: UDP, length 1400\nIP 87.98.244.20.11211 &gt; 104.28.1.1.41281: UDP, length 1400\nIP 188.138.125.254.11211 &gt; 104.28.1.1.41281: UDP, length 1400\nIP 188.138.125.254.11211 &gt; 104.28.1.1.41281: UDP, length 1400\nIP 188.138.125.254.11211 &gt; 104.28.1.1.41281: UDP, length 1400\nIP 188.138.125.254.11211 &gt; 104.28.1.1.41281: UDP, length 1400\nIP 188.138.125.254.11211 &gt; 104.28.1.1.41281: UDP, length 1400\nIP 5.196.85.159.11211 &gt; 104.28.1.1.1635: UDP, length 1400\nIP 46.31.44.199.11211 &gt; 104.28.1.1.6358: UDP, length 13\n</code></pre>\n<p>The majority of packets are 1400 bytes in size. Doing the math 23Mpps x 1400 bytes gives 257Gbps of bandwidth, exactly what the chart shows.</p>\n<h3 id=\"memcacheddoesudp\">Memcached does UDP?</h3>\n<p>I was surprised to learn that memcached does UDP, but there you go! The <a href=\"https://github.com/memcached/memcached/blob/master/doc/protocol.txt\">protocol specification</a> shows that it's one of <em>the best protocols to use for amplification ever</em>! There are absolutely zero checks, and the data <em>WILL</em> be delivered to the client, with blazing speed! Furthermore, the request can be tiny and the response huge (up to 1MB).</p>\n<p>Launching such an attack is easy. First the attacker implants a large payload on an exposed memcached server. Then, the attacker spoofs the &quot;get&quot; request message with target Source IP.</p>\n<p>Synthetic run with Tcpdump shows the traffic:</p>\n<pre><code>$ sudo tcpdump -ni eth0 port 11211 -t\nIP 172.16.170.135.39396 &gt; 192.168.2.1.11211: UDP, length 15\nIP 192.168.2.1.11211 &gt; 172.16.170.135.39396: UDP, length 1400\nIP 192.168.2.1.11211 &gt; 172.16.170.135.39396: UDP, length 1400\n...(repeated hundreds times)...\n</code></pre>\n<p>15 bytes of request triggered 134KB of response. This is amplification factor of 10,000x! In practice we've seen a 15 byte request result in a 750kB response (that's a 51,200x amplification).</p>\n<h3 id=\"sourceips\">Source IPs</h3>\n<p>The vulnerable memcached servers are all around the globe, with higher concentration in North America and Europe. Here is a map of the source IPs we've seen in each of our 120+ points of presence:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/memcached-map2.png\" alt=\"memcached-map2\" loading=\"lazy\"></p>\n<p>Interestingly our datacenters in EWR, HAM and HKG see disproportionally large numbers of attacking IPs. This is because most of the vulnerable servers are located in major hosting providers. The AS numbers of the IPs that we've seen:</p>\n<pre><code>┌─ips─┬─srcASN──┬─ASName───────────────────────────────────────┐\n│ 578 │ AS16276 │ OVH                                          │\n│ 468 │ AS14061 │ DIGITALOCEAN-ASN - DigitalOcean, LLC         │\n│ 231 │ AS7684  │ SAKURA-A SAKURA Internet Inc.                │\n│ 199 │ AS9370  │ SAKURA-B SAKURA Internet Inc.                │\n│ 165 │ AS12876 │ AS12876                                      │\n│ 119 │ AS9371  │ SAKURA-C SAKURA Internet Inc.                │\n│ 104 │ AS16509 │ AMAZON-02 - Amazon.com, Inc.                 │\n│ 102 │ AS24940 │ HETZNER-AS                                   │\n│  81 │ AS26496 │ AS-26496-GO-DADDY-COM-LLC - GoDaddy.com, LLC │\n│  74 │ AS36351 │ SOFTLAYER - SoftLayer Technologies Inc.      │\n│  65 │ AS20473 │ AS-CHOOPA - Choopa, LLC                      │\n│  49 │ AS49981 │ WORLDSTREAM                                  │\n│  48 │ AS51167 │ CONTABO                                      │\n│  48 │ AS33070 │ RMH-14 - Rackspace Hosting                   │\n│  45 │ AS19994 │ RACKSPACE - Rackspace Hosting                │\n│  44 │ AS60781 │ LEASEWEB-NL-AMS-01 Netherlands               │\n│  42 │ AS45899 │ VNPT-AS-VN VNPT Corp                         │\n│  41 │ AS2510  │ INFOWEB FUJITSU LIMITED                      │\n│  40 │ AS7506  │ INTERQ GMO Internet,Inc                      │\n│  35 │ AS62567 │ DIGITALOCEAN-ASN-NY2 - DigitalOcean, LLC     │\n│  31 │ AS8100  │ ASN-QUADRANET-GLOBAL - QuadraNet, Inc        │\n│  30 │ AS14618 │ AMAZON-AES - Amazon.com, Inc.                │\n│  30 │ AS31034 │ ARUBA-ASN                                    │\n└─────┴─────────┴──────────────────────────────────────────────┘\n</code></pre>\n<p>Most of the memcached servers we've seen were coming from AS16276 - OVH, AS14061 - Digital Ocean and AS7684 - Sakura.</p>\n<p>In total we've seen only 5,729 unique source IPs of memcached servers. We're expecting to see much larger attacks in future, as <a href=\"https://www.shodan.io\">Shodan</a> reports 88,000 open memcached servers:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/memcached-shodan.png\" alt=\"memcached-shodan\" loading=\"lazy\"></p>\n<h3 id=\"letsfixitup\">Let's fix it up</h3>\n<p>It's necessary to fix this and prevent further attacks. Here is a list of things that should be done.</p>\n<h4 id=\"memcachedusers\">Memcached Users</h4>\n<p>If you are using memcached, please disable UDP support if you are not using it. On memcached startup you can specify <code>--listen 127.0.0.1</code> to listen only to localhost and <code>-U 0</code> to disable UDP completely. <em>By default memcached listens on INADDR_ANY and runs with UDP support ENABLED</em>. Documentation:</p>\n<ul>\n<li><a href=\"https://github.com/memcached/memcached/wiki/ConfiguringServer#udp\">https://github.com/memcached/memcached/wiki/ConfiguringServer#udp</a></li>\n</ul>\n<p>You can easily test if your server is vulnerable by running:</p>\n<pre><code>$ echo -en &quot;\\x00\\x00\\x00\\x00\\x00\\x01\\x00\\x00stats\\r\\n&quot; | nc -q1 -u 127.0.0.1 11211\nSTAT pid 21357\nSTAT uptime 41557034\nSTAT time 1519734962\n...\n</code></pre>\n<p>If you see non-empty response (like the one above), your server is vulnerable.</p>\n<h4 id=\"systemadministrators\">System administrators</h4>\n<p>Please ensure that your memcached servers are firewalled from the internet! To test whether they can be accessed using UDP I recommend the <code>nc</code> example above, to verify if TCP is closed run <code>nmap</code>:</p>\n<pre><code>$ nmap TARGET -p 11211 -sU -sS --script memcached-info\nStarting Nmap 7.30 ( https://nmap.org ) at 2018-02-27 12:44 UTC\nNmap scan report for xxxx\nHost is up (0.011s latency).\nPORT      STATE         SERVICE\n11211/tcp open          memcache\n| memcached-info:\n|   Process ID           21357\n|   Uptime               41557524 seconds\n|   Server time          2018-02-27T12:44:12\n|   Architecture         64 bit\n|   Used CPU (user)      36235.480390\n|   Used CPU (system)    285883.194512\n|   Current connections  11\n|   Total connections    107986559\n|   Maximum connections  1024\n|   TCP Port             11211\n|   UDP Port             11211\n|_  Authentication       no\n11211/udp open|filtered memcache\n</code></pre>\n<h4 id=\"internetserviceproviders\">Internet Service Providers</h4>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/memcached-reflector.png\" alt=\"memcached-reflector\" loading=\"lazy\"></p>\n<p>In order to defeat such attacks in future, we need to fix vulnerable protocols and also IP spoofing. As long as IP spoofing is permissible on the internet, we'll be in trouble.</p>\n<p>Help us out by tracking who is behind these attacks. We must know not who has problematic memcached servers, but <em>who sent them queries in the first place</em>. We can't do this without your help!</p>\n<h4 id=\"developers\">Developers</h4>\n<p>Please please please: Stop using UDP. If you must, please don't enable it by default. If you do not know what an amplification attack is I hereby forbid you from ever typing <code>SOCK_DGRAM</code> into your editor.</p>\n<p>We've been down this road so many times. DNS, NTP, Chargen, SSDP and now memcached. If you use UDP, you must always respond with strictly a <em>smaller</em> packet size then the request. Otherwise your protocol will be abused. Also remember that people do forget to set up a firewall. Be a nice citizen. Don't invent a UDP-based protocol that lacks authentication of any kind.</p>\n<h3 id=\"thatsall\">That's all</h3>\n<p>It's anyone's guess how large the memcached attacks will become before we clean the vulnerable servers up. There were already rumors of 0.5Tbps amplifications in the last few days, and this is just a start.</p>\n<p>Finally, you are OK if you are a Cloudflare customer. Cloudflare's Anycast architecture works well to distribute the load in case of large amplification attacks, and unless your origin IP is exposed, you are safe behind Cloudflare.</p>\n<h3 id=\"prologue\">Prologue</h3>\n<p>A comment (below) points out that the possibility of using memcached for DDoS was discussed in a <a href=\"http://powerofcommunity.net/poc2017/shengbao.pdf\">2017 presentation</a>.</p>\n<p><strong>Update</strong><br>\nWe received a word from Digital Ocean, OVH, Linode and Amazon that they tackled the memcached problem, their networks should not be a vector in future attacks. Hurray!</p>\n<hr>\n<p><em>Dealing with DDoS attacks sound interesting? Join our <a href=\"https://boards.greenhouse.io/cloudflare/jobs/589572\">world famous team</a> in London, Austin, San Francisco and our elite office in Warsaw, Poland</em>.</p>\n<!--kg-card-end: markdown-->",
		"comment_id": "5a951f19668f4b0022d82b50",
		"feature_image": "http://blog.cloudflare.com/content/images/2018/02/3829936641_f112ed1665_b-1.jpg",
		"featured": false,
		"visibility": "public",
		"created_at": "2018-02-27T09:04:25.000+00:00",
		"updated_at": "2018-08-29T08:14:20.000+01:00",
		"published_at": "2018-02-27T14:38:35.000+00:00",
		"custom_excerpt": "Over last couple of days we've seen a big increase in an obscure amplification attack vector - using the memcached protocol, coming from UDP port 11211. In the past, we have talked a lot about amplification attacks happening on the internet. ",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "5d1644b141acde0011a94f30",
				"name": "Marek Majkowski",
				"slug": "marek-majkowski",
				"profile_image": "http://blog.cloudflare.com/content/images/2017/03/b5967d6c687939594adb6992723d0529.jpeg",
				"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-101.png",
				"bio": null,
				"website": null,
				"location": null,
				"facebook": null,
				"twitter": "@majek04",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/marek-majkowski/"
			}
		],
		"tags": [
			{
				"id": "5d16450341acde0011a951e3",
				"name": "DDoS",
				"slug": "ddos",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/ddos/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			},
			{
				"id": "5d16450341acde0011a951f4",
				"name": "Mitigation",
				"slug": "mitigation",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/mitigation/"
			},
			{
				"id": "5d16450341acde0011a951ce",
				"name": "Reliability",
				"slug": "reliability",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/reliability/"
			},
			{
				"id": "5d16450341acde0011a95169",
				"name": "Attacks",
				"slug": "attacks",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/attacks/"
			},
			{
				"id": "5d16450341acde0011a951aa",
				"name": "Vulnerabilities",
				"slug": "vulnerabilities",
				"description": "Vulnerabilities (EN)",
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/vulnerabilities/"
			}
		],
		"primary_author": {
			"id": "5d1644b141acde0011a94f30",
			"name": "Marek Majkowski",
			"slug": "marek-majkowski",
			"profile_image": "http://blog.cloudflare.com/content/images/2017/03/b5967d6c687939594adb6992723d0529.jpeg",
			"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-101.png",
			"bio": null,
			"website": null,
			"location": null,
			"facebook": null,
			"twitter": "@majek04",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/marek-majkowski/"
		},
		"primary_tag": {
			"id": "5d16450341acde0011a951e3",
			"name": "DDoS",
			"slug": "ddos",
			"description": null,
			"feature_image": null,
			"visibility": "public",
			"meta_title": null,
			"meta_description": null,
			"og_image": null,
			"og_title": null,
			"og_description": null,
			"twitter_image": null,
			"twitter_title": null,
			"twitter_description": null,
			"codeinjection_head": null,
			"codeinjection_foot": null,
			"canonical_url": null,
			"accent_color": null,
			"url": "http://blog.cloudflare.com/tag/ddos/"
		},
		"url": "http://blog.cloudflare.com/memcrashed-major-amplification-attacks-from-port-11211/",
		"excerpt": "Over last couple of days we've seen a big increase in an obscure amplification attack vector - using the memcached protocol, coming from UDP port 11211. In the past, we have talked a lot about amplification attacks happening on the internet. ",
		"reading_time": 7,
		"access": true,
		"comments": false,
		"og_image": null,
		"og_title": null,
		"og_description": null,
		"twitter_image": null,
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": null,
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	},
	"locale": "en-us"
}