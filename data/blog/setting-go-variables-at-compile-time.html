<div class="post-content lh-copy gray1">
	<!--kg-card-begin: markdown-->
	<p>CloudFlare's DNS server, <a href="https://blog.cloudflare.com/tag/rrdns/">RRDNS</a>, is written in Go and the DNS team used to generate a file called <code>version.go</code> in our Makefile. <code>version.go</code> looked something like this:</p>
	<pre><code class="language-go">// THIS FILE IS AUTOGENERATED BY THE MAKEFILE. DO NOT EDIT.

// +build	make

package version

var (
	Version   = "2015.6.2-6-gfd7e2d1-dev"
	BuildTime = "2015-06-16-0431 UTC"
)
</code></pre>
	<p>and was used to embed version information in RRDNS. It was built inside the Makefile using <code>sed</code> and <code>git describe</code> from a template file. It worked, but was pretty ugly.</p>
	<p>Today we noticed that another Go team at CloudFlare, the <a href="https://blog.cloudflare.com/tag/data/">Data</a> team, had <strong>a much smarter way to bake version numbers into binaries using the <code>-X</code> linker option</strong>.</p>
	<p>The <code>-X</code> <a href="https://golang.org/cmd/ld/" target="_blank">Go linker option</a>, which you can set with <code>-ldflags</code>, sets the value of a string variable in the Go program being linked. You use it like this: <code>-X main.version 1.0.0</code>.</p>
	<p>A simple example: let's say you have this source file saved as <code>hello.go</code>.</p>
	<pre><code class="language-go">package main

import "fmt"

var who = "World"

func main() {
    fmt.Printf("Hello, %s.\n", who)
}
</code></pre>
	<p>Then you can use <code>go run</code> (or other build commands like <code>go build</code> or <code>go install</code>) with the <code>-ldflags</code> option to modify the value of the <code>who</code> variable:</p>
	<pre><code>$ go run hello.go
Hello, World.
$ go run -ldflags="-X main.who CloudFlare" hello.go
Hello, CloudFlare.
</code></pre>
	<p>The format is <code>importpath.name string</code>, so it's possible to set the value of any string anywhere in the Go program, not just in main. Note that from Go 1.5 the syntax has <a href="https://tip.golang.org/cmd/link/" target="_blank">changed</a> to <code>importpath.name=string</code>. The old style is still supported but the linker will complain.</p>
	<p>I was worried this would not work with external linking (<a href="https://docs.google.com/document/d/1nr-TQHw_er6GOQRsF6T43GGhFDelrAP0NqSS_00RgZQ/view" target="_blank">for example when using cgo</a>) but as we can see with <code>-ldflags="-linkmode=external -v"</code> the Go linker runs first anyway and takes care of our <code>-X</code>.</p>
	<pre><code>$ go build -x -ldflags="-X main.who CloudFlare -linkmode=external -v" hello.go
WORK=/var/folders/v8/xdj2snz51sg2m2bnpmwl_91c0000gn/T/go-build149644699
mkdir -p $WORK/command-line-arguments/_obj/
cd /Users/filippo/tmp/X
/usr/local/Cellar/go/1.4.2/libexec/pkg/tool/darwin_amd64/6g -o $WORK/command-line-arguments.a -trimpath $WORK -p command-line-arguments -complete -D _/Users/filippo/tmp/X -I $WORK -pack ./hello.go
cd .
/usr/local/Cellar/go/1.4.2/libexec/pkg/tool/darwin_amd64/6l -o hello -L $WORK -X main.hi hi -linkmode=external -v -extld=clang $WORK/command-line-arguments.a
# command-line-arguments
HEADER = -H1 -T0x2000 -D0x0 -R0x1000
searching for runtime.a in $WORK/runtime.a
searching for runtime.a in /usr/local/Cellar/go/1.4.2/libexec/pkg/darwin_amd64/runtime.a
 0.06 deadcode
 0.07 pclntab=284969 bytes, funcdata total 49800 bytes
 0.07 dodata
 0.08 symsize = 0
 0.08 symsize = 0
 0.08 reloc
 0.09 reloc
 0.09 asmb
 0.09 codeblk
 0.09 datblk
 0.09 dwarf
 0.09 sym
 0.09 headr
host link: clang -m64 -gdwarf-2 -Wl,-no_pie,-pagezero_size,4000000 -o hello -Qunused-arguments /var/folders/v8/xdj2snz51sg2m2bnpmwl_91c0000gn/T//go-link-mFNNCD/000000.o /var/folders/v8/xdj2snz51sg2m2bnpmwl_91c0000gn/T//go-link-mFNNCD/000001.o /var/folders/v8/xdj2snz51sg2m2bnpmwl_91c0000gn/T//go-link-mFNNCD/go.o -g -O2 -g -O2 -lpthread
 0.17 cpu time
33619 symbols
64 sizeof adr
216 sizeof prog
23412 liveness data
</code></pre>
	<p><em>Do you want to work next to Go developers that can always make you learn a new trick? <a href="https://www.cloudflare.com/join-our-team" target="_blank">We are hiring in London, San Francisco and Singapore</a>.</em></p>
	<!--kg-card-end: markdown-->
</div>