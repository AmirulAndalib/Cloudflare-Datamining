{
	"locale": "en-us",
	"post": {
		"id": "62e7d815eb2757000a160d47",
		"uuid": "fd308148-fb48-4333-98ee-9ae73dedade0",
		"title": "Running Zig with WASI on Cloudflare Workers",
		"slug": "running-zig-with-wasi-on-cloudflare-workers",
		"html": "<!--kg-card-begin: markdown--><p><em><small>This post is also available in <a href=\"http://blog.cloudflare.com/zh-cn/running-zig-with-wasi-on-cloudflare-workers-zh-cn/\">简体中文</a> and <a href=\"http://blog.cloudflare.com/zh-tw/running-zig-with-wasi-on-cloudflare-workers-zh-tw/\">繁體中文</a>.</small></em></p>\n<!--kg-card-end: markdown--><figure class=\"kg-card kg-image-card\"><img src=\"http://blog.cloudflare.com/content/images/2022/08/image1-4.png\" class=\"kg-image\" alt=\"Running Zig with WASI on Cloudflare Workers\" loading=\"lazy\"></figure><p>After the recent announcement regarding <a href=\"http://blog.cloudflare.com/announcing-wasi-on-workers/\">WASI support in Workers</a>, I decided to see what it would take to get code written in <a href=\"https://ziglang.org/\">Zig</a> to run as a Worker, and it turned out to be trivial. This post documents the process I followed as a new user of Zig. It’s so exciting to see how Cloudflare Workers is a polyglot platform allowing you to write programs in the language you love, or the language you’re learning!</p><h3 id=\"hello-world-\">Hello, World!</h3><p>I’m not a Zig expert by any means, and to keep things entirely honest I’ve only just started looking into the language, but we all have to start somewhere. So, if my Zig code isn’t perfect please bear with me. My goal was to build a real, small program using Zig and deploy it on Cloudflare Workers. And to see how fast I can go from a blank screen to production code.</p><p>My goal for this wasn’t ambitious, just read some text from stdin and print it to stdout with line numbers, like running <code>cat -n</code>. But it does show just how easy the Workers paradigm is. This Zig program works identically on the command-line on my laptop and as an HTTP API deployed on Cloudflare Workers.</p><p>Here’s my code. It reads a line from stdin and outputs the same line prefixed with a line number. It terminates when there’s no more input.</p><!--kg-card-begin: markdown--><pre><code>const std = @import(&quot;std&quot;);\n\npub fn main() anyerror!void {\n\t// setup allocator\n\tvar gpa = std.heap.GeneralPurposeAllocator(.{}){};\n\tdefer std.debug.assert(!gpa.deinit());\n\tconst allocator = gpa.allocator();\n\n\t// setup streams\n\tconst stdout = std.io.getStdOut().writer();\n\tconst in = std.io.getStdIn();\n\tvar reader = std.io.bufferedReader(in.reader()).reader();\n\n\tvar counter: u32 = 1;\n\n\t// read input line by line\n\twhile (try reader.readUntilDelimiterOrEofAlloc(allocator, '\\n', std.math.maxInt(usize))) |line| {\n    \t    defer allocator.free(line);\n    \t    try stdout.print(&quot;{d}\\t{s}\\n&quot;, .{counter, line});\n    \t    counter = counter + 1;\n\t}\n}\n</code></pre>\n<!--kg-card-end: markdown--><p>To build Zig code, you create a <code>build.zig</code> file that defines how to build your project. For this trivial case I just opted to build an executable from the sources</p><!--kg-card-begin: markdown--><pre><code>const std = @import(&quot;std&quot;);\n\npub fn build(b: *std.build.Builder) void {\n\tconst target = b.standardTargetOptions(.{});\n\tconst mode = b.standardReleaseOptions();\n\n\tconst exe = b.addExecutable(&quot;print-with-line-numbers&quot;, &quot;src/main.zig&quot;);\n\texe.setTarget(target);\n\texe.setBuildMode(mode);\n\texe.install();\n}\n</code></pre>\n<!--kg-card-end: markdown--><p>By running <code>zig build</code> the compiler will run and output a binary under <code>zig-out/bin</code></p><!--kg-card-begin: markdown--><pre><code>$ zig build\n\n$ ls zig-out/bin\nprint-with-line-numbers\n\n$ echo &quot;Hello\\nWorld&quot; | ./zig-out/bin/print-with-line-numbers\n1    Hello\n2    World\n</code></pre>\n<!--kg-card-end: markdown--><h3 id=\"wasi\">WASI</h3><p>The next step is to get this running on Workers, but first I need to compile it into WASM with WASI support.</p><p>Thankfully, this comes out of the box with recent versions of Zig, so you can just tell the compiler to build your executable using the <code>wasm32-wasi</code> target, which will produce a file that can be run on any WASI-compatible WebAssembly runtime, such as <a href=\"https://wasmtime.dev/\">wasmtime</a>.</p><p>This same .wasm file can be run in wasmtime and deployed directly to Cloudflare Workers. This makes building, testing and deploying seamless.</p><!--kg-card-begin: markdown--><pre><code>$ zig build -Dtarget=wasm32-wasi\n\n$ ls zig-out/bin\nprint-with-line-numbers.wasm\n\n$ echo &quot;Hello\\nWorld&quot; | wasmtime ./zig-out/bin/print-with-line-numbers.wasm\n1    Hello\n2    World\n</code></pre>\n<!--kg-card-end: markdown--><h3 id=\"zig-on-workers\">Zig on Workers</h3><p>With our binary ready to go, the last piece is to get it running on Cloudflare Workers using <a href=\"http://blog.cloudflare.com/wrangler-v2-beta/\">wrangler2</a>. That is as simple as publishing the .wasm file on workers.dev. If you don’t have a <a href=\"https://workers.dev\">workers.dev</a> account, you can follow the tutorial on our <a href=\"https://developers.cloudflare.com/workers/get-started/guide/\">getting started guide </a>that will get you from code to deployment within minutes!</p><p>In fact, once I signed up for my account, all I needed to do was complete the first two steps, install wrangler and login.</p><!--kg-card-begin: markdown--><pre><code>$ npx wrangler@wasm login\nAttempting to login via OAuth...\nOpening a link in your default browser: https://dash.cloudflare.com/oauth2/auth\nSuccessfully logged in.\n</code></pre>\n<!--kg-card-end: markdown--><p>Then, I ran the following command to publish my worker:</p><!--kg-card-begin: markdown--><pre><code>$ npx wrangler@wasm publish --name print-with-line-numbers --compatibility-date=2022-07-07 zig-out/bin/print-with-line-numbers.wasm\nUploaded print-with-line-numbers (3.04 sec)\nPublished print-with-line-numbers (6.28 sec)\n  print-with-line-numbers.workers.dev\n</code></pre>\n<!--kg-card-end: markdown--><p>With that step completed, the worker is ready to run and can be invoked by calling the URL printed from the output above.</p><!--kg-card-begin: markdown--><pre><code>echo &quot;Hello\\nWorld&quot; | curl https://print-with-line-numbers.workers.dev -X POST --data-binary @-\n1    Hello\n2    World\n</code></pre>\n<!--kg-card-end: markdown--><p>Success!</p><h3 id=\"conclusion\">Conclusion</h3><p>What impressed me the most here was just how easy this process was.</p><p>First, I had a binary compiled for the architecture of my laptop, then I compiled the code into WebAssembly by just passing a flag to the compiler, and finally I had this running on workers <strong>without having to change any code.</strong></p><p>Granted, this program was not very complicated and does not do anything other than read from STDIN and write to STDOUT, but it gives me confidence of what is possible, especially as technology like WASI matures.<br><br><br></p>",
		"comment_id": "62e7d815eb2757000a160d47",
		"feature_image": "http://blog.cloudflare.com/content/images/2022/08/image1-5.png",
		"featured": false,
		"visibility": "public",
		"created_at": "2022-08-01T14:41:41.000+01:00",
		"updated_at": "2024-02-15T23:54:41.000+00:00",
		"published_at": "2022-08-01T15:12:26.000+01:00",
		"custom_excerpt": "After the recent announcement regarding WASI support in Workers I decided to see what it would take to get code written in Zig to run as a Worker, and it turned out to be pretty trivial. This post documents the process I followed",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"tags": [
			{
				"id": "62e7dafaeb2757000a160d55",
				"name": "#BLOG-1281",
				"slug": "hash-blog-1281",
				"description": null,
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			},
			{
				"id": "5d16450341acde0011a95253",
				"name": "Cloudflare Workers",
				"slug": "workers",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/workers/"
			},
			{
				"id": "5d16450341acde0011a95290",
				"name": "WebAssembly",
				"slug": "webassembly",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/webassembly/"
			},
			{
				"id": "5f69c072ef1e1403f1f04339",
				"name": "WASM",
				"slug": "wasm",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/wasm/"
			},
			{
				"id": "5d16450341acde0011a95283",
				"name": "#Lindered",
				"slug": "lindered",
				"description": "Posts featuring Kari Linder's awesome design work",
				"feature_image": null,
				"visibility": "internal",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/404/"
			},
			{
				"id": "5d16450341acde0011a95204",
				"name": "Developers",
				"slug": "developers",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Developers-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Developers",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Developers'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developers/"
			},
			{
				"id": "64a3e2b834124c000b00b717",
				"name": "Developer Platform",
				"slug": "developer-platform",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/developer-platform/"
			}
		],
		"authors": [
			{
				"id": "62e7da3feb2757000a160d4c",
				"name": "Daniel Harper",
				"slug": "daniel-harper",
				"profile_image": "http://blog.cloudflare.com/content/images/2022/08/me21.jpg",
				"cover_image": null,
				"bio": "Systems Engineer",
				"website": "https://djharper.dev",
				"location": "United Kingdom",
				"facebook": null,
				"twitter": null,
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/daniel-harper/"
			}
		],
		"primary_author": {
			"id": "62e7da3feb2757000a160d4c",
			"name": "Daniel Harper",
			"slug": "daniel-harper",
			"profile_image": "http://blog.cloudflare.com/content/images/2022/08/me21.jpg",
			"cover_image": null,
			"bio": "Systems Engineer",
			"website": "https://djharper.dev",
			"location": "United Kingdom",
			"facebook": null,
			"twitter": null,
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/daniel-harper/"
		},
		"primary_tag": null,
		"url": "http://blog.cloudflare.com/running-zig-with-wasi-on-cloudflare-workers/",
		"excerpt": "After the recent announcement regarding WASI support in Workers I decided to see what it would take to get code written in Zig to run as a Worker, and it turned out to be pretty trivial. This post documents the process I followed",
		"reading_time": 4,
		"access": true,
		"comments": false,
		"og_image": "http://blog.cloudflare.com/content/images/2022/08/Running-Zig-with-WASI-on-Cloudflare-Workers-OG-3.png",
		"og_title": null,
		"og_description": null,
		"twitter_image": "http://blog.cloudflare.com/content/images/2022/08/Running-Zig-with-WASI-on-Cloudflare-Workers-OG-2.png",
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": "After the recent announcement regarding WASI support in Workers I decided to see what it would take to get code written in Zig to run as a Worker, and it turned out to be pretty trivial. This post documents the process I followed",
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	}
}