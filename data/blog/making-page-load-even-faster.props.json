{
	"locale": "en-us",
	"post": {
		"id": "5d16453b41acde0011a95694",
		"uuid": "9f8c530d-926f-4576-825a-28044b7edcff",
		"title": "How we made our page-load optimisations even faster",
		"slug": "making-page-load-even-faster",
		"html": "<!--kg-card-begin: markdown--><p>In 2017 we made two of our web optimisation products - <a href=\"https://www.cloudflare.com/website-optimization/mirage/\">Mirage</a> and <a href=\"https://vimeo.com/24900882\">Rocket Loader</a> - even faster! Combined, these products speed up around 1.2 billion web-pages a week. The products are both around 5 years old, so there was a big opportunity to update them for the brave new world of highly-tuned browsers, HTTP2 and modern Javascript tooling. We measured a performance boost that, <a href=\"#savings\">very roughly</a>, will save visitors to sites on our network between 50-700ms. Visitors that see content faster have much higher engagement and lower bounce rates, as shown by studies like <a href=\"https://www.doubleclickbygoogle.com/articles/mobile-speed-matters/\">Google’s</a>. This really adds up, representing a further saving of 380 years of loading time each year and a staggering 1.03 petabytes of data transfer!</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/dimon-blr-309444.jpg\" alt=\"dimon-blr-309444\" loading=\"lazy\"><br>\n<small>Cycling image Photo by <a href=\"https://unsplash.com/photos/mdgMbYfFlSA\">Dimon Blr on Unsplash</a>.</small></p>\n<h3 id=\"whatmirageandrocketloaderdo\">What Mirage and Rocket Loader do</h3>\n<p>Mirage and Rocket Loader both optimise the loading of a web page by reducing and deferring the number of assets the browser needs to request for it to complete HTML parsing and rendering on screen.</p>\n<h4 id=\"mirage\">Mirage</h4>\n<style>\n.has_images {\n    overflow: auto;\n}\n\n@media (min-width: 600px) {\n    .has_images p {\n        float: left; width: 50%;\n    }\n    .has_images img {\n        float: right; margin: 1em; width: 40%\n    }\n}\n</style>\n<div class=has_images>\n<p>With Mirage, users on slow mobile connections will be quickly shown a full page of content, using placeholder images with a low file-size which will load much faster. Without Mirage visitors on a slow mobile connection will have to wait a long time to download high-quality images. Since it’ll take a long time, they will perceive your website as slow:</p>\n<img alt=\"Mirage---before\" src=\"http://blog.cloudflare.com/content/images/2018/02/Mirage---before-1.svg\" />\n</div>\n<p><br><br></p>\n<div class=has_images>\n<p>With Mirage visitors will see content much faster, will thus perceive that the content is loading quickly, and will be less likely to give up:</p></p>\n<img alt=\"mirage-after\" src=\"http://blog.cloudflare.com/content/images/2018/02/mirage-after-1.svg\"  />\n</div>\n<h4 id=\"rocketloader\">Rocket Loader</h4>\n<div class=has_images>\n<p>Browsers will not show content that until all the Javascript that might affect it has been loaded and run. This can mean users wait a significant time before seeing any content at all, even if that content is the only reason they’re on visiting the page!</p>\n<img alt=\"Rocket-before\" src=\"http://blog.cloudflare.com/content/images/2018/02/Rocket-before.svg\"  />\n</div>\n<div class=has_images>\n<p>Rocket Loader transparently defers all Javascript execution until the rest of the page has loaded. This allows the browser to display the content the visitors are interested in as soon as possible.</p>\n<img alt=\"Rocket-after\" src=\"http://blog.cloudflare.com/content/images/2018/02/Rocket-after.svg\"  />\n</div>\n<h3 id=\"howtheywork\">How they work</h3>\n<p>Both of these products  involve a two step process: first our optimizing proxy-server will rewrite customers’ HTML as it’s delivered, and then our on-page Javascript will attempt to optimise aspects of the page load. For instance, Mirage's server-side rewrites image tags as follows:</p>\n<pre><code>&lt;!-- before --&gt;\n&lt;img src=&quot;/some-image.png&quot;&gt;\n\n&lt;!-- after --&gt;\n&lt;img data-cfsrc=&quot;/some-image.png&quot; style=&quot;display:none;visibility:hidden;&quot;&gt;\n</code></pre>\n<p>Since browsers don't recognise <code>data-cfsrc</code>, the Mirage Javascript can control the whole process of loading these images. It uses this opportunity to intelligently load placeholder images on slow connections.</p>\n<p>Rocket Loader uses a similar approach to de-prioritise Javascript during page load, allowing the browser to show visitors the content of the page sooner.</p>\n<h3 id=\"theproblems\">The problems</h3>\n<p>The Javascript for both products was written years ago, when <a href=\"https://github.com/rollup/rollup\">‘rollup’</a> brought to mind a poor lifestyle choice rather than an excellent build-tool. With the big changes we’ve seen in browsers, protocols, and JS, there were many opportunities to optimise.</p>\n<h4 id=\"dynamicallyslowingthingsdown\">Dynamically... slowing things down</h4>\n<p>Designed for the ecosystem of the time, both products were loaded by Cloudflare’s <a href=\"https://github.com/amdjs/amdjs-api/wiki/AMD\">asynchronous-module-definition</a> (AMD) loader, called CloudflareJS, which also bundled some shared libraries.</p>\n<p>This meant the process of loading Mirage or Rocket Loader looked like:</p>\n<ol>\n<li>CFJS inserted in blocking script tag by server-side rewriter</li>\n<li>CFJS runs, and looks at some on-page config to decide at runtime whether to load Rocket/Mirage via AMD, inserting new script tags</li>\n<li>Rocket/Mirage are loaded and run</li>\n</ol>\n<h4 id=\"fightingbrowsers\">Fighting browsers</h4>\n<p>Dynamic loading meant the products could not benefit from optimisations present in modern browsers. Browsers now scan HTML as they receive it instead of waiting for it all to arrive, identifying and loading external resources like script tags as quickly as possible. This process is called <a href=\"https://andydavies.me/blog/2013/10/22/how-the-browser-pre-loader-makes-pages-load-faster/\">preload scanning</a>, and is one of the most important optimisations performed by the brower. Since we used dynamic code inside CFJS to load Mirage and Rocket Loader, we were preventing them from benefitting from the preload scanner.</p>\n<p>To make matters worse, Rocket Loader was being dynamically inserted using that villain of the DOM API, <code>document.write</code> - a technique that creates huge performance problems. Understanding exactly why is involved, so I’ve created a diagram. Skim it, and refer back to it as you read the next paragraph:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/Old-version.svg\" alt=\"Old-version\" loading=\"lazy\"></p>\n<p>As said, using <code>document.write</code> to insert scripts is be particularly damaging to page load performance. Since the <code>document.write</code> that inserts the script is invisible to the preload scanner (even if the script is inline, which ours isn’t, preload scanning <a href=\"https://bugs.chromium.org/p/chromium/issues/detail?id=575850\">doesn’t</a> even attempt to scan JS), at the instant it is inserted the browser will already be busy requesting resources the scanner found elsewhere in the page (other script tags, images etc). This matters because a browser encountering a non-deferred or asynchronous Javascript, like Rocket Loader, must block all further building of the DOM tree until that script is loaded and executed, to give the script a chance to modify the DOM. So Rocket Loader was being inserted at an instant in which it was going to be very slow to load, due to the backlog of requests from the preload scan, and therefore causes a very long delay until the DOM parser can resume!</p>\n<p>Aside from this grave performance issue, it became more urgent to remove <code>document.write</code> when <a href=\"https://www.chromestatus.com/feature/5718547946799104\">Chrome began to intervene against it in version 55</a> triggering a <a href=\"https://github.com/WICG/interventions/issues/17\">very interesting discussion</a>. This intervention would sometimes prevent Rocket Loader from being inserted on slow 2G connections, stopping any other Javascript from loading at all!</p>\n<p>Clearly, <code>document.write</code> needed to be extirpated!</p>\n<h4 id=\"unusedandovergeneralcode\">Unused and over-general code</h4>\n<p>CFJS was authored as a shared library for Cloudflare client-side code, including the original Cloudflare app store. This meant it had quite a large set of APIs. Although both Mirage and Rocket Loader depended on some of them, the overlap was actually small. Since we've launched the new, shiny <a href=\"http://blog.cloudflare.com/cloudflare-apps-2/\">Cloudflare Apps</a>, CFJS had no other important products dependant upon it.</p>\n<h3 id=\"aplanofaction\">A plan of action</h3>\n<p>Before joining Cloudflare in July this year, I had been working in TypeScript, a language with all the lovely new syntax of modern Javascript. Taking over multiple AMD, ES5-based projects using Gulp and Grunt was a bit of a shock. I really thought I'd written my last <code>define(['writing', 'very-bug'], function(twice, prone) {})</code>, but here I was in 2017 seeing it again!</p>\n<p>So it was very tempting to do a big-bang rewrite and get back to playing with the new ECMAScript 2018 toys. However, I’ve been involved in enough rewrites to know they’re <a href=\"https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i/\">very rarely justified</a>, and instead identified the highest priority changes we’d need to improve performance (though I admit I wrote a few <code>git checkout -b typescript-version</code> branches to vent).</p>\n<p>So, the plan was:</p>\n<ol>\n<li>identify and inline the parts of CFJS used by Mirage and Rocket Loader</li>\n<li>produce a new version of the other dependencies of CFJS (our <a href=\"https://www.cloudflare.com/logo\">logo badge widget</a> is actually hardcoded to point at CloudflareJS)</li>\n<li>switch from AMD to Rollup (and thus ECMAScript import syntax)</li>\n</ol>\n<p>The decision to avoid making a new shared library may be surprising, especially as tree-shaking avoids some of the code-size overhead from unused parts of our dependencies. However, a little duplication seemed the lesser evil compared to cross-project dependencies given that:</p>\n<ul>\n<li>the overlap in code used was small</li>\n<li>over-general, library-style functions were part of why CFJS became too big in the first place</li>\n<li>Rocket Loader has some exciting things in its future...</li>\n</ul>\n<p>Sweating kilobytes out of the minified + Gzipped Javascript files is be a waste of time for most applications. However, in the context of code that'll be run literally millions of times in the time you read this article, it really pays off. This is a process we’ll be continuing in 2018.</p>\n<h4 id=\"switchingoutamd\">Switching out AMD</h4>\n<p>Switching out Gulp, Grunt and AMD was a fairly mechanical process of replacing syntax like this:</p>\n<pre><code>define(['cloudflare/iterator', 'cloudflare/dom'], function(iterator, dom) {\n    // ...\n    return {\n        Mirage: Mirage,\n    };\n})\n</code></pre>\n<p>with ECMAScript modules, ready for Rollup, like:</p>\n<pre><code>import * as iterator from './iterator';\nimport { isHighLatency } from './connection';\n\n// ...\n\nexport { Mirage }\n</code></pre>\n<h4 id=\"postrefactorweighin\">Post refactor weigh-in</h4>\n<p>Once the parts of CFJS used by the projects were inlined into the projects, we ended up with both Rocket and Mirage being slightly <a href=\"#badge\">larger</a> (all numbers minified + GZipped):</p>\n<script src=\"https://cdn.plot.ly/plotly-latest.min.js\"></script>\n<div id=sizeChart></div>\n<script>\n(function() {\nvar x = ['Mirage old', 'Mirage new', 'Rocket Loader old', 'Rocket Loader new'];\nvar trace1 = {\n  x: x,\n  y: [8019,13029,25151,31621],\n  name: 'Main file',\n  type: 'bar'\n};\nvar trace2 = {\n  x: x,\n  y: [21572,0,21572,0],\n  name: 'Additional dependencies',\n  type: 'bar'\n};\nvar data = [trace1, trace2];\nvar layout = {barmode: 'stack',plot_bgcolor: 'transparent', paper_bgcolor: 'transparent'}; \nPlotly.newPlot('sizeChart', data, layout); \n})();\n</script>\n<p>So we made a significant file-size saving (about <a href=\"https://mathiasbynens.be/demo/jquery-size\">half a jQuery’s worth</a>) vs the original file-size required to completely load either product.</p>\n<h4 id=\"newinsertionflow\">New insertion flow</h4>\n<p>Before, our original insertion flow looked something like this:</p>\n<pre><code>// on page embed, injected into customers' pages\n&lt;script&gt;\n  var cloudflare = { rocket: true, mirage: true };\n&lt;/script&gt;\n&lt;script src=&quot;/cloudflare.min.js&quot;&gt;&lt;/script&gt;\n</code></pre>\n<p>Inside cloudflare.min.js we found the dynamic code that, once run, would kick off the requests for Mirage and Rocket Loader:</p>\n<pre><code>// cloudflare.min.js\nif(cloudflare.rocket) {\n    require(“cloudflare/rocket”);\n}\n</code></pre>\n<p>Our approach is now far more browser friendly, roughly:</p>\n<pre><code>// on page embed\n&lt;script&gt;\n  var cloudflare = { /* some config */ }\n&lt;/script&gt;\n&lt;script src=&quot;/mirage.min.js&quot;&gt;&lt;/script&gt;\n&lt;script src=&quot;/rocket.min.js&quot;&gt;&lt;/script&gt;\n</code></pre>\n<p>If you compare the new insertion sequence diagram, you can see why this is so much better:</p>\n<p><img src=\"http://blog.cloudflare.com/content/images/2018/02/New-Version.svg\" alt=\"New-Version\" loading=\"lazy\"></p>\n<h3 id=\"measurement\">Measurement</h3>\n<p>Theory implied our smaller, browser-friendly strategy should be faster, but only by doing some good old empirical research would we know <a href=\"#hume\">for sure</a>.</p>\n<p>To measure the results, I set up a representative test page (including Bootstrap, custom fonts, some images, text) and calculated the change in the average <a href=\"https://developers.google.com/web/tools/lighthouse\">Lighthouse</a> performance scores out of 100 over a number of runs. The metrics I focussed on were:</p>\n<ol>\n<li>Time till first meaningful paint (TTFMP) - FMP is when we first see some useful content, e.g. images and text</li>\n<li>Overall - this is Lighthouse's aggregate score for a page - the closer to 100, the better</li>\n</ol>\n<div id=lighthouse></div>\n<script>\n(function() {\nvar x = ['Mirage','Rocket Loader'];\nvar trace1 = {\n  x: x,\n  y: [93.4,86.6],\n  marker: {color: '#F8B168'},\n  name: 'Lighthouse score, old',\n  type: 'bar'\n};\nvar trace2 = {\n  x: x,\n  y: [93.4,92.9],\n    marker: {color: '#FF7900'},\n  name: 'Lighthouse score, new',\n  type: 'bar'\n};\nvar trace3 = {\n  x: x,\n  y: [88,72.2],\n      marker: {color: '#2F7BBF'},\n  name: 'Lightscore FMP score, old',\n  type: 'bar'\n};\nvar trace4 = {\n  x: x,\n  y: [89,86.8],\n        marker: {color: '#63A1D7'},\n  name: 'Lightscore FMP score, new',\n  type: 'bar'\n};\nvar data = [trace1, trace2, trace3, trace4];\nvar layout = {barmode: 'group',plot_bgcolor: 'transparent', paper_bgcolor: 'transparent',title:'Observed average Lighthouse scores (max 100) for FMP, and overall performance'}; \nPlotly.newPlot('lighthouse', data, layout);\n})();\n</script>\n<div id=ttfmp_chart></div>\n<script>\n(function() {  \nvar x = ['Mirage','Rocket Loader'];\nvar trace1 = {\n  x: x,\n  y: [2195.3,2959.5],\n  name: 'Old version, TTFMP ms',\n  type: 'bar'\n};\nvar trace2 = {\n  x: x,\n  y: [2146.3,2265.5],\n  name: 'New version, TTFMP ms',\n  type: 'bar'\n};\nvar data = [trace1, trace2];\nvar layout = {barmode: 'group',plot_bgcolor: 'transparent', paper_bgcolor: 'transparent',title:'Observed average TTFMP in ms'}; \nPlotly.newPlot('ttfmp_chart', data, layout);\n})();\n</script>\n<h4 id=\"assessment\">Assessment</h4>\n<p>So, improved metrics across the board! We can see the changes have resulted in solid improvements, e.g a reduction in our average time till first meaningful paint of 694ms for Rocket, and 49ms for Mirage.</p>\n<h3 id=\"conclusion\">Conclusion</h3>\n<p>The optimisations to Mirage and Rocket Loader have resulted in less bandwidth use, and measurably better performance for visitors to Cloudflare optimised sites.</p>\n<br />\n<br />\n<br />\n<h4 id=\"footnotes\">Footnotes</h4>\n<style>\n    a:not([href]) {\n      text-decoration: inherit !important;\n      color: inherit !important;\n    }\n</style>\n<ol>\n<li><a id=savings>The</a> following are back-of-the-envelope calculations. Mirage gets 980 million requests a week, TTFMP reduction of 50ms. There are 1000 ms in a second * 60 seconds * 60 minutes * 24 hours * 365 days = 31.5 billion milliseconds in a year. So (980e6 * 50 * 52) / 31.5e9  = in aggregate, 81 years less waiting for first-paint. Rocket gets 270 million requests a week, average TTFMP reduction of 694ms, (270e6 * 694 * 52) / 31.5e9 = in aggregate, 301 years less waiting for first-meaningful-paint. Similarly 980 million savings of 16kb per week for Mirage = 817.60 terabytes per year and 270 million savings of 15.2kb per week for Rocket Loader = 213.79 terabytes per year for a combined total of 1031 terabytes or 1.031 petabytes.</li>\n<li><a id=badge>and</a> a tiny 1.5KB file for our <a href=\"https://www.cloudflare.com/logo\">web badge</a> - written in TypeScript ? - which previously was loaded on top of the 21.6KB CFJS</li>\n<li><a id=hume></a><a href=\"https://plato.stanford.edu/entries/induction-problem/\">shut it Hume</a></li>\n<li>Thanks to Peter Belesis for doing the initial work of identifying which products depended upon CloudflareJS, and Peter, Matthew Cottingham, Andrew Galloni, Henry Heinemann, Simon Moore and Ivan Nikulin for their wise counsel on this blog post.</li>\n</ol>\n<!--kg-card-end: markdown-->",
		"comment_id": "5113",
		"feature_image": "http://blog.cloudflare.com/content/images/2018/02/dimon-blr-309444-1.jpg",
		"featured": false,
		"visibility": "public",
		"created_at": "2017-12-19T16:33:42.000+00:00",
		"updated_at": "2019-06-29T22:07:05.000+01:00",
		"published_at": "2018-02-02T16:41:00.000+00:00",
		"custom_excerpt": "We improved the Lighthouse and time-to-first-meaningful-paint scores of two of our web optimisation products: Mirage and Rocket Loader! Combined, these products speed up around 1.2 billion web-pages a week.",
		"codeinjection_head": null,
		"codeinjection_foot": null,
		"custom_template": null,
		"canonical_url": null,
		"authors": [
			{
				"id": "5d1644b141acde0011a94fb0",
				"name": "Tim Ruffles",
				"slug": "tim",
				"profile_image": "http://blog.cloudflare.com/content/images/2022/08/Screen-Shot-2022-08-18-at-11.51.06-AM.png",
				"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-59.png",
				"bio": null,
				"website": "http://truffles.me.uk",
				"location": null,
				"facebook": null,
				"twitter": "@timruffles",
				"meta_title": null,
				"meta_description": null,
				"url": "http://blog.cloudflare.com/author/tim/"
			}
		],
		"tags": [
			{
				"id": "5d16450341acde0011a95149",
				"name": "Mirage",
				"slug": "mirage",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/mirage/"
			},
			{
				"id": "5d16450341acde0011a95170",
				"name": "Rocket Loader",
				"slug": "rocketloader",
				"description": null,
				"feature_image": null,
				"visibility": "public",
				"meta_title": null,
				"meta_description": null,
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/rocketloader/"
			},
			{
				"id": "5d16450341acde0011a95160",
				"name": "Speed & Reliability",
				"slug": "speed-and-reliability",
				"description": null,
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Speed---Reliability-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Speed & Reliability",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Speed & Reliability'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/speed-and-reliability/"
			},
			{
				"id": "5d16450341acde0011a951ee",
				"name": "Product News",
				"slug": "product-news",
				"description": "Product News (EN)",
				"feature_image": "http://blog.cloudflare.com/content/images/2020/10/Product-News-1.png",
				"visibility": "public",
				"meta_title": "Cloudflare Blog: Product News",
				"meta_description": "Collection of Cloudflare blog posts tagged 'Product News'.",
				"og_image": null,
				"og_title": null,
				"og_description": null,
				"twitter_image": null,
				"twitter_title": null,
				"twitter_description": null,
				"codeinjection_head": null,
				"codeinjection_foot": null,
				"canonical_url": null,
				"accent_color": null,
				"url": "http://blog.cloudflare.com/tag/product-news/"
			}
		],
		"primary_author": {
			"id": "5d1644b141acde0011a94fb0",
			"name": "Tim Ruffles",
			"slug": "tim",
			"profile_image": "http://blog.cloudflare.com/content/images/2022/08/Screen-Shot-2022-08-18-at-11.51.06-AM.png",
			"cover_image": "http://blog.cloudflare.com/content/images/2018/08/general@2x-59.png",
			"bio": null,
			"website": "http://truffles.me.uk",
			"location": null,
			"facebook": null,
			"twitter": "@timruffles",
			"meta_title": null,
			"meta_description": null,
			"url": "http://blog.cloudflare.com/author/tim/"
		},
		"primary_tag": {
			"id": "5d16450341acde0011a95149",
			"name": "Mirage",
			"slug": "mirage",
			"description": null,
			"feature_image": null,
			"visibility": "public",
			"meta_title": null,
			"meta_description": null,
			"og_image": null,
			"og_title": null,
			"og_description": null,
			"twitter_image": null,
			"twitter_title": null,
			"twitter_description": null,
			"codeinjection_head": null,
			"codeinjection_foot": null,
			"canonical_url": null,
			"accent_color": null,
			"url": "http://blog.cloudflare.com/tag/mirage/"
		},
		"url": "http://blog.cloudflare.com/making-page-load-even-faster/",
		"excerpt": "We improved the Lighthouse and time-to-first-meaningful-paint scores of two of our web optimisation products: Mirage and Rocket Loader! Combined, these products speed up around 1.2 billion web-pages a week.",
		"reading_time": 9,
		"access": true,
		"comments": false,
		"og_image": null,
		"og_title": null,
		"og_description": null,
		"twitter_image": null,
		"twitter_title": null,
		"twitter_description": null,
		"meta_title": null,
		"meta_description": "This year we made two of our web optimisation products-Mirage & Rocket Loader-even faster! These products are inserted into pages around 1.2b times a week.",
		"email_subject": null,
		"frontmatter": null,
		"feature_image_alt": null,
		"feature_image_caption": null
	}
}