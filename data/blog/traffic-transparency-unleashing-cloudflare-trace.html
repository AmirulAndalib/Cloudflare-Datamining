<div class="mb2 gray5">6 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/09/image7-9.png" class="kg-image" alt="Traffic Transparency: Unleashing the Power of Cloudflare Trace" loading="lazy" width="1999" height="1125"></figure>
	<p>Today, we are excited to announce Cloudflare Trace! Cloudflare Trace is available to all our customers. Cloudflare Trace enables you to understand how HTTP requests traverse your zone's configuration and what <a href="https://developers.cloudflare.com/ruleset-engine" target="_blank">Cloudflare Rules</a> are being applied to the request.</p>
	<p>For many Cloudflare customers, the journey their customers' traffic embarks on through the Cloudflare ecosystem was a mysterious black box. It's a complex voyage, routed through various products, each capable of introducing modification to the request.</p>
	<p>Consider this scenario: your web traffic could get blocked by <a href="https://developers.cloudflare.com/waf/custom-rules" target="_blank">WAF Custom Rules</a> or <a href="https://developers.cloudflare.com/waf/managed-rules" target="_blank">Managed Rules (WAF)</a>; it might face <a href="https://developers.cloudflare.com/waf/rate-limiting-rules" target="_blank">rate limiting</a>, or undergo modifications via <a href="https://developers.cloudflare.com/rules/transform" target="_blank">Transform Rules</a>, Where a Cloudflare account has many admins, modifying different things it can be akin to a game of "hit and hope," where the outcome of your web traffic's journey is uncertain as you are unsure how another admins rule will impact the request before or after yours. While Cloudflare's individual products are designed to be intuitive, their interoperation, or how they work together, hasn't always been as transparent as our customers need it to be. Cloudflare Trace changes this.</p>
	<h3 id="running-a-trace">Running a trace</h3>
	<p>Cloudflare Trace allows users to set a number of request variables, allowing you to tailor your trace precisely to your needs. A basic trace will require users to define two settings. A URL that is being proxied through Cloudflare and an <a href="https://www.cloudflare.com/learning/ddos/glossary/hypertext-transfer-protocol-http" target="_blank">HTTP method</a> such as GET. However, customers can also set request headers, add a request body and even set a bot score to allow users to validate the correct behavior of their security rules.</p><!--kg-card-begin: html-->
	<div style="position: relative; padding-top: 57.415565345080765%;">
		<iframe src="https://customer-eq7kiuol0tk9chox.cloudflarestream.com/666d4a5e27f447282cec9d03cec82098/iframe?muted=true&amp;preload=true&amp;loop=true&amp;autoplay=true&amp;poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2F666d4a5e27f447282cec9d03cec82098%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600" style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe>
	</div>
	<p></p><!--kg-card-end: html-->
	<p>Once a trace is initiated, the dashboard returns a visualization of the products that were matched on a request, such as Configuration Rules, Transform Rules, and Firewall Rules, along with the specific rules inside these phases that were applied. Customers can then view further details of the filters and actions the specific rule undertakes. Clicking the rule id will take you directly to that specific rule in the Cloudflare Dashboard, allowing you to edit filters and actions if needed.</p>
	<p>The user interface also generates a programmatic version of the trace that can be used by customers to run traces via a command line. This enables customers to use tools like <a href="https://jqlang.github.io/jq" target="_blank">jq</a> to further investigate the extensive details returned via the trace output.</p>
	<h3 id="the-life-of-a-cloudflare-request">The life of a Cloudflare request</h3>
	<p>Understanding the intricate journey that your traffic embarks on within Cloudflare can be a challenging task for many of our customers and even for Cloudflare employees. This complexity often leads to questions within our Cloudflare Community or direct inquiries to our support team. Internally, over the past 13 years at Cloudflare, numerous individuals have attempted to explain this journey through diagrams. We maintain an internal Wiki page titled 'Life of a Request Museum.' This page archives all the attempts made over the years by some of the first Cloudflare engineers, heads of product, and our marketing team, where the following image was used in our 2018 marketing slides.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2023/09/pasted-image-0-4.png" class="kg-image" alt="A picture showing the lift of a request that marketing created. it shows a simple flow through DNS, DOS, SSL, Security, Performance, Argo then insights." loading="lazy" width="1600" height="973"></figure>
	<p>The "problem" (a rather positive one) is that Cloudflare is innovating so rapidly. New products are being added, code is removed, and existing products are continually enhanced. As a result, a diagram created just a few weeks ago can quickly become outdated and challenging to keep up to date.</p>
	<h3 id="finding-a-happy-medium">Finding a happy medium</h3>
	<p>However, customers still want to understand, “The life of a request.” Striking the ideal balance between providing just enough detail without overwhelming our users posed a problem akin to the <a href="https://en.wikipedia.org/wiki/Goldilocks_principle" target="_blank">Goldilocks principle</a>. One of our first attempts to detail the ordering of Cloudflare products was <a href="https://blog.cloudflare.com/traffic-sequence-which-product-runs-first">Traffic Sequence</a>, a straightforward dashboard illustration that provides a basic, high-level overview of the interactions between Cloudflare products. While it does not detail every intricacy, it helps our customers understand the order and flow of products that interacted with an HTTP request and was a welcome addition to the Cloudflare dashboard.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/09/Screenshot-2023-09-22-at-13.28.24.png" class="kg-image" alt="Flow diagram in the UI showing cloudflare flow of a request." loading="lazy" width="1564" height="698"></figure>
	<p>However, customers still requested further insights and details. Especially around debugging issues. Internally Cloudflare teams utilize a number of self created products to trace a request. One of these products is Flute. This product gives a verbose output of all rules, Cloudflare features and codepaths a request undertakes. This allows our engineers and support teams to investigate an issue and identify if something is awry. For example in the following Flute trace image you can see how a request for my domain is evaluated against <a href="https://developers.cloudflare.com/rules/url-forwarding/single-redirects" target="_blank">Single Redirects</a>, <a href="https://developers.cloudflare.com/waiting-room" target="_blank">Waiting Room</a>, <a href="https://developers.cloudflare.com/rules/configuration-rules" target="_blank">Configuration Settings</a>, <a href="https://blog.cloudflare.com/cloudflare-snippets-alpha">Snippets</a> and <a href="https://developers.cloudflare.com/rules/origin-rules" target="_blank">Origin Rules</a>.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/09/image9-1.png" class="kg-image" alt="Output of Flute Trace output showing the zone and the phases that were matched." loading="lazy" width="1999" height="912"></figure>
	<p>The Flute tool became one of the key focal points in the development of Cloudflare Trace. However, it can be quite intricate and packed with extensive details, potentially leading to more questions than solutions if copied verbatim and exposed to our customers.</p>
	<p>To understand the happy medium in developing Cloudflare Trace. We closely collaborated with our Support team to gain a deeper understanding of the challenges our customers faced specifically around <a href="https://developers.cloudflare.com/ruleset-engine" target="_blank">Cloudflare Rulesets</a>. The primary challenge centered around understanding which rules were applicable to specific requests. Customers often raised queries, and in certain instances, these inquiries had to be escalated for further investigation into the reasons behind a request's specific behavior. By empowering our customers to independently investigate and comprehend these issues, we identified a second area where Cloudflare Trace proves invaluable—by reducing the workload of our support team and enabling them to operate more efficiently while focusing on other support tickets.</p>
	<p>For customers encountering genuine problems, they have the capability to export the JSON response of a trace, which can then be directly uploaded to a support ticket. This streamlined process significantly reduces the time required to investigate and resolve support tickets.</p>
	<h3 id="trace-examples">Trace examples</h3>
	<p>Cloudflare Trace has been available via API for the last nine months. We have been working with a number of customers and stakeholders to understand where tracing is beneficial and solving customer problems. Here are some of the real world examples that we have solved using Cloudflare Trace.</p>
	<h3 id="transform-rules-inconsistently-matching">Transform Rules inconsistently matching</h3>
	<p>A customer encountered an issue while attempting to rewrite a URL to their origin for specific paths using Transform rules. The Cloudflare account created a filter that employed regex to match against a specific path.</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2023/09/pasted-image-0--1--4.png" class="kg-image" alt="" loading="lazy" width="1600" height="910"></figure>
	<p>A systems administrator monitoring their web server observed in their logs that the URLs for a small percentage of requests were not transforming correctly, causing disruptions to the application. They decided to investigate by comparing a correctly functioning request with one that was not, and subsequently conducted traces.</p>
	<p>In the problematic trace, only one rule matched the trace parameters and was setting incorrect parameters.</p><!--kg-card-begin: html-->
	<div style="position: relative; padding-top: 56.82492581602374%;">
		<iframe src="https://customer-eq7kiuol0tk9chox.cloudflarestream.com/083154477826948229d16dd52427876b/iframe?muted=true&amp;preload=true&amp;loop=true&amp;autoplay=true&amp;poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2F083154477826948229d16dd52427876b%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600" style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe>
	</div>
	<p></p><!--kg-card-end: html-->
	<p>Whereas on the other URL the rule that contained the regex matched as intended and set the correct URL parameters.</p><!--kg-card-begin: html-->
	<div style="position: relative; padding-top: 59.13978494623656%;">
		<iframe src="https://customer-eq7kiuol0tk9chox.cloudflarestream.com/87cc286c9b963b55c4d53a12479b0969/iframe?muted=true&amp;preload=true&amp;loop=true&amp;autoplay=true&amp;poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2F87cc286c9b963b55c4d53a12479b0969%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600" style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe>
	</div>
	<p></p><!--kg-card-end: html-->
	<p>This allowed the sysadmin to pinpoint the problem: the regex was specifically designed to handle requests with subdirectories, but it failed to address cases where requests directly targeted the root or a non-subdirectory path. After identifying this issue within the traces, the sysadmin updated the filter. Subsequently, both cases matched successfully, leading to the resolution of the problem.</p>
	<h3 id="what-origin">What origin?</h3>
	<p>When a request encounters a Cloudflare ruleset, such as Origin Rules, all the rules are evaluated, and any rule that is matched is applied in sequential order of priority. This means that multiple settings could be applied from different rules. For example, a Host Header could be set in rule 1, and a DNS origin could be assigned in rule 3. This means that the request will exit the Origin Rules phase with a new Host Header and be routed to a different origin. Cloudflare Trace allows users to easily see all the rules that matched and altered the request.</p><!--kg-card-begin: html-->
	<div style="position: relative; padding-top: 57.74647887323944%;">
		<iframe src="https://customer-eq7kiuol0tk9chox.cloudflarestream.com/fedb79e65817e659f911bb59f805eece/iframe?muted=true&amp;preload=true&amp;loop=true&amp;autoplay=true&amp;poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2Ffedb79e65817e659f911bb59f805eece%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600" style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe>
	</div>
	<p></p><!--kg-card-end: html-->
	<h3 id="tracing-the-future">Tracing the future</h3>
	<p>Cloudflare Trace will be available to all our customers over this coming week. And located within the Account section of your Cloudflare Dashboard for all plans. We are excited to introduce additional features and products to Cloudflare Trace in the coming months. In the future will also be developing scheduling and alerts, which will enable you to monitor if a newly deployed rule is impacting the critical path of your application. As with all our products, we value your feedback. Within the Trace dashboard, you'll find a form for providing feedback and feature requests to help us enhance the product before its general release.</p>
</div>