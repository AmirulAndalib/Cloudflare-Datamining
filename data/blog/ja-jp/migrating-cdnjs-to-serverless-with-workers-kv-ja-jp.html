<div class="mb2 gray5">8 min read</div>
<div class="post-content lh-copy gray1">
	<p>Cloudflareは<a href="https://cdnjs.com" target="_blank">cdnjs</a>を運用しています。cdnjsは、オープンソースプロジェクトで、人気のJavaScriptライブラリとリソースを<a href="https://www.cloudflare.com/cdn" target="_blank">Cloudflare Workersのネットワーク</a>を経由して配信することで、Webサイトを加速させます。<a href="https://blog.cloudflare.com/an-update-on-cdnjs">12月に本格的なアップデートをしてから</a>、スケーラビリティと耐障害性を求めて、cdnjsのモデルチェンジに重点を置きました。本日、Cloudflareがcdnjsを配信する方法を発表できることを嬉しく思います。これは<a href="https://developers.cloudflare.com/workers" target="_blank">Cloudflare Workers</a>と分散キーバリューストア<a href="https://developers.cloudflare.com/workers/reference/storage" target="_blank">Workers KV</a>を用いるサーバーレスインフラストラクチャへの移行です。</p>
	<p>cdnjsとは？</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/11/imagesmall.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>詳しくない方のためにご説明すると、cdnjsとは「コンテンツ配信ネットワーク（CDN）for JavaScript（JS）」の頭文字語です。<a href="https://www.cloudflare.com/learning/cdn/what-is-a-cdn" target="_blank">CDN</a>は、単にインターネットミームや猫の動画、またはHTMLページなどインターネットコンテンツを提供するサーバーの地理的に分散されたネットワークのことです。当社の場合、CDNはCloudflareのグローバルに分散された200以上のデータセンターの<a href="https://blog.cloudflare.com/cloudflare-network-expands-to-more-than-100-countries">ネットワークの拡大</a>を指します。</p>
	<p>では、これとみなさまがどのように関わっていくのかをご説明します。まず、ページ読み込み時間が超高速になります。事実上これを含めて、どのWebサイトでも読み込むためにJSライブラリを取得する必要があります。たとえば、シドニーを拠点にするWebサイトを訪れるとします。このサイトは、<a href="https://w3techs.com/technologies/details/js-jquery" target="_blank">76.2%</a>のWebサイトで見られる人気ライブラリであるjQueryからのローカルファイルを含んでいます。New Yorkからこのサイトにアクセスした場合、遅延に気づくかもしれません。TLSハンドシェイク を含むラウンドトリップにかかる時間はもちろん、ファイルの取得するために300ミリ秒を軽く超えてしまうからです。しかし、このWebサイトがcdnj.cloudflare.comを使ってjQueryを参照すると、バッファローにある直近のCloudflareデータセンターからファイルを取り出すことができて、レイテンシーが驚きの20ミリ秒まで短縮します。</p>
	<p>cdnjsは水面下で稼働していますが、<a href="https://w3techs.com/technologies/overview/content_delivery" target="_blank">11%以上</a>のWebサイトで使用され、インターネットをはるかに速くし、さらに信頼性の高い場所に変えてくれています。7月、cdnjsはおよそ190億件ものリクエストを処理しました。データの量は3.46PB（ペタバイト）です。</p>
	<h3 id="-">ファイルの保存場所</h3><!--kg-card-begin: html-->
	<p><img style="border-width: 0px;" src="https://blog.cloudflare.com/content/images/2020/09/image5-2.png" alt="" width="400" height="333"></p><!--kg-card-end: html-->
	<p>cdnjsがインターネットのスピードアップさせていますが、もちろん魔法ではありません。</p>
	<p>これまでは、Cloudflareのコアデータセンター１か所で<a href="https://www.cloudflare.com/load-balancing" target="_blank">負荷分散された</a>マシンの多くは、cdnjs.cloudflare.comのオリジンとして機能する補助記憶装置から定期的にcdnjsファイルをプルしてきました。新しいファイルがリクエストされると、Cloudflareが<a href="https://www.cloudflare.com/learning/cdn/what-is-caching" target="_blank">キャッシュ</a>して、どのデータセンターからでも迅速に取得できるようにしました。</p>
	<p>補助記憶装置は、オープンソースの<a href="https://github.com" target="_blank">GitHub</a>リポジトリの形式で、JS、CSSや他のWebライブラリのカタログです。ということは、みなさんも含めて、誰でもレビューやその他のプロセスの対象として貢献できるということです。</p>
	<p>しかし最近まで、こうした既存の作業は労働集約型で脆弱なものでした。</p>
	<p>このブログ記事では、cdnjsの背後にあるインフラストラクチャをより高速で確実、維持が簡単になるように変えたのか、その理由を説明していきます。まず、旧システムに関する問題と懸念を概説して、コミュニティがどのようにcdnjsに貢献したのかを考えます。そして、Workers KVへの移行によってもたらされるメリットを見ていきます。そのあとで、新しいアーキテクチャだけではなく、Webサイトとcdnjs APIへのアップグレードにも触れていきます。最後に、cdnjsの歴史を振り返り、これからどこに向かっていくのかについて、検討していきます。</p>
	<h3 id="-pr-">勘違いしていませんか、PRの方法を</h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/11/image1-1-2.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>専門家ではない読者の方にとって、プルリクエスト（PR）とは、リポジトリで行った変更とマージするリクエストのことです。従来、cdnjsにJavaScfriptライブラリを含めたいと思ったら、まずGitHub上でパッケージを記述したJSONファイルと、含めたいバージョンの追加ファイルで<a href="https://github.com/cdnjs/cdnjs" target="_blank">cdnjs/cdnjs</a>にPRを作成していました。当社の<a href="https://github.com/PeterBot" target="_blank">古いボット</a>がPRを承認すると、手動でレビューされ、メ‑ンテナーがマージします。そしてパッケージがcdnjsと統合されます。</p>
	<p>簡単そうですよね？そのリポジトリをフォークしてクローン、そしてファイルをいくつかコピペするだけですね？</p>
	<p>その通りです。もし書き込みにかけられる時間が何時間あったり、大文字と小文字を区別するファイルシステムや300 GBリポジトリを<a href="https://git-scm.com/docs/git-clone" target="_blank">git clone</a>（リポジトリを複製）するためのディスクの空きスペースが数百ギガバイトもあったりすれば、コントリビュートするのは簡単です。しかし、時間が足りない場合でも大丈夫です。<a href="https://git-scm.com/docs/git-sparse-checkout" target="_blank">git sparse-checkout</a>（リポジトリの一部をチェックアウト）してこの作業を終わらせることができます。gitをご存知ありませんか？GitHubのUIを使って手動で1回に1つのファイルを手動で追加するだけです。</p>
	<p>これで、大事なことはお分かりになったと思います。macOSがデフォルトで大文字と小文字を区別しないことを発見するためだけに、無邪気にリポジトリのクローニングに10時間も費やしたことを確かに覚えています。</p>
	<p>しかし、cdnjsの更新はコントリビュータにとってだけでなく、メンテナーにとっても難しいのです。歴史的に、コミュニティはバージョンファイルに直接コントリビュートできていましたが、これは悪意のあるものになる可能性がありました。各ファイルを手動で確認する必要があり、公式ライブラリソースとファイルを<a href="https://man7.org/linux/man-pages/man1/diff.1.html" target="_blank">diff</a>し、マルウェアチェックを実行するため、メンテナーの作業を大量に増やしていました。</p>
	<p>すでにcdnjsにあるパッケージをどのようにアップデートしたのでしょうか。各パッケージを記述したJSONファイルにライブラリの新バージョンを探す場所をボットに指示する自動更新の定義がオプションであります。存在する場合は、パッケージがnpmまたはGitHubから新バージョンをリリースした時に、ボットがダウンロードし、ファイルを<a href="https://github.com/cdnjs/cdnjs" target="_blank">cdnjs/cdnjs</a>に、そして算出された<a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" target="_blank">サブリソース完全性</a>（SRI）のハッシュを<a href="https://github.com/cdnjs/SRIs" target="_blank">cdnjs/SRI</a>にプッシュします。自動更新のプロパティがない場合は、手動PRを作ってcdnjsを新バージョンに更新するのは、みなさんの責任となります。</p>
	<h3 id="cdnjs-">cdnjsの注意喚起</h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/11/image6-1-2.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>4月、当社のコアデータセンターの1つでメンテナンス中に技術者が、他のデータセンターとの外部接続すべてを供給するケーブルを切断してしまう事故があり、そのデータセンターが約4時間オフラインになってしまいました。特に、影響を受けたデータセンターがプライマリcdnjsオリジンWebサーバーをハウジングしていたため、<a href="https://blog.cloudflare.com/cloudflare-dashboard-and-api-outage-on-april-15-2020">この出来事</a>が、cdnjsに対する最初の警鐘となりました。この場合では、外部プロバイダーで実行するバックアップがありましたが、当社を救ったのは、実はCloudflareのグローバルキャッシュでした。キャッシュされていないプロパティだけが読み込みされていなかったため、停止の影響を最小限に抑えることができました。</p>
	<p>cdnjsの提供方法をめぐり、信頼性とパフォーマンスの両方をどのように改善できるかを考え始めました。そこで、すぐに目を向けたのが、エッジでの開発に向けた当社独自のプラットフォームである<a href="https://workers.cloudflare.com" target="_blank">Cloudflare Workers</a>です。そして、Workersに構築された強力なツールの1つが<a href="https://developers.cloudflare.com/workers/reference/storage" target="_blank">Workers KV</a>です。高度な読み取りアプリケーションのために最適化され、低レイテンシーでグローバルに分散されたキーバリューストアです。</p>
	<p>当社はあれこれと考え合わせ、<a href="https://github.com/cdnjs/cdnjs" target="_blank">cdnjs/cdnjs</a>リポジトリをプルし、ディスクからファイルを処理する代わりに、物理的マシンを完全に省き、世界中にデータを分散してエッジから直接ファイルを処理することができると気が付きました。この方法ならば、cdnjsは拡張性を高めつつ、オリジンデータセンターの障害から回復することができます。</p>
	<h3 id="workers-kv-">Workers KVが救う</h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/11/image3-3-1.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>一見したところ、Workers KVの利用を決定するのは、簡単なことでした。cdnjsのファイルを変更することは決してありませんが、頻繁な読み取りが必要となるため、Workers KVは完璧でした。</p>
	<p>しかし、移行を計画しているうちに、cdnjsにある700万以上のアセットがあると、<a href="https://developers.cloudflare.com/workers/about/limits" target="_blank">Workers KVの10 MiB値制限</a>を超えるファイルが間違いなく存在するという懸念が出てきました。調査した後、数百ものcdnjsファイルが大容量で、大半が<a href="https://developer.mozilla.org/en-US/docs/Tools/Debugger/How_to/Use_a_source_map" target="_blank">JavaScriptソースマップ</a>であることが明らかになりました。</p>
	<p>そして、このアイディアが頭に浮かびました。Workers KVに圧縮されたバージョンのcdnjsファイルを保管することができ、容量の大きいファイル問題を解決するだけでなく、ファイルの処理方法も最適化できます。</p>
	<p>インターネット料金を支払っている場合、<a href="https://blog.cloudflare.com/the-relative-cost-of-bandwidth-around-the-world">帯域幅が高額</a>になってしまうのはお分かりでしょう。そのため、すべての最新ブラウザで、利用可能なときは常に、<a href="https://blog.cloudflare.com/efficiently-compressing-dynamically-generated-53805">圧縮されたWebコンテンツ</a>を取得することにします。同様にCloudflare内でも、帯域幅を削減するために、可能な時は常に徹底して圧縮されたコンテンツを処理して<a href="https://blog.cloudflare.com/results-experimenting-brotli">オンザフライ圧縮を試行</a>してみました。その結果、<a href="https://github.com/google/brotli" target="_blank">Brotli </a>フォームと<a href="https://www.gzip.org" target="_blank">gzip</a>フォームの両方でWorkers KVに書き込んで、早めにすべてのcdnjsファイルを圧縮することに決めました。そうすることで、レイテンシー要件がなくなり、オンザフライ圧縮よりも圧力レベルを高くすることができました。</p>
	<p>つまり今、cdnjsファイルは速くてコンパクトに処理できているということです！</p>
	<h3 id="cdnjs--1">cdnjsの大変身</h3><!--kg-card-begin: html-->
	<p><a href="https://blog.cloudflare.com/content/images/2020/09/image7-1.png" target="_blank" rel="noopener"><img style="border-width: 0px;" src="https://blog.cloudflare.com/content/images/2020/09/image7-1.png" width="800" height="498" alt=""></a></p><!--kg-card-end: html-->
	<p>今日では、cdnjsのJavaScriptライブラリを含めたい場合にまず、GitHub上のPRを当社の新しいリポジトリ<a href="https://github.com/cdnjs/packages" target="_blank">cdnjs/package</a>に作成します。リポジトリは50MBで簡単にクローンでき、何千ものJSONファイルで構成されます。JSONファイルはそれぞれcdnjsパッケージとnpmまたはgitからどのように自動更新されるかを記述します。ファイルが（<a href="https://github.com/cdnjs/tools" target="_blank">新規ボット</a>によって）自動化されたCIに検証されると、メンテナーがマージし、パッケージは自動的に、自動更新サービスでエンロールされます。</p>
	<p>新システムでは、セキュリティと保守性が優先されます。まず始めとして、cdnjsバージョンファイルは新バージョンとマージする際、当社のボットが作成して人によるエラーを最小限に抑えます。<a href="https://github.com/cdnjs/packages" target="_blank">cdnjs/package</a>のJSONファイルを間違えを起こしやすい人間が追加しますが、メンテナーに承認される前に当社のボットで検査します。各ファイルは、自動的に<a href="https://github.com/cdnjs/tools/blob/master/schema_human.json" target="_blank">JSONスキーマ</a>が検証され、npmまたはGitHubの人気度もチェックされます。</p>
	<p>ボットは、新しいリリースを検出すると、Brotliとgzipで圧縮されたバージョンのファイルをWorkers KV内のファイルネームスペースへプッシュします。各エントリで、ボットは<a href="https://blog.cloudflare.com/catching-up-with-workers-kv">Workers KVのメタデータ</a>を<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag" target="_blank">Etag</a>と<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified" target="_blank">Last-Modified</a> HTTPヘッダーのために書きます。以前のように、ボットは圧縮されていないファイルの<a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" target="_blank">サブリソース完全性</a>（SRI）ハッシュも算出しますが、今ではWorkers KVのSRIネームスペースの代わりにそれをプッシュします。</p>
	<p>次に、cdnjs.cloudflare.comから新規ファイルがリクエストされると、<a href="https://developers.cloudflare.com/workers" target="_blank">Cloudflare Worker</a>がクライアントの<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Encoding" target="_blank">Accept-Encoding</a>ヘッダーを検査し、ETagとLast-Modified メタデータをWorkers KVとともに、Brotliまたはgzip圧縮バージョンのどちらかを取得します。圧縮されたファイルがCloudflareを介して戻るため、今後のリクエストと、必要とあれば、圧縮していないオンザフライがキャッシュされます。</p>
	<p>現時点では、Workers KVのサイズ制限を超えるファイルがまだ若干あります。したがって、Cloudflare WorkersがWorkers KVからのファイルの取得に失敗すると、オリジナルのgitリポジトリにバックアップされたオリジンから取得されることになります。今後数ヶ月で、徐々にこのインフラストラクチャをなくしていく予定です。</p>
	<h3 id="web-api-">WebサイトとAPIの拡張</h3>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2020/11/image2-1.gif" class="kg-image" alt="" loading="lazy"></figure>
	<p>コアのcdnjsインフラストラクチャに加えて、他の多くのコンポーネントもアップグレードされました！</p>
	<p>cdnjsプロジェクトの<a href="https://cdnjs.com" target="_blank">ホームページ</a>では、<a href="https://github.com/mattipv4" target="_blank">Matt</a>が構築したカッコいい<a href="https://github.com/cdnjs/static-website" target="_blank">新ベータWebサイト</a>がみなさんをお迎えします。<a href="https://vuejs.org" target="_blank">Vue</a>と<a href="https://nuxtjs.org" target="_blank">Nuxt</a>で構成されているベータWebサイトは、完全に<a href="https://cdnjs.com/api" target="_blank">cdnjs API</a>で運用されています。結果として、最新パッケージ情報で常に最新のものであり、このサイトの提供で必要とされるリソースの使用量が少なくて済みます。このサイトは、最初のページの読み取り以降、クライアント側で完全に実行されており、cdnjsの終わりのない成長に合わせて、当社が拡張するために役立ちます。</p>
	<p>実際に、cdnjs APIもその拡張性を強化し、cdnjsとWorkers KVで見てきたものに近いサーバーレスアーキテクチャから恩恵を受けてきました。</p>
	<p>Workers KVに移行する前に、cdnjs APIは約300MBのメタデータを生成する定期的なプロセスに依存してきました。cdnjs APIのバックエンドでは、この巨大な「package.min.js」ファイルをメモリーに取得し、それを用いてAPIを操作しました。もし気になるのであれば、ファイルはまだ<a href="https://storage.googleapis.com/cdnjs-assets/package.min.js" target="_blank">こちら</a>でホストされていますので、どうぞ。ただし、ひとこと言っておきますが、みなさんのブラウザに遅れが出るかもしれません！同様に、SRIは<a href="https://github.com/cdnjs/SRIs" target="_blank">cdnjs/SRI</a>へとプッシュされ、ローカルでAPIにクローンされ、SRI応答に提供されました。</p>
	<p>すべてのcdnjsファイルが（許可されたサイズ制限内で）Workers KVへと移された後、こうしたレガシープロセスは持続不可能となり、何百万もの読み取りとあり得ないほど長い時間が必要となりました。そのため、当社はWorkers KVで見つかったすべてのメタデータをアップロードすることにしました。メタデータを4つのネームスペースに分けました。1つ目はパッケージレベルのメタデータで、2つ目はバージョン固有のメタデータ、3つ目は集約された1つのメタデータ、最後はファイルSRIです。</p>
	<p>cdnjsのサーバーレスデザインのように、Cloudflare Workerは<a href="http://metadata.speedcdnjs.com/packages" target="_blank">metadata.speedcdnjs.com</a>上にあり、いくつものパブリックエンドポイントを使って、Workers KVからデータを提供します。現在のところ、cdnjs APIは完全にこうしたエンドポイントと統合され、cdnjsの拡張にしたがって、明確なソリューションを提供します。</p>
	<h3 id="cdnjs--2">cdnjsの透明性と将来性</h3>
	<p>2011年1月の誕生以来、cdnjsは常に透明性に深く根ざし、コミュニティから強さを引き出しています。たとえcdnjsが大規模になって、2011年7月に創設者のRyan KirkmanとThomas Davisが<a href="https://blog.cloudflare.com/cdnjs-community-moderated-javascript-librarie">当社と手を組んだ</a>時でも、プロジェクトは完全に<a href="https://github.com/cdnjs" target="_blank">GitHub</a>でオープンソースのままであり続けました。</p>
	<p>時が経つにつれて、創設者が積極的に活動するのが難しくなり、サポートをコミュニティに頼るようになりました。ほとんど存在しない予算とリポジトリへのわずかなアクセスで、コアcdnjsのメンテナーは毎日プロジェクトを進めるために駆け回りました。</p>
	<p>昨年、これが創設者に連絡を取るきっかけとなりました。<a href="https://news.ycombinator.com/item?id=21416614" target="_blank">2人ともプロジェクトの支援を受けることを喜んでくれました</a>。Cloudflareの役割が大きくなり、cdnjsはこれまで以上に安定し、<a href="https://cdnjs.com/about" target="_blank">活発に参加するメンバー達</a>がCloudflareとコミュニティの両方から集まりました。</p>
	<p>しかし、レガシーシステムへの依存を排除し、ファイルをWorkers KVへと保存するようになると、cdnjsが専有になるのではないかという懸念の声が上がりました。しかし、どうぞご心配なく。cdnjsがこれまで通りの透明性を維持し、限りなくオープンソースであることを保証するために当社は懸命に作業してきました。コミュニティが監査の更新をWorkers KVでできるように、新規リポジトリの<a href="https://github.com/cdnjs/logs" target="_blank">cdnjs/ログ</a>があります。これはボットがすべてのWorkers KV関連イベントを記録するために利用するものです。さらに誰でも、cdnjs APIからSRIを取得して、cdnjsファイルの整合性を検証することができます。</p>
	<h3 id="--1">まとめ</h3>
	<p>概して、この1年間はcdnjsにとって波乱の年でしたが、その弱点すべてが危険信号として機能し、当社がより良いシステムを構築する手助けとなっています。最近では、1か所で物理的なマシンに依存することのリスクを軽減でき、<a href="https://developers.cloudflare.com/workers/reference/storage" target="_blank">Workers KV</a>でファイルが保管されるサーバーレスインフラストラクチャへと移行しました。</p>
	<p>現在、cdnjsは何も心配することなく、どこかに消えてしまうことはありません。特にメンテナーの<a href="https://github.com/xtuc" target="_blank">Sven</a>と<a href="https://github.com/mattipv4" target="_blank">Matt</a>にはこのプロジェクトに勢いを提供し、cdnjsの拡張からこのブログ記事の編集まで、すべてをしてくれたことに感謝の気持ちを送ります。</p>
	<p>将来に向けて、cdnjsの透明性を可能な限り高めるために尽力します。cdnjsが向上するにしたがって、さらにブログ記事を通して、コミュニティに最新情報をリリースしていきます。関心がおありの場合は、当社のブログをサブスクライブしてください。結局、cndjsを可能にしているのは、コミュニティです！積極的に活動するGitHubコントリビュータのみなさん、<a href="https://github.com/cdnjs/cdnjs/discussions" target="_blank">cdnjsコミュニティフォーラムのメンバ</a>ーのみなさん、これからもよろしくお願いします！</p>
</div>