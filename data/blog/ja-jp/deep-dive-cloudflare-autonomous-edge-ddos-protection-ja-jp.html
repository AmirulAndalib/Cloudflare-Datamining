<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/04/1-25.png" class="kg-image" alt="A deep-dive into Cloudflare’s autonomous edge DDoS protection" loading="lazy"></figure>
	<p>本日は、自律的なDDoS（<a href="https://www.cloudflare.com/ja-jp/learning/ddos/what-is-a-ddos-attack" target="_blank">分散サービス妨害</a>）攻撃対策システムをみなさまにご紹介いたします。このシステムは、Cloudflareの200を超えるデータセンターでデプロイされており、人の介入を必要とせず、（<a href="https://www.cloudflare.com/ja-jp/learning/ddos/glossary/open-systems-interconnection-model-osi" target="_blank">OSI 参照モデルの</a>）レイヤー3からレイヤー7を狙うDDoS攻撃からすべてのお客様を保護しています。当社は<a href="https://blog.cloudflare.com/unmetered-mitigation">DDoS攻撃対策を定額制にする取り組み</a>を行っており、DDoS攻撃を受けた際もお客様から追加料金をいただくことはありません。</p>
	<h3 id="-">エッジを自律的に保護</h3>
	<p>お客様をDDoS攻撃から迅速かつ正確に保護するため、エッジで自律的な検出と軽減システムを構築し、コンセンサスを集約するのではなく、エッジ独自で意思決定を行えるようにしました。これは完全にソフトウェア定義であり、コモディティサーバー上にあるCloudflareのエッジで実行されます。当システムでは、元々2019年半ばにL3/L4 DDoS攻撃から保護するために使用されはじめたサービス拒否デーモン（dosd）を活用しています。それ以来、当社では攻撃者の先を行くため、そして攻撃者の活動を阻止するために、同機能を強化し向上させるための投資を継続的に行ってきました。最新版の改善では、L3/4に加えて、L7攻撃対策にもエッジ軽減コンポーネントを拡大させています。</p>
	<p>このシステムは、エッジにある全データセンターの全サーバーで稼働しています。パケットとHTTPリクエストを常に分析し、DDoS攻撃がないかスキャンしています。攻撃を検出すると、軽減ルールとリアルタイムで生成された証明書が、Linaxスタック内で最もコスト効率よく軽減策が適用される場所に向かってプッシュされます。</p>
	<figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2021/04/2-13.png" class="kg-image" alt="A conceptual diagram of Cloudflare DDoS mitigation systems" loading="lazy">
		<figcaption>Cloudflare DDoS軽減システムの概念図<span class="-mobiledoc-kit__atom">‌‌</span></figcaption>
	</figure>
	<p>Cloudflareのエッジ検出機能は、当社のネットワークコアにある、既存のグローバル脅威検出メカニズムである、<a href="https://blog.cloudflare.com/meet-gatebot-a-bot-that-allows-us-to-sleep">Gatebot</a>を補完するものです。Gatebotを使用するネットワークコアでの攻撃の検出は、Cloudflareエッジ全体にわたる調整を必要とする大規模な分散型の帯域幅消費型攻撃には最適です。しかし、小規模でローカライズされた攻撃では、異なるアプローチが必要になります。ネットワーク層とHTTP攻撃をエッジで検出するということは、より高速にサンプリングを行い、小規模攻撃と大規模攻撃の両方を検出し、すぐに軽減ルールが生成できることを意味します。この数か月、すべてのL3/4 DDoS攻撃の98.6%が、dosd機能で検出されています。同様に、dosdの拡張バージョンをデプロイして以来、すべてのL7攻撃の81%が軽減されています。</p>
	<p>以前のブログで、<a href="https://blog.cloudflare.com/meet-gatebot-a-bot-that-allows-us-to-sleep">Gatebot</a>と<a href="https://blog.cloudflare.com/announcing-flowtrackd">flowtrackd</a>をご紹介しました。このブログでは、拡張されたdosd機能に焦点を当てたいと思います。</p>
	<h3 id="linux-">Linuxネットワークを利用してパケットとリクエストをワイヤースピードでドロップ</h3>
	<p>10年前、Linuxネットワークのスピードは遅いものでした。今は、Linuxのおかげで（具体的には、LinuxのiptablesとeXpress Data Path：XDP）ワイヤースピードでパケットがドロップできています。</p>
	<h3 id="--1">パケットの寿命</h3>
	<p>Cloudflareで保護されているお客様が送信先となっているパケットは、直近の<a href="https://www.cloudflare.com/ja-jp/network" target="_blank">Cloudflareデータセンター</a>に向かうとき<a href="https://www.cloudflare.com/ja-jp/learning/cdn/glossary/anycast-network" target="_blank">BGPエニーキャスト</a>を使います。データセンターに到着すると、ルーターからネットワークスイッチを介して、等価コストマルチパスルーティンググループ（<a href="https://en.wikipedia.org/wiki/Equal-cost_multi-path_routing" target="_blank">ECMP</a>)アルゴリズムを使うサーバーに渡されます。サーバーに到着すると、パケットは、eXpress Data Path（<a href="https://en.wikipedia.org/wiki/Express_Data_Path" target="_blank">XDP</a>）のグループに送られます。XDOプログラムの最初のグループ、<a href="https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations">L4Drop</a>が、前回検出された攻撃から軽減ルールを適用し、今後の分析のために、パケットサンプルをdosdに送信します。</p>
	<p>パケットが悪意のあるものとしてドロップされなかった場合、パケットは<a href="https://blog.cloudflare.com/unimog-cloudflares-edge-load-balancer">Unimog</a>に渡されます。これは当社独自のL4 ロードバランサーです。Unimogは、サーバーの正常性とパフォーマンス指標を使用して、パケットを同じサーバに保存するか、より良い処理が行えるデータセンター内の別のサーバーに渡して処理するかを決定します。Unimogの後、パケットは、iptablesファイアウォールを通過し、その後、L7アプリケーション（例えば、Cloudflare WAFによって保護されたサービス）をターゲットとする場合、当社のHTTPリバースプロキシに渡されます。リバースプロキシはユーザースペースで実行され、その中でパケットは HTTP リクエストになり、<a href="https://www.cloudflare.com/ja-jp/waf" target="_blank">Webアプリケーションファイアウォール</a>を通過し、アプリケーションファイアウォールルール、および追加のカスタマー設定がこれに適用されます。パケットが TCP/UDP アプリケーション（Spectrum）、またはプロキシではなくルーティングされた（Magic Transit）IPの宛先に向けて送信された場合は、当社のHTTPプロキシではなくそれらのシステムを通過します。</p>
	<figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.cloudflare.com/content/images/2021/04/3-9.png" class="kg-image" alt="Life of a packet" loading="lazy">
		<figcaption>パケットの寿命</figcaption>
	</figure>
	<p>L4Dropに加えて、当社のHTTPプロキシは、HTTPリクエストのサンプルとメタデータもdosdに送信します。このエッジサンプリングは、コアサンプリングの10倍の速度で行われます。これは、コアデータセンターに送られるのではなく、ローカルで信号を分析（および処理）することができるためです。同様に、パケットは、Gatebotの81倍の速度でdosdによってサンプリングされます。</p>
	<p>dosd、gatebot、flowtrackdは共に受信したサンプルを分析し、DDoS攻撃が検出されたときに軽減ルールを適用します。HTTP攻撃を軽減するために、これらは軽減ルールをWebプロキシにプッシュします。攻撃リクエストは、システムの判断に応じて、ブロック、レート制限、またはチャレンジアクションを使って処理されます。ただし、攻撃の規模が非常に大きい場合は、よりコスト効率のよい軽減を行うため、軽減ルールは下位層のiptablesファイアウォールまでプッシュダウンされ、L7攻撃は<a href="https://blog.cloudflare.com/rolling-with-the-punches-shifting-attack-tactics-dropping-packets-faster-cheaper-at-the-edge/#jails">IP Jail</a>を使ってL4でドロップされます。同様に、L3/4攻撃は、iptablesファイアウォールで、L4Dropの内部にある拡張されたBerkeley Packet Filter (<a href="https://blog.cloudflare.com/cloudflare-architecture-and-how-bpf-eats-the-world">eBPF</a>）プログラムを使って軽減されます。これらのコンポーネントを活用することで、大規模なDDoS攻撃を自動的に軽減できます。</p>
	<h3 id="--2">攻撃活動を途絶させる</h3>
	<p>Cloudflareの拡張された自律システムは、前述のとおり、既存の脅威軽減コンポーネントとともに、非常に簡単に、そして安価に仕掛けられるようになったDDoS攻撃からお客様を保護するために開発されました。これらの攻撃は、Webサイト、モバイルアプリ、ゲームの停止や、インターネットに接続されたプロパティの削除を目的とする悪意のあるアクターによって仕掛けられます。当社の<a href="https://blog.cloudflare.com/network-layer-ddos-attack-trends-for-q3-2020">DDoSトレンドレポート</a>に記載されているように、過去1年間でこの攻撃数が増加したため、保護を拡大することが必要でした。さらに、攻撃はますます大きく、そして<a href="https://blog.cloudflare.com/beat-an-acoustics-inspired-ddos-attack">高度化</a>しており、この種の攻撃としてアコースティックビートを模した攻撃も、出現しています。しかし、小さい攻撃であっても、小規模のWebプロパティを削除する可能性があります。つまり、攻撃の規模が大きくても小さくてもすべてブロックすることが重要なのです。</p>
	<p>DDoS攻撃に関しては多くの場合、攻撃者が公に利用可能なツールを使用すれば無料で、またはダークウェブの<a href="https://blog.cloudflare.com/moobot-vs-gatebot-cloudflare-automatically-blocks-botnet-ddos-attack-topping-at-654-gbps">Mootbot</a>などのDDoS-as-a-service (サービスとしてのDDoS) <a href="https://www.cloudflare.com/ja-jp/learning/ddos/what-is-a-ddos-botnet" target="_blank">ボットネット</a>を使えば安価で攻撃を開始することができます。<a href="https://www.privacyaffairs.com/dark-web-price-index-2020" target="_blank">2020年のダークウェブ価格指数</a>によると、DDoS攻撃の料金は、1時間の攻撃が、1 秒あたり1万～5万件のリクエストの割合で10ドルからとなっています。攻撃は、攻撃によって引き起こされるダメージよりも攻撃を仕掛ける方がはるかに割安です。システム障害や、サービスを低下させるだけでも、攻撃者は被害者にかなりの損害を与えることができます。たとえば、eコマースのWebサイトを停止すれば、ユーザーがログインして購入できないようになります。遅延が増加するだけで、ユーザーはショッピングカートを放棄して競合他社に飛び移る可能性があります。1分間のダウンタイムが、<a href="https://www.gremlin.com/ecommerce-cost-of-downtime" target="_blank">何万ドル</a>もの損失になるのです。</p>
	<p>頻度、技巧、規模が高まるDDoS攻撃には、迅速で正確な、高精度の新しいアプローチが必要です。これが、当社がこの記事で紹介した保護を拡大するシステムを開発した理由です。</p>
	<h3 id="--3">より良いインターネットの構築を支援</h3>
	<p>Cloudflareのミッションは、安全で、より速く、すべての人にとってより信頼性の高いインターネットを構築することです。DDoSチームのビジョンは、このミッションに由来しています。そして、我々の目標は、DDoS攻撃の影響を過去のものにすることです。90年代と2000年代に<a href="https://en.wikipedia.org/wiki/History_of_email_spam" target="_blank">スパムメールが深刻な問題になりました</a>。今日ではメールサービスがスパムをフィルタリングしてくれます。CloudflareはDDoS攻撃についても同じことを目指しています。</p>
	<p>CloudflareのDDoS攻撃対策に関する詳細につきましては、<a href="https://www.cloudflare.com/ja-jp/enterprise" target="_blank">こちら</a>にお問い合わせください。また、CloudflareのFreeプランをお試しになりたい場合は、 <a href="https://dash.cloudflare.com/sign-up" target="_blank">こちら</a>のサイトからお申し込みいただけます。</p>
</div>