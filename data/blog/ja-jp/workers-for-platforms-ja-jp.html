<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/05/image4-4.png" class="kg-image" alt="Announcing Workers for Platforms: making every application on the Internet more programmable" loading="lazy"></figure>
	<p>新興企業であれフォーチュン500の企業であれ、ビジネスにおいて最優先されるのは、自社の製品によってお客様を満足させ、成功させることです。しかし、お客様にとっては、成功と満足がたった1つの機能に依存しているように見えることがあります。</p>
	<p>「<em>Xさえカスタマイズしていただければ、御社の製品を使えるようになります」-</em>パイプラインの中で最大の見込み客です。<em>「Yさえできるようにしていただければ、御社の製品の利用を10倍に拡大できます」</em>- 最も戦略的な既存のお客様です。</p>
	<p>企業は企業の製品がすべての人のためになることを望んでいますが、非常に迅速に対応できるのはエンジニアリングだけです。それはどういうことでしょうか？</p>
	<p>本日、Workers for Platformsを発表します。これは、あらゆる製品をプログラム可能にし、お客様がそれぞれのお客様と開発者に瞬時に価値を提供できるように支援する一連のツールです。</p>
	<h2 id="-"><strong>プログラム可能なインターフェース</strong></h2>
	<p>お客様がプログラムによって企業の製品を操作できるようにする方法の1つは、APIを提供することです。APIが今日これほど普及しているのは、これが大きな理由です。コード（企業自身のものであれ、第三者のものであれ）をアプリケーションと連携させることはまさに革命的です。</p>
	<p>しかし、まだ問題があります。APIを使用すると、開発者はプログラムによってアプリケーションの操作ができるようになりますが、開発者は最終的には常に、APIによって公開される抽象化によって制限されます。アプリケーション所有者は、お客様が製品をどのように使用するかを予測し、ユースケースをサポートするAPIを構築する必要があります。私がプロダクトマネージャーとして1つ学んだことがあるとすれば、お客様が製品をどのように使用するかを予測することはほとんど不可能だということです。そして、もう1つ学んだことは、たとえ豊富なエンジニアリングリソースがあったとしても、お客様を満足させ続けるために必要なすべての機能を構築することはほぼ不可能だということです。</p>
	<p>しかし、別の方法があります。</p>
	<p>APIとは対照的に、関数は最低レベルのプリミティブを提供します（プリミティブの上に抽象化を置くのではなく） 。これにより、開発者はそこから適切な動作を定義できます。また、プリミティブの上に独自のAPIを定義することもできます。</p>
	<p>この意味では、関数とAPIは実際には相互補完的であり、関数から直接別のAPIを呼び出すこともできます。たとえば、メッセージングシステムでイベントを処理する場合、電子メールAPIを呼び出して電子メールを送信する独自の機能を実装したり、チケットシステムでチケットを作成したりできます。</p>
	<p>Workers for Platformsが非常に魅力的である理由はここにあります。Workers for Platformsを使用することにより、お客様の開発者は任意のアプリケーションに独自のロジックを実装するための直接的な方法を公開できます。私たちは、Workers for Platformsを採用する企業にお客様主導のイノベーションの波が押し寄せ、APIがそうであったように、ウェブ上のアプリケーション構築に影響を与える可能性があると考えています。</p>
	<h2 id="--1"><strong>開発者エクスペリエンスの向上</strong></h2>
	<p>Workers for Platformsは、製品をプログラム可能にするためのより強力なパラダイムを公開しますが、開発者としてのエクスペリエンスの向上にもつながります。</p>
	<p>今日、開発者として、APIやWebhookを使い始める前に、まず対処しなければならない面倒なタスクのリストがあります。まず、サーバー（またはサーバーレス関数）に関係なく、コードをホストする場所を設定し、外部エンドポイントを介してコードを公開する必要があります。OPS、カスタムトークン、新しい認証スキーマの把握など、始める前にすべて対処しなければなりません。次に、そのサービスを保守し、イベントが常に適切に処理されるように、サービスを稼働させなければなりません。</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/05/image3-6.png" class="kg-image" alt="" loading="lazy"></figure>
	<p>使用している製品に直接組み込まれている関数を使用すると、<em>コードの記述を開始できます</em>。</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2022/05/image1-14.png" class="kg-image" alt="" loading="lazy"></figure>
	<h2 id="--2"><strong>このモデルがこれまで採用されていないのはなぜですか？</strong></h2>
	<p>開発者、がイベントがどのように動作するかをプログラムできるようにすることは、当たり前のことのように思えますが、だからといって、それが簡単なこととは限りません。</p>
	<p>Cloudflareでは、5年前にまさにこの問題に直面しました。私たちは、ネットワークに多くのお客様をオンボードし、それぞれのお客様が独自の方法でリクエストの結果を決定する必要がありました。Page RulesはURLごとに動作を修正する方法を提供していましたが、お客様はCookie、ヘッダー、ジオロケーションなどに基づいて動作を制御したいと考えていました。</p>
	<p>私たちは弊社のエンジニアリングチームがすべてのリクエストに対応することはできないと考え、お客様が当社の製品をそれぞれのニーズに合わせて変更できるようにしました。</p>
	<p>この問題へのアプローチを模索する中で、次の2つの要件を満たすソリューションを探しました。</p>
	<ol>
		<li>パフォーマンス要件：サイトを高速化するはずのCDNが遅延を発生させることは許容されません。どうすれば、そこにあることに気づかないほど速くできるますか？</li>
		<li>セキュリティ要件：信頼されないコードを安全に実行するにはどうすればよいでしょうか？</li>
	</ol>
	<p>これらの要件は、パフォーマンスやセキュリティ製品を提供する場合に特に重要ですが、お客様に製品をプログラムする機能を提供する場合にも、これらの課題を解決することは重要です。関数をユーザーに対してクリティカルパスで実行する必要がある場合、遅延を招くようなことも同様に許容されません。そしてもちろん、ユーザーがプログラムできるようにするためだけに、セキュリティが侵害されることを望む人はいないでしょう。</p>
	<p>真に高速で安全なマルチテナント環境を構築するのは簡単なことではありません。</p>
	<p>この問題を解決するための選択肢を評価したとき、私たちはまず、この問題を解決するためにサーバー上に存在する技術に着目しました。サーバーレス関数は当時既に存在していましたが、コンテナーを使用していたため、コールドスタートで実行されます。それは、非現実的なものでした。そこで私たちは<a href="https://blog.cloudflare.com/cloudflare-workers-open-source">ブラウザ</a>に着目（特にV8を搭載したChromeに着目）し、同じアプローチをとることを決め、サーバー上で実行しました。</p>
	<p>また、このアプローチはシンプルに聞こえますが（おそらく、振り返ってみればそう聞こえがちであることは当然ですが）、大規模なマルチテナント開発プラットフォームを大規模に実行するのは簡単な作業ではありません。お客様が製品をプログラムできるようにする目的の一部が、エンジニアリングの労力を解放して新しい機能の構築に集中することであるなら、このような開発プラットフォームの維持と拡大に労力をかけることは目的を台無しにする可能性があります。</p>
	<p>最近になって気づいたことは、この問題を解決しようとしているのは、私たちだけではないということです。</p>
	<p>Shopifyのような企業は、次世代のプログラム可能なストアフロント「Oxygen」を構築して、同じ問題を解決しようと試みていました。彼らはセキュアなマルチテナント環境を維持しながら、お客様がカスタムストアフロントを実行し、可能な限り最高のパフォーマンスを提供できるようにしたいと考えていました。</p>
	<blockquote>Shopifyのカスタマーストアフロント担当製品ディレクター、Zack Koch氏は、「Shopifyはインターネット上の商業インフラで、数百万もの商業者がこのプラットフォームを利用しています。Cloudflareとの連携で、開発者がユニークで機能性の高いストアフロントを構築する際に必要なツールを提供できるようになりました。Cloudflareとの協力により、スケーラビリティやグローバルな可用性といったコマース体験を構築するうえで避けられない複雑さをある程度緩和し、開発者は自社ブランドの差別化に集中できるようになります」と述べています。</blockquote>
	<h2 id="workers-for-platforms-"><strong>Workers for Platformsで次のプラットフォームを構築するにはどうすればよいでしょうか？</strong></h2>
	<p>Shopifyのようなプラットフォームと協力して開発者のニーズに対応することで、私たちは開発者エクスペリエンスが万能ではないという別の問題に気づきました。つまり、私たちは幅広い開発者のためにプラットフォームを構築していますが、eコマース開発者は、より専門的なニーズを持っている可能性があり、そのニーズに合わせた開発者エクスペリエンスが最善の解決策になります。また、基盤となるテクノロジーは同じでも、直接のお客様が必要とするのと同じ高レベルの概念でプラットフォームを構築することには意味がありません。</p>
	<p>企業のお客様のことを誰よりもよく知るのは企業であるため、プラットフォームプロバイダーである企業には、ユーザーにとって最適なエクスペリエンスを設計していただきたいと考えています。Workers for Platformsは、設計する展開フローに直接統合するための、新しいツールとAPIのセットを公開します（私たちが何をしたのかわかりますか?）。</p>
	<h3 id="-api-"><strong>タグAPIで関数を大規模に管理</strong></h3>
	<p>APIを使用することで、開発者がプラットフォームにスクリプトをデプロイするときはいつでも、APIを呼び出して新しいWorkerをバックグラウンドでデプロイできます。従来のWorkers製品とは異なり、Workers for Platformsは、数十万から数百万のCloudflare Workersを管理するために大規模に使用されるように設計されています。</p>
	<p>デプロイメントサービスまたはユーザーの管理方法に応じて、タグを使用してスクリプトのグルーピングを管理するオプションも提供されるようになりました。たとえば、ユーザーが自分のアカウントを削除し、すべてのWorkerがクリーンアップされていることを確認する場合です。タグを使用することで、スクリプトごとに任意のタグ（ユーザーIDなど）を追加して、一括アクションが実行できるようになりました。</p>
	<h3 id="trace-workers"><strong>Trace Workers</strong></h3>
	<p>煙があるところには火があり、コードがあるところにはバグもあるはずです。開発者にコードを記述してデプロイするツールを提供する場合は、デバッグする手段も提供する必要があります。</p>
	<p>Trace Workerを使用すると、ログや例外など、Workerによって処理されたリクエストに関するあらゆる情報を収集し、お客様に渡すことができます。Trace Workerは、他のWorkerの実行に関する情報を受け取るWorkerであり、選択した宛先に転送して、ライブロギングや長期保存などのユースケースを可能にします。</p>
	<p>以下は、HTTPエンドポイントにトレースデータを送信するシンプルなトレースWorkerです。</p><!--kg-card-begin: markdown-->
	<pre><code class="language-js">addEventListener("trace", event =&gt; {
  event.waitUntil(fetch("http://example.com/trace", {
    method: "POST",
    body: JSON.stringify(event.traces),
  }))
})
</code></pre>
	<!--kg-card-end: markdown-->
	<p>以下は event.traces のデータの例です。</p><!--kg-card-begin: markdown-->
	<pre><code class="language-js">[
  {
    "scriptName": "Example script",
    "outcome": "exception",
    "eventTimestamp": 1587058642005,
    "event": {
      "request": {
        "url": "https://example.com/some/requested/url",
        "method": "GET",
        "headers": [
          "cf-ray": "57d55f210d7b95f3",
          "x-custom-header-name": "my-header-value"
        ],
        "cf": {
          "colo": "SJC"
        }
      },
    },
    "logs": [
      {
        "message": ["string passed to console.log()"],
        "level": "log",
        "timestamp": 1587058642005
      }
    ],
    "exceptions": [
      {
        "name": "Error",
        "message": "Threw a sample exception",
        "timestamp": 1587058642005
      }
    ]
  }
]
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="-worker-"><strong>動的ディスパッチで複数のWorkerを連鎖させる</strong></h3>
	<p>いくつかの初期のお客様との作業でよく聞かれた別のニーズは、お客様のコードを実行する前に、企業独自のコードを実行する機能についてです。たとえば、認証のレイヤーを実行したり、入力や出力をサニタイズしたり、有用な情報（ユーザーIDやアカウントIDなど）をダウンストリームに提供したりする必要がある場合があります。</p>
	<p>そのためには、企業独自のWorkerを保守する必要があります。実行が完了したら、<em>お客様の</em>コードを使用して次のWorkerを呼び出すことができます。</p>
	<p>例：</p><!--kg-card-begin: markdown-->
	<pre><code class="language-js">let user_worker = dispatcher.get('customer-worker-123');
let response = await user_worker.fetch(request);
</code></pre>
	<!--kg-card-end: markdown-->
	<h3 id="--3"><strong>カスタムドメイン、その他にも！</strong></h3>
	<p>上記の機能は、今週の時点でお客様に対して有効にした新しいWorkers機能にすぎませんが、プラットフォームの構築に必要なすべてのツールを提供することが目標です。たとえば、Workers for Platformsを使用して<a href="https://developers.cloudflare.com/ssl/ssl-for-saas/" target="_blank">Cloudflare for SaaSでカスタムドメインを作成</a>することができます。（「その他にも！」の部分にもご期待ください）。</p>
	<h2 id="--4"><strong>どうすればアクセスできますか？</strong></h2>
	<p>私たちがリリースするどの新製品でもそうですが、お客様やそのユースケースから学ぶべきことがたくさんあることは間違いありません。私たちは企業に確実に成功を収めていただけるようサポートしたいと考えています。ご興味をお持ちであれば、私たちは企業とそのユースケースについて理解を深め、必要なすべてのツールをセットアップさせていただきます。はじめに、<a href="https://www.cloudflare.com/lp/workers-for-platforms" target="_blank">弊社のフォームにご記入</a>ください。折り返しご連絡いたします。</p>
	<p>その間に、開発者向けドキュメントをご覧いただいたり、Discordにメッセージを送ってみたりしてください。</p>
	<h2 id="--5"><strong>まだまだこれから</strong></h2>
	<p>私たちは5年前にこの問題に直面しました。弊社のサービスを拡張していただける機能をお客様に適した方法で提供する必要があり、Cloudflare Workersを立ち上げたときにそれを実行しました。弊社のグローバルネットワークをお客様がそのニーズに合わせてプログラムできるようにしたことで、開発プラットフォームでより多くのお客様をサポートできるようになり、一方で、弊社のエンジニアリングチームは、最も要求の多いカスタマイズを機能として実現することに専念できるようになりました。私たちは、企業の開発者がそのプラットフォーム上で何を構築するか、そして、企業が思いもよらないようなユースケースを、開発者が思いつくことに驚かされることだろうと信じています。また、企業のエンジニアリングチームが並行してどのようなことに取り組むことができるか見ることを楽しみにしています。</p>
</div>