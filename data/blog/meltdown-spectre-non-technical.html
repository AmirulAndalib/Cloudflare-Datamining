<div class="mb2 gray5">6 min read</div>
<div class="post-content lh-copy gray1"><!--kg-card-begin: markdown-->
	<p>Last week the news of two significant computer bugs was announced. They've been dubbed Meltdown and Spectre. These bugs take advantage of very technical systems that modern CPUs have implemented to make computers extremely fast. Even highly technical people can find it difficult to wrap their heads around how these bugs work. But, using some analogies, it's possible to understand exactly what's going on with these bugs. If you've found yourself puzzled by exactly what's going on with these bugs, read on â€” this blog is for you.</p>
	<p><img src="https://blog.cloudflare.com/content/images/2018/01/2-paths--copy@0.5x.png" alt="" loading="lazy"></p>
	<p>â€œ<em>When you come to a fork in the road, take it.</em>â€ â€” Yogi Berra</p>
	<p>Late one afternoon walking through a forest near your home and navigating with the GPS you come to a fork in the path which youâ€™ve taken many times before. Unfortunately, for some mysterious reason your GPS is not working and being a methodical person you like to follow it very carefully.</p>
	<p>Cooling your heels waiting for GPS to start working again is annoying because you are losing time when you could be getting home. Instead of waiting, you decide to make an intelligent guess about which path is most likely based on past experience and set off down right hand path.</p>
	<p>After walking for a short distance the GPS comes to life and tells you which is the correct path. If you predicted correctly then youâ€™ve saved a significant amount of time. If not, then you hop over to the other path and carry on that way.</p>
	<p><img src="https://blog.cloudflare.com/content/images/2018/01/crystal-ball@0.5x.png" alt="" loading="lazy"></p>
	<p>Something just like this happens inside the CPU in pretty much every computer. Fundamental to the very essence and operation of a computer is the ability to branch, to choose between two different code paths. As you read this, your web browser is making branch decisions continuously (for example, some part of it is waiting for you to click a link to go to some other page).</p>
	<p>One way that CPUs have reached incredible speeds is the ability to predict which of two branches is most likely and start executing it before it knows whether thatâ€™s the correct path to take.</p>
	<p>For example, the code that checks for you clicking <a href="https://cloudflare.com">this link</a> might be a little slow because itâ€™s waiting for mouse movements and button clicks. Rather than wait the CPU will start automatically executing the branch it thinks is most likely (probably that you donâ€™t click the link). Once the check actually indicates â€œclickedâ€ or â€œnot clickedâ€ the CPU will either continue down the branch it took, or abandon the code it has executed and restart at the â€˜fork in the pathâ€™.</p>
	<p>This is known as â€œbranch predictionâ€ and saves a great deal of idling processor time. It relies on the ability of the CPU to run code â€œspeculativelyâ€ and throw away results if that code should not have been run in the first place.</p>
	<p><img src="https://blog.cloudflare.com/content/images/2018/01/2-paths-@0.5x-1.png" alt="" loading="lazy"></p>
	<p>Every time youâ€™ve taken the right hand path in the past itâ€™s been correct, but today it isnâ€™t. Today itâ€™s winter and the foliage is sparser and youâ€™ll see something you shouldnâ€™t down that path: a secret government base hiding alien technology.</p>
	<p>But wanting to get home fast you take the path anyway not realizing that the GPS is going to indicate that left hand path today and keep you out of danger. Before the GPS comes back to life you catch a glimpse of an alien through the trees.</p>
	<p>Moments later two Men In Black appear, erase your memory and dump you back at the fork in the path. Shortly after, the GPS beeps and you set off down the left hand path none the wiser.</p>
	<p><img src="https://blog.cloudflare.com/content/images/2018/01/memory-erase-@0.5x-1.png" alt="" loading="lazy"></p>
	<p>Something similar to this happens in the Spectre/Meltdown attack. The CPU starts executing a branch of code that it has previously learnt is typically the right code to run. But itâ€™s been tricked by a clever attacker and this time itâ€™s the wrong branch. Worse, the code will access memory that it shouldnâ€™t (perhaps from another program) giving it access to otherwise secret information (such as passwords).</p>
	<p>When the CPU realizes itâ€™s gone the wrong way it forgets all the erroneous work itâ€™s done (and the fact that it accessed memory it shouldnâ€™t have) and executes the correct branch instead. Even though illegal memory was accessed what it contained has been forgotten by the CPU.</p>
	<p>The core of Meltdown and Spectre is the ability to exfiltrate information, from this speculatively executed code, concerning the illegally accessed memory through whatâ€™s known as a â€œside channelâ€.</p>
	<p><img src="https://blog.cloudflare.com/content/images/2018/01/reactor-core-@0.5x.png" alt="" loading="lazy"></p>
	<p>Youâ€™d actually heard rumours of Men In Black and want to find some way of letting yourself know whether you saw aliens or not. Since thereâ€™s a short space between you seeing aliens and your memory being erased you come up with a plan.</p>
	<p>If you see aliens then you gulp down an energy drink that you have in your backpack. Once deposited back at the fork by the Men In Black you can discover whether you drank the energy drink (and therefore whether you saw aliens) by walking 500 metres and timing yourself. Youâ€™ll go faster with the extra carbs in a can of <em>Reactor Core</em>.</p>
	<p><img src="https://blog.cloudflare.com/content/images/2018/01/stopwatch@0.5x.png" alt="" loading="lazy"></p>
	<p>Computers have also reached high speeds by keeping a copy of frequently or recently accessed information inside the CPU itself. The closer data is to the CPU the faster it can be used.</p>
	<p>This store of recently/frequently used data inside the CPU is called a â€œcacheâ€. Both branch prediction and the cache mean that CPUs are blazingly fast. Sadly, they can also be combined to create the security problems that have recently been reported with Intel and other CPUs.</p>
	<p>In the Meltdown/Spectre attacks, the attacker determines what secret information (the real world equivalent of the aliens) was accessed using timing information (but not an energy drink!). In the split second after accessing illegal memory, and before the code being run is forgotten by the CPU, the attackerâ€™s code loads a single byte into the CPU cache. A single byte which it has perfectly legal access to; something from its own program memory!</p>
	<p>The attacker can then determine what happened in the branch just by trying to read the same byte: if it takes a long time to read then it wasnâ€™t in cache, if it doesnâ€™t take long then it was. The difference in timing is all the attacker needs to know what occurred in the branch the CPU should never have executed.</p>
	<p>To turn this into an exploit that actually reads illegal memory is easy. Just repeat this process over and over again once per single bit of illegal memory that you are reading. Each single bitâ€™s 1 or 0 can be translated into the presence or absence of an item in the CPU cache which is â€˜readâ€™ using the timing trick above.</p>
	<p>Although that might seem like a laborious process, it is, in fact, something that can be done very quickly enabling the dumping of the entire memory of a computer. In the real world it would be impractical to hike down the path and get zapped by the Men In Black in order to leak details of the aliens (their color, size, language, etc.), but in a computer itâ€™s feasible to redo the branch over and over again because of the inherent speed (100s of millions of branches per second!).</p>
	<p>And if an attacker can dump the memory of a computer it has access to the crown jewels: whatâ€™s in memory at any moment is likely to be very, very sensitive: passwords, cryptographic secrets, the email you are writing, a private chat and more.</p>
	<h3 id="conclusion">Conclusion</h3>
	<p>I hope that this helps you understand the essence of Meltdown and Spectre. There are many variations of both attacks that all rely on the same ideas: get the CPU to speculatively run some code (through branch prediction or another technique) that illegally accesses memory and extract information using a timing side channel through the CPU cache.</p>
	<p>If you care to read all the gory detail thereâ€™s a <a href="https://meltdownattack.com/meltdown.pdf">paper on Meltdown</a> and a separate one <a href="https://spectreattack.com/spectre.pdf">on Spectre</a>.</p>
	<p>Acknowledgements: Iâ€™m grateful to all the people who read this and gave me feedback (including gently telling me the ways in which I didnâ€™t understand branch prediction and speculative execution). Thank you especially to David Wragg, Kenton Varda, Chris Branch, Vlad Krasnov, Matthew Prince, Michelle Zatlyn and Ben Cartwright-Cox. And huge thanks for Kari Linder for the illustrations.</p>
	<!--kg-card-end: markdown-->
</div>