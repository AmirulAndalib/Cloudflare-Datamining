<div class="mb2 gray5">9 min read</div>
<div class="post-content lh-copy gray1">
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/image3-17.png" class="kg-image" alt="How to secure Generative AI applications" loading="lazy" width="1999" height="1125"></figure>
	<p>I remember when the first iPhone was announced in 2007. This was NOT an iPhone as we think of one today. It had warts. A lot of warts. It couldn’t do MMS for example. But I remember the possibility it brought to mind. No product before had seemed like anything more than a product. The iPhone, or more the potential that the iPhone hinted at, had an actual impact on me. It changed my thinking about what could be.</p>
	<p>In the years since no other product came close to matching that level of awe and wonder. That changed in March of this year. The release of GPT-4 had the same impact I remember from the iPhone launch. It’s still early, but it's opened the imagination, and fears, of millions of developers in a way I haven’t seen since that iPhone announcement.</p>
	<p>That excitement has led to <a href="https://www.nytimes.com/2023/03/14/technology/ai-funding-boom.html">an explosion of development</a> and hundreds of new tools broadly grouped into a category we call generative AI. <a href="https://www.cloudflare.com/learning/ai/what-is-generative-ai">Generative AI systems</a> create content mimicking a particular style. New images that look like Banksy or lyrics that sound like Taylor Swift. All of these Generative AI tools, whether built on top of GPT-4 or something else, use the same basic model technique: a transformer.</p>
	<h3 id="attention-is-all-you-need">Attention is all you need</h3>
	<p>GPT-4 (Generative Pretrained Transformer) is the most advanced version of a transformer model. Transformer models all emerged from a seminal paper written in 2017 by researchers at the University of Toronto and the team at Google Brain, titled <a href="https://proceedings.neurips.cc/paper_files/paper/2017/file/3f5ee243547dee91fbd053c1c4a845aa-Paper.pdf">Attention is all you need</a>. The key insight from the paper is the <strong>self-attention mechanism</strong>. This mechanism replaced recurrent and convolutional layers, allowing for faster training and better performance.</p>
	<p>The secret power of transformer models is their ability to efficiently process large amounts of data in parallel. It's the transformers' gargantuan scale and extensive training that makes them so appealing and versatile, turning them into the Swiss Army knife of natural language processing. At a high level, <a href="https://www.cloudflare.com/learning/ai/what-is-large-language-model">Large Language Models (LLMs)</a> are just transformer models that use an incredibly large number of parameters (billions), and are trained on incredibly large amounts of unsupervised text (the Internet). Hence large, and language.</p>
	<h3 id="groundbreaking-technology-brings-groundbreaking-challenges">Groundbreaking technology brings groundbreaking challenges</h3>
	<p>Unleashing the potential of LLMs in consumer-facing AI tools has opened a world of possibilities. But possibility also means new risk: developers must now navigate the unique security challenges that arise from making powerful new tools widely available to the masses.</p>
	<p>First and foremost, <strong>consumer-facing applications inherently expose the underlying AI systems to millions of users</strong>, vastly increasing the <a href="https://www.cloudflare.com/learning/security/what-is-an-attack-surface">potential attack surface</a>. Since developers are targeting a consumer audience, they can't rely on trusted customers or limit access based on geographic location. Any security measure that makes it too difficult for consumers to use defeats the purpose of the application. Consequently, developers must strike a delicate balance between security and usability, which can be challenging.</p>
	<p>The current popularity of AI tools makes <a href="https://www.reuters.com/technology/chatgpt-sets-record-fastest-growing-user-base-analyst-note-2023-02-01"><strong>explosive takeoff</strong></a><strong> more likely than in the past</strong>. This is great! Explosive takeoff is what you want! But, that explosion can also lead to exponential growth in costs, as the computational requirements for serving a rapidly growing user base can become overwhelming.</p>
	<p>In addition to being popular, Generative AI apps are unique in that <strong>calls to them are incredibly resource intensive</strong>, and therefore <a href="https://a16z.com/2023/04/27/navigating-the-high-cost-of-ai-compute">expensive for the owner</a>. In comparison, think about a more traditional <a href="https://www.cloudflare.com/learning/security/api/what-is-an-api">API</a> that Cloudflare has protected for years. A product API. Sites don’t want competitors calling their product API and scraping data. This has an obvious negative business impact. However, it doesn’t have a direct infrastructure cost. A product list API returns a small amount of text. An attacker calling it 4 million times will have a negligible cost to an infrastructure bill. But generative models can cost cents, or in the case of image generation even tens of cents per call. An attacker gaining access and generating millions of calls has a real cost impact to the developers providing those APIs.</p>
	<p>Not only are the costs for generating content high, but <strong>the value that end users are willing to pay is high as well</strong>. Customers tell us that they have seen multiple instances of bad actors accessing an API without paying, then reselling the content they generate for 50 cents or more per call. The huge monetary opportunity of exploitation means attackers are highly motivated to come back again and again, refactoring their approach each time.</p>
	<p>Last, consumer-facing LLM applications are generally designed as a single entry point for customers, almost always <strong>accepting query text as input</strong>. The open-text nature of these calls makes it difficult to predict the potential impact of a single request. For example, a complex query might consume significant resources or trigger unexpected behavior. While these APIs are not GraphQL based, <a href="https://cheatsheetseries.owasp.org/cheatsheets/GraphQL_Cheat_Sheet.html">the challenges</a> are similar. When you accept unstructured submissions, it's harder to create any type of rule to prevent abuse.</p>
	<h3 id="tips-for-protecting-your-generative-ai-application">Tips for protecting your Generative AI application</h3>
	<p>So you've built the latest generative AI sensation, and the world is about to be taken by storm. But that success is also about to make you a target. What's the trick to stopping all those attacks you’re about to see? Well, unfortunately there isn’t one. For all the reasons above, this is a hard, persistent problem with no simple solution. But, we’ve been fortunate to work with many customers who have had that target on their back for months, and we’ve learned a lot from that experience. Here are some recommendations that will give you a good foundation for making sure that you, and only you, reap the rewards of your hard work.</p>
	<p>1. <strong>Enforce tokens for each user</strong>. Enforcing usage based on a specific user or user session is straightforward. But sometimes you want to allow anonymous usage. While anonymous usage is great for demos and testing, it can lead to abuse. If you must allow anonymous usage, <a href="https://developers.cloudflare.com/load-balancing/understand-basics/session-affinity">create a “stickier” identification scheme</a> that persists browser restarts and incognito mode. Your goal isn’t to track specific users, but instead to understand how much an anonymous user has already used your service so far in demo / free mode.</p>
	<p>2. <strong>Manage quotas carefully</strong>. Your service likely incurs costs and charges users per API call, so it likely makes sense to set a limit on the number of times any user can call your API. You may not ever intend for the average user to hit this limit, but having limits in place will protect against that user’s API key becoming compromised and shared amongst many users. It also protects against programming errors that could result in 100x or 1000x expected usage, and a large unexpected bill to the end user.</p>
	<p>3. <strong>Block certain </strong><a href="https://www.cloudflare.com/learning/network-layer/what-is-an-autonomous-system"><strong>ASNs</strong></a><strong> (autonomous system numbers) wholesale</strong>. Blocking ASNs, or even IPs wholesale is an incredibly blunt tool. In general Cloudflare rarely recommends this approach to customers. However, when tools are as popular as some generative AI applications, attackers are highly motivated to send as much traffic as possible to those applications. The fastest and cheapest way to accomplish this is through data centers that usually share a common ASN. Some ASNs belong to ISPs, and source traffic from people browsing the Internet. But other ASNs belong to cloud compute providers, and mainly source outbound traffic from virtual servers. Traffic from these servers can be overwhelmingly malicious. For example, several of our customers have found ASNs where 88-90% of the traffic turns out to be automated, while this number is usually only 30% for average traffic. In cases this extreme, blocking entire ASNs can make sense.</p>
	<p>4. <strong>Implement smart rate limits</strong>. Counting not only requests per minute and requests per session, but also IPs per token and tokens per IP can guard against abuse. Tracking how many different IPs are using a particular token at any one time can alert you to a user's token being leaked. Similarly, if one IP is rotating through tokens, looking at each token’s session traffic would not alert you to the abuse. You’d need to look at how many tokens that single IP is generating in order to pinpoint that specific abusive behavior.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/download-13.png" class="kg-image" alt="" loading="lazy" width="591" height="454"></figure>
	<p>5. <strong>Rate limit on something other than the user.</strong> Similar to enforcing tokens on each user, your <a href="https://blog.cloudflare.com/advanced-rate-limiting">real time rate limits</a> should also be set on your sticky identifier.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/download--1--9.png" class="kg-image" alt="" loading="lazy" width="611" height="229"></figure>
	<p>6. <strong>Have an option to slow down attackers. </strong>Customers often think about stopping abuse in terms of blocking traffic from abusers. But blocking isn’t the only option. Attacks not only need to be successful, they also need to be economically feasible. If you can make requests more difficult or time-consuming for abusers, you can ruin their economics. You can do this by implementing a waiting room, or by challenging users. We recommend a challenge option that <a href="https://blog.cloudflare.com/turnstile-private-captcha-alternative">doesn’t give real users an awful experience</a>. Challenging users can also be quickly enabled or disabled as you see abuse spike or recede.</p>
	<p>7. <strong>Map and analyze sequences</strong>. By sampling user sessions that you suspect of abuse, you can i<a href="https://blog.cloudflare.com/api-sequence-analytics">nspect their requests path-by-path</a> in your SIEM. Are they using your app as expected? Or are they circumventing intended usage? You might benefit from enforcing a user flow between endpoints.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2023/05/download--2--7.png" class="kg-image" alt="" loading="lazy" width="932" height="929"></figure>
	<p>8. <strong>Build and validate an API schema</strong>. Many API breaches happen due to permissive schemas. Users are allowed to send in extra fields in requests that grant them too many privileges or allow access to other users’ data. Make sure you build a verbose schema that outlines what intended usage is by <a href="https://blog.cloudflare.com/ml-api-discovery-and-schema-learning">identifying and cataloging all API endpoints</a>, then making sure all specific parameters are listed as required and have type limits to them.</p>
	<p>We recently went through the transition to an <a href="https://blog.cloudflare.com/open-api-transition">OpenAPI schema</a> ourselves for api.cloudflare.com. Our schema looks like this:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-yaml">/zones:
    get:
      description: List, search, sort, and filter your zones.
      operationId: zone-list-zones
      responses:
        4xx:
          content:
            application/json:
              schema:
                allOf:
                - $ref: '#/components/schemas/components-schemas-response_collection'
                - $ref: '#/components/schemas/api-response-common-failure'
          description: List Zones response failure
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/components-schemas-response_collection'
          description: List Zones response
      security:
      - api_email: []
        api_key: []
      summary: List Zones
      tags:
      - Zone
      x-cfPermissionsRequired:
        enum:
        - '#zone:read'
      x-cfPlanAvailability:
        business: true
        enterprise: true
        free: true
        pro: true
</code></pre>
	<!--kg-card-end: markdown-->
	<p>9. <strong>Analyze the depth and complexity of queries</strong>. Are your APIs driven by GraphQL? GraphQL queries can be a source of abuse since they allow such free-form requests. Large, complex queries can grow to <a href="https://developers.cloudflare.com/api-shield/security/graphql-protection/configure">overwhelm origins if limits aren’t in place</a>. Limits help guard against outright DoS attacks as well as developer error, keeping your origin healthy and serving requests to your users as expected.</p>
	<p>For example, if you have statistics about your GraphQL queries by depth and query size, you could execute this TypeScript function to analyze them by quantile:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-typescript">import * as ss from 'simple-statistics';

function calculateQuantiles(data: number[], quantiles: number[]): {[key: number]: string} {
    let result: {[key: number]: string} = {};
    for (let q of quantiles) {
        // Calculate quantile, convert to fixed-point notation with 2 decimal places
        result[q] = ss.quantile(data, q).toFixed(2);
    }
    return result;
}

// Example usage:
let queryDepths = [2, 2, 2, 2, 2, 2, 2, 4, 4, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1];
let querySizes = [11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2];

console.log(calculateQuantiles(queryDepths, [0.5, 0.75, 0.95, 0.99]));
console.log(calculateQuantiles(querySizes, [0.5, 0.75, 0.95, 0.99]));
</code></pre>
	<!--kg-card-end: markdown-->
	<p>The results give you a sense for the depth of the average query hitting your endpoint, grouped by quantile:</p><!--kg-card-begin: markdown-->
	<pre><code class="language-typescript">{ '0.5': 2, '0.75': 3, '0.95': 4, '0.99': 4 }
{ '0.5': 6.5, '0.75': 2, '0.95': 2, '0.99': 2 }
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Actual data from your production environment would provide a threshold to start an investigation into which queries to further log or limit. A simpler option is to use a <a href="https://developers.cloudflare.com/api-shield/security/graphql-protection/configure">query analysis tool, like Cloudflare’s</a>, to make the process automatic.</p>
	<p>10. <strong><strong><strong>Use short-lived access tokens and long-lived refresh tokens upon successful authentication of your users</strong>. </strong></strong>Implement token validation in a middleware layer or API Gateway, and be sure to have a dedicated token renewal endpoint in your API. <a href="https://developers.cloudflare.com/cloudflare-one/identity/authorization-cookie/validating-json">JSON Web Tokens (JWTs)</a> are popular choices for these short-lived tokens. When access tokens expire, allow users to obtain new ones using their refresh tokens. Revoke refresh tokens when necessary to maintain system security. Adopting this approach enhances your API's security and user experience by effectively managing access and mitigating the risks associated with compromised tokens.</p>
	<p>11. <strong>Communicate directly with your users</strong>. All of the above recommendations are going to make it a bit more cumbersome for some of your customers to use your product. You are going to get complaints. You can reduce these by first, giving clear communication to your users explaining why you put these measures in place. Write a blog about what security measures you did and did not decide to implement and have dev docs explaining troubleshooting steps to resolve. Second, give your users concrete steps they can take if they are having trouble, and a clear way to contact you directly. Feeling inconvenienced can be frustrating, but feeling stuck can lose you a customer.</p>
	<h3 id="conclusion-this-is-the-beginning">Conclusion: this is the beginning</h3>
	<p>Generative AI, like the first iPhone, has sparked a surge of excitement and innovation. But that excitement also brings risk, and innovation brings new security holes and attack vectors. The broadness and uniqueness of generative AI applications in particular make securing them particularly challenging. But as every scout knows, being prepared ahead of time means less stress and worry during the journey. Implementing the tips we've shared can establish a solid foundation that will let you sit back and enjoy the thrill of building something special, rather than worrying what might be lurking around the corner.</p>
	<p>To learn more about how you can put some of these recommendations into practice, check out our <a href="https://www.cloudflare.com/developer-platform/products">developer platform</a>, <a href="https://www.cloudflare.com/products/api-gateway">API Security</a>, and <a href="https://blog.cloudflare.com/advanced-rate-limiting">Rate Limiting products</a>.</p>
	<h3 id="watch-on-cloudflare-tv">Watch on Cloudflare TV</h3><!--kg-card-begin: html-->
	<div style="position: relative; padding-top: 56.25%;"><iframe src="https://customer-rhnwzxvb3mg4wz3v.cloudflarestream.com/75b97f7a31ac535296f806385031b84a/iframe?preload=true&amp;poster=https%3A%2F%2Fcustomer-rhnwzxvb3mg4wz3v.cloudflarestream.com%2F75b97f7a31ac535296f806385031b84a%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D1s%26height%3D600" style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe></div><!--kg-card-end: html-->
</div>