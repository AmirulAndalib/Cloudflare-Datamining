<div class="post-content lh-copy gray1">
	<!--kg-card-begin: markdown-->
	<p><em><small>This post is also available in <a href="https://blog.cloudflare.com/zh-cn/keyless-ssl-supports-fips-140-2-l3-hsm-zh-cn">简体中文</a>, <a href="https://blog.cloudflare.com/zh-tw/keyless-ssl-supports-fips-140-2-l3-hsm-zh-tw">繁體中文</a>, <a href="https://blog.cloudflare.com/ja-jp/keyless-ssl-supports-fips-140-2-l3-hsm-ja-jp">日本語</a>, <a href="https://blog.cloudflare.com/id-id/keyless-ssl-supports-fips-140-2-l3-hsm-id-id">Bahasa Indonesia</a>, <a href="https://blog.cloudflare.com/th-th/keyless-ssl-supports-fips-140-2-l3-hsm-th-th">ไทย</a>.</small></em></p>
	<!--kg-card-end: markdown-->
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/03/image1-55.png" class="kg-image" alt="Keyless SSL now supports FIPS 140-2 L3 hardware security module (HSM) offerings from all major cloud providers" loading="lazy"></figure>
	<p><strong>Private encryption keys stored in hardware security module offerings from all major cloud providers can now be used to secure HTTPS connections at Cloudflare’s global edge</strong>.</p>
	<p>Cloudflare generates, protects, and manages more SSL/TLS private keys than perhaps any organization in the world. Private keys must be carefully protected, as an attacker in possession of one can impersonate legitimate sites and decrypt HTTPS requests. To mitigate this risk, Cloudflare has strict key handling procedures and <a href="https://blog.cloudflare.com/going-keyless-everywhere">layers of isolation</a> at the edge that are designed to safeguard keys at all costs. But for a small minority of customers with information security policies dictating where they can (or cannot) custody their keys, these protections do not meet their requirements.</p>
	<p>It was for these customers that we <a href="https://blog.cloudflare.com/announcing-keyless-ssl-all-the-benefits-of-cloudflare-without-having-to-turn-over-your-private-ssl-keys">first released Keyless SSL in 2014</a>, a protocol we use extensively inside our network: all of the TLS handshakes per day established at the Cloudflare edge that take place in a process that has no access to our customers’ private keys. The data required to establish the session is instead sent to a separate system, where the necessary cryptographic signing operation is performed. For keys uploaded to or generated by Cloudflare, we manage this other system, but some customers wish to manage it themselves.</p>
	<figure class="kg-card kg-image-card"><img src="https://blog.cloudflare.com/content/images/2021/03/image2-47.png" class="kg-image" alt="[LOGICAL DIAGRAM SHOWING PRIVATE KEYS STORED ON HSMs BEING USED FOR TLS HANDSHAKE]" loading="lazy"></figure>
	<p>Historically the keys were placed on the server running the <a href="https://github.com/cloudflare/gokeyless" target="_blank">open source gokeyless daemon</a> we provide to process the handshake, or secured in an on-prem hardware security module (HSM) that gokeyless interfaces with using a standard protocol known as PKCS#11. However, as financial services, healthcare, cryptocurrency, and other highly regulated or security-focused companies have moved to the cloud, they cannot simply ship these expensive boxes and ask Amazon, Google, IBM, or Microsoft to rack and stack them.</p>
	<p>For these customers, especially those whose information security policies mandate <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.140-2.pdf" target="_blank">FIPS 140-2 Level 3</a> validated HSMs, we are announcing that Keyless SSL now supports the following cloud-hosted HSMs: <a href="https://aws.amazon.com/cloudhsm" target="_blank">Amazon Cloud HSM</a>; <a href="https://cloud.google.com/kms/docs/hsm" target="_blank">Google Cloud HSM</a>; <a href="https://cloud.ibm.com/catalog/infrastructure/hardware-security-module" target="_blank">IBM Cloud HSM</a>; <a href="https://azure.microsoft.com/en-us/services/azure-dedicated-hsm" target="_blank">Microsoft Azure Dedicated HSM</a> and <a href="https://azure.microsoft.com/en-us/updates/akv-managed-hsm-public-preview" target="_blank">Managed HSM</a>. We also support any other HSM that implements the PKCS#11 standard, including series such as the <a href="https://developers.cloudflare.com/ssl/keyless-ssl/hardware-security-modules/ncipher-thales-nshield-connect" target="_blank">nCipher nShield Connect</a> and Thales Luna.</p>
	<h3 id="hsm-overview">HSM overview</h3>
	<p>HSMs are purpose-built machines that are tamper-resistant, hardened against weaknesses such as side-channel attacks, and optimized to perform cryptographic operations such as signing and decryption. They can be deployed as stand-alone boxes, as expansion cards inserted into servers, or, most recently, as cloud services.</p>
	<p>Rather than generate private keys on a server and upload them to the HSM, vendors and security experts typically recommend that keys are generated on (and never leave) the device itself. HSMs have better randomness guarantees than general-purpose servers, and take special precautions to protect keys in memory before synchronizing them to disk in an encrypted state. When operations that require the private key are required, services make authenticated API calls into the device using libraries provided by the HSM vendor.</p>
	<h3 id="hsms-and-fips-140-2-level-3">HSMs and FIPS 140-2 level 3</h3>
	<p>HSMs are typically validated against the Federal Information Process Standard (FIPS) publication 140-2: <a href="https://csrc.nist.gov/publications/detail/fips/140/2/final" target="_blank">Security Requirements for Cryptographic Modules</a>. There are four levels — 1 through 4 — that specify increasingly stringent requirements around approved algorithms, security functions, <a href="https://www.cloudflare.com/learning/access-management/role-based-access-control-rbac" target="_blank">role-based access control</a>, and tamper evident/resistant protections.</p>
	<p>The National Institute of Standards and Technology (NIST) publishes these guidelines, administers the <a href="https://csrc.nist.gov/projects/cryptographic-module-validation-program/validated-modules" target="_blank">Cryptographic Module Validation Program</a>, and publishes a <a href="https://csrc.nist.gov/projects/cryptographic-module-validation-program/validated-modules/search" target="_blank">searchable database of validated modules</a>, which includes the offerings listed below. We have provided instructions on how to use them with Cloudflare.</p>
	<h3 id="getting-started-with-cloud-offerings">Getting started with cloud offerings</h3>
	<p>All existing Keyless SSL customers can immediately make use of this technology, and you can read instructions for doing so at <a href="https://developers.cloudflare.com/ssl/keyless-ssl/hardware-security-modules" target="_blank">https://developers.cloudflare.com/ssl/keyless-ssl/hardware-security-modules</a>. Source code is available on GitHub: <a href="https://github.com/cloudflare/gokeyless" target="_blank">https://github.com/cloudflare/gokeyless</a>.</p>
	<h3 id="end-to-end-example-microsoft-azure-managed-hsm">End-to-end example: Microsoft Azure Managed HSM</h3>
	<p>Microsoft’s Azure Key Vault team <a href="https://azure.microsoft.com/en-us/updates/akv-managed-hsm-public-preview" target="_blank">released Managed HSM</a>. The offering is FIPS 140-2 Level 3 validated and is integrated with Azure services such as Azure Storage, Azure SQL, and Azure Information Protection. Managed HSM is available in the following regions: East US 2, South Central US, North Europe, and West Europe.</p>
	<p>The instructions below are taken from the <a href="https://docs.microsoft.com/en-us/azure/key-vault/managed-hsm/quick-create-cli" target="_blank">Quickstart: Provision and activate a managed HSM using Azure CLI</a> guide, followed by instructions for using the Managed HSM with Cloudflare. The commands were run on a Ubuntu VM created in the same region (South Central US) as the HSM; this is also where we will deploy the Cloudflare Keyless SSL daemon.</p>
	<h3 id="provision-and-activate-the-hsm">Provision and activate the HSM</h3>
	<p>First we log in via the CLI and create a resource group for the Managed HSM in one of the supported regions. Note that you may get warnings from various commands based on the preview status of the offering.</p><!--kg-card-begin: markdown-->
	<pre><code>$ LOCATION=southcentralus; GROUPNAME=”HSMgroup”; HSMNAME=”KeylessHSM”
$ az login
$ az group create --name $GROUPNAME --location $LOCATION
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Next, we provision the HSM resource and activate it by downloading the <a href="https://docs.microsoft.com/en-us/azure/key-vault/managed-hsm/security-domain" target="_blank">security domain</a>. The example below grants administrative access to the signed-in user, along with another administrator whose OID can be retrieved by executing the same oid=$(...) command from the CLI where that user is logged in.</p><!--kg-card-begin: markdown-->
	<pre><code>$ MYOID=$(az ad signed-in-user show --query objectId -o tsv)
$ OTHERADMIN_OID=...

$ az keyvault create --hsm-name $HSMNAME --resource-group $GROUPNAME --location $LOCATION --administrators $MYOID $OTHERADMIN_OID

Argument '--hsm-name' is in preview and under development. Reference and support levels: https://aka.ms/CLI_refstatus
Argument '--administrators' is in preview and under development. Reference and support levels: https://aka.ms/CLI_refstatus
{- Finished ..
  "id": "/subscriptions/.../resourceGroups/HSMgroup/providers/Microsoft.KeyVault/managedHSMs/Keyles
sHSM",
  "location": "southcentralus",
  "name": "KeylessHSM",
  "properties": {
    "createMode": null,
    "enablePurgeProtection": false,
    "enableSoftDelete": true,
    "hsmUri": "https://keylesshsm.managedhsm.azure.net/",
    "initialAdminObjectIds": [
      "$MYOID",
      "$OTHERADMIN_OID"
    ],
    "provisioningState": "Succeeded",
    "softDeleteRetentionInDays": 90,
    "statusMessage": "The Managed HSM is provisioned and ready to use.",
    "tenantId": "..."
  },
  "resourceGroup": "$GROUPNAME",
  "sku": {
    "family": "B",
    "name": "Standard_B1"
  },
  "tags": {},
  "type": "Microsoft.KeyVault/managedHSMs"
}
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Record the <strong>hsmUri</strong> property that is returned from the command above. You will need this shortly when configuring Keyless SSL on your VM.</p><!--kg-card-begin: markdown-->
	<pre><code>$ HSMURI="https://keylesshsm.managedhsm.azure.net/"
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Now that the HSM is provisioned, you must provide it with at least 3 RSA public keys. The HSM will encrypt the security domain with these keys and send it back to you, after which the HSM is ready to use.</p><!--kg-card-begin: markdown-->
	<pre><code class="language-json">$ openssl req -newkey rsa:2048 -nodes -keyout cert_0.key -x509 -days 365 -out cert_0.cer
$ openssl req -newkey rsa:2048 -nodes -keyout cert_1.key -x509 -days 365 -out cert_1.cer
$ openssl req -newkey rsa:2048 -nodes -keyout cert_2.key -x509 -days 365 -out cert_2.cer

$ az keyvault security-domain download --hsm-name $HSMNAME --sd-wrapping-keys ./cert_0.cer ./cert_1.cer ./cert_2.cer --sd-quorum 2 --security-domain-file $HSMNAME-SD.json
</code></pre>
	<!--kg-card-end: markdown-->
	<p>If you get a “Failed to connect to MSI” error, and you are using a cloud shell from the Azure Portal, run az login again as this is a known issue.</p>
	<p>Once you have your HSM provisioned, <a href="https://docs.microsoft.com/en-us/cli/azure/keyvault/key?view=azure-cli-latest#az_keyvault_key_import" target="_blank">add your private key</a> to the keyvault</p><!--kg-card-begin: markdown-->
	<pre><code>$ az keyvault key import --KeylessHSM
</code></pre>
	<!--kg-card-end: markdown-->
	<p>This will return a URI that you will later add to the Keyless YAML file to indicate where your private key is stored.</p>
	<p>Now that you have your HSM provisioned and activated, you need to create a VM where you will deploy the Keyless daemon. For this example, we will create an Ubuntu Xenial VM in Azure. In the portal, go to the <strong>Virtual machines </strong>page and <strong>Add </strong>a VM. There, you can use the resource group that you created earlier for the HSM. For best results, choose the same region as the one for the HSM. Note the public IP of the VM, you will use this to remotely connect to the server.</p>
	<p>Next, configure your VM as a key server. First, you need to add the <a href="https://pkg.cloudflare.com" target="_blank">Cloudflare Package Repository</a>. Then, you will update your OS’ package listings and install the gokeyless server.</p><!--kg-card-begin: markdown-->
	<pre><code>$ apt-get update
$ echo 'deb http://pkg.cloudflare.com/ Xenial main' |
sudo tee /etc/apt/sources.list.d/cloudflare-main.list
$ curl -C - https://pkg.cloudflare.com/pubkey.gpg | sudo apt-key
$ apt-get update
$ apt-get install gokeyless
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Then, update the gokeyless YAML file. There, you will add the hostname of your keyserver — this hostname should have a DNS record that points to your VM, the zoneID, and Origin CA API key. The zoneID and Origin CA API key can be found in the Cloudflare dashboard. In addition to that, indicate the URI that to points to your private key’s directory under private_key_stores.</p><!--kg-card-begin: markdown-->
	<pre><code>$ vim /etc/keyless/gokeyless.yaml
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Lastly, start the keyless server.</p><!--kg-card-begin: markdown-->
	<pre><code>$ service gokeyless start
</code></pre>
	<!--kg-card-end: markdown-->
	<p>Go back to the Azure portal and open the required TCP ports for the Azure VM. Go to your VM → Networking → Add inbound port rule. Make sure you allow traffic on any source port and indicate Port 2407 for the destination port.</p>
	<p>Save the change, then go to the Cloudflare dashboard to upload your SSL certificate. You should see “Upload Keyless SSL Certificate” in the Edge Certificates section of the SSL/TLS tab. There, enter the fields with the key server label, the hostname in the YAML file, the key server port-- 2407 is the default port, and paste the SSL certificate.</p>
	<p>Next you’re ready to test! Run <code>curl -v https://zone.com</code> and check that the TLS handshake is successfully completed.</p>
	<h3 id="microsoft-azure-dedicated-hsm">Microsoft Azure Dedicated HSM</h3>
	<p>In addition to the Managed HSM offering that is now in public preview, Azure customers can configure Cloudflare’s edge to utilize keys stored in Microsoft’s <a href="https://azure.microsoft.com/en-us/services/azure-dedicated-hsm" target="_blank">Dedicated HSM offering</a>, based on the SafeNet Luna Network HSM 7 Model A790 series.</p>
	<p>Azure Dedicated HSM is validated against both FIPS 140-2 Level 3 and eIDAS Common Criteria EAL4+. After following the instructions to <a href="https://docs.microsoft.com/en-us/azure/dedicated-hsm/tutorial-deploy-hsm-powershell" target="_blank">deploy the HSM</a>, customers should follow the Azure specific Keyless SSL instructions <a href="https://developers.cloudflare.com/ssl/keyless-ssl/hardware-security-modules/azure-dedicated-hsm" target="_blank">here</a>.</p>
	<h3 id="amazon-web-services-aws-cloud-hsm">Amazon Web Services (AWS) Cloud HSM</h3>
	<p><a href="https://aws.amazon.com/cloudhsm" target="_blank">AWS CloudHSM</a> also provides FIPS 140-2 Level 3 validated HSMs to store your private keys.</p>
	<p>The official <a href="https://registry.terraform.io/providers/hashicorp/aws/latest" target="_blank">AWS Terraform Provider</a> now includes support for the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudhsm_v2_cluster" target="_blank">aws_cloudhsm_v2_cluster</a>, which is the version that Cloudflare supports. After <a href="https://docs.aws.amazon.com/cloudhsm/latest/userguide/getting-started.html" target="_blank">provisioning the AWS CloudHSM cluster</a>, customers should follow the AWS specific Keyless SSL instructions <a href="https://developers.cloudflare.com/ssl/keyless-ssl/hardware-security-modules/aws-cloud-hsm" target="_blank">here</a>.</p>
	<h3 id="google-cloud-hsm">Google Cloud HSM</h3>
	<p><a href="https://cloud.google.com/kms/docs/hsm" target="_blank">Google Cloud HSM</a> uses GCP’s Cloud KMS as its front end, and allows hosting of keys in FIPS 140-2 Level 3 validated HSMs. Additionally, Google offers the ability to host your own HSM in Google provided space; it is recommended that you contact your GCP account representative for additional information about this option.</p>
	<p>Once the key ring and key have been <a href="https://cloud.google.com/kms/docs/hsm" target="_blank">created</a> within the HSM, customers should follow the Google Cloud specific Keyless SSL instructions <a href="https://developers.cloudflare.com/ssl/keyless-ssl/hardware-security-modules/google-cloud-hsm" target="_blank">here</a>. Additional details on using asymmetric keys with GCP KMS can be found <a href="https://cloud.google.com/kms/docs/encrypt-decrypt-rsa" target="_blank">here</a>.</p>
	<h3 id="ibm-cloud">IBM Cloud</h3>
	<p><a href="https://cloud.ibm.com/docs/hardware-security-modules/about.html#about-ibm-cloud-hsm" target="_blank">IBM Cloud HSM</a> 7.0 provides FIPS 140-2 Level 3 validated HSM capabilities. The offering is based on the SafeNet Luna A750 series.</p>
	<p>After <a href="https://cloud.ibm.com/docs/hardware-security-modules?topic=hardware-security-modules-provisioning-ibm-cloud-hsm#provisioning-ibm-cloud-hs" target="_blank">provisioning the HSM</a>, customers should refer to the IBM specific Keyless SSL instructions <a href="https://developers.cloudflare.com/ssl/keyless-ssl/hardware-security-modules/ibm-cloud-hsm" target="_blank">here</a>.</p>
	<h3 id="getting-help-and-providing-feedback">Getting help and providing feedback</h3>
	<p>HSMs offer strong key protection capabilities, but can be complicated to set up and deploy. If you need assistance deploying the HSM on your cloud provider, we suggest that you start with their support channels.</p>
	<p>However, if you need assistance configuring the HSM to work with Cloudfare’s edge, or would like to provide feedback on the process, you should reach out directly to your Solutions Engineering team who can put you in touch with Cloudflare’s Keyless SSL specialists.</p>
</div>